<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>企业微信获客助手回调地址配置</title>
    <link href="/2025/03/07/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E8%8E%B7%E5%AE%A2%E5%8A%A9%E6%89%8B%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/"/>
    <url>/2025/03/07/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E8%8E%B7%E5%AE%A2%E5%8A%A9%E6%89%8B%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="企业微信获客助手回调地址配置教程"><a href="#企业微信获客助手回调地址配置教程" class="headerlink" title="企业微信获客助手回调地址配置教程"></a>企业微信获客助手回调地址配置教程</h1><p>企业微信开放平台提供的一种功能，允许企业生成带有唯一标识参数的URL链接，用户点击链接可直接跳转至企业微信的“添加联系人”页面，快速完成客户与员工的连接，可以帮助企业更好地获取客户线索</p><p><strong>先判断是否类目支持获客助手链接打开回调</strong></p><blockquote><p> 仅部分经营类目企业支持，当前企业是否支持可在「高级功能-获客助手」中查看该类目对应的功能是否包含「链接打开回调」。</p></blockquote><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20250310151814579.png" alt="image-20250310151814579"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20250310151841561.png" alt="image-20250310151841561"></p><h2 id="一、创建自建应用"><a href="#一、创建自建应用" class="headerlink" title="一、创建自建应用"></a>一、创建自建应用</h2><ol><li><strong>登录企业微信管理后台</strong> ：使用企业的管理员账号登录企业微信管理后台，网址为 <a href="https://work.weixin.qq.com/%E3%80%82">https://work.weixin.qq.com/。</a></li><li><strong>进入应用管理</strong> ：在管理后台导航栏中，找到并点击 “应用管理” 选项。</li><li><strong>创建自建应用</strong> ：点击 “创建应用” 按钮，按照页面提示填写应用名称、logo 和应用简介等信息，完成自建应用的创建。</li></ol><h2 id="二、配置应用回调地址"><a href="#二、配置应用回调地址" class="headerlink" title="二、配置应用回调地址"></a>二、配置应用回调地址</h2><ol><li><p><strong>进入应用详情页面</strong> ：在应用管理页面中，找到刚刚创建的自建应用，点击其名称进入应用详情页面，接受消息-&gt;设置API接收 </p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20250310151654612.png" alt="image-20250310151654612"></p></li><li><p><strong>接收消息服务器配置</strong></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20250310151713513.png" alt="image-20250310151713513"></p></li><li><p><strong>配置可调用接口的应用</strong></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20250310151937301.png" alt="image-20250310151937301"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20250310151959153.png" alt="image-20250310151959153"></p></li></ol><h2 id="三、通过接口创建获客链接"><a href="#三、通过接口创建获客链接" class="headerlink" title="三、通过接口创建获客链接"></a>三、通过接口创建获客链接</h2><ol><li><p><strong>获取access_token</strong>相关文档地址：<a href="https://developer.work.weixin.qq.com/document/path/91039">https://developer.work.weixin.qq.com/document/path/91039</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">请求方式： GET（HTTPS）<br>请求地址： https:<span class="hljs-regexp">//</span>qyapi.weixin.qq.com<span class="hljs-regexp">/cgi-bin/g</span>ettoken?corpid=ID&amp;corpsecret=SECRET<br></code></pre></td></tr></table></figure></li><li><p><strong>获取接口文档</strong> ：企业微信提供了创建获客链接的接口，相关文档可参考 <a href="https://developer.work.weixin.qq.com/document/path/97297#%E5%88%9B%E5%BB%BA%E8%8E%B7%E5%AE%A2%E9%93%BE%E6%8E%A5">创建获客链接接口文档</a>。</p></li><li><p><strong>调用接口创建获客链接</strong> ：使用已配置好回调地址的自建应用的 <code>agentid</code> 和企业的 <code>access_token</code> ，按照接口文档中的要求，调用创建获客链接接口。在接口调用过程中，可以设置获客链接的相关参数，如链接名称等。</p></li><li><p><strong>关联应用与获客链接</strong> ：通过接口创建的获客链接会自动与对应的自建应用关联，确保企业微信在用户通过获客链接打开链接&#x2F;发起申请等事件发生时，能够将相关回调信息发送到企业服务器的指定回调地址。</p></li></ol><blockquote><p><strong>重点：</strong>管理后台直接创建的获客链接并不与特定的应用关联，因此无法接收回调。必须通过自建应用并使用接口来创建获客链接，才能确保回调功能正常。且必须要拼接customer channel参数才能接收到回调。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>广告</category>
      
    </categories>
    
    
    <tags>
      
      <tag>广告</tag>
      
      <tag>企业微信</tag>
      
      <tag>获客助手</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringBoot接入Prometheus+Grafana监控资源</title>
    <link href="/2025/02/24/SpringBoot%E6%8E%A5%E5%85%A5Prometheus-Grafana%E7%9B%91%E6%8E%A7%E8%B5%84%E6%BA%90/"/>
    <url>/2025/02/24/SpringBoot%E6%8E%A5%E5%85%A5Prometheus-Grafana%E7%9B%91%E6%8E%A7%E8%B5%84%E6%BA%90/</url>
    
    <content type="html"><![CDATA[<h4 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h4><p>Prometheus 是一个开源的监控和报警系统，专为容器化和微服务架构设计。它通过拉取（Pull）模式定期从应用程序或系统的指标端点（通常是 HTTP 接口）抓取时间序列数据。数据以时间戳+指标名称+标签的形式存储，支持高效查询和聚合。Prometheus 使用 PromQL（Prometheus 查询语言）来查询、聚合和展示数据。</p><p>Prometheus 提供强大的告警机制，通过定义规则，在数据满足特定条件时触发告警。告警规则根据预设的时间间隔进行评估，并将告警信息发送到告警管理系统（如 Alertmanager）。</p><p>Prometheus 自带内存存储引擎，支持按时间范围自动删除过期数据。它还支持通过Push Gateway接收推送数据，以及与其他系统集成（如 Grafana）进行可视化展示。总体来说，Prometheus 的设计强调高效、可扩展、灵活，适合动态环境下的实时监控。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250224150420029.png" alt="img"></p><center><small>(图源自网络)</small></center><h4 id="docker-compose-安装promethus-Grafana"><a href="#docker-compose-安装promethus-Grafana" class="headerlink" title="docker-compose 安装promethus+Grafana"></a>docker-compose 安装promethus+Grafana</h4><blockquote><p>已安装可忽略</p></blockquote><ul><li><p>编辑prometheus配置文件</p><p>&#x2F;prometheus&#x2F;prometheus.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 全局配置</span><br><span class="hljs-attr">global:</span><br>  <span class="hljs-comment"># 设置抓取目标的默认时间间隔，表示 Prometheus 每 15 秒抓取一次目标数据</span><br>  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span><br>  <span class="hljs-comment"># 设置评估规则的默认时间间隔，表示 Prometheus 每 15 秒评估一次告警规则</span><br>  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span><br>  <span class="hljs-comment"># 默认抓取超时设置为10秒</span><br>  <span class="hljs-comment"># scrape_timeout is set to the global default (10s).</span><br><br><span class="hljs-comment"># 告警配置</span><br><span class="hljs-attr">alerting:</span><br>  <span class="hljs-comment"># 配置告警管理器，指定告警接收的目标地址</span><br>  <span class="hljs-attr">alertmanagers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">static_configs:</span><br>        <span class="hljs-comment"># 告警接收地址，Prometheus 会将告警信息发送到此地址</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;127.0.0.1:9093&#x27;</span>]<br><br><span class="hljs-comment"># 加载规则文件，并根据全局“评估间隔”定期评估规则</span><br><span class="hljs-attr">rule_files:</span><br>  <span class="hljs-comment"># 指定规则文件的位置</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/etc/prometheus/rules.yml&quot;</span><br><br><span class="hljs-comment"># 控制 Prometheus 监控哪些资源</span><br><span class="hljs-comment"># 默认配置中，Prometheus 会配置一个名为 &#x27;prometheus&#x27; 的作业，该作业用于抓取 Prometheus 服务器本身公开的时间序列数据</span><br><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-comment"># 作业名称会作为标签“job=&lt;job_name&gt;`添加到此配置中获取的任何数据</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;prometheus&#x27;</span><br>    <span class="hljs-comment"># 静态配置，指定 Prometheus 要抓取的目标地址</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-comment"># 目标地址，Prometheus 会从此地址抓取数据（通常是 Prometheus 自己暴露的指标）</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;localhost:9090&#x27;</span>]<br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;node&#x27;</span><br>    <span class="hljs-comment"># 静态配置，指定 Prometheus 要抓取的目标地址</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-comment"># 目标地址，Prometheus 会从此地址抓取数据（通常是 Node Exporter）</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;localhost:9100&#x27;</span>]<br>        <span class="hljs-comment"># 为此目标添加标签，用于标识环境和角色</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">env:</span> <span class="hljs-string">dev</span><br>          <span class="hljs-attr">role:</span> <span class="hljs-string">docker</span><br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;prometheusapp&#x27;</span><br>    <span class="hljs-comment"># 设置自定义的 metrics 路径，告诉 Prometheus 从哪里抓取应用程序的指标数据</span><br>    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">&#x27;/actuator/prometheus&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-comment"># 目标地址，Prometheus 会从该地址抓取 Prometheus 应用程序的指标数据</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;host.docker.internal:8080&#x27;</span>]<br><br></code></pre></td></tr></table></figure></li><li><p>编辑告警规则文件</p><p>&#x2F;prometheus&#x2F;rules.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">groups:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">example</span><br>  <span class="hljs-attr">rules:</span><br> <span class="hljs-comment"># Alert for any instance that is unreachable for &gt;5 minutes.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">InstanceDown</span><br>    <span class="hljs-attr">expr:</span> <span class="hljs-string">up</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span><br>    <span class="hljs-attr">labels:</span><br>      <span class="hljs-attr">serverity:</span> <span class="hljs-string">page</span><br>    <span class="hljs-attr">annotations:</span><br>      <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;Instance <span class="hljs-template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down&quot;</span><br>      <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="hljs-template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 5 minutes.&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>编辑告警配置文件</p><p>&#x2F;alertmanager&#x2F;alertmanager.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">global:</span><br>  <span class="hljs-attr">resolve_timeout:</span> <span class="hljs-string">5m</span><br>  <span class="hljs-attr">smtp_smarthost:</span> <span class="hljs-string">&#x27;xxx@xxx:587&#x27;</span><br>  <span class="hljs-attr">smtp_from:</span> <span class="hljs-string">&#x27;zhaoysz@xxx&#x27;</span><br>  <span class="hljs-attr">smtp_auth_username:</span> <span class="hljs-string">&#x27;xxx@xxx&#x27;</span><br>  <span class="hljs-attr">smtp_auth_password:</span> <span class="hljs-string">&#x27;xxxx&#x27;</span><br>  <span class="hljs-attr">smtp_require_tls:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">route:</span><br>  <span class="hljs-attr">group_by:</span> [<span class="hljs-string">&#x27;alertname&#x27;</span>]<br>  <span class="hljs-attr">group_wait:</span> <span class="hljs-string">10s</span><br>  <span class="hljs-attr">group_interval:</span> <span class="hljs-string">10s</span><br>  <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">1h</span><br>  <span class="hljs-attr">receiver:</span> <span class="hljs-string">&#x27;test-mails&#x27;</span><br><span class="hljs-attr">receivers:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;test-mails&#x27;</span><br>  <span class="hljs-attr">email_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span> <span class="hljs-string">&#x27;xxxxxx@qq.com&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>编辑docker-compose</p><p>docker-compose.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.8&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">prometheus:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">9090</span><span class="hljs-string">:9090</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/prometheus/:/etc/prometheus/</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">prometheus_data:/prometheus</span><br>    <span class="hljs-attr">command:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--web.external-url=http://prometheus:9090/&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--web.enable-lifecycle&#x27;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">monitor_net</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br><br>  <span class="hljs-attr">alertmanager:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/alertmanager</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/alertmanager/:/etc/alertmanager/</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">alertmanager_data:/alertmanager</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">9093</span><span class="hljs-string">:9093</span><br>    <span class="hljs-attr">command:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--config.file=/etc/alertmanager/alertmanager.yml&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--storage.path=/alertmanager&#x27;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">monitor_net</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br><br>  <span class="hljs-attr">grafana:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">3000</span><span class="hljs-string">:3000</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/grafana/:/etc/grafana/provisioning/</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">grafana_data:/var/lib/grafana</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">GF_INSTALL_PLUGINS=camptocamp-prometheus-alertmanager-datasource</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">prometheus</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">alertmanager</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">monitor_net</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br><br><span class="hljs-attr">volumes:</span><br>  <span class="hljs-attr">prometheus_data:</span> &#123;&#125;<br>  <span class="hljs-attr">grafana_data:</span> &#123;&#125;<br>  <span class="hljs-attr">alertmanager_data:</span> &#123;&#125;<br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">monitor_net:</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span><br></code></pre></td></tr></table></figure></li><li><p>启动composer</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker-compose -f docker-compose.yml up -d<br></code></pre></td></tr></table></figure><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250224150433800.png" alt="image-20250224113243071"></p><blockquote><p>关闭命令：docker-compose -f docker-compose.yml down</p></blockquote></li><li><p>访问端点<br><a href="http://localhost:9090/">http://localhost:9090</a> Prometheus server主页<br><a href="http://localhost:9090/metrics">http://localhost:9090/metrics</a> Prometheus server自身指标<br><a href="http://localhost:3000/">http://localhost:3000</a> Grafana</p></li><li><p>配置Grafana</p><blockquote><p>访问<a href="http://localhost:3000/%EF%BC%8C%E5%88%9D%E5%A7%8B%E7%99%BB%E5%BD%95%E8%B4%A6%E5%8F%B7/%E5%AF%86%E7%A0%81%EF%BC%9A">http://localhost:3000/，初始登录账号/密码：</a> admin&#x2F;admin</p></blockquote><p>创建Prometheus数据源<br>左侧菜单Connection -&gt; Data sources -&gt; Add data source<br>选择“ Prometheus”作为类型。<br>设置适当的Prometheus服务器网址（例如，<a href="http://prometheus:9090/%EF%BC%89">http://prometheus:9090/）</a><br><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250224150438814.png" alt="image-20250224105335976"><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250224150500328.png" alt="image-20250224105319683"></p></li></ul><h3 id="Springboot集成promethus"><a href="#Springboot集成promethus" class="headerlink" title="Springboot集成promethus"></a>Springboot集成promethus</h3><ul><li><p>pom.xml 添加以下dependency</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Spring Boot Actuator --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.15<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- Micrometer Prometheus Registry --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.micrometer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.14<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">management:</span><br>  <span class="hljs-comment"># 配置 Spring Boot 的管理端点（如健康检查、指标等）</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-comment"># 配置管理端点的 web 相关暴露设置</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-comment"># 设置暴露的端点，&#x27;include: *&#x27; 表示暴露所有管理端点</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br>    <br>    <span class="hljs-comment"># 配置 Spring Boot 的指标收集和导出设置</span><br>    <span class="hljs-attr">metrics:</span><br>      <span class="hljs-comment"># 配置 Prometheus 导出设置</span><br>      <span class="hljs-attr">export:</span><br>        <span class="hljs-attr">prometheus:</span><br>          <span class="hljs-comment"># 启用 Prometheus 数据导出功能，允许 Prometheus 从 Spring Boot 应用中抓取指标</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>          <br>      <span class="hljs-comment"># 设置 Spring Boot 应用的标签信息</span><br>      <span class="hljs-attr">tags:</span><br>        <span class="hljs-comment"># 为导出的 Prometheus 数据添加标签，这里使用应用程序的名称作为标签值</span><br>        <span class="hljs-attr">application:</span> <span class="hljs-string">&#x27;$&#123;spring.application.name&#125;&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>启动Springboot应用</p><p>访问<a href="http://localhost:8080/actuator/prometheus">http://localhost:8080/actuator/prometheus</a></p><p><img src="https://raw.githubusercontent.com/CasonMo/pic-go/master/img/20250224150442343.png" alt="image-20250224105134383"></p></li><li><p>自定义监控指标</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br>MeterRegistry meterRegistry;<br><br><span class="hljs-meta">@RequestMapping(value = &quot;/&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>    meterRegistry.counter(<span class="hljs-string">&quot;requests_count&quot;</span>).increment();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>监控指标+制作Grafana看板</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250224150445272.png" alt="image-20250224105241055"><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250224150448905.png" alt="image-20250224105303039"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>promethus</tag>
      
      <tag>Grafana</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Logback-异常日志企业微信机器人通知</title>
    <link href="/2025/02/11/Logback-%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%9C%BA%E5%99%A8%E4%BA%BA%E9%80%9A%E7%9F%A5/"/>
    <url>/2025/02/11/Logback-%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%9C%BA%E5%99%A8%E4%BA%BA%E9%80%9A%E7%9F%A5/</url>
    
    <content type="html"><![CDATA[<p>在生产环境中，异常日志往往涉及系统故障、接口调用失败或关键业务流程异常，必须及时被相关人员关注并处理。将异常日志实时推送到企业微信，可以确保运维团队和开发人员第一时间收到警报，避免因日志沉淀在服务器而错过关键问题。相比于传统的邮件或短信告警，企业微信具备更高的即时性，并支持群聊讨论，提高协作效率。此外，企业微信的 Webhook 机制使得日志推送简单灵活，能够根据日志级别、异常类型等条件筛选重要日志推送，减少无效告警，提高告警的精准度和响应速度。</p><blockquote><p>如果需要告警钉钉调整机器人接口即可</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WecomLogAlertAppender</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppenderBase</span>&lt;ILoggingEvent&gt; &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 抛弃策略的线程池</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">THREAD_POOL_EXECUTOR</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">60_000</span>, TimeUnit.MILLISECONDS<br>            , <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>), (Runnable r) -&gt; &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r);<br>        thread.setName(<span class="hljs-string">&quot;WeChatAppender-&quot;</span> + thread.getId());<br>        <span class="hljs-keyword">return</span> thread;<br>    &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy());<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 初始化OkHttp客户端</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()<br>            .connectionPool(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionPool</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES))<br>            .connectTimeout(<span class="hljs-number">5</span>, TimeUnit.SECONDS)<br>            .writeTimeout(<span class="hljs-number">5</span>, TimeUnit.SECONDS)<br>            .readTimeout(<span class="hljs-number">10</span>, TimeUnit.SECONDS)<br>            .retryOnConnectionFailure(<span class="hljs-literal">true</span>)<br>            .build();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Environment environment;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">webhookUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取需要推送的日志级别</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Set&lt;Level&gt; <span class="hljs-title function_">getLogLevels</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">levelConfig</span> <span class="hljs-operator">=</span> Optional.ofNullable(getEnvironment()).map(env -&gt; env.getProperty(<span class="hljs-string">&quot;whisper.log.levels&quot;</span>)).orElse(<span class="hljs-string">&quot;ERROR&quot;</span>);<br>        <span class="hljs-keyword">return</span> Arrays.stream(levelConfig.split(<span class="hljs-string">&quot;,&quot;</span>))<br>                .map(String::trim)<br>                .map(String::toUpperCase)<br>                .map(Level::toLevel)<br>                .collect(Collectors.toSet());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 双重检查锁定模式获取environment</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Environment <span class="hljs-title function_">getEnvironment</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (WecomLogAlertAppender.class) &#123;<br>                <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span>) &#123;<br>                    environment = SpringContextUtil.getBean(Environment.class);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> environment;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取企业微信机器人key</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getRobotKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (Objects.isNull(getEnvironment())) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> getEnvironment().getProperty(<span class="hljs-string">&quot;whisper.robotKey&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取是否启用播报企业微信</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getEnable</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (Objects.isNull(getEnvironment())) &#123;<br>            <span class="hljs-keyword">return</span> Boolean.FALSE;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> Boolean.parseBoolean(getEnvironment().getProperty(<span class="hljs-string">&quot;whisper.enable&quot;</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> Boolean.FALSE;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取企业微信机器人key</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getProfiles</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (Objects.isNull(getEnvironment())) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> getEnvironment().getProperty(<span class="hljs-string">&quot;spring.profiles.active&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">append</span><span class="hljs-params">(ILoggingEvent event)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!getEnable()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(getRobotKey())) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 仅发送配置的日志级别</span><br>        <span class="hljs-keyword">if</span> (!getLogLevels().contains(event.getLevel())) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        THREAD_POOL_EXECUTOR.execute(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(createMessage(event));<br>                <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(json, MediaType.get(<span class="hljs-string">&quot;application/json; charset=utf-8&quot;</span>));<br>                <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>                        .url(webhookUrl + getRobotKey())<br>                        .post(body)<br>                        .build();<br>                <span class="hljs-keyword">try</span> (<span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.newCall(request).execute()) &#123;<br>                    <span class="hljs-keyword">if</span> (!response.isSuccessful()) &#123;<br>                        addError(<span class="hljs-string">&quot;Failed to send log message to WeChat:&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(response.body().string()));<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException e) &#123;<br>                addError(<span class="hljs-string">&quot;Failed to convert log message to JSON&quot;</span>, e);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                addError(<span class="hljs-string">&quot;Failed to send log message to WeChat&quot;</span>, e);<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">createMessage</span><span class="hljs-params">(ILoggingEvent event)</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">exceptionMessage</span> <span class="hljs-operator">=</span> getExceptionMessage(event);<br><br>        <span class="hljs-comment">// 根据日志级别设置颜色</span><br>        String color;<br>        <span class="hljs-keyword">if</span> (event.getLevel() == Level.ERROR) &#123;<br>            color = <span class="hljs-string">&quot;#F24956&quot;</span>; <span class="hljs-comment">// 红色</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.getLevel() == Level.WARN) &#123;<br>            color = <span class="hljs-string">&quot;#F2AA27&quot;</span>; <span class="hljs-comment">// 黄色</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.getLevel() == Level.INFO) &#123;<br>            color = <span class="hljs-string">&quot;#000000&quot;</span>; <span class="hljs-comment">// 黑色</span><br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// DEBUG 及其他</span><br>            color = <span class="hljs-string">&quot;#A0A0A0&quot;</span>; <span class="hljs-comment">// 浅灰色</span><br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;[%s] &lt;font color=\&quot;%s\&quot;&gt;**%s**&lt;/font&gt; %s\n&gt; %s \n%s&quot;</span>,<br>                getProfiles(), color, event.getLevel(), sdf.format(event.getTimeStamp()),<br>                event.getFormattedMessage(),<br>                exceptionMessage.substring(<span class="hljs-number">0</span>, Math.min(exceptionMessage.length(), <span class="hljs-number">1000</span>)));<br><br>        Map&lt;String, Object&gt; message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        message.put(<span class="hljs-string">&quot;msgtype&quot;</span>, <span class="hljs-string">&quot;markdown&quot;</span>);<br>        Map&lt;String, String&gt; markdown = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        markdown.put(<span class="hljs-string">&quot;content&quot;</span>, content.substring(<span class="hljs-number">0</span>, Math.min(content.length(), <span class="hljs-number">4095</span>)));<br>        message.put(<span class="hljs-string">&quot;markdown&quot;</span>, markdown);<br><br>        <span class="hljs-keyword">return</span> message;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getExceptionMessage</span><span class="hljs-params">(ILoggingEvent event)</span> &#123;<br>        <span class="hljs-type">IThrowableProxy</span> <span class="hljs-variable">throwableProxy</span> <span class="hljs-operator">=</span> event.getThrowableProxy();<br>        <span class="hljs-keyword">if</span> (throwableProxy != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            sb.append(throwableProxy.getClassName()).append(<span class="hljs-string">&quot;: &quot;</span>).append(throwableProxy.getMessage()).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            <span class="hljs-keyword">for</span> (StackTraceElementProxy element : throwableProxy.getStackTraceElementProxyArray()) &#123;<br>                sb.append(element.toString()).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> sb.toString();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringContextUtil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过bean名称获取bean</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beanName bean的名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;      bean的类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 获取到的bean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String beanName, Class&lt;T&gt; beanType)</span> &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(beanName, beanType);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过bean名称获取bean</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beanName bean的名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 获取到的bean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String beanName)</span> &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(beanName);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过bean类型获取bean</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beanType bean的类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;      bean的类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 获取到的bean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; beanType)</span> &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(beanType);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> &#123;<br>        SpringContextUtil.applicationContext = applicationContext;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="编程式配置"><a href="#编程式配置" class="headerlink" title="编程式配置"></a>编程式配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogbackConfigurer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationListener</span>&lt;ContextRefreshedEvent&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ContextRefreshedEvent event)</span> &#123;<br>        <span class="hljs-type">LoggerContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (LoggerContext) LoggerFactory.getILoggerFactory();<br>        <span class="hljs-type">WecomLogAlertAppender</span> <span class="hljs-variable">wecomAppender</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WecomLogAlertAppender</span>();<br>        wecomAppender.start();<br>        <span class="hljs-type">Logger</span> <span class="hljs-variable">rootLogger</span> <span class="hljs-operator">=</span> context.getLogger(<span class="hljs-string">&quot;ROOT&quot;</span>);<br>        rootLogger.addAppender(wecomAppender);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="声明式配置"><a href="#声明式配置" class="headerlink" title="声明式配置"></a>声明式配置</h4><p>logback.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs XML"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WECOM&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.****.WecomLogAlertAppender&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;WECOM&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h4><p>application.properites</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#企业微信日志告警配置</span><br><span class="hljs-attr">whisper.robotKey</span>=<span class="hljs-number">13</span>xx18b-xxxx-<span class="hljs-number">0</span>ecaxxxee36<br><span class="hljs-attr">whisper.enable</span>=<span class="hljs-literal">true</span><br><span class="hljs-attr">whisper.log.levels</span>=WARN,ERROR<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>log</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>广告数据同步系统的限流失败重试策略</title>
    <link href="/2025/02/07/%E5%B9%BF%E5%91%8A%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E7%B3%BB%E7%BB%9F%E7%9A%84%E9%99%90%E6%B5%81%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95%E7%AD%96%E7%95%A5/"/>
    <url>/2025/02/07/%E5%B9%BF%E5%91%8A%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E7%B3%BB%E7%BB%9F%E7%9A%84%E9%99%90%E6%B5%81%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95%E7%AD%96%E7%95%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="广告数据同步系统的失败重试策略"><a href="#广告数据同步系统的失败重试策略" class="headerlink" title="广告数据同步系统的失败重试策略"></a><strong>广告数据同步系统的失败重试策略</strong></h1><p>在与外部广告 API（如 Facebook Marketing API）交互时，可能会遇到超时、限流等问题。为了保证数据同步的可靠性，我们可以采用以下方法来优化失败重试机制。</p><h2 id="1-持久化上下文"><a href="#1-持久化上下文" class="headerlink" title="1. 持久化上下文"></a><strong>1. 持久化上下文</strong></h2><p><strong>持久化任务的执行状态</strong></p><ul><li>使用数据库记录任务进度<ul><li>任务唯一标识（广告账户ID+日期&#x2F;时间+任务类型）</li><li>任务执行状态（成功 &#x2F; 进行中 &#x2F; 失败 &#x2F; 待处理 &#x2F; 待重试 &#x2F; 暂时失败）</li></ul></li><li>数据库持久化任务历史<ul><li>适用于长期存储，可用于任务回溯和统计分析</li></ul></li><li>清理机制<ul><li>定期清除旧的或已完成的任务记录，避免历史数据占用过多存储空间</li></ul></li></ul><p>为了提高数据同步效率，避免因同步任务粒度过大导致的性能瓶颈，我们将每个同步任务拆解至账户+日期+任务类型维度。每个任务只关注单一账户的数据，减少层级依赖，简化任务调度和失败处理的复杂度。这样即使某个账户的任务失败，也不会影响其他账户的任务，从而提高了系统的并发能力和容错能力。</p><p>此外，通过这种方式，可以快速定位失败的账户，并在失败时通过任务状态标记，将失败的账户快速捞出来进行重试，避免因任务失败导致整个数据同步流程中断，从而减少了重复请求，提升了效率。</p><h2 id="2-消息队列"><a href="#2-消息队列" class="headerlink" title="2. 消息队列"></a><strong>2. 消息队列</strong></h2><p>使用消息队列实现异步任务处理，确保失败任务能够自动重试。</p><ul><li><strong>延迟队列</strong>：<ul><li>当 API 超时或被限流时，将失败任务放入延迟队列，稍后自动重试</li><li>适用于短期失败（例如 API 速率限制）</li></ul></li><li><strong>死信队列（DLQ）</strong>：<ul><li>任务多次重试仍然失败时，进入死信队列，人工或异步修正后再处理</li><li>避免失败任务无限重试影响系统健康</li></ul></li></ul><h2 id="3-指数退避重试"><a href="#3-指数退避重试" class="headerlink" title="3. 指数退避重试"></a><strong>3. 指数退避重试</strong></h2><p>避免对 API 进行无效的高频请求，导致进一步的限流。</p><ul><li><strong>重试时间呈指数增长（如 1s -&gt; 2s -&gt; 4s -&gt; 8s）</strong></li><li><strong>设定最大重试次数，避免无限循环</strong></li><li><strong>结合随机抖动，防止多个请求同时重试导致雪崩效应</strong></li></ul><h2 id="4-分页-并发优化"><a href="#4-分页-并发优化" class="headerlink" title="4. 分页 + 并发优化"></a><strong>4. 分页 + 并发优化</strong></h2><p>API 查询时，合理设计分页策略，减少单次请求的超时风险，并提高吞吐量。</p><ul><li><strong>分页获取数据</strong>：<ul><li>限制每次请求的数据量，减少超时风险</li><li>API 可能提供 <code>limit</code> 和 <code>offset</code> 参数来分页</li></ul></li><li><strong>并发请求优化</strong>：<ul><li>控制同时执行的任务数量，避免 API 负载过高</li><li>根据 API 速率限制动态调整并发度</li></ul></li></ul><h2 id="5-分散任务执行时间"><a href="#5-分散任务执行时间" class="headerlink" title="5. 分散任务执行时间"></a><strong>5. 分散任务执行时间</strong></h2><p>为了避免多任务集中请求导致 API 限流，可以将任务执行的时间进行分散处理。</p><ul><li>定时任务拆分<ul><li>将任务划分为多个时间点执行，避免所有任务在同一时间同时执行</li><li>根据任务的数量与优先级，合理分配执行时间，降低API接口瞬时压力</li></ul></li><li>时间错峰<ul><li>利用时间窗口来平衡任务的执行量，避免短时间内的请求洪峰</li></ul></li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>为了优化广告数据同步系统的失败重试机制，我们可以采用： </p><p>✅ <strong>持久化上下文</strong> 记录任务进度，避免重复拉取<br>✅ <strong>消息队列</strong> 进行异步重试，避免阻塞<br>✅ <strong>指数退避</strong> 避免高频失败<br>✅ <strong>分页 + 并发优化</strong> 提高 API 调用效率<br>✅ <strong>分散任务执行时间</strong> 防止流量峰值，降低 API 限流风险</p><p>这种优化方案能够有效提高数据同步的稳定性，提升系统的吞吐量，同时降低失败重试带来的额外开销，使广告数据同步更加高效可靠。</p>]]></content>
    
    
    <categories>
      
      <category>广告</category>
      
    </categories>
    
    
    <tags>
      
      <tag>广告</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>巨量星图-点击监测和数据回传</title>
    <link href="/2025/02/07/%E5%B7%A8%E9%87%8F%E6%98%9F%E5%9B%BE-%E7%82%B9%E5%87%BB%E7%9B%91%E6%B5%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E5%9B%9E%E4%BC%A0/"/>
    <url>/2025/02/07/%E5%B7%A8%E9%87%8F%E6%98%9F%E5%9B%BE-%E7%82%B9%E5%87%BB%E7%9B%91%E6%B5%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E5%9B%9E%E4%BC%A0/</url>
    
    <content type="html"><![CDATA[<p>巨量星图后台：<a href="https://www.xingtu.cn/ad/creator/index">https://www.xingtu.cn/ad/creator/index</a></p><p>星图监测联调工具使用说明:<a href="https://www.xingtu.cn/help-center/demander/121314">https://www.xingtu.cn/help-center/demander/121314</a></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250207110837781.png" alt="image-20250207110834573"></p><h4 id="点击监测"><a href="#点击监测" class="headerlink" title="点击监测"></a>点击监测</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250207113044484.png" alt="diagram-6457048858840653735"></p><ul><li><p>指派类、投稿和招募非转化&#x2F;付费分佣类任务 点击监测链接举例</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">https://域名/路径?os=<span class="hljs-emphasis">__OS__</span>&amp;TIMESTAMP=<span class="hljs-emphasis">__TS__</span>&amp;model=<span class="hljs-emphasis">__MODEL__</span>&amp;ua=<span class="hljs-emphasis">__UA__</span>&amp;ip=<span class="hljs-emphasis">__IP__</span>&amp;callback=<span class="hljs-emphasis">__CALLBACK_PARAM__</span>&amp;callbackUrl=<span class="hljs-emphasis">__CALLBACK_URL__</span>&amp;itemId=<span class="hljs-emphasis">__ITEM_ID__</span>&amp;demandId=<span class="hljs-emphasis">__DEMAND_ID__</span>&amp;awemeAuthorId=<span class="hljs-emphasis">__AWEME_AUTHOR_ID__</span><br></code></pre></td></tr></table></figure><blockquote><p> 更多具体宏参数参考：<a href="https://www.xingtu.cn/help-center/demander/109173">https://www.xingtu.cn/help-center/demander/109173</a></p></blockquote></li><li><p>投稿和招募按转化、付费分佣结算任务 点击监测链接举例</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">https://域名/路径?os=<span class="hljs-emphasis">__OS__</span>&amp;TIMESTAMP=<span class="hljs-emphasis">__TS__</span>&amp;model=<span class="hljs-emphasis">__MODEL__</span>&amp;ua=<span class="hljs-emphasis">__UA__</span>&amp;ip=<span class="hljs-emphasis">__IP__</span>&amp;callback=<span class="hljs-emphasis">__CALLBACK_PARAM__</span>&amp;callbackUrl=<span class="hljs-emphasis">__CALLBACK_URL__</span>&amp;itemId=<span class="hljs-emphasis">__ITEM_ID__</span>&amp;demandId=<span class="hljs-emphasis">__DEMAND_ID__</span><br></code></pre></td></tr></table></figure><blockquote><p> 更多具体宏参数参考：<a href="https://www.xingtu.cn/help-center/demander/109134">https://www.xingtu.cn/help-center/demander/109134</a></p></blockquote></li></ul><h4 id="数据回传"><a href="#数据回传" class="headerlink" title="数据回传"></a>数据回传</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250207113031308.png" alt="diagram-10853842925606986107"></p><ul><li><p>手机号码加密代码</p><blockquote><p>加密算法文档地址：<a href="https://bytedance.larkoffice.com/docx/YNEGdIF6IoKupfxP9CBcYOSInse">https://bytedance.larkoffice.com/docx/YNEGdIF6IoKupfxP9CBcYOSInse</a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String str)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">publicKeyAsString</span> <span class="hljs-operator">=</span><br>            <span class="hljs-string">&quot;-----BEGIN PUBLIC KEY-----\n&quot;</span> +<br>                    <span class="hljs-string">&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCmnVrcCkHV8b+2BaMSC95DY0z9\n&quot;</span> +<br>                    <span class="hljs-string">&quot;9B7MgFoHMxXaZn0k6fvUXJTgxXtYleGFdoifHSVsrJIB0P1V4hazTIyDLnHGFOCp\n&quot;</span> +<br>                    <span class="hljs-string">&quot;UnYkLE2L8M/l0msAiKmShlxQAPB9IBNLOLFcp3qubLjfGGB1xfsDXHY9dAxYY8XC\n&quot;</span> +<br>                    <span class="hljs-string">&quot;edrYgXwkA0i3/dL+UQIDAQAB\n&quot;</span> +<br>                    <span class="hljs-string">&quot;-----END PUBLIC KEY-----&quot;</span>;<br>  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">publicKeyPem</span> <span class="hljs-operator">=</span> publicKeyAsString<br>            .replace(<span class="hljs-string">&quot;-----BEGIN PUBLIC KEY-----&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>            .replaceAll(<span class="hljs-string">&quot;\\n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>            .replace(<span class="hljs-string">&quot;-----END PUBLIC KEY-----&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>  <br>    <span class="hljs-type">byte</span>[] keyContentAsBytes = Base64.getDecoder().decode(publicKeyPem);<br>    <span class="hljs-type">KeyFactory</span> <span class="hljs-variable">fact</span> <span class="hljs-operator">=</span> KeyFactory.getInstance(<span class="hljs-string">&quot;RSA&quot;</span>);<br>    <span class="hljs-type">X509EncodedKeySpec</span> <span class="hljs-variable">pubKeySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">X509EncodedKeySpec</span>(keyContentAsBytes);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">publicKey</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(fact.generatePublic(pubKeySpec).getEncoded());<br>    <span class="hljs-type">byte</span>[] decoded = Base64.getDecoder().decode(publicKey);<br>    <span class="hljs-type">RSAPublicKey</span> <span class="hljs-variable">pubKey</span> <span class="hljs-operator">=</span> (RSAPublicKey) KeyFactory.getInstance(<span class="hljs-string">&quot;RSA&quot;</span>).generatePublic(<span class="hljs-keyword">new</span> <span class="hljs-title class_">X509EncodedKeySpec</span>(decoded));<br>    <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(<span class="hljs-string">&quot;RSA&quot;</span>);<br>    cipher.init(Cipher.ENCRYPT_MODE, pubKey);<br>    <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(cipher.doFinal(str.getBytes(StandardCharsets.UTF_8)));<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>表单提交回调</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ad.oceanengine.com<span class="hljs-regexp">/track/</span>activate/?callback=&lt;clickId&gt;&amp;event_type=<span class="hljs-number">3</span>&amp;phone_num=&lt;加密后的手机号码&gt;<br></code></pre></td></tr></table></figure></li><li><p>付费回调</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ad.oceanengine.com<span class="hljs-regexp">/track/</span>activate/?callback=&lt;clickid&gt;&amp;event_type=<span class="hljs-number">2</span>&amp;props=&#123;<span class="hljs-string">&quot;pay_amount&quot;</span>:<span class="hljs-string">&quot;1000&quot;</span>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250207113055996.png" alt="image-20250207110815245"></p><h4 id="点击监测和数据回传配置"><a href="#点击监测和数据回传配置" class="headerlink" title="点击监测和数据回传配置"></a>点击监测和数据回传配置</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/20250207113058164.png" alt="image-20250207111330839"></p>]]></content>
    
    
    <categories>
      
      <category>广告</category>
      
    </categories>
    
    
    <tags>
      
      <tag>广告</tag>
      
      <tag>巨量星图</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>可靠分布式系统-paxos的直观解释</title>
    <link href="/2024/11/12/%E5%8F%AF%E9%9D%A0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F-paxos%E7%9A%84%E7%9B%B4%E8%A7%82%E8%A7%A3%E9%87%8A/"/>
    <url>/2024/11/12/%E5%8F%AF%E9%9D%A0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F-paxos%E7%9A%84%E7%9B%B4%E8%A7%82%E8%A7%A3%E9%87%8A/</url>
    
    <content type="html"><![CDATA[<blockquote><p>转载自<a href="https://zhuanlan.zhihu.com/p/145044486">https://zhuanlan.zhihu.com/p/145044486</a></p></blockquote><p>update 2020-11-26: 本文讲的算法, 好多同学问起实现细节的问题, 基本可以在下面这篇找到想要的答案:</p><p><a href="https://zhuanlan.zhihu.com/p/275710507">drdr xp：200行代码实现基于paxos的kv存储262 赞同 · 37 评论文章<img src="https://pic4.zhimg.com/v2-77d183bb5e17f35687d077506a020529_180x120.jpg" alt="img"></a></p><p>之前在每个呆过的公司都做过至少1次paxos的培训(在别人家公司也做过几次), paxos其实挺好理解, 但是术语造成了障碍. 如果直接从问题出发, 先提出准确的问题, 再通过例子来回答问题, 比从概念来解释更容易被人接受. 就按这个套路来:</p><p>&gt;&gt;&gt; 例子贼多图贼多.</p><p>原文链接: <a href="https://link.zhihu.com/?target=https://blog.openacid.com/algo/paxos/">https://blog.openacid.com/algo/paxos/</a></p><p><img src="https://pica.zhimg.com/v2-8e4de0756f52a90e02b5f5067612ca04_b.jpg" alt="img"></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><strong>前言</strong></h2><p><strong>paxos是什么</strong>?</p><ul><li>在分布式系统中保证多副本数据强一致的算法.</li></ul><p><strong>paxos有啥用</strong>?</p><ul><li>没有paxos的一堆机器, 叫做分布式;</li><li>有paxos协同的一堆机器, 叫分布式系统.</li></ul><p>Google Chubby的作者Mike Burrows说过:</p><blockquote><p><em>这个世界上只有一种一致性算法，那就是Paxos …</em></p></blockquote><p>其他一致性算法, 都可以看做paxos在实现中的变体和扩展.</p><p>另外一个经常被提及的<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=%E5%88%86%E5%B8%83%E5%BC%8F%E7%AE%97%E6%B3%95&zhida_source=entity">分布式算法</a>是<a href="https://link.zhihu.com/?target=https://raft.github.io/">raft</a>, raft的贡献在于把一致性算法落地. 因为 <a href="https://link.zhihu.com/?target=http://www.lamport.org/">Leslie Lamport</a> 的理论很抽象, 要想把他的理论应用到现实中, 还需要工程师完全掌握他的理论再添加工程必要的环节才能跑起来.</p><p>经常有人问起raft和paxos的区别, 或在实现中应该选择哪个, 在不了解paxos之前可能会有这种疑问. 对于这个问题, 就像是被问及<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=%E5%9B%9B%E5%88%99%E8%BF%90%E7%AE%97&zhida_source=entity">四则运算</a>和算盘有什么区别, 小店老板应该使用四则远算还是用算盘结账一样.</p><p>记得 Leslie Lamport 2015年时来了一次北京, 那时会场上有人也问了老爷子 paxos和raft有啥区别.</p><p>老爷子当时给出的回答是: 没听过raft…</p><p><img src="https://picx.zhimg.com/v2-83540d3b7c424ff4a38b645601ba24a3_b.jpg" alt="img"></p><p>raft的核心可以认为是multi paxos的一个应用, 对于要掌握一致性算法的核心内容, 从paxos入手, 更容易去掉无关干扰, 直达问题本质. 所以我们选择paxos作为了解一致性算法的入口, 聊开了聊透了.</p><p>网络上raft比paxos流行, 因为raft的描述更直白一些, 实际上raft比paxos更复杂. raft详细的解释了”HOW”, 缺少”WHY”的解释. paxos从根本上解释清楚了”WHY”, 但一直缺少一份通俗易懂的教程. 以至于没有被更广泛的接受. 所以就有了本文, 一篇paxos入门教程, 从基本的分布式中的复制的问题出发, 通过逐步解决和完善这几个问题, 最后推导出paxos的算法.</p><p>分2个部分:</p><ul><li>前1部分是分布式一致性问题的讨论和解决方案的逐步完善, 用人话得出<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=paxos%E7%AE%97%E6%B3%95&zhida_source=entity">paxos算法</a>的过程. 如果只希望理解paxos而不打算花太多时间深入细节, 只阅读这1部分就可以啦.</li><li>第2部分是paxos算法和协议的严格描述. 这部分可以作为paxos原paper的实现部分的概括. 如果你打算实现自己的paxos或类似协议, 需要仔细了解协议细节, 希望这部分内容可以帮你节省阅读原paper的时间.</li></ul><p><strong>分布式系统要解决的问题</strong></p><p><strong>slide-00</strong></p><p><a href="http://weixin.qq.com/r/RHRYQNjEiYX2rZwj9yFW">http://weixin.qq.com/r/RHRYQNjEiYX2rZwj9yFW</a> (二维码自动识别)</p><p><strong>slide-01</strong> paxos的工作, 就是把一堆运行的机器协同起来, 让多个机器成为一个整体系统. 在这个系统中, 每个机器都必须让系统中的状态达成一致, 例如三副本集群如果一个机器上上传了一张图片, 那么另外2台机器上也必须复制这张图片过来, 整个系统才处于一个<strong>一致</strong>的状态.</p><p><img src="https://pic3.zhimg.com/v2-d2ccbe5e87f31aea1313158da16cc5d2_b.jpg" alt="img"></p><p><strong>slide-02</strong> 我是无需解释的目录页.</p><p><img src="https://pic4.zhimg.com/v2-581488ab432677491b28036393beb8e1_b.jpg" alt="img"></p><p><strong>slide-03</strong> 分布式系统的一致性问题最终都归结为<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8&zhida_source=entity">分布式存储</a>的一致性. 像aws的<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8&zhida_source=entity">对象存储</a>可靠性要求是9~13个9. 而这么高的可靠性都是建立在可靠性没那么高的硬件上的.</p><p><img src="https://pica.zhimg.com/v2-3ce5a5a0603796e979ac66eed469dd50_b.jpg" alt="img"></p><p><strong>slide-04</strong> 几乎所有的分布式存储(甚至单机系统, 参考<a href="https://link.zhihu.com/?target=https://blog.openacid.com/storage/ec-1">EC第一篇:原理</a>, <a href="https://link.zhihu.com/?target=https://blog.openacid.com/storage/ec-2">EC第二篇:实现</a>, <a href="https://link.zhihu.com/?target=https://blog.openacid.com/storage/ec-3">EC第三篇:极限</a>) 都必须用某种冗余的方式在廉价硬件的基础上搭建高可靠的存储. 而冗余的基础就是多副本策略, 一份数据存多份. 多副本保证了可靠性, 而副本之间的一致, 就需要paxos这类分布式一致性算法来保证.</p><p><img src="https://picx.zhimg.com/v2-066242ba40a4354cacaae7af2517dcf9_b.jpg" alt="img"></p><p><strong>slide-05</strong> 在早些年各种各样的复制策略都被提出来来解决各种场景下的需要. 除了复制的份数之外, 各种各样的算法实际上都是在尝试解决一致的问题. 从下一页开始简单回顾下各种复制策略, 看看他们的优缺点以及paxos如何解决副本之间一致性的问题.</p><p><img src="https://pic3.zhimg.com/v2-cdb2f48ff9170be2a7d86e3d1e42a90e_b.jpg" alt="img"></p><h2 id="不太完美的复制策略"><a href="#不太完美的复制策略" class="headerlink" title="不太完美的复制策略"></a><strong>不太完美的复制策略</strong></h2><p><strong>slide-06</strong> 无需解释的目录页</p><p><img src="https://pic3.zhimg.com/v2-27642fe3ef8046742db4e647f8a3f3d4_b.jpg" alt="img"></p><p><strong>slide-07</strong> <strong>主从异步复制</strong>是最简单的策略之一, 它很容易实现, 但存在一个问题: 客户端收到一个<strong>数据已经安全</strong>(OK)的信息, 跟<strong>数据真正安全</strong>(数据复制到全部的机器上)在时间上有一个空隙, 这段时间负责接收客户端请求的那个机器(master)如果被闪电击中或被陨石砸到或被打扫卫生的大姐踢断了电源, 那数据就可能会丢失. 因此它不是一个可靠的复制策略(使用主从异步复制要求你必须相信宇宙中不存在闪电陨石和扫地大姐).</p><p><img src="https://pic1.zhimg.com/v2-a1b980dcb9483fec1b5f51b21f033c84_b.jpg" alt="img"></p><p><strong>slide-08</strong> 跟主从异步复制相比, <strong><a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5&zhida_source=entity">主从同步</a>复制</strong>提供了完整的可靠性: 直到数据真的安全的复制到全部的机器上之后, master才告知客户端<strong>数据已经安全</strong>.</p><p>但主从<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=2&q=%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6&zhida_source=entity">同步复制</a>有个致命的缺点就是整个系统中有任何一个机器宕机, 写入就进行不下去了. 相当于系统的可用性随着副本数量指数降低.</p><p><img src="https://pica.zhimg.com/v2-66dc3da46d671bf644a53af9a560dc30_b.jpg" alt="img"></p><p><strong>slide-09</strong> 然鹅, 在同步和异步之间, 做一个折中, 看起来是一个不错的方案. 这就是**<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6&zhida_source=entity">半同步复制</a><strong>. 它要求master在应答客户端之前必须把数据复制到</strong>足够多**的机器上, 但不需要是全部. <strong>这样副本数够多可以提供比较高的可靠性; 1台机器宕机也不会让整个系统停止写入</strong>.</p><p>但是它还是不完美, 例如数据a复制到slave-1, 但没有到达slave-2; 数据b复制达到了slave-2但没有到达slave-1, 这时如果master挂掉了需要从某个slave恢复出数据, 任何一个slave都不能提供完整的数据. 所以在整个系统中, 数据存在某种<strong>不一致</strong>.</p><p><img src="https://picx.zhimg.com/v2-8097f9f12b3878bc66efc4d026927adf_b.jpg" alt="img"></p><p><strong>slide-10</strong> 为了解决半同步复制<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=%E4%B8%AD%E6%95%B0%E6%8D%AE&zhida_source=entity">中数据</a>不一致的问题, 可以将这个复制策略再做一改进: <strong>多数派读写</strong>: 每条数据必须写入到<strong>半数以上</strong>的机器上. 每次读取数据都必须检查<strong>半数以上</strong>的机器上是否有这条数据.</p><p>在这种策略下, 数据可靠性足够, 宕机容忍足够, 任一机器故障也能读到全部数据.</p><p><img src="https://picx.zhimg.com/v2-381d667a3039b1d5eb6b440b2a327737_b.jpg" alt="img"></p><p><strong>slide-11</strong> 然鹅多数派读写的策略也有个<strong>但是</strong>, 就是对于一条数据的更新时, 会产生不一致的状态. 例如:</p><ul><li>node-1, node-2都写入了a&#x3D;x,</li><li>下一次更新时node-2, node-3写入了a&#x3D;y.</li></ul><p>这时, 一个要进行读取a的客户端如果联系到了node-1和node-2, 它将看到2条<strong>不同</strong>的数据.</p><p>为了不产生歧义, 多数派读写还必须给每笔写入增加一个<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=%E5%85%A8%E5%B1%80%E9%80%92%E5%A2%9E&zhida_source=entity">全局递增</a>的<strong>时间戳</strong>. 更大时间戳的记录如果被看见, 就应该忽略小时间戳的记录. 这样在读取过程中, 客户端就会看到a&#x3D;x₁, a&#x3D;y₂ 这2条数据, 通过比较时间戳1和2, 发现y是更新的数据, 所以忽略a&#x3D;x₁. 这样保证多次更新一条数据不产生歧义.</p><p><img src="https://pica.zhimg.com/v2-7b7c7b515e2e18c79c930c83b1a58084_b.jpg" alt="img"></p><p><strong>slide-12</strong> 是的, <strong>但是</strong>又来了. 这种带时间戳的<strong>多数派读写</strong>依然有问题. 就是在客户端没有完成一次完整的多数派写的时候: 例如, 上面的例子中写入, a&#x3D;x₁写入了node-1和node-2, a&#x3D;y₂时只有node-3 写成功了, 然后客户端进程就挂掉了, 留下系统中的状态如下:</p><p><img src="https://pic2.zhimg.com/v2-cee8e660ba022a04d4a5b22f2dfa73e9_b.jpg" alt="img"></p><p>这时另一个读取的客户端来了,</p><ul><li>如果它联系到node-1和node-2, 那它得到的结果是a&#x3D;x₁.</li><li>如果它联系到node-2和node-3, 那它得到的结果是a&#x3D;y₂.</li></ul><p>整个系统对外部提供的信息仍然是不一致的.</p><p><img src="https://pica.zhimg.com/v2-8a1d86f4235015a6b31c873406396d18_b.jpg" alt="img"></p><p><strong>slide-13</strong> 现在我们已经非常接近最终奥义了, paxos可以认为是多数派读写的进一步升级, paxos中通过2次原本并不严谨的多数派读写, 实现了严谨的强一致consensus算法.</p><p><img src="https://pic2.zhimg.com/v2-30c367a001de3ffd18a4d044a7e183eb_b.jpg" alt="img"></p><h2 id="从多数派读写到paxos的推导"><a href="#从多数派读写到paxos的推导" class="headerlink" title="从多数派读写到paxos的推导"></a><strong>从多数派读写到paxos的推导</strong></h2><p><strong>slide-14</strong> 首先为了清晰的呈现出分布式系统中的核心问题: 一致性问题, 我们先设定一个假象的存储系统, 在这个系统上, 我们来逐步实现一个强一致的存储, 就得到了paxos对一致性问题的解决方法.</p><p><img src="https://picx.zhimg.com/v2-8eb822a33c46b6f224daa4b21134e977_b.jpg" alt="img"></p><p><strong>slide-15</strong> 在实现中, set命令直接实现为一个多数派写, 这一步非常简单. 而inc操作逻辑上也很简单, 读取一个变量的值i₁, 给它加上一个数字得到i₂, 再通过多数派把i₂写回到系统中.</p><p><img src="https://pic4.zhimg.com/v2-54bce7e711819a8b1a7fed0943016e51_b.jpg" alt="img"></p><p><strong>slide-16</strong> 冰雪如你一定已经看到了这种实现方式中的问题: 如果有2个并发的客户端进程同时做这个inc的操作, 在多数派读写的实现中, 必然会产生一个Y客户端覆盖X客户端的问题. 从而产生了数据更新点的丢失.</p><p>而paxos就是为了解决这类问题提出的, 它需要让Y能检测到这种并发冲突, 进而采取措施避免更新丢失.</p><p><img src="https://pic3.zhimg.com/v2-d5106d56d5af104f614899626545768c_b.jpg" alt="img"></p><p><strong>slide-17</strong> 提取一下上面提到的问题: 让Y去更新的时候不能直接更新i₂, 而是应该能检测到i₂的存在, 进而将自己的结果保存在下一个版本i₃中, 再写回系统中.</p><p>而这个问题可以转化成: i的每个版本只能被写入一次, 不允许修改. 如果系统设计能满足这个要求, 那么X和Y的inc操作就都可以正确被执行了.</p><p><img src="https://pic1.zhimg.com/v2-521503c70b2f65dea7deecfcfbf37866_b.jpg" alt="img"></p><p><strong>slide-18</strong> 于是我们的问题就转化成一个更简单, 更基础的问题: 如何确定一个值(例如iⱼ)已经被写入了.</p><p>直观来看, 解决方法也很简单, 在X或Y写之前先做一次<strong>多数派读</strong>, 以便确认是否有其他客户端进程已经在写了, 如果有, 则放弃.</p><p><img src="https://pica.zhimg.com/v2-c55a998e4c767edcf45bab38fe3ba6d0_b.jpg" alt="img"></p><p><strong>slide-19</strong> <strong>但是</strong>!!!, 这里还有个并发问题, X和Y可能同时做这个<strong>写前读取</strong>的操作, 并且同时得出一个结论: 还没有其他进程在写入, 我可以写. 这样还是会造成更新丢失的问题.</p><p><img src="https://pic3.zhimg.com/v2-429652b0634cde717b49fee6445d491e_b.jpg" alt="img"></p><p><strong>slide-20</strong> 为了解决上面的问题, 存储节点还需要增加一个功能, 就是它必须记住谁最后一个做过<strong>写前读取</strong>的操作. 并且只允许最后一个完成<strong>写前读取</strong>的进程可以进行后续写入, 同时拒绝之前做过<strong>写前读取</strong>的进程写入的权限.</p><p>可以看到, 如果每个节点都记得谁<strong>读</strong>过, 那么当Y最后完成了<strong>写前读取</strong>的操作后, 整个系统就可以阻止过期的X的写入.</p><p>这个方法之所以能工作也是因为多数派写中, 一个系统最多只能允许一个多数派写成功. paxos也是通过2次多数派读写来实现的强一致.</p><p><img src="https://pic4.zhimg.com/v2-6fea346168c259f84df8a5668d9f40a1_b.jpg" alt="img"></p><p><strong>slide-21</strong> 以上就是paxos算法的全部核心思想了, 是不是很简单? 剩下的就是如何实现的简单问题了: 如何标识一个客户端如X和Y, 如何确认谁是最后一个完成<strong>写前读写</strong>的进程, 等等.</p><p><img src="https://pic2.zhimg.com/v2-70aca3ffb1490ed42fe777189ee53cdd_b.jpg" alt="img"></p><p><strong>slide-22</strong> <a href="https://link.zhihu.com/?target=http://www.lamport.org/">Leslie Lamport</a> 就这么把这么简单的一个算法写了个paper就获得了图领奖! 骚年, 改变世界就这么容易!</p><p><img src="https://pic1.zhimg.com/v2-af4e5a8ff8494f8796c0b7d9cb1109b6_b.jpg" alt="img"></p><h2 id="paxos算法描述"><a href="#paxos算法描述" class="headerlink" title="paxos算法描述"></a><strong>paxos算法描述</strong></h2><p>接下来的篇幅中我们将用计算机的语言准确的描述整个paxos运行的过程.</p><p><strong>slide-23</strong> 首先明确要解决的问题:</p><p><img src="https://pic1.zhimg.com/v2-00ae7aed7ebafcb87b55e509aba4eb16_b.jpg" alt="img"></p><p><strong>slide-24</strong> 我们要介绍的paxos实际上是最朴实的classic paxos, 在这之后我们顺提下几个老爷子对paxos的优化, multi paxso和fast paxos, 它们都是针对paxos的理论层面的优化.</p><p><img src="https://pic1.zhimg.com/v2-d8f7323a28d68b29e588e9c43aff0798_b.jpg" alt="img"></p><p><strong>slide-25</strong> paxos算法中解决了如何在不可靠硬件基础上构建一个可靠的分布式系统的方法. 但paxos核心算法中只解决网络延迟&#x2F;乱序的问题, 它不试图解决存储不可靠和消息错误的问题, 因为这两类问题本质上跟分布式关系不大, 属于数据校验层面的事情.</p><p>有兴趣可以参考 <a href="https://link.zhihu.com/?target=https://en.wikipedia.org/wiki/Paxos_(computer_science)%23Byzantine_Paxos">Byzantine Paxos</a> 的介绍.</p><p><img src="https://pic4.zhimg.com/v2-d307d23c82638fdbccf1df4ef748b575_b.jpg" alt="img"></p><p><strong>slide-26</strong> 本文尽量按照 <a href="https://link.zhihu.com/?target=http://lamport.azurewebsites.net/pubs/pubs.html%23paxos-simple">Classic Paxos</a> 的术语来描述,</p><blockquote><p><em>老爷子后面的一篇</em> <em><a href="https://link.zhihu.com/?target=http://lamport.azurewebsites.net/pubs/pubs.html%23fast-paxos">Fast Paxos</a></em> <em>实现了fast-paxos, 同时包含了classic-paxos, 但使用了一些不同的术语表示.</em></p></blockquote><ul><li>Proposer 可以理解为客户端.</li><li>Acceptor 可以理解为<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=2&q=%E5%AD%98%E5%82%A8%E8%8A%82%E7%82%B9&zhida_source=entity">存储节点</a>.</li><li>Quorum 在99%的场景里都是指多数派, 也就是半数以上的Acceptor.</li><li>Round 用来标识一次paxos算法实例, 每个round是2次多数派读写: 算法描述里分别用phase-1和phase-2标识. 同时为了简单和明确, 算法中也规定了每个Proposer都必须生成全局单调递增的round, 这样round既能用来区分先后也能用来区分不同的Proposer(客户端).</li></ul><p><img src="https://picx.zhimg.com/v2-0fb6fda91f543b6760c5329e82e7ad95_b.jpg" alt="img"></p><p><strong>slide-27</strong> 在存储端(Acceptor)也有几个概念:</p><ul><li>last_rnd 是Acceptor记住的最后一次进行<strong>写前读取</strong>的Proposer(客户端)是谁, 以此来决定谁可以在后面真正把一个值写到存储中.</li><li>v 是最后被写入的值.</li><li>vrnd 跟v是一对, 它记录了在哪个Round中v被写入了.</li></ul><p>v和vrnd是用于恢复一次未完成的paxos用的. 一次未完成的paxos算法运行可能留下一些没有达到多数派的值的写入(就像原生的多数派写的脏读的问题), paxos中通过vrnd来决定哪些值是最后写入的, 并决定恢复哪个未完成的paxos运行. 后面我们会通过几个例子来描述vrnd的作用.</p><p><img src="https://pic2.zhimg.com/v2-288515af9b4118e774bab93cb74f2857_b.jpg" alt="img"></p><p><strong>slide-28</strong> 首先是paxos的phase-1, 它相当于之前提到的写前读取过程. 它用来在存储节点(Acceptor)上记录一个标识: 我后面要写入; 并从Acceptor上读出是否有之前未完成的paxos运行. 如果有则尝试恢复它; 如果没有则继续做自己想做的事情.</p><p>我们用类似yaml的格式来描述phase-1的请求&#x2F;应答的格式:</p><p><img src="https://pic1.zhimg.com/v2-8825fd94059fc33b8bdc272f283b23ec_b.jpg" alt="img"></p><p>phase-1成后, acceptor应该记录X的rnd&#x3D;1, 并返回自己之前保存的v和vrnd.</p><p><img src="https://pic4.zhimg.com/v2-5148b510c03ba42e1221001b2dec4e99_b.jpg" alt="img"></p><p><strong>slide-29</strong> Proposer X收到多数(quorum)个应答, 就认为是可以继续运行的.如果没有联系到多于半数的<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=2&q=acceptor&zhida_source=entity">acceptor</a>, 整个系统就hang住了, 这也是paxos声称的只能运行少于半数的节点失效.</p><p>这时Proposer面临2种情况:</p><ul><li>所有应答中都没有任何非空的v, 这表示系统之前是干净的, 没有任何值已经被其他paxos客户端完成了写入(因为一个多数派读一定会看到一个多数派写的结果). 这时Proposer X继续将它要写的值在phase-2中真正写入到多于半数的Acceptor中.</li><li>如果收到了某个应答包含被写入的v和vrnd, 这时, Proposer X 必须假设有其他客户端(Proposer) 正在运行, 虽然X不知道对方是否已经成功结束, 但任何已经写入的值都不能被修改!, 所以X必须保持原有的值. 于是X将看到的最大vrnd对应的v作为X的phase-2将要写入的值. 这时实际上可以认为X执行了一次(不知是否已经中断的)其他客户端(Proposer)的修复.</li></ul><p><img src="https://pica.zhimg.com/v2-57fb1a930d3c41c3725137a669dd7a40_b.jpg" alt="img"></p><p><strong>slide-30</strong> 在第2阶段phase-2, Proposer X将它选定的值写入到Acceptor中, 这个值可能是它自己要写入的值, 或者是它从某个Acceptor上读到的v(修复).</p><p>同样用类似yaml的方式描述请求应答:</p><p><img src="https://pic2.zhimg.com/v2-615293fece633418ce61ea9f1adb1985_b.jpg" alt="img"></p><p><img src="https://pic2.zhimg.com/v2-33233d9740cad6ca291711123592d69d_b.jpg" alt="img"></p><p><strong>slide-31</strong> 当然这时(在X收到phase-1应答, 到发送phase-2请求的这段时间), 可能已经有其他Proposer又完成了一个rnd更大的phase-1, 所以这时X不一定能成功运行完phase-2.</p><p>Acceptor通过比较phase-2请求中的rnd, 和自己本地记录的rnd, 来确定X是否还有权写入. 如果请求中的<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=13&q=rnd&zhida_source=entity">rnd</a>和Acceptor本地记录的rnd一样, 那么这次写入就是被允许的, Acceptor将v写入本地, 并将phase-2请求中的rnd记录到本地的vrnd中.</p><p><img src="https://pic3.zhimg.com/v2-c050e21d9d3f12bb24150f8f19d102c8_b.jpg" alt="img"></p><h2 id="用例子看paxos运行"><a href="#用例子看paxos运行" class="headerlink" title="用例子看paxos运行"></a><strong>用例子看paxos运行</strong></h2><p>好了paxos的算法描述也介绍完了. 这些抽象的算法描述, 其中的规则覆盖了实际所有可能遇到的情况的处理方式. 一次不太容易看清楚它们的作用, 所以我们接下来通过几个例子来看看paxos如何处理各种不同状态并最终使整个系统的状态达成一致.</p><p><strong>slide-32</strong> 没冲突的例子不解释了</p><p><img src="https://pica.zhimg.com/v2-0a3a5e25cf6963617c306d02d07e506c_b.jpg" alt="img"></p><p><strong>slide-33</strong> X和Y同时运行paxos, Y迫使X中断的例子:</p><ul><li>X成功完成了写前读取(phase-1), 将rnd&#x3D;1写入到左边2个Acceptor.</li><li>Y用更大的rnd&#x3D;2, 覆盖了X的rnd, 将rnd&#x3D;2写入到右边2个Acceptor.</li><li>X以为自己还能运行phase-2, 但已经不行了, X只能对最左边的Acceptor成功运行phase-2, 而中间的Acceptor拒绝了X的phase-2.</li><li>Y对右边2个Acceptor成功运行了phase-2, 完成写入v&#x3D;y, vrnd&#x3D;2.</li></ul><p><img src="https://picx.zhimg.com/v2-6472642b4a1ad5dc246c79d0229425b7_b.jpg" alt="img"></p><p><strong>slide-34</strong> 继续上面的例子, 看X如何处理被抢走写入权的情况:</p><p>这时X的phase-2没成功, 它需要重新来一遍, 用更大的rnd&#x3D;3.</p><ul><li>X成功在左边2个Acceptor上运行phase-1之后, X发现了2个被写入的值: v&#x3D;x, vrnd&#x3D;1 和 v&#x3D;y, vrnd&#x3D;2; 这时X就不能再写入自己想要写入的值了. 它这次paxos运行必须不能修改已存在的值, 这次X的paxos的运行唯一能做的就是, 修复(可能)已经中断的其他proposer的运行.</li><li>这里v&#x3D;y, vrnd&#x3D;2 是可能在phase-2达到多数派的值. v&#x3D;x, vrnd&#x3D;1不可能是, 因为其他proposer也必须遵守算法约定, 如果v&#x3D;x, vrnd&#x3D;1在某个phase-2达到多数派了, Y一定能在phase-1中看到它, 从而不会写入v&#x3D;y, vrnd&#x3D;2.</li></ul><p>因此这是X选择v&#x3D;y, 并使用rnd&#x3D;3继续运行, 最终把v&#x3D;y, vrnd&#x3D;3写入到所有Acceptor中.</p><p><img src="https://pic4.zhimg.com/v2-01aeaa06dd92aa08f1322db83d5446c1_b.jpg" alt="img"></p><p><strong>slide-35</strong> Paxos 还有一个不太重要的角色Learner, 是为了让系统完整加入的, 但并不是整个算法执行的关键角色, 只有在最后在被通知一下.</p><p><img src="https://picx.zhimg.com/v2-9e9a92b3f6188dc00dace8f3d43497f3_b.jpg" alt="img"></p><h2 id="Paxos-优化"><a href="#Paxos-优化" class="headerlink" title="Paxos 优化"></a><strong>Paxos 优化</strong></h2><p><strong>slide-36</strong> 第一个优化 <strong><a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=1&q=multi-paxos&zhida_source=entity">multi-paxos</a></strong>:</p><p>paxos诞生之初为人诟病的一个方面就是每写入一个值就需要2轮rpc:<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=10&q=phase-1&zhida_source=entity">phase-1</a>和phase-2. 因此一个寻常的优化就是用一次rpc为多个paxos实例运行phase-1.</p><p>例如, Proposer X可以一次性为i₁~i₁₀这10个值, 运行phase-1, 例如为这10个paxos实例选择rnd为1001, 1002…1010. 这样就可以节省下9次rpc, 而所有的写入平均下来只需要1个rpc就可以完成了.</p><p>这么看起来就有点像raft了:</p><ul><li>再加上commit概念(commit可以理解为: 值v送达到多数派这件事情是否送达到多数派了),</li><li>和组成员变更(将quorum的定义从”多于半数”扩展到”任意2个quourm必须有交集”).</li></ul><p><img src="https://pic1.zhimg.com/v2-c97028ee3e786bc779ba30238f2f2ece_b.jpg" alt="img"></p><p><strong>slide-37</strong> 第二个优化 <strong>fast-paxos</strong>:</p><p>fast-paxos通过增加quorum的数量来达到一次rpc就能达成一致的目的. 如果fast-paxos没能在一次rpc达成一致, 则要退化到classic paxos.</p><p><img src="https://pic4.zhimg.com/v2-52d5cb71ced2fc1c959e5f4540063fcf_b.jpg" alt="img"></p><p><strong>slide-38</strong> fast-paxos为了能在退化成classic paxos时不会选择不同的值, 就必须扩大<a href="https://zhida.zhihu.com/search?content_id=120364113&content_type=Article&match_order=4&q=quorum&zhida_source=entity">quorum</a>的值. 也就是说fast-round时, quorum的大小跟classic paxos的大小不一样. 同样我们先来看看为什么fast-quorum不能跟classic-quorum一样, 这样的配置会引起classic阶段回复时选择错误的值 y₀:</p><p><img src="https://pica.zhimg.com/v2-ccae6a05e4ab73007852f15b20219cde_b.jpg" alt="img"></p><p><strong>slide-39</strong> 要解决这个问题, 最粗暴的方法是把fast-quorum设置为n, 也就是全部的acceptor都写入成功才认为fast-round成功(实际上是退化到了主从同步复制). 这样, 如果X和Y两个proposer并发写入, 谁也不会成功, 因此X和Y都退化到classic paxos进行修复, 选任何值去修复都没问题. 因为之前没有Proposer认为自己成功写入了.</p><p>如果再把问题深入下, 可以得出, 如果classic paxos的quorum是n&#x2F;2+1, 那么fast-round的quorum应该是大于¾n, ¾的由来可以简单理解为: 在最差情况下, 达到fast-quorum的acceptor在classic-quorum中必须大于半数, 才不会导致修复进程选择一个跟fast-round不同的值.</p><p><img src="https://pica.zhimg.com/v2-b173bdc6d18b0868a14b232aa4136d72_b.jpg" alt="img"></p><p><strong>slide-40</strong> 下面是一个fast-round中X成功, Y失败的冲突的例子:</p><p>X已经成功写入到4(fast-quorum&gt;¾n)个acceptor, Y只写入1个, 这时Y进入classic-round进行息修复, 可以看到, 不论Y选择哪3(classic quorum)个acceptor, 都可以看到至少2个x₀, 因此Y总会选择跟X一样的值, 保证了<strong>写入的值就不会被修改</strong>的条件.</p><p><img src="https://pica.zhimg.com/v2-51ca437c5db5aea11071655cca66a2a0_b.jpg" alt="img"></p><p><strong>slide-41</strong> 再来看一个X和Y都没有达到fast-quorum的冲突:</p><p>这时X和Y都不会认为自己的fast-round成功了, 因此修复过程选择任何值都是可以的. 最终选择哪个值, 就回归到X和Y两个classic-paxos进程的竞争问题了. 最终会选择x₀或y₀中的一个.</p><p><img src="https://picx.zhimg.com/v2-e8cd5df6b1192a075c32eff3a63534b9_b.jpg" alt="img"></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a><strong>其他</strong></h2><p><strong>slide-42</strong> 一个很容易验证的优化, 各种情况下都能得到一致的结果.</p><p><img src="https://pic1.zhimg.com/v2-8216575fa4c8b9c2ff727af1961390f6_b.jpg" alt="img"></p><p><strong>slide-43</strong> 广告页, 不解释了</p><p><a href="http://weixin.qq.com/r/RHRYQNjEiYX2rZwj9yFW">http://weixin.qq.com/r/RHRYQNjEiYX2rZwj9yFW</a> (二维码自动识别)</p><p>本次的 pdf 可以下载和在线看哦:</p><ul><li><a href="https://link.zhihu.com/?target=https://blog.openacid.com/post-res/paxos/%E5%8F%AF%E9%9D%A0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F-paxos%E7%9A%84%E7%9B%B4%E8%A7%82%E8%A7%A3%E9%87%8A.pdf">可靠分布式系统-paxos的直观解释.pdf</a></li><li><a href="https://link.zhihu.com/?target=https://blog.openacid.com/post-res/paxos/%E5%8F%AF%E9%9D%A0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F-paxos%E7%9A%84%E7%9B%B4%E8%A7%82%E8%A7%A3%E9%87%8A.html">可靠分布式系统-paxos的直观解释.html</a></li></ul><p>本文链接: <a href="https://link.zhihu.com/?target=https://blog.openacid.com/algo/paxos/">https://blog.openacid.com/algo/paxos/</a></p><p>update 2020-11-26: 本文讲的算法, 好多同学问起实现细节的问题, 基本可以在下面这篇找到想要的答案:</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>广告体系架构简单整理</title>
    <link href="/2024/11/12/%E5%B9%BF%E5%91%8A%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84%E7%AE%80%E5%8D%95%E6%95%B4%E7%90%86/"/>
    <url>/2024/11/12/%E5%B9%BF%E5%91%8A%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84%E7%AE%80%E5%8D%95%E6%95%B4%E7%90%86/</url>
    
    <content type="html"><![CDATA[<p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20241112110051158.png" alt="image-20241112110051158"></p><h3 id="1-数据来源"><a href="#1-数据来源" class="headerlink" title="1. 数据来源"></a>1. <strong>数据来源</strong></h3><ul><li><strong>H5 和 App</strong>：通过 JavaScript 和 SDK 实现用户行为数据的埋点采集。</li><li><strong>广告平台</strong>：通过 API 与广告平台进行交互，采集广告相关数据。</li><li><strong>HTTP</strong>：其他通过 HTTP 接口传输的数据。对接广告平台（媒体）API获取投放的广告的报表数据，或者MMP的webhook回调等等</li></ul><h3 id="2-数据采集"><a href="#2-数据采集" class="headerlink" title="2. 数据采集"></a>2. <strong>数据采集</strong></h3><ul><li><strong>Kafka</strong>：作为消息队列，用于存储和传输采集到的用户行为数据。Kafka 负责高效处理来自多个来源的大量实时数据。</li></ul><h3 id="3-大数据处理"><a href="#3-大数据处理" class="headerlink" title="3. 大数据处理"></a>3. <strong>大数据处理</strong></h3><ul><li>实时计算 (Flink)<ul><li>Flink 负责从 Kafka 获取用户行为数据流，对数据进行实时清洗和处理以及用户打标签</li><li>将处理后的数据持久化到数据库（例如 MySQL）。</li></ul></li><li>归档与数据存储<ul><li>将历史数据归档到 Hive，以便进行长期存储和查询、以及分担实时库的查询压力。</li></ul></li><li>离线计算 (Spark)<ul><li>使用 Spark 编写 SQL 作业，通过小海豚调度系统来执行。</li><li>离线计算用于分析用户画像，整合和处理用户行为数据。</li></ul></li></ul><h3 id="4-数据与服务监控"><a href="#4-数据与服务监控" class="headerlink" title="4. 数据与服务监控"></a>4. <strong>数据与服务监控</strong></h3><ul><li><strong>Prometheus</strong>：用于监控系统状态，收集和处理监控指标。api的调用的成功率，kafka的堆积情况等等。</li><li><strong>Logstash&#x2F;Filebeat</strong>：用于日志收集和转发，将日志数据发送到 Elasticsearch。系统的报错日志等等</li><li><strong>Elasticsearch</strong>：用作存储和检索日志数据的搜索引擎。</li><li><strong>Grafana 和 Kibana</strong>：用作数据可视化工具，分别连接到 Prometheus 和 Elasticsearch，提供实时的监控图表和分析视图。</li></ul><h3 id="5-数据展示"><a href="#5-数据展示" class="headerlink" title="5. 数据展示"></a>5. <strong>数据展示</strong></h3><ul><li><strong>Redash</strong>：用于数据展示和报表生成，帮助分析和可视化数据。</li><li><strong>Presto</strong>：访问多种类型的数据源在大规模数据集上进行快速、交互式的查询</li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>整个系统架构展示了如何从不同数据来源采集用户行为数据，并通过流式计算（Flink）和批处理（Spark）进行数据清洗、处理和分析。实时数据被用于快速响应，而离线数据则被用来构建详细的用户画像。监控和可视化层面，通过 Elasticsearch、Grafana 和 Kibana 等工具来进行数据和服务的监控。Redash 最终将分析结果以用户友好的方式展示。</p>]]></content>
    
    
    
    <tags>
      
      <tag>广告</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>操作系统-mmap、sendFile、splice三种零拷贝技术介绍</title>
    <link href="/2024/10/29/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-mmap%E3%80%81sendFile%E3%80%81splice%E4%B8%89%E7%A7%8D%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D/"/>
    <url>/2024/10/29/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-mmap%E3%80%81sendFile%E3%80%81splice%E4%B8%89%E7%A7%8D%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D/</url>
    
    <content type="html"><![CDATA[<blockquote><p>转载文章</p></blockquote><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在传统网络数据传输的过程中，数据会被来回拷贝很多次，而其中有一些是不必要拷贝，而零拷贝技术就是为了<code>减少这些不必要的数据复制操作</code>。下面会详细介绍各种数据拷贝的详细过程，这也是一个非常高频的面试问题。</p><h2 id="传统数据拷贝"><a href="#传统数据拷贝" class="headerlink" title="传统数据拷贝"></a>传统数据拷贝</h2><p>当我们通过网络从服务器上获取数据时，数据整体的传输过程是这样子的，如图（可以放大看）：</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20241112111431751.png" alt="image-20241112111431751"> 详细过程：</p><ol><li>等待cpu调度，通过cpu发起io请求，通过read()方法读取数据，此时用户态切换为内核态；</li><li>DMA对硬盘发起IO请求；</li><li>DMA从硬盘中把数据拷贝到pageCache中；</li><li>DMA拷贝完成后发送完成信息；</li><li><code>cpu从pageCache中把数据拷贝到用户缓冲区；</code></li><li>此时read()方法调用完成，内核态切换为用户态；</li><li>等待cpu调度，通过cpu发起io请求，通过write()方法写数据，此时用户态切换为内核态；</li><li><code>cpu把数据从用户缓冲区拷贝到socket缓冲区；</code></li><li>DMA通知网卡设备要发起IO请求；</li><li>DMA开始进行数据拷贝；</li><li>DMA拷贝完成，通知写完成信息；</li><li>write()方法调用完成，内核态切换为用户态。</li></ol><p>上述过程中出现了4次上下文切换，2次cpu拷贝，2次DMA拷贝；可以发现这里面有很多是不必要的操作，如：从pageCache拷贝到用户缓冲区，再从用户缓冲区拷贝到socket缓冲区；而零拷贝的出现就是为了节省这些cpu拷贝、上下文切换，从而提高服务的整体性能。目前linux提供了mmap、sendfile、splice等都是为了省去不必要的操作从而提升服务整体性能。</p><h2 id="DMA拷贝"><a href="#DMA拷贝" class="headerlink" title="DMA拷贝"></a>DMA拷贝</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">DMA其实就是在主板上安装了一块独立的芯片，它的作用当我们在内存和IO设备上传输设备的时候不需要<span class="hljs-meta">cpu</span>来控制数据的传输，而是直接通过DMA控制器来传输；这样就可以释放<span class="hljs-meta">cpu</span>来做其他的事情；但DMA只能用于设备之间的数据拷贝，所以传统数据传输只有在硬盘、网卡数据拷贝时才用得上。<br></code></pre></td></tr></table></figure><h2 id="mmap-write"><a href="#mmap-write" class="headerlink" title="mmap + write"></a>mmap + write</h2><p>mmap是linux内核提供的一种内存映射文件的方式，将一个进程的虚拟地址映射到磁盘文件地址。它可以将内核缓冲区的地址与用户缓冲区的地址进行映射，从而实现内核缓冲区到用户缓冲区的内存共享。省去数据从内核缓冲区拷贝到用户缓冲区的过程。具体过程如下：</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20241112111538855.png" alt="image-20241112111538855"></p><ol><li>发起mmap()调用，建立用户缓冲区和pageCache的地址映射；</li><li>DMA对硬盘发起IO请求；</li><li>DMA从硬盘中把数据拷贝到pageCache中；</li><li>DMA拷贝完成后发送完成信息；</li><li>mmap()调用完成，内核态切换为用户态；</li><li>等待cpu调度，通过cpu发起io请求，通过write()方法写数据，此时用户态切换为内核态；</li><li><code>cpu把数据从用户缓冲区拷贝到socket缓冲区；</code></li><li>DMA通知网卡设备要发起IO请求；</li><li>DMA开始进行数据拷贝；</li><li>DMA拷贝完成，通知写完成信息；</li><li>write()方法调用完成，内核态切换为用户态。</li></ol><p>后续的write()方法和传统数据拷贝的过程是相同的，整体上发生了4次上下文切换，一次cpu拷贝，<code>节省了一次从pageCache拷贝到用户缓冲区的cpu拷贝过程</code>；同时用户态空间的共享区使用的是虚拟内存，并不会占用过多的物理内存。</p><p>优点：针对大文件可以极大的提高IO性能，但是对于小文件，内存映射反而会导致碎片空间的浪费。</p><h2 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h2><p>sendfile系统调用是Linux2.1引入的目的简化网络通过两个通道之间的数据传输；它可以使数据直接在内核空间进行IO传输，省去了用户空间和内核空间来回拷贝的过程。如图：</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20241112111554791.png" alt="image-20241112111554791"></p><ol><li>发起sendfile()调用，用户态切换为内核态；</li><li>DMA对硬盘发起IO请求；</li><li>DMA从硬盘中把数据拷贝到pageCache中；</li><li>DMA拷贝完成后发送完成信息；</li><li><code>cpu从pageCache拷贝到socket缓冲区；</code></li><li>DMA通知网卡设备要发起IO请求；</li><li>DMA开始进行数据拷贝；</li><li>DMA拷贝完成，通知写完成信息；</li><li>sendfile()调用完成，内核态切换为用户态。</li></ol><p>整个过程中只发生了2次上下文切换，1次cpu拷贝；相比mmap+write又节省了<code>2次上下文切换</code>。 而在linux2.4内核版本开始，又增加了<code>gather操作</code>，可以把仅有的这次cpu拷贝也省去掉。过程如下：</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20241112111609402.png" alt="image-20241112111609402"></p><p>上图红色字体的过程为改进点。它把数据描述信息读到socket的缓冲区中，DMA Gather Copy根据socket缓冲的数据描述信息批量的从pageCache中读取到网卡设备上。至此剩余的一次<code>pageCache到socket缓冲的cpu拷贝</code>也被节省掉了。</p><h2 id="splice"><a href="#splice" class="headerlink" title="splice"></a>splice</h2><p>上面的零拷贝，都是大家平时刷文章经常刷到的，这里再介绍一种不那么常见的<code>splice</code>。过程图如下：</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20241112111622999.png" alt="image-20241112111622999"></p><p>在第5步是创建一个splice管道，并且把该管道的写端绑定在pageCache上，读端绑定到socket缓冲区上，再通过DMA拷贝到网卡设备上，也实现真正意义上的零cpu拷贝。</p><blockquote><p>作者：想打游戏的程序猿<br>链接：<a href="https://juejin.cn/post/7404036819107102739">https://juejin.cn/post/7404036819107102739</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
    </categories>
    
    
    <tags>
      
      <tag>零拷贝</tag>
      
      <tag>mmap</tag>
      
      <tag>sendFile</tag>
      
      <tag>splice</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>抓包精灵-上传功能服务端代码</title>
    <link href="/2024/07/29/%E6%8A%93%E5%8C%85%E7%B2%BE%E7%81%B5-%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81/"/>
    <url>/2024/07/29/%E6%8A%93%E5%8C%85%E7%B2%BE%E7%81%B5-%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<p>服务端代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> multiparty = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;multiparty&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;os&#x27;</span>);<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// 确保上传目录存在</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> form = <span class="hljs-keyword">new</span> multiparty.<span class="hljs-title class_">Form</span>();<br>    form.<span class="hljs-property">uploadDir</span> = <span class="hljs-title function_">generateSavePath</span>(req); <span class="hljs-comment">// 设置上传目录</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(form.<span class="hljs-property">uploadDir</span>)<br>    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(form.<span class="hljs-property">uploadDir</span>)) &#123;<br>        fs.<span class="hljs-title function_">mkdirSync</span>(form.<span class="hljs-property">uploadDir</span>, &#123;<span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>&#125;);<br>    &#125;<br>    form.<span class="hljs-property">keepExtensions</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 保持文件扩展名</span><br>    form.<span class="hljs-title function_">parse</span>(req, <span class="hljs-function">(<span class="hljs-params">err, fields, files</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (err) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error parsing form:&#x27;</span>, err);<br>            <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>(&#123;<span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Error parsing form&#x27;</span>&#125;);<br>        &#125;<br><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Fields:&#x27;</span>, fields);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Files:&#x27;</span>, files);<br><br>        res.<span class="hljs-title function_">json</span>(&#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;File uploaded successfully.&#x27;</span>&#125;);<br>    &#125;);<br>&#125;);<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">generateSavePath</span> = (<span class="hljs-params">req</span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> vpnStart = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;vpn_start_time&#x27;</span>];<br>    <span class="hljs-keyword">const</span> appName = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;app_name&#x27;</span>];<br>    <span class="hljs-keyword">const</span> ipAndPort = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;ipandport&#x27;</span>];<br>    <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;uploads&#x27;</span>, vpnStart, appName, ipAndPort);<br>&#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getLocalIP</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> interfaces = os.<span class="hljs-title function_">networkInterfaces</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> name <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(interfaces)) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> net <span class="hljs-keyword">of</span> interfaces[name]) &#123;<br>            <span class="hljs-keyword">if</span> (net.<span class="hljs-property">family</span> === <span class="hljs-string">&#x27;IPv4&#x27;</span> &amp;&amp; !net.<span class="hljs-property">internal</span>) &#123;<br>                <span class="hljs-keyword">return</span> net.<span class="hljs-property">address</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>;<br>&#125;<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> localIP = <span class="hljs-title function_">getLocalIP</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server is running on http://<span class="hljs-subst">$&#123;localIP&#125;</span>:3000`</span>);<br>&#125;);<br><br></code></pre></td></tr></table></figure><p>下载运行必要npm包</p><p><code>npm install express</code></p><p><code>npm install multiparty</code></p><p><code>npm install fs</code></p><p><code>npm install path</code></p><p><code>npm install os</code></p><p>运行</p><p><code>node server.js</code></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Tunnelblick身份验证自动通过Google Authenticator Token(谷歌验证器验证码)</title>
    <link href="/2024/07/01/Tunnelblick%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E8%87%AA%E5%8A%A8%E9%80%9A%E8%BF%87Google-Authenticator-Token-%E8%B0%B7%E6%AD%8C%E9%AA%8C%E8%AF%81%E5%99%A8%E9%AA%8C%E8%AF%81%E7%A0%81/"/>
    <url>/2024/07/01/Tunnelblick%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E8%87%AA%E5%8A%A8%E9%80%9A%E8%BF%87Google-Authenticator-Token-%E8%B0%B7%E6%AD%8C%E9%AA%8C%E8%AF%81%E5%99%A8%E9%AA%8C%E8%AF%81%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<p>文档地址</p><blockquote><p><a href="https://tunnelblick.net/cUsingScripts.html">Using Scripts - Tunnelblick | Free open source OpenVPN VPN client server software GUI for Mac OS X.</a></p><p><a href="https://tunnelblick.net/cMultiFactorAuthentication.html">https://tunnelblick.net/cMultiFactorAuthentication.html</a></p></blockquote><p>原理大概就是：Tunnelblick开启了Google Authenticator Token(谷歌验证器验证码)MFA验证，可以通过配置了static-challenge-response.user.sh，自动从脚本里获取stdout来输入到Google Authenticator Token(谷歌验证器验证码)</p><h4 id="提取绑定二维码获取以下信息，然后提取secret"><a href="#提取绑定二维码获取以下信息，然后提取secret" class="headerlink" title="提取绑定二维码获取以下信息，然后提取secret"></a>提取绑定二维码获取以下信息，然后提取secret</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-symbol">otpauth:</span>/<span class="hljs-regexp">/totp/xxxxx</span><span class="hljs-symbol">:xxxxx?secret=&lt;secret&gt;&amp;issuer=&lt;issuer&gt;</span><br></code></pre></td></tr></table></figure><h4 id="把secret存储到钥匙串访问（Keychain）"><a href="#把secret存储到钥匙串访问（Keychain）" class="headerlink" title="把secret存储到钥匙串访问（Keychain）"></a>把secret存储到钥匙串访问（Keychain）</h4><ul><li>命令行添加</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/bin/security add-generic-password -s &quot;Tunnelblick-Auth-****&quot; -a &quot;otp-secret&quot;  -w &quot;add-your-otp-secret-here&quot;<br></code></pre></td></tr></table></figure><ul><li>设置-钥匙串访问-添加</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240701192824848.png" alt="image-20240701192824848"></p><h4 id="安装oath-toolkit"><a href="#安装oath-toolkit" class="headerlink" title="安装oath-toolkit"></a>安装oath-toolkit</h4><blockquote><p>OATH Toolkit提供了构建一次性密码身份验证系统的组件。支持的技术包括基于事件的HOTP算法(RFC 4226)、基于时间的TOTP算法(RFC 6238)和可移植对称密钥容器(PSKC, RFC 6030)，用于管理密钥数据</p></blockquote><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">brew </span><span class="hljs-keyword">install </span>oath-toolkit<br></code></pre></td></tr></table></figure><h4 id="在-x2F-Library-x2F-Application-Support-x2F-Tunnelblick-x2F-Shared-x2F-lt-gt-tblk-x2F-Contents-x2F-Resources目录下创建static-challenge-response-user-sh"><a href="#在-x2F-Library-x2F-Application-Support-x2F-Tunnelblick-x2F-Shared-x2F-lt-gt-tblk-x2F-Contents-x2F-Resources目录下创建static-challenge-response-user-sh" class="headerlink" title="在 ~&#x2F;Library&#x2F;Application Support&#x2F;Tunnelblick&#x2F;Shared&#x2F;&lt;********&gt;.tblk&#x2F;Contents&#x2F;Resources目录下创建static-challenge-response.user.sh"></a>在 ~&#x2F;Library&#x2F;Application Support&#x2F;Tunnelblick&#x2F;Shared&#x2F;&lt;********&gt;.tblk&#x2F;Contents&#x2F;Resources目录下创建static-challenge-response.user.sh</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash -e</span><br>otp_pw_name=&quot;Tunnelblick-Auth-&lt;****&gt;&quot;<br>otp_pw_account=&quot;otp-secret&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Get otp-secret from keychain:</span><br>if ! otp_secret=$(/usr/bin/security find-generic-password -w -s &quot;$otp_pw_name&quot; -a &quot;$otp_pw_account&quot;); then<br>  exit 1<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Generate otp code</span><br>otp_code=$(/opt/homebrew/Cellar/oath-toolkit/2.6.11/bin/oathtool --totp -b &quot;$otp_secret&quot;)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Output the otp_code without a trailing newline</span><br>printf &quot;%s&quot; &quot;$otp_code&quot;<br></code></pre></td></tr></table></figure><p>然后就可以了自动输入谷歌验证码连接了</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>对深度链接的简单理解</title>
    <link href="/2024/06/24/%E5%AF%B9%E6%B7%B1%E5%BA%A6%E9%93%BE%E6%8E%A5%E7%9A%84%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3/"/>
    <url>/2024/06/24/%E5%AF%B9%E6%B7%B1%E5%BA%A6%E9%93%BE%E6%8E%A5%E7%9A%84%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="深度链接（DeepLink）"><a href="#深度链接（DeepLink）" class="headerlink" title="深度链接（DeepLink）"></a>深度链接（DeepLink）</h3><p>深度链接是一种基于URI架构的技术协议，允许直接跳转到应用内的特定功能模块或内容页面（如微信扫码 <code>weixin://dl/scan</code>），而不仅是简单唤起App。其核心价值在于解决两大痛点：</p><ol><li><strong>打破应用孤岛</strong>：实现跨应用的无缝跳转（如广告跳转电商商品页）</li><li><strong>精准场景直达</strong>：避免用户手动查找路径（直接打开抖音特定视频）</li></ol><h4 id="技术实现方式"><a href="#技术实现方式" class="headerlink" title="技术实现方式"></a>技术实现方式</h4><ul><li>URL Scheme（基础方案）：<ul><li>格式：<code>[scheme]://[host]/[path]?[query]</code></li><li>缺点：无法处理未安装场景，多应用冲突时需用户手动选择</li></ul></li><li>平台级方案：<ul><li>Android App Links &#x2F; iOS Universal Links</li><li>使用HTTP&#x2F;HTTPS链接（如 <code>https://app.com/product/123</code>）</li><li>优势：未安装时自动跳转网页，安装后直通App内容</li></ul></li></ul><hr><h3 id="延迟深度链接（Deferred-Deeplink）"><a href="#延迟深度链接（Deferred-Deeplink）" class="headerlink" title="延迟深度链接（Deferred Deeplink）"></a>延迟深度链接（Deferred Deeplink）</h3><p>当用户点击链接时若未安装应用，传统深度链接会失效。<strong>延迟深度链接通过上下文还原技术，实现安装启动后自动跳转到原始目标页</strong>，典型流程如下：</p><ol><li>用户在广告H5页点击「立即购买」</li><li>系统检测应用未安装 → 引导下载</li><li>安装后首次启动时自动打开商品购买页</li></ol><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20250624175615323.png" alt="image-20250624175615323"></p><h4 id="关键技术实现"><a href="#关键技术实现" class="headerlink" title="关键技术实现"></a>关键技术实现</h4><table><thead><tr><th align="center">技术方案</th><th align="center">实现原理</th><th align="center">适用场景</th></tr></thead><tbody><tr><td align="center">剪贴板数据传递</td><td align="center">下载时将参数加密存入剪贴板（点击下载的时候，将场景中的一些参数记录下，生成一条链接或者更为复杂得多口令码，启动的时候从剪贴板中读取参数）</td><td align="center">安卓&#x2F;iOS通用</td></tr><tr><td align="center">设备指纹匹配</td><td align="center">记录设备ID&#x2F;IP，云端匹配用户行为（将当前网络的IP、系统、可以获取的ID信息记录下来，某个时间段可以匹配上的用户可以认为是同一个用户。）</td><td align="center">广告投放场景</td></tr></tbody></table><blockquote><p>典型案例：小红书H5页→下载→启动后自动打开《10分钟早餐》笔记</p></blockquote><hr><h3 id="上下文深度链接（Contextual-Deeplink）"><a href="#上下文深度链接（Contextual-Deeplink）" class="headerlink" title="上下文深度链接（Contextual Deeplink）"></a>上下文深度链接（Contextual Deeplink）</h3><p>在基础深度链接上增加<strong>环境参数传递能力</strong>，实现智能化场景适配：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-comment">// 示例：携程酒店深度链接携带用户偏好</span><br>ctrip:<span class="hljs-comment">//hotels/detail?id=12345&amp;</span><br>    checkin=<span class="hljs-number">2023</span>-<span class="hljs-number">06</span>-<span class="hljs-number">20</span><span class="hljs-meta">&amp;</span><br>    adult=<span class="hljs-number">2</span><span class="hljs-meta">&amp;</span><br>    children=<span class="hljs-number">1</span><span class="hljs-meta">&amp;</span><br>    utm_source=weibo_ad<br></code></pre></td></tr></table></figure><h4 id="核心价值"><a href="#核心价值" class="headerlink" title="核心价值"></a>核心价值</h4><ol><li><strong>动态内容加载</strong>：根据参数展示定制化页面（如不同促销活动）</li><li><strong>用户行为跟踪</strong>：通过UTM参数追踪转化路径</li><li><strong>跨平台一致性</strong>：保持网页与App体验无缝衔接</li><li><strong>条件路由</strong>：根据设备类型&#x2F;地理位置自动分流</li></ol><blockquote><p>实际应用：美团在不同城市广告中植入地理参数，实现「点击即打开本地优惠页」</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>广告</category>
      
    </categories>
    
    
    <tags>
      
      <tag>广告</tag>
      
      <tag>深度链接</tag>
      
      <tag>延迟深度链接</tag>
      
      <tag>上下文深度链接</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>移动测量合作伙伴（MMP）的广告归因链路</title>
    <link href="/2024/05/30/%E7%A7%BB%E5%8A%A8%E6%B5%8B%E9%87%8F%E5%90%88%E4%BD%9C%E4%BC%99%E4%BC%B4%EF%BC%88MMP%EF%BC%89%E7%9A%84%E5%B9%BF%E5%91%8A%E5%BD%92%E5%9B%A0%E9%93%BE%E8%B7%AF/"/>
    <url>/2024/05/30/%E7%A7%BB%E5%8A%A8%E6%B5%8B%E9%87%8F%E5%90%88%E4%BD%9C%E4%BC%99%E4%BC%B4%EF%BC%88MMP%EF%BC%89%E7%9A%84%E5%B9%BF%E5%91%8A%E5%BD%92%E5%9B%A0%E9%93%BE%E8%B7%AF/</url>
    
    <content type="html"><![CDATA[<h3 id="移动测量合作伙伴（MMP）的广告归因链路"><a href="#移动测量合作伙伴（MMP）的广告归因链路" class="headerlink" title="移动测量合作伙伴（MMP）的广告归因链路"></a>移动测量合作伙伴（MMP）的广告归因链路</h3><p>移动测量合作伙伴（Mobile Measurement Partner，简称MMP）是一类专门提供移动应用广告归因和分析服务的第三方平台。MMP的主要功能是帮助广告主和应用开发者跟踪和分析广告效果，确定用户的来源，从而优化广告投放策略，提高广告投放的投资回报率（ROI）。广告归因是MMP的核心功能之一，通过收集和分析用户的点击和安装数据，确定用户是通过哪个广告平台、广告活动甚至具体的广告创意下载并安装了应用。</p><h4 id="无链接广告的归因链路"><a href="#无链接广告的归因链路" class="headerlink" title="无链接广告的归因链路"></a>无链接广告的归因链路</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240530145119242.png" alt="image-20240530145119242"></p><p>无链接广告通常指那些不包含深度链接或特定归因链接的广告。这类广告的归因依赖于设备标识符和时间窗口。以下是无链接广告的归因链路详细过程：</p><ol><li><strong>广告展示与点击</strong>：<ul><li>用户在广告平台（如Google、Facebook）上看到广告并点击。</li><li>广告平台记录下点击事件，包括设备ID（如IDFA、GAID）和点击时间。</li><li>为了能够进行准确的归因，广告平台（如Google、Facebook）在用户点击广告时，会将点击数据（如点击时间、设备ID等）发送到MMP。</li></ul></li><li><strong>应用下载与安装</strong>：<ul><li>用户被引导到应用商店，下载并安装应用。</li></ul></li><li><strong>应用激活与MMP SDK的作用</strong>：<ul><li>用户首次打开应用时，应用内集成的MMP SDK（如Adjust、AppsFlyer）会触发一次激活事件。</li><li>SDK收集设备标识符、安装时间等信息，并发送到MMP服务器。</li></ul></li><li><strong>广告归因处理</strong>：<ul><li>MMP服务器将接收到的激活数据与之前从广告平台获取的点击数据进行匹配。</li><li>通过时间窗口（通常为点击后的24至48小时）和设备标识符，MMP确定用户的安装行为与哪个点击事件相关联。</li></ul></li><li><strong>归因报告</strong>：<ul><li>MMP回传数据告知是通过哪个广告平台的广告安装了应用。</li></ul></li></ol><p>这种归因方法依赖于设备标识符和时间窗口来推断用户行为，可能会因设备ID的变化或其他因素影响归因准确性。</p><h4 id="有链接广告的归因链路"><a href="#有链接广告的归因链路" class="headerlink" title="有链接广告的归因链路"></a>有链接广告的归因链路</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240530145130921.png" alt="image-20240530145130921"></p><p>有链接广告包含深度链接或特定的归因链接，例如Branch链接或AppsFlyer Onelink。这些链接能直接追踪用户的点击行为，使归因过程更为精确。以下是有链接广告的归因链路详细过程：</p><ol><li><strong>广告展示与点击</strong>：<ul><li>用户在广告平台上看到包含归因链接的广告（如Branch链接或AppsFlyer Onelink）。</li><li>用户点击广告链接。</li></ul></li><li><strong>链接重定向与归因信息收集</strong>：<ul><li>点击广告链接后，用户会被重定向到归因平台的中间页面。</li><li>中间页面收集用户点击信息，包括设备ID、点击时间、广告来源等。</li></ul></li><li><strong>重定向到应用商店</strong>：<ul><li>收集完必要信息后，用户被重定向到应用商店的应用下载页面。</li></ul></li><li><strong>应用下载与安装</strong>：<ul><li>用户下载并安装应用。</li></ul></li><li><strong>应用激活与SDK的作用</strong>：<ul><li>用户首次打开应用时，应用内集成的归因平台SDK（如Branch SDK、AppsFlyer SDK）会触发一次激活事件。</li><li>SDK将设备标识符和安装时间等信息发送到归因平台服务器。</li></ul></li><li><strong>归因匹配</strong>：<ul><li>归因平台服务器将激活事件与之前收集的点击数据进行匹配。</li><li>由于链接中包含了具体的归因信息，归因平台能够直接将用户安装归因到特定的广告点击。</li></ul></li><li><strong>归因报告</strong>：<ul><li>归因平台回调告知是通过哪个广告平台和具体的广告链接下载并安装了应用。</li></ul></li></ol><p>有链接广告的归因方法由于使用了明确的点击信息和广告来源，归因过程更加直接和精确。</p><h4 id="无链接广告与有链接广告的区别"><a href="#无链接广告与有链接广告的区别" class="headerlink" title="无链接广告与有链接广告的区别"></a>无链接广告与有链接广告的区别</h4><ol><li><strong>归因信息收集</strong>：<ul><li><strong>无链接广告</strong>：依赖于设备标识符和时间窗口进行归因，需要更多的匹配步骤。</li><li><strong>有链接广告</strong>：通过深度链接或归因链接直接收集点击信息，归因过程更加直接和精确。</li></ul></li><li><strong>中间页面重定向</strong>：<ul><li><strong>无链接广告</strong>：用户点击广告后直接跳转到应用商店，归因信息通过后台匹配。</li><li><strong>有链接广告</strong>：用户点击广告后首先重定向到归因平台的中间页面，收集归因信息后再跳转到应用商店。</li></ul></li><li><strong>准确性</strong>：<ul><li><strong>无链接广告</strong>：归因准确性可能受限于设备标识符的变化和点击后的时间窗口。</li><li><strong>有链接广告</strong>：归因更准确，因为链接中包含了明确的点击信息和广告来源。</li></ul></li><li><strong>归因速度</strong>：<ul><li><strong>无链接广告</strong>：归因过程可能需要更多时间来匹配和确认。</li><li><strong>有链接广告</strong>：归因过程更加迅速，因为点击信息在链接中已经明确。</li></ul></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>广告</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Springboot-Redisson实现延迟消息队列</title>
    <link href="/2024/04/29/Springboot-Redisson%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    <url>/2024/04/29/Springboot-Redisson%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/</url>
    
    <content type="html"><![CDATA[<p>Redisson是一个基于Redis的Java驻留库，旨在简化Java应用程序对Redis的操作。它提供了丰富的功能和易于使用的API，使得在Java应用中集成Redis变得更加简单和高效。Redisson的主要功能包括分布式对象、分布式锁、分布式队列、分布式调度器等，使得在分布式环境中进行协作变得更加容易。</p><p>延迟队列是Redisson提供的一个功能强大的组件之一。它允许开发者在指定的延迟时间之后自动执行任务，这对于需要在一定时间后执行操作的应用程序非常有用，如消息通知、订单处理、定时任务等。</p><p>Redisson实现延迟队列的原理基于Redis的有序集合（Sorted Set）和Redis的过期时间机制</p><h3 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h3><p>因为<code>RDelayedQueue</code>并不直接存储任务。相反，它是一种装饰器或包装器，用于添加延迟功能到一个标准的Redisson队列（如<code>RBlockingQueue</code>）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonDelayQueueProducer</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addDelayedTask</span><span class="hljs-params">(String topic, Object task, <span class="hljs-type">long</span> delay, TimeUnit timeUnit)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;redis的延迟队列 &#123;&#125; (添加)的key:&#123;&#125;,time:&#123;&#125;,当前时间:&#123;&#125;&quot;</span>, topic, task, delay, LocalDateTimeUtil.formatNormal(LocalDateTime.now()));<br>        redissonClient.getDelayedQueue(redissonClient.getBlockingQueue(topic)).offerAsync(task, delay, timeUnit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">cancelDelayedTask</span><span class="hljs-params">(String topic, Object task)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;redis的延迟队列&#123;&#125; (移除)的key:&#123;&#125;,当前时间:&#123;&#125;&quot;</span>, topic, task, LocalDateTimeUtil.formatNormal(LocalDateTime.now()));<br>        <span class="hljs-comment">// 从延迟队列中移除任务</span><br>        <span class="hljs-keyword">return</span> redissonClient.getDelayedQueue(redissonClient.getBlockingQueue(topic)).remove(task);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><p>起一个线程循环监听延迟队列</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonDelayedQueueConsumer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic&quot;</span>;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建延迟队列</span><br>        log.info(<span class="hljs-string">&quot;&#123;&#125; 开始监听&quot;</span>, topic);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    RBlockingQueue&lt;Object&gt; aaa = redissonClient.getBlockingQueue(topic);<br>                    RDelayedQueue&lt;Object&gt; delayedQueue = redissonClient.getDelayedQueue(aaa);<br>                    <span class="hljs-comment">// 从延迟队列中取出任务</span><br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">take</span> <span class="hljs-operator">=</span> aaa.take();<br>                    <span class="hljs-comment">// 处理延迟任务，例如执行某个操作</span><br>                    log.info(<span class="hljs-string">&quot;redis的延迟队列:&#123;&#125;,当前时间:&#123;&#125;&quot;</span>, take, LocalDateTimeUtil.formatNormal(LocalDateTime.now()));<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    log.error(<span class="hljs-string">&quot;redis的延迟队列抛出异常&quot;</span>, e);<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240429115537300.png" alt="image-20240429115537300"></p><h4 id="redisson配置"><a href="#redisson配置" class="headerlink" title="redisson配置"></a>redisson配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.17.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfig</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.data.redis.host&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String redisHost;<br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.data.redis.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String redisPort;<br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.data.redis.password&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-meta">@Bean(destroyMethod = &quot;shutdown&quot;)</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://&quot;</span> + redisHost + <span class="hljs-string">&quot;:&quot;</span> + redisPort);<br>        <span class="hljs-keyword">if</span>(StringUtils.isBlank(password)) &#123;<br>            config.useSingleServer().setPassword(<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            config.useSingleServer().setPassword(password);<br>        &#125;<br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Redisson</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>实用的 IntelliJ 插件</title>
    <link href="/2024/04/22/%E5%AE%9E%E7%94%A8%E7%9A%84-IntelliJ-%E6%8F%92%E4%BB%B6/"/>
    <url>/2024/04/22/%E5%AE%9E%E7%94%A8%E7%9A%84-IntelliJ-%E6%8F%92%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="Translation"><a href="#Translation" class="headerlink" title="Translation"></a>Translation</h2><p>最好用过的翻译工具</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422111533246.png" alt="image-20240422111533246"></p><h2 id="RoboPOJOGenerator"><a href="#RoboPOJOGenerator" class="headerlink" title="RoboPOJOGenerator"></a>RoboPOJOGenerator</h2><p>IntelliJ Idea 和 Android Studio 的插件，用于将 JSON 转换为 POJO。 从 JSON 生成 Java、Java Records 和 Kotlin 的 POJO 文件：GSON、FastJSON、AutoValue（GSON）、Logan Square、Jackson、Lombok、Jakarta JSON Binding、空注解模板。支持：原始类型、多个内部 JSONArray。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422112843612.png" alt="image-20240422112843612"></p><h2 id="Java-Bean-to-Json"><a href="#Java-Bean-to-Json" class="headerlink" title="Java Bean to Json"></a>Java Bean to Json</h2><p> Java类对象转换成一个 json</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422111653856.png" alt="image-20240422111653856"></p><h2 id="SequenceDiagram"><a href="#SequenceDiagram" class="headerlink" title="SequenceDiagram"></a>SequenceDiagram</h2><p> Java类直接生成时序图</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422111717408.png" alt="image-20240422111717408"></p><h2 id="CamelCase"><a href="#CamelCase" class="headerlink" title="CamelCase"></a>CamelCase</h2><p>可以轻松地在kebab-case、SNAKE_CASE、PascalCase、camelCase、snake_case或者space case之间切换。查看编辑菜单或使用 ⇧ + ⌥ + U &#x2F; Shift + Alt + U。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422111856198.png" alt="image-20240422111856198"></p><h2 id="GenerateAllSetter"><a href="#GenerateAllSetter" class="headerlink" title="GenerateAllSetter"></a>GenerateAllSetter</h2><p>一键调用一个对象的所有的set方法,get方法等，在方法上生成两个对象的转换</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422112011976.png" alt="image-20240422112011976"></p><h2 id="Key-Promoter-X"><a href="#Key-Promoter-X" class="headerlink" title="Key Promoter X"></a>Key Promoter X</h2><p>Key Promoter X能帮助你在工作时学习必要的快捷键。当你在IDE内使用鼠标点击按钮时，Key Promoter X会显示你应该使用的键盘快捷键。这为学习如何用键盘按键替换繁琐的鼠标操作提供了一种简单的方法，并有助于过渡到更快速、无需鼠标的开发方式。Key Promoter X工具窗口会显示你最常使用的鼠标操作的清单，并直接提供可替代的快捷键。对于没有快捷键的按钮，Key Promoter X会提示你直接创建一个快捷键。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422112110446.png" alt="image-20240422112110446"></p><h2 id="LeetCode-Editor"><a href="#LeetCode-Editor" class="headerlink" title="LeetCode Editor"></a>LeetCode Editor</h2><p>支持leetcode.com和leetcode.cn，可以测试和提交问题</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422112201974.png" alt="image-20240422112201974"></p><h2 id="Maven-Helper"><a href="#Maven-Helper" class="headerlink" title="Maven Helper"></a>Maven Helper</h2><p>一个必备的 Maven 工作插件。 </p><ul><li>分析和排除冲突依赖的简便方式。 </li><li>在包含当前文件的模块或根模块上运行&#x2F;调试 Maven 目标的操作。 </li><li>在当前 Maven 模块路径打开终端的操作。 运行&#x2F;调试当前测试文件的操作。</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422112321393.png" alt="image-20240422112321393"></p><h2 id="MyBatis-Log-Free"><a href="#MyBatis-Log-Free" class="headerlink" title="MyBatis Log Free"></a>MyBatis Log Free</h2><p>将MyBatis的SQL日志还原为原始的完整可执行SQL。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422112434638.png" alt="image-20240422112434638"></p><h2 id="MyBatisX"><a href="#MyBatisX" class="headerlink" title="MyBatisX"></a>MyBatisX</h2><p>MybatisX插件功能：</p><ul><li>Mapper和XML之间可以相互跳转</li><li>提示MyBatis.xml和Mapper.xml文件</li><li>Mapper和XML支持像JPA一样的自动提示（参考MybatisCodeHelperPro）</li><li>集成MyBatis Generator GUI（从免费MyBatis插件复制）</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422112524955.png" alt="image-20240422112524955"></p><h2 id="Rainbow-Brackets"><a href="#Rainbow-Brackets" class="headerlink" title="Rainbow Brackets"></a>Rainbow Brackets</h2><p>彩虹色的花括号</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240422112711489.png" alt="image-20240422112711489"></p>]]></content>
    
    
    
    <tags>
      
      <tag>IntelliJ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>腾讯云大文件迁移教程-内网互联+scp</title>
    <link href="/2024/04/15/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%A4%A7%E6%96%87%E4%BB%B6%E8%BF%81%E7%A7%BB%E6%95%99%E7%A8%8B-%E5%86%85%E7%BD%91%E4%BA%92%E8%81%94-scp/"/>
    <url>/2024/04/15/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%A4%A7%E6%96%87%E4%BB%B6%E8%BF%81%E7%A7%BB%E6%95%99%E7%A8%8B-%E5%86%85%E7%BD%91%E4%BA%92%E8%81%94-scp/</url>
    
    <content type="html"><![CDATA[<p>超过几十GB的大文件传输，通过公网会非常的慢几乎2mb&#x2F;s，腾讯云提供了内网互联的功能，内网传输就会很快上100mb&#x2F;s</p><h4 id="创建内网互联"><a href="#创建内网互联" class="headerlink" title="创建内网互联"></a>创建内网互联</h4><ul><li><p><a href="https://console.cloud.tencent.com/vpc/ccn">云联网 - 私有网络 - 控制台 (tencent.com)</a></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240415141102214.png" alt="image-20240415141102214"></p></li><li><p>获取账号ID和云联网ID</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240415141202604.png" alt="image-20240415141202604"></p></li></ul><h4 id="云服务器关联云联网"><a href="#云服务器关联云联网" class="headerlink" title="云服务器关联云联网"></a>云服务器关联云联网</h4><ul><li><p>点击实例-&gt;网络信息-&gt;所属网络  点击进去</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240415141409631.png" alt="image-20240415141409631"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240415141540933.png" alt="image-20240415141540933"></p></li></ul><p>​</p><ul><li><p>输入刚刚获取的账号ID和云联网ID</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240415141546636.png" alt="image-20240415141546636"></p></li><li><p>同意加入云联网</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240415141716611.png" alt="image-20240415141716611"></p></li></ul><p>同意了以后，就可以通过腾讯云提供的内网ip进行内网数据传输了</p><h4 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h4><ul><li><p>借助screen来后台执行传输job，断开ssh也不会停止</p><p>Linux 的 <code>screen</code> 命令是一种非常实用的工具，它可以让用户在单个终端窗口中创建多个会话，并能够在这些会话之间自由切换。<code>screen</code> 还能够让这些会话在用户断开连接后继续运行，这对于远程工作和长时间运行的进程非常有用。</p><p>如果没有安装screen可以使用yum安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install screen<br></code></pre></td></tr></table></figure></li><li><p>创建一个名为restore的回话</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">screen -S restore<br></code></pre></td></tr></table></figure></li><li><p>使用scp从指定服务器拷贝数据到本地</p><p><code>scp</code> 是一个在 Linux 和 Unix 系统中用于在不同主机之间安全地传输文件的命令行工具</p><p>命令结构是：scp [选项] [源文件] [目标位置]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">scp -r xxx.xx.xx.xx:/home/data /tmp/data<br></code></pre></td></tr></table></figure></li><li><p>输入ctrl + z 暂停</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[1]+ 已停止 scp -r xxx.xx.xx.xx:/home/data /tmp/data<br></code></pre></td></tr></table></figure></li><li><p>查看任务，输入命令：jobs</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost /]# jobs<br>[1]+ 已停止 scp -r xxx.xx.xx.xx:/home/data /tmp/data<br></code></pre></td></tr></table></figure></li><li><p>bg将其放入后台，输入命令：bg %1</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost /]# bg %1<br>[1]+ scp -r xxx.xx.xx.xx:/home/data /tmp/data<br></code></pre></td></tr></table></figure></li><li><p>查看任务是否在后台</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@localhost /]<span class="hljs-comment"># jobs</span><br>[<span class="hljs-number">1</span>]+ 运行中 scp -r xxx.xx.xx.xx:<span class="hljs-regexp">/home/</span>data <span class="hljs-regexp">/tmp/</span>data<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Springboot Guava Eventbus简单使用</title>
    <link href="/2024/04/12/Springboot-Guava-Eventbus%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <url>/2024/04/12/Springboot-Guava-Eventbus%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h4 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h4><p>EventBus是 Google Guava 提供的一个事件总线库，用于简化组件之间的通信。它基于发布-订阅模式，允许组件在不直接依赖彼此的情况下进行通信。在一个应用程序中，当某个组件触发了一个事件，所有订阅了该事件的组件都会收到通知并执行相应的操作。</p><p>简单来说，<code>EventBus</code> 可以帮助你解耦代码，使得组件之间更加灵活和独立。</p><h4 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h4><ol><li><p><strong>事件（Event）</strong></p><p>事件是系统中某一特定状态的表示，可以是用户操作、系统状态改变等。通常是一个普通的POJO对象，用于封装事件相关的数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyEvent</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br>    ..........<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>事件发布者（Event Publisher）</strong></p><p>负责发布事件的组件，通常是某个服务、控制器或其他业务逻辑组件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyEventBus</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EventBus</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Object object)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;&#123;&#125; 订阅成功 &quot;</span>, object.getClass().getSimpleName());<br>        <span class="hljs-built_in">super</span>.register(object);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unregister</span><span class="hljs-params">(Object object)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;&#123;&#125; 移除订阅成功 &quot;</span>, object.getClass().getSimpleName());<br>        <span class="hljs-built_in">super</span>.unregister(object);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">post</span><span class="hljs-params">(Object event)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;notify : &#123;&#125;&quot;</span>, JSON.toJSONString(event));<br>        <span class="hljs-built_in">super</span>.post(event);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>事件订阅者（Event Subscriber）</strong></p><p>负责订阅并处理特定类型事件的组件，通常是一个或多个。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyEventBusSubscribe</span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MyEventBus eventBus;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">()</span> &#123;<br>        eventBus.register(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Subscribe</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MyEvent t)</span>&#123;<br>    <span class="hljs-comment">//执行业务</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>使用</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//依赖注入</span><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> MyEventBus myEventBus;<br><br><span class="hljs-comment">//定义消息</span><br>MyEvent myevent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyEvent</span>();<br>myevent.setMessage(<span class="hljs-string">&quot;message&quot;</span>);<br><span class="hljs-comment">//发送消息</span><br>myEventBus.post(myevent);<br></code></pre></td></tr></table></figure></li></ol><h4 id="同步消费-EventBus"><a href="#同步消费-EventBus" class="headerlink" title="同步消费-EventBus"></a>同步消费-EventBus</h4><p><code>EventBus</code> 是按照先到先服务（FIFO）的顺序依次处理事件的。也就是说，当一个事件被发布后，<code>EventBus</code> 会依次通知所有订阅者并让它们处理该事件，只有当当前事件的所有订阅者处理完成后，<code>EventBus</code> 才会发布下一个事件。</p><blockquote><p>验证代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.common.eventbus.EventBus;<br><span class="hljs-keyword">import</span> com.google.common.eventbus.Subscribe;<br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-comment">// 定义一个事件类</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageEvent</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br>&#125;<br><br><span class="hljs-comment">// 定义一个订阅者</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageSubscriber</span> &#123;<br>    <span class="hljs-meta">@Subscribe</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveMessage</span><span class="hljs-params">(MessageEvent event)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;Received message: &quot;</span> + event.getMessage());<br>        Thread.sleep((<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">5</span>) + <span class="hljs-number">1</span>) * <span class="hljs-number">1000</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 创建一个事件总线</span><br>        <span class="hljs-type">EventBus</span> <span class="hljs-variable">eventBus</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventBus</span>();<br>        <span class="hljs-comment">// 注册订阅者</span><br>        <span class="hljs-type">MessageSubscriber</span> <span class="hljs-variable">subscriber</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageSubscriber</span>();<br>        eventBus.register(subscriber);<br>        <span class="hljs-comment">// 发布事件</span><br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus1!&quot;</span>));<br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus2!&quot;</span>));<br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus3!&quot;</span>));<br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus4!&quot;</span>));<br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus5!&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240412183032548.png" alt="image-20240412183032548"></p><center>（图片展示为即使消费速度快慢不同仍依次消费）</center><h4 id="异步消费-AsyncEventBus"><a href="#异步消费-AsyncEventBus" class="headerlink" title="异步消费-AsyncEventBus"></a>异步消费-AsyncEventBus</h4><p>对于AsyncEventBus.post方法会立即将事件加入到事件队列中，但它并不会等待事件的消费者（订阅者）处理完一条消息再继续发布下一条消息。相反，它会在将事件放入队列后立即返回，允许代码继续执行。</p><p>异步事件处理的机制会确保订阅者在后台线程中处理事件，因此即使在一条事件还未被完全处理完成时，<code>AsyncEventBus</code> 也可以接受和处理其他事件。</p><p>这意味着，在使用 <code>AsyncEventBus</code> 时，即使在短时间内多次调用 <code>post</code> 方法来发布多个事件，它们也会被立即加入到事件队列中，并在后台线程中异步处理。</p><blockquote><p>验证代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.common.eventbus.AsyncEventBus;<br><span class="hljs-keyword">import</span> com.google.common.eventbus.Subscribe;<br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-comment">// 定义一个事件类</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageEvent</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br>&#125;<br><br><span class="hljs-comment">// 定义一个订阅者</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageSubscriber</span> &#123;<br>    <span class="hljs-meta">@Subscribe</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveMessage</span><span class="hljs-params">(MessageEvent event)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;Received message: &quot;</span> + event.getMessage());<br>        Thread.sleep((<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">5</span>) + <span class="hljs-number">1</span>) * <span class="hljs-number">1000</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 创建一个异步事件总线</span><br>        <span class="hljs-type">AsyncEventBus</span> <span class="hljs-variable">eventBus</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncEventBus</span>(Executors.newCachedThreadPool());<br>        <span class="hljs-comment">// 注册订阅者</span><br>        <span class="hljs-type">MessageSubscriber</span> <span class="hljs-variable">subscriber</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageSubscriber</span>();<br>        eventBus.register(subscriber);<br>        <span class="hljs-comment">// 发布事件</span><br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus1!&quot;</span>));<br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus2!&quot;</span>));<br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus3!&quot;</span>));<br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus4!&quot;</span>));<br>        eventBus.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEvent</span>(<span class="hljs-string">&quot;Hello, EventBus5!&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240412185436477.png" alt="image-20240412185436477"></p><center>（图片展示为消费速度快慢不同导致执行结果次序不同）</center>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>EventBus</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo giscus配置评论功能</title>
    <link href="/2024/04/07/Hexo-giscus%E9%85%8D%E7%BD%AE%E8%AF%84%E8%AE%BA%E5%8A%9F%E8%83%BD/"/>
    <url>/2024/04/07/Hexo-giscus%E9%85%8D%E7%BD%AE%E8%AF%84%E8%AE%BA%E5%8A%9F%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<blockquote><p>注意：本文以Fluid主题当示例来介绍如何配置评论，其他主题请根据对应用户手册配置</p></blockquote><p>Giscus 允许你将 GitHub Discussions 集成到你的网站上作为评论系统。这样做的好处是评论数据存储在 GitHub 上，不需要第三方服务。</p><p>官方地址：<a href="https://giscus.app/">https://giscus.app/</a></p><ul><li><p>首先先看看自己的theme&#x2F;fluid下是否包含giscus相关的文件，如果fluid版本过旧没有相关文件就要先更新fluid支持giscus</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm update --save hexo-theme-fluid<br></code></pre></td></tr></table></figure></li><li><p>新建github仓库</p></li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081715639.png" alt="image-20220508171452067"></p><p>（我这里已经创建过了，所以显示报错）</p><ul><li>github仓库启用Discussions功能 settings-&gt;General-&gt;Features</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240407175728062.png" alt="image-20240407175728062"></p><ul><li>点击链接安装gisacus <a href="https://github.com/apps/giscus">https://github.com/apps/giscus</a></li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240407175530551.png" alt="image-20240407175530551"></p><ul><li>然后根据官网提示填写对应信息</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240407175638999.png" alt="image-20240407175638999"></p><ul><li>然后就能获取到repo-id等相关信息</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240407175938792.png" alt="image-20240407175938792"></p><ul><li>修改_config.fluid.yml文件</li></ul><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">giscus</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">repo</span><span class="hljs-punctuation">:</span> <span class="hljs-string">xxxx/xxxx</span><br>  <span class="hljs-attribute">repo-id</span><span class="hljs-punctuation">:</span> <span class="hljs-string">xxxx</span><br>  <span class="hljs-attribute">category</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Announcements</span><br>  <span class="hljs-attribute">category-id</span><span class="hljs-punctuation">:</span> <span class="hljs-string">xxxx</span><br>  <span class="hljs-comment"># Available values: pathname | url | title | og:title</span><br>  <span class="hljs-attribute">mapping</span><span class="hljs-punctuation">:</span> <span class="hljs-string">pathname</span><br>  <span class="hljs-comment"># Available values: 0 | 1</span><br>  <span class="hljs-attribute">reactions-enabled</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br>   <span class="hljs-comment"># Available values: 0 | 1</span><br>  <span class="hljs-attribute">emit-metadata</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br>  <span class="hljs-comment"># Available values: light | dark | dark_high_contrast | transparent_dark | preferred-color-scheme</span><br>  <span class="hljs-attribute">theme</span><span class="hljs-punctuation">:</span> <span class="hljs-string">preferred_color_scheme</span><br>  <span class="hljs-comment"># Available values: en | zh-CN</span><br>  <span class="hljs-attribute">lang</span><span class="hljs-punctuation">:</span> <span class="hljs-string">zh-CN</span><br>  <span class="hljs-comment"># Place the comment box above the comments</span><br>  <span class="hljs-attribute">input-position</span><span class="hljs-punctuation">:</span> <span class="hljs-string">top</span><br></code></pre></td></tr></table></figure><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs coq">comments:<br>  enable: true<br>  # 指定的插件，需要同时设置对应插件的必要参数<br>  # The specified plugin needs to <span class="hljs-built_in">set</span> the necessary parameters <span class="hljs-built_in">at</span> the same <span class="hljs-built_in">time</span><br>  # <span class="hljs-keyword">Options</span>: utterances | <span class="hljs-type">disqus</span> | <span class="hljs-type">gitalk</span> | <span class="hljs-type">valine</span> | <span class="hljs-type">waline</span> | <span class="hljs-type">changyan</span> | <span class="hljs-type">livere</span> | <span class="hljs-type">remark42</span> | <span class="hljs-type">twikoo</span> | <span class="hljs-type">cusdis</span><br>  type: giscus<br></code></pre></td></tr></table></figure><ul><li>打开自己的网站看到以下评论框就大功告成</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240407183951630.png" alt="image-20240407183951630"></p><p>注意：以前用Utterances的可以把github issue 转成discussion</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240407185028973.png" alt="image-20240407185028973"></p>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用Github-Action持续部署Springboot或vue</title>
    <link href="/2024/01/11/%E4%BD%BF%E7%94%A8Github-Action%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2Springboot%E6%88%96vue/"/>
    <url>/2024/01/11/%E4%BD%BF%E7%94%A8Github-Action%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2Springboot%E6%88%96vue/</url>
    
    <content type="html"><![CDATA[<p>GitHub Actions 是 GitHub 提供的一项持续集成 (CI) 和持续部署 (CD) 服务。它允许你在代码仓库中定义和运行自动化的工作流程，以响应存储库中的事件或调度。GitHub Actions 可以用于构建、测试、打包和部署项目，也可以执行其他自动化任务。</p><blockquote><p>详细github action相关信息请看最底部</p></blockquote><p><strong>第一步需要先配置secrets，保证我们的服务器信息不暴露</strong></p><p>GitHub Actions 中的 secrets 和 variables 都是用于存储和访问敏感信息或配置的机制</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20240111105350117.png" alt="image-20240111105350117"></p><p>因为我的服务器用的宝塔面板环境，加上构建出来的包和文件并不是很大，所以使用的方式是先在github action的环境构建打包，然后将包发送到目标服务器。你也可以在github action里让目标服务器执行命令去做git，构建，部署，启动等等相关的</p><h2 id="Springboot"><a href="#Springboot" class="headerlink" title="Springboot"></a>Springboot</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Java</span> <span class="hljs-string">CI</span> <span class="hljs-string">with</span> <span class="hljs-string">Maven</span><br><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">&quot;master&quot;</span> ]<br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">build:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <br>    <span class="hljs-attr">steps:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">JDK</span> <span class="hljs-number">17</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v3</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">java-version:</span> <span class="hljs-string">&#x27;17&#x27;</span><br>        <span class="hljs-attr">distribution:</span> <span class="hljs-string">&#x27;temurin&#x27;</span><br>        <span class="hljs-attr">cache:</span> <span class="hljs-string">maven</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">Maven</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">mvn</span> <span class="hljs-string">-B</span> <span class="hljs-string">package</span> <span class="hljs-string">--file</span> <span class="hljs-string">pom.xml</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">jar</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">cross-the-world/ssh-scp-ssh-pipelines@latest</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">host:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HOST</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">user:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.USERNAME</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">pass:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">22</span><br>        <span class="hljs-attr">scp:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          ./target/springboot.jar =&gt; /home/</span><br><span class="hljs-string"></span>        <span class="hljs-attr">last_ssh:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          JAR_NAME=&quot;springboot.jar&quot;; PID=$(ps aux | grep &quot;$JAR_NAME&quot; | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;); if [ -n &quot;$PID&quot; ]; then kill -9 $PID &amp;&amp; echo &quot;进程 $PID 已被杀死&quot;; else echo &quot;未找到与 $JAR_NAME 相关的进程&quot;; fi</span><br><span class="hljs-string">          /usr/bin/java -jar -Xmx1024M -Xms256M  /home/springboot.jar &amp;</span><br></code></pre></td></tr></table></figure><h2 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Server</span><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">&quot;master&quot;</span> ]<br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">deploy:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span> <br><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">node-version:</span> <span class="hljs-number">16</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">yarn</span> <br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">project</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">yarn</span> <span class="hljs-string">generate</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">zip</span> <span class="hljs-string">dist</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">zip</span> <span class="hljs-string">-r</span> <span class="hljs-string">dist.zip</span> <span class="hljs-string">dist/</span><br><br>        <span class="hljs-comment"># 部署到服务器</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">🚀</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">cross-the-world/ssh-scp-ssh-pipelines@latest</span><br>        <span class="hljs-attr">with:</span><br>            <span class="hljs-attr">host:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HOST</span> <span class="hljs-string">&#125;&#125;</span><br>            <span class="hljs-attr">user:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.USERNAME</span> <span class="hljs-string">&#125;&#125;</span><br>            <span class="hljs-attr">pass:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">22</span><br>            <span class="hljs-attr">scp:</span> <span class="hljs-string">|</span><br><span class="hljs-string">                &#x27;./dist.zip&#x27; =&gt; /home</span><br><span class="hljs-string"></span>            <span class="hljs-attr">last_ssh:</span> <span class="hljs-string">|</span><br><span class="hljs-string">                cd /home/</span><br><span class="hljs-string">                rm -rf dist/ || true</span><br><span class="hljs-string">                unzip dist.zip</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h2 id="常见的-GitHub-Actions-YAML-语法和关键概念"><a href="#常见的-GitHub-Actions-YAML-语法和关键概念" class="headerlink" title="常见的 GitHub Actions YAML 语法和关键概念"></a>常见的 GitHub Actions YAML 语法和关键概念</h2><p>GitHub Actions 使用 YAML 文件来定义工作流程。以下是一些常见的 GitHub Actions YAML 语法和关键概念：</p><h3 id="工作流程（Workflow）的定义："><a href="#工作流程（Workflow）的定义：" class="headerlink" title="工作流程（Workflow）的定义："></a>工作流程（Workflow）的定义：</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">My</span> <span class="hljs-string">Workflow</span><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">my_job:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">Repository</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span><br>      <span class="hljs-comment"># 其他步骤...</span><br></code></pre></td></tr></table></figure><ul><li><code>name</code>: 工作流程的名称。</li><li><code>on</code>: 触发工作流程的事件，例如 <code>push</code> 到特定分支。</li><li><code>jobs</code>: 包含一个或多个任务的部分。</li></ul><h3 id="任务（Job）的定义："><a href="#任务（Job）的定义：" class="headerlink" title="任务（Job）的定义："></a><strong>任务（Job）的定义：</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">my_job:</span><br>  <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>  <span class="hljs-attr">steps:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Step</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Hello, World!&quot;</span><br>    <span class="hljs-comment"># 其他步骤...</span><br></code></pre></td></tr></table></figure><ul><li><code>runs-on</code>: 指定任务运行的操作系统和环境。</li><li><code>steps</code>: 包含一个或多个步骤的列表。</li></ul><h3 id="步骤（Steps）的定义："><a href="#步骤（Steps）的定义：" class="headerlink" title="步骤（Steps）的定义："></a><strong>步骤（Steps）的定义：</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">steps:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Step</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Hello, World!&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Step</span> <span class="hljs-number">2</span><br>    <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span><br>    <span class="hljs-attr">with:</span><br>      <span class="hljs-attr">node-version:</span> <span class="hljs-string">&#x27;14&#x27;</span><br>  <span class="hljs-comment"># 其他步骤...</span><br></code></pre></td></tr></table></figure><ul><li><code>name</code>: 步骤的名称。</li><li><code>run</code>: 执行的命令或脚本。</li><li><code>uses</code>: 使用的动作（可以是内置动作或自定义动作）。</li><li><code>with</code>: 传递给动作的参数。</li></ul><h3 id="触发器（Trigger）的定义："><a href="#触发器（Trigger）的定义：" class="headerlink" title="触发器（Trigger）的定义："></a><strong>触发器（Trigger）的定义：</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span><br>  <span class="hljs-attr">pull_request:</span><br>    <span class="hljs-attr">branches:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">feature/*</span><br></code></pre></td></tr></table></figure><ul><li><code>on</code>: 触发工作流程的事件。</li><li><code>push</code>: 代码推送事件。</li><li><code>pull_request</code>: 合并请求事件。</li></ul><h3 id="环境变量（Environment-Variables）的定义："><a href="#环境变量（Environment-Variables）的定义：" class="headerlink" title="环境变量（Environment Variables）的定义："></a><strong>环境变量（Environment Variables）的定义：</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">my_job:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">env:</span><br>      <span class="hljs-attr">MY_VARIABLE:</span> <span class="hljs-string">my_value</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-comment"># 步骤...</span><br></code></pre></td></tr></table></figure><ul><li><code>env</code>: 定义任务运行时的环境变量。</li></ul><h2 id="Secrets-和-Variables"><a href="#Secrets-和-Variables" class="headerlink" title="Secrets 和 Variables"></a>Secrets 和 Variables</h2><h3 id="使用-Secrets："><a href="#使用-Secrets：" class="headerlink" title="使用 Secrets："></a>使用 Secrets：</h3><p>GitHub Actions 的 secrets 是用于存储敏感信息，例如 API 密钥、访问令牌等。这些 secrets 可以被工作流程中的步骤引用，但它们是加密的，并且只有在运行工作流程时才会暴露给步骤。</p><ol><li><p><strong>在 GitHub 存储库中创建 secret：</strong></p><ul><li>转到 GitHub 存储库的页面。</li><li>在存储库顶部导航栏中，点击 “Settings”。</li><li>在左侧边栏中，选择 “Secrets”。</li><li>点击 “New repository secret”，然后输入 secret 名称和值。</li></ul></li><li><p><strong>在工作流程中使用 secret：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">my_job:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">secret</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.MY_SECRET</span> <span class="hljs-string">&#125;&#125;</span><br></code></pre></td></tr></table></figure></li></ol><p>这里 <code>MY_SECRET</code> 是你创建的 secret 的名称，可以在步骤中使用 <code>$&#123;&#123; secrets.MY_SECRET &#125;&#125;</code> 引用它。</p><h3 id="使用-Variables："><a href="#使用-Variables：" class="headerlink" title="使用 Variables："></a>使用 Variables：</h3><p>GitHub Actions 的 variables 是由 GitHub 提供的一组默认环境变量，同时你也可以定义自己的环境变量。这些变量可以在工作流程的任何步骤中使用。</p><ol><li><p><strong>在工作流程中使用 GitHub 提供的 variables：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">my_job:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">GitHub-provided</span> <span class="hljs-string">variable</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">github.event_name</span> <span class="hljs-string">&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>这里的 <code>github.event_name</code> 是 GitHub 提供的一个默认变量，表示触发工作流程的事件的名称。</p></li><li><p><strong>在工作流程中定义自己的 variables：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">my_job:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">env:</span><br>      <span class="hljs-attr">MY_VARIABLE:</span> <span class="hljs-string">my_value</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">custom</span> <span class="hljs-string">variable</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">$MY_VARIABLE</span><br></code></pre></td></tr></table></figure></li></ol><p>在 <code>env</code> 部分定义自己的环境变量，然后在步骤中使用 <code>$MY_VARIABLE</code> 引用它。</p><p>注意：GitHub Actions 中的环境变量（包括 secrets 和 variables）在步骤中的引用方式使用 <code>$&#123;&#123; ... &#125;&#125;</code> 语法。此外，secrets 只能在工作流程的同一存储库中使用，而 variables 则可以在不同存储库的工作流程中共享。</p>]]></content>
    
    
    
    <tags>
      
      <tag>github action</tag>
      
      <tag>springboot</tag>
      
      <tag>vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Easypoi-大数据量导出</title>
    <link href="/2024/01/09/Easypoi-%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%87%8F%E5%AF%BC%E5%87%BA/"/>
    <url>/2024/01/09/Easypoi-%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%87%8F%E5%AF%BC%E5%87%BA/</url>
    
    <content type="html"><![CDATA[<p>EasyExcel 在处理 Excel 文件时，需要占用一定的内存。如果导出的数据量过大，可能导致内存占用过高，从而引发 CPU 过高的问题。并发访问导出接口也会导致性能问题，所以尽量在数据量比较大的导出接口添加锁控制。</p><blockquote><p>以下是虚化业务后的代码，记录一下遇到的问题解决方案</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 导出大数据量Excel文件</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> response HttpServletResponse对象，用于设置响应头和输出流</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> requestForm 包含查询参数的表单对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> ParseException 当日期解析发生错误时抛出异常</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> IOException 当输入或输出操作发生错误时抛出异常</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportBigExcelist</span><span class="hljs-params">(HttpServletResponse response, RequestForm requestForm)</span> <span class="hljs-keyword">throws</span> ParseException, IOException &#123;<br>    <span class="hljs-comment">// 设置Excel导出参数，包括标题和sheet名称</span><br>    <span class="hljs-type">ExportParams</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExportParams</span>(<span class="hljs-string">&quot;标题&quot;</span>, <span class="hljs-string">&quot;sheet名称&quot;</span>);<br><br>    <span class="hljs-comment">// 使用EasyExcel工具类导出大数据Excel文件</span><br>    <span class="hljs-type">Workbook</span> <span class="hljs-variable">workbook</span> <span class="hljs-operator">=</span> ExcelExportUtil.exportBigExcel(params, ExcelDto.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IExcelExportServer</span>() &#123;<br>        <span class="hljs-meta">@SneakyThrows</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">selectListForExcelExport</span><span class="hljs-params">(Object queryParams, <span class="hljs-type">int</span> page)</span> &#123;<br>            <span class="hljs-comment">// 强制转换查询参数为RequestForm对象</span><br>            <span class="hljs-type">RequestForm</span> <span class="hljs-variable">tempForm</span> <span class="hljs-operator">=</span> (RequestForm) queryParams;<br>            <br>            <span class="hljs-comment">// 设置分页参数</span><br>            tempForm.setPage(page);<br>            tempForm.setPageSize(<span class="hljs-number">10000</span>);<br>            <br>            <span class="hljs-comment">// 调用业务服务进行分页查询逻辑</span><br>            List&lt;ExcelDto&gt; list = service.selectlist(tempForm);<br>            <br>            <span class="hljs-comment">// 将查询结果转化为List&lt;Object&gt;</span><br>            List&lt;Object&gt; objects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(list);<br>            <br>            <span class="hljs-comment">// 如果查询结果为空，则返回null</span><br>            <span class="hljs-keyword">if</span> (list.size() == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <br>            <span class="hljs-keyword">return</span> objects;<br>        &#125;<br>    &#125;, requestForm);<br><br>    <span class="hljs-comment">// 设置响应头，指定导出文件类型为Excel</span><br>    response.setHeader(<span class="hljs-string">&quot;content-Type&quot;</span>, <span class="hljs-string">&quot;application/vnd.ms-excel&quot;</span>);<br>    <span class="hljs-comment">// 设置响应头，指定导出文件的名称，并对文件名进行UTF-8编码</span><br>    response.setHeader(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename=&quot;</span> + URLEncoder.encode(<span class="hljs-string">&quot;filename.xls&quot;</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>    <br>    <span class="hljs-comment">// 将生成的Excel文件写入到响应输出流</span><br>    workbook.write(response.getOutputStream());<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Easypoi</tag>
      
      <tag>Excel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Threadlocal-内存泄露问题</title>
    <link href="/2024/01/03/Threadlocal-%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98/"/>
    <url>/2024/01/03/Threadlocal-%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://cason.work/2022/06/16/Threadlocal%E7%9A%84%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3%E5%92%8C%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Threadlocal的简单理解和部分源码分析 - Blog|CasonMo</a></p></blockquote><p>在ThreadLocalMap中，用Entry来保存K-V结构数据的。Entry的构造方法已经限定Entry中key只能是ThreadLocal对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&gt; &#123;<br>    <span class="hljs-comment">/** The value associated with this ThreadLocal. */</span><br>    Object value;<br><br>    Entry(ThreadLocal k, Object v) &#123;<br>        <span class="hljs-built_in">super</span>(k);<br>        value = v;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Entry继承自WeakReference（弱引用，生命周期只能存活到下次GC前），但只有Key是弱引用类型的，Value并非弱引用。（问题马上就来了）</p><blockquote><h4 id="四种引用类型"><a href="#四种引用类型" class="headerlink" title="四种引用类型"></a>四种引用类型</h4><ol><li>强引用（StrongReference）</li></ol><p>  类似Object obj &#x3D; new Object()这类似的引用，强引用在程序代码中普遍存在，只要强引用在，垃圾搜集器永远不会搜集被引用的对象。也就是说，<strong>宁愿出现内存溢出（OutOfMemoryError），也不会回收这些对象</strong></p><ol start="2"><li>软引用（SoftReference）</li></ol><p>  在Java中用java.lang.ref.SoftReference类来表示。<strong>对于软引用关联着的对象，只有在内存不足的时候JVM才会回收该对象</strong></p><ol start="3"><li>弱引用（WeakReference）</li></ol><p>  弱引用也是用来描述非必需对象的，用java.lang.ref.WeakReference类来表示，<strong>当JVM进行垃圾回收时，无论内存是否充足，都会回收被弱引用关联的对象。</strong></p><ol start="4"><li>虚引用 （PhantomReference）</li></ol><p>  java.lang.ref.PhantomReference类表示。如果一个对象与虚引用关联，则跟没有引用与之关联一样，<strong>在任何时候都可能被垃圾回收器回收</strong>。</p><p>  虚引用与软引用和弱引用的区别：<strong>虚引用必须和引用队列联合使用。</strong></p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-type">ReferenceQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span> ();<br><span class="hljs-type">PhantomReference</span> <span class="hljs-variable">pr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhantomReference</span> (object, queue); <br></code></pre></td></tr></table></figure></blockquote><p>由于ThreadLocalMap的key是弱引用，而Value是强引用。这就导致了一个问题，ThreadLocal在没有外部对象强引用时，发生GC时弱引用Key会被回收，而Value不会回收。</p><p>当线程没有结束，但是ThreadLocal已经被回收，则可能导致线程中存在<code>ThreadLocalMap&lt;null, Object&gt;</code>的键值对，造成内存泄露。（ThreadLocal被回收，ThreadLocal关联的线程共享变量还存在）。</p><h2 id="如何避免泄漏"><a href="#如何避免泄漏" class="headerlink" title="如何避免泄漏"></a>如何避免泄漏</h2><p>为了防止此类情况的出现，我们有两种手段。</p><ul><li><p>使用完线程共享变量后，显示调用<code>ThreadLocalMap.remove</code>方法清除线程共享变量；</p><p>既然Key是弱引用，那么我们要做的事，就是在调用ThreadLocal的<code>get()</code>、<code>set()</code>方法时完成后再调用remove方法，将Entry节点和Map的引用关系移除，这样整个Entry对象在GC Roots分析后就变成不可达了，下次GC的时候就可以被回收。</p></li><li><p>JDK建议ThreadLocal定义为<code>private static</code>，这样ThreadLocal的弱引用问题则不存在了。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>并发编程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ThreadLocal</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mybatisplus-动态获取sql字符串</title>
    <link href="/2023/12/11/Mybatisplus-%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96sql%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <url>/2023/12/11/Mybatisplus-%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96sql%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>记录贴</p></blockquote><p>借助mybatisplus构建动态 SQL 查询语句的功能，来动态构建sql来做presto查询，这样就不用在代码里写sql了</p><p><code>getBoundSql</code> 是 MyBatis 中 <code>org.apache.ibatis.mapping.BoundSql</code> 接口的方法，用于获取一个表示 SQL 语句和相关参数映射的对象。<code>BoundSql</code> 实例包含了预编译的 SQL 语句以及参数映射信息，可以用于执行数据库操作。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.ibatis.mapping.BoundSql;<br><span class="hljs-keyword">import</span> org.apache.ibatis.mapping.MappedStatement;<br><span class="hljs-keyword">import</span> org.apache.ibatis.mapping.ParameterMapping;<br><span class="hljs-keyword">import</span> org.apache.ibatis.reflection.MetaObject;<br><span class="hljs-keyword">import</span> org.apache.ibatis.session.Configuration;<br><span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicSqlUtils</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SqlSession sqlSession;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">(Class clz,String method, Object obj)</span> &#123;<br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> sqlSession.getConfiguration();<br>        <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(clz.getName() + <span class="hljs-string">&quot;.&quot;</span> + method);<br>        <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(obj);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">parsedSql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>      <span class="hljs-comment">// #&#123;&#125;会被替换成? ,$&#123;&#125;才会被替换成对应的值</span><br>        <span class="hljs-comment">// 获取参数映射</span><br>        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();<br>        <span class="hljs-comment">// 获取参数对象</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();<br>        <span class="hljs-comment">// 打印参数占位符和对应的参数值</span><br>        <span class="hljs-keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> parameterMapping.getProperty();<br>            <span class="hljs-comment">// 获取参数值</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (boundSql.hasAdditionalParameter(property)) &#123;<br>                <span class="hljs-comment">// 对于额外的参数，直接获取</span><br>                value = boundSql.getAdditionalParameter(property);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterObject != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 对于参数对象，通过反射获取属性值</span><br>                <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);<br>                value = metaObject.getValue(property);<br>            &#125;<br>            <span class="hljs-comment">// 替换 SQL 语句中的占位符</span><br>            parsedSql = parsedSql.replaceFirst(<span class="hljs-string">&quot;\\?&quot;</span>, <span class="hljs-string">&quot;&#x27;&quot;</span>+value.toString()+<span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> parsedSql;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;demoList&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.*.dto.DemoDTO&quot;</span>&gt;</span><br>  select * from t demo where 1=1<br>  <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;form.status != null&quot;</span>&gt;</span><br>     and  t.status = #&#123;form.status&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>mapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DemoMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;DemoEntity&gt; &#123;<br>List&lt;DemoDTO&gt; <span class="hljs-title function_">demoList</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;form&quot;)</span> DemoForm form)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>调用</p><p>值得注意的是，如果使用了@Param(“form”)给方法参数起别名，那么就要使用Map来包装一下map.put(“form”,原来的form对象)，否则获取不到form</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>Map&lt;String, Object&gt; map2 = JSON.parseObject(JSON.toJSONString(demoForm), <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, Object&gt;&gt;() &#123;&#125;);<br>map.put(<span class="hljs-string">&quot;form&quot;</span>, map2);<br>String sql=dynamicSqlUtils.getSql(DemoMapper.class, <span class="hljs-string">&quot;demoList&quot;</span>, map);<br><span class="hljs-comment">//presto.query(sql) 或者 hive.query(sql)</span><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
      <tag>presto</tag>
      
      <tag>SQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>简单实现分流功能</title>
    <link href="/2023/12/11/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E5%88%86%E6%B5%81%E5%8A%9F%E8%83%BD/"/>
    <url>/2023/12/11/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E5%88%86%E6%B5%81%E5%8A%9F%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<p>逻辑比较简单就是对字符串一顿加解密操作然后hashcode然后取模100，然后看取模结果落在哪个组的区间</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.util.CollectionUtils;<br><span class="hljs-keyword">import</span> org.springframework.util.DigestUtils;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.math.RoundingMode;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Percent</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 流量切分算法（随机）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> rid       rid</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> groupMap 对照组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 分组</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">choose</span><span class="hljs-params">(String rid, Map&lt;String, Double&gt; groupMap)</span> &#123;<br>        <span class="hljs-keyword">if</span> (groupMap == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        List&lt;String&gt; groups = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(groupMap.keySet());<br>        List&lt;Double&gt; rates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(groupMap.values());<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(groupMap) || CollectionUtils.isEmpty(rates)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">digest</span> <span class="hljs-operator">=</span> DigestUtils.md5DigestAsHex(rid.getBytes());<br>        <span class="hljs-type">int</span> <span class="hljs-variable">hashCode</span> <span class="hljs-operator">=</span> digest.hashCode();<br>        <span class="hljs-comment">//百分比</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> Math.abs(hashCode) % <span class="hljs-number">100</span>;<br>        <span class="hljs-comment">//murmur3_32算法比较好，分布很均匀</span><br>        <span class="hljs-comment">//int random = Math.abs(Hashing.murmur3_32().hashString(rid, Charset.forName(&quot;utf-8&quot;)).asInt())%100;</span><br><br>        <span class="hljs-type">double</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;<br>        <span class="hljs-type">double</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; rates.size(); i++) &#123;<br>            end = end + rates.get(i);<br>            <span class="hljs-keyword">if</span> (start &lt;= random &amp;&amp; random &lt; end) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> groups.get(i);<br>                <span class="hljs-keyword">for</span> (String tempGroup : groups) &#123;<br>                    <span class="hljs-keyword">if</span> (group.equals(tempGroup)) &#123;<br>                        log.info(<span class="hljs-string">&quot;choose [rid]: &#123;&#125; [group]: &#123;&#125; random ;&#123;&#125;&quot;</span>, rid, group, random);<br>                        <span class="hljs-keyword">return</span> group;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            start = start + rates.get(i);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>写个main方法测试一下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    Map&lt;String, Double&gt; groups = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    groups.put(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-number">15d</span>);<br>    groups.put(<span class="hljs-string">&quot;g2&quot;</span>, <span class="hljs-number">25d</span>);<br>    groups.put(<span class="hljs-string">&quot;g3&quot;</span>, <span class="hljs-number">30d</span>);<br>    groups.put(<span class="hljs-string">&quot;g4&quot;</span>, <span class="hljs-number">30d</span>);<br>    Map&lt;String, Integer&gt; groupCountMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-number">100000</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; total; i++) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">group_super_id</span> <span class="hljs-operator">=</span> choose(UUID.randomUUID().toString(), groups);<br>        <span class="hljs-keyword">if</span> (!groupCountMap.containsKey(group_super_id)) &#123;<br>            groupCountMap.put(group_super_id, <span class="hljs-number">1</span>);<br>        &#125;<br>        groupCountMap.put(group_super_id, groupCountMap.get(group_super_id) + <span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : groupCountMap.entrySet()) &#123;<br>        log.info(<span class="hljs-string">&quot;group : &#123;&#125; count : &#123;&#125; percent :&#123;&#125;&quot;</span>, entry.getKey(), entry.getValue(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(entry.getValue()).divide(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(total), <span class="hljs-number">4</span>, RoundingMode.UP).multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>)) + <span class="hljs-string">&quot;%&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>结果逼近预设值</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231211160804894.png" alt="image-20231211160804894"></p>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>分流</tag>
      
      <tag>算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo-生成站点地图（sitemap）</title>
    <link href="/2023/12/08/Hexo-%E7%94%9F%E6%88%90%E7%AB%99%E7%82%B9%E5%9C%B0%E5%9B%BE%EF%BC%88sitemap%EF%BC%89/"/>
    <url>/2023/12/08/Hexo-%E7%94%9F%E6%88%90%E7%AB%99%E7%82%B9%E5%9C%B0%E5%9B%BE%EF%BC%88sitemap%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h3 id="SiteMap是什么"><a href="#SiteMap是什么" class="headerlink" title="SiteMap是什么"></a>SiteMap是什么</h3><p>Sitemap 是一种列举了网站中所有页面的 XML 文件。它可以被搜索引擎（如 Google、Bing）用来更有效地抓取网站，了解网站的结构。Sitemap 文件提供了网站上每个页面的链接以及有关页面最后修改时间、更新频率和相对重要性的附加信息，这有助于搜索引擎确定哪些页面应该优先考虑以及多久抓取一次这些页面。</p><p>对于大型网站、具有许多动态页面的网站或新网站，Sitemap 尤其重要，因为它能确保搜索引擎能够发现并索引网站上的所有重要页面。即便对于小型网站，拥有 Sitemap 也有助于提高SEO（搜索引擎优化）的效果。</p><p>站点地图有两种常见类型：</p><ol><li><p>XML Sitemap：<br>这是给搜索引擎的，规范定义比较严格，它使用 XML 语言编写，一般会放在网站的根目录下，并可以通过 &#x2F;sitemap.xml 访问。这样做可以使搜索引擎更容易找到和抓取所有的页面。</p></li><li><p>HTML Sitemap：<br>这类 Sitemap 是给用户的，通常是一个简单的 HTML 页面，包含了网站上所有或是最重要的页面的链接。这可以帮助用户快速导航到他们想要找的页面，并提高网站的用户体验。</p></li></ol><h3 id="Hexo如何生成Sitemap"><a href="#Hexo如何生成Sitemap" class="headerlink" title="Hexo如何生成Sitemap"></a>Hexo如何生成Sitemap</h3><ul><li><p>Google 版本</p><p><code>npm install hexo-generator-sitemap --save</code></p></li><li><p>Baidu 版本</p><p><code>npm install hexo-generator-baidu-sitemap --save</code></p></li><li><p>在<code>_config.yml</code>中找到<code>url</code>，改成你自己的域名，影响生成的sitemap下的每一条链接</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># URL</span><br><span class="hljs-comment">## Set your site url here. For example, if you use GitHub Page, set url as &#x27;https://username.github.io/project&#x27;</span><br><span class="hljs-attr">url:</span> <span class="hljs-string">&lt;这里&gt;</span><br><span class="hljs-attr">permalink:</span> <span class="hljs-string">:year/:month/:day/:title/</span><br><span class="hljs-attr">permalink_defaults:</span><br><span class="hljs-attr">pretty_urls:</span><br>  <span class="hljs-attr">trailing_index:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># Set to false to remove trailing &#x27;index.html&#x27; from permalinks</span><br>  <span class="hljs-attr">trailing_html:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># Set to false to remove trailing &#x27;.html&#x27; from permalinks</span><br></code></pre></td></tr></table></figure></li><li><p>打包自动在<code>public</code>下生成<code>sitemap.xml</code>和<code>baidusitemap.xml</code></p><p><code>hexo g -d</code></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231208174125354.png" alt="image-20231208174125354"></p><p>浏览器访问<code>https://&lt;域名&gt;/sitemap.xml</code>和<code>https://&lt;域名&gt;/baidusitemap.xml</code>即可看到内容<img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231208174254230.png" alt="image-20231208174254230"></p></li></ul><h3 id="提交站点到百度"><a href="#提交站点到百度" class="headerlink" title="提交站点到百度"></a>提交站点到百度</h3><ul><li><p>到百度资源平台提交站点</p><blockquote><p><a href="https://ziyuan.baidu.com/site/index#/">站点管理_站长工具_百度搜索资源平台 (baidu.com)</a></p></blockquote><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231208174539329.png" alt="image-20231208174539329"></p></li><li><p>提交Sitemap<br><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231208174443927.png" alt="image-20231208174443927"></p></li></ul><h3 id="提交站点到谷歌"><a href="#提交站点到谷歌" class="headerlink" title="提交站点到谷歌"></a>提交站点到谷歌</h3><ul><li><p>到google search console 提交站点</p><blockquote><p><a href="https://search.google.com/search-console">https://search.google.com/search-console</a></p></blockquote><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231208174713820.png" alt="image-20231208174713820"></p></li><li><p>提交站点地图Sitemap</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231208174929691.png" alt="image-20231208174929691"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
      <tag>Seo</tag>
      
      <tag>Sitemap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Easypoi-导出excel单元格添加下拉列表</title>
    <link href="/2023/12/08/Easypoi-%E5%AF%BC%E5%87%BAexcel%E5%8D%95%E5%85%83%E6%A0%BC%E6%B7%BB%E5%8A%A0%E4%B8%8B%E6%8B%89%E5%88%97%E8%A1%A8/"/>
    <url>/2023/12/08/Easypoi-%E5%AF%BC%E5%87%BAexcel%E5%8D%95%E5%85%83%E6%A0%BC%E6%B7%BB%E5%8A%A0%E4%B8%8B%E6%8B%89%E5%88%97%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<p>我们在使用excel进行批量导入的时候，通常会提供导入模板excel来给用户来规范用户的输入，其中就会用到下拉选项来约束这一种方式</p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231208165732976.png" alt="image-20231208165732976" style="zoom:50%;" /><h3 id="方法一：-Excel"><a href="#方法一：-Excel" class="headerlink" title="方法一：@Excel"></a>方法一：@Excel</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Excel(name = &quot;状态&quot;, width = 25, replace = &#123;&quot;待审_1&quot;, &quot;通过_2&quot;, &quot;驳回_3&quot;&#125;,addressList = true,orderNum = &quot;25&quot;)</span><br><span class="hljs-keyword">private</span> Integer status;<br></code></pre></td></tr></table></figure><p>主要是replace和addressList这两个属性配置。</p><p><code>replace</code>：替换字段内容，通常用于状态字段的显示（例如：”男_1,女_2”）。</p><p><code>addressList</code>：是否生成下拉的选项。</p><blockquote><p><code>@Excel</code> 是 easypoi 中用于 Excel 导入导出的注解，可以用于实体类的字段上，用以定义该字段数据与 Excel 文件中的列的对应关系以及进行导入导出时的各种设置。以下是 <code>@Excel</code> 注解的一些主要属性和它们的功能：</p><ol><li><code>name</code>：设置导出时在表格中的显示名称。</li><li><code>width</code>：列宽度，单位为字符。</li><li><code>height</code>：行高度，单位为字符。</li><li><code>orderNum</code>：导出排序顺序，数值小的先导出。</li><li><code>needMerge</code>：是否需要合并单元格。</li><li><code>mergeVertical</code>：纵向合并内容相同的单元格。</li><li><code>mergeRely</code>：合并依赖于某些列的情况。</li><li><code>replace</code>：替换字段内容，通常用于状态字段的显示（例如：”男_1,女_2”）。</li><li><code>suffix</code>：文本后缀，如%、元、个。</li><li><code>isImportField</code>：是否为导入字段，导入模板时是否需要显示。</li><li><code>exportType</code>：导出类型，指导出文本还是导出图片等类型。</li><li><code>format</code>：时间格式化，比如：”yyyy-MM-dd”。</li><li><code>databaseFormat</code>：数据库格式，通常配合 <code>format</code> 使用。</li><li><code>dict</code>：数据字典标识。</li><li><code>savePath</code>：图片等文件保存路径。</li><li><code>type</code>：字段类型（文本、图片、文件）。</li><li><code>imageType</code>：图片类型，控制导出图片的方式。</li><li><code>suffix</code>：文本类型的字段后缀标记。</li><li><code>statistics</code>：是否统计当前列，生成统计行。</li></ol></blockquote><h3 id="方法二：DataValidation"><a href="#方法二：DataValidation" class="headerlink" title="方法二：DataValidation"></a>方法二：DataValidation</h3><p>由于有的时候我们的下拉列表选项来自数据库，可以使用dict属性搭配IExcelDictHandler，也可以直接在workbook上操作，把列表约束作用到指定单元格</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * firstRow 开始行号 根据此项目，默认为2(下标0开始)</span><br><span class="hljs-comment">     * lastRow  根据此项目，默认为最大65535</span><br><span class="hljs-comment">     * firstCol 区域中第一个单元格的列号 (下标0开始)</span><br><span class="hljs-comment">     * lastCol 区域中最后一个单元格的列号</span><br><span class="hljs-comment">     * strings 下拉内容</span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addDropdown</span><span class="hljs-params">(Workbook workbook,<span class="hljs-type">int</span> firstRow, <span class="hljs-type">int</span> col, String[] strings )</span>&#123;<br>       <span class="hljs-comment">//对工作簿中第一个工作表进行操作</span><br>        <span class="hljs-type">Sheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> workbook.getSheetAt(<span class="hljs-number">0</span>);<br>       <span class="hljs-comment">// 创建`CellRangeAddressList`对象，该对象指定下拉列表的适用区域：</span><br>      <span class="hljs-comment">//该区域从`firstRow`起始行（包含）到第65535行（包含），在`col`列上。（由于我们作用于同一列，所以firstCol=lastCol）</span><br>        <span class="hljs-type">CellRangeAddressList</span> <span class="hljs-variable">cellRangeAddressList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CellRangeAddressList</span>(firstRow, <span class="hljs-number">65535</span>, col,col);<br>        <span class="hljs-type">DataValidationHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> sheet.getDataValidationHelper();<br>       <span class="hljs-comment">//使用传入的字符串数组创建一个显式列表约束，确定下拉列表中的选项</span><br>        <span class="hljs-type">DataValidationConstraint</span> <span class="hljs-variable">dvConstraint</span> <span class="hljs-operator">=</span> helper.createExplicitListConstraint(strings);<br>       <span class="hljs-comment">//把创建的列表约束作用到那些范围内的单元格</span><br>        <span class="hljs-type">DataValidation</span> <span class="hljs-variable">validation</span> <span class="hljs-operator">=</span> helper.createValidation(dvConstraint, cellRangeAddressList);<br>       <span class="hljs-comment">//  作用到sheet上</span><br>        sheet.addValidationData(validation);<br>    &#125;<br></code></pre></td></tr></table></figure><p>但是以上代码有个问题就是，如果下拉选项过多，会无法显示，这时候我们就需要借助一个隐藏的字典sheet，这时候我们就需要修改一下代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addLongDropdown</span><span class="hljs-params">(Workbook workbook,<span class="hljs-type">int</span> firstRow, <span class="hljs-type">int</span> col, String[] strings )</span>&#123;<br>       <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> (XSSFSheet)workbook.getSheetAt(<span class="hljs-number">0</span>);<br>       <span class="hljs-comment">//默认为最大65535</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">endRow</span> <span class="hljs-operator">=</span><span class="hljs-number">65535</span>;<br>       <span class="hljs-comment">//随便起个sheet名</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">hiddenName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hidden&quot;</span>+col;<br>       <span class="hljs-comment">//1.创建隐藏的sheet页。</span><br>       <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">hidden</span> <span class="hljs-operator">=</span> (XSSFSheet)workbook.createSheet(hiddenName);<br>       <span class="hljs-comment">//2.循环赋值（为了防止下拉框的行数与隐藏域的行数相对应，将隐藏域加到结束行之后）</span><br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, length = strings.length; i &lt; length; i++) &#123;<br>           hidden.createRow(endRow + i).createCell(col).setCellValue(strings[i]);<br>       &#125;<br>       <span class="hljs-comment">//创建可被其他单元格引用的名称</span><br>       <span class="hljs-type">Name</span> <span class="hljs-variable">workbookName</span> <span class="hljs-operator">=</span> workbook.createName();<br>       workbookName.setNameName(hiddenName);<br>       <span class="hljs-comment">//3 A1:A代表隐藏域创建第N列createCell(N)时。以A1列开始A行数据获取下拉数组</span><br>       workbookName.setRefersToFormula(hiddenName + <span class="hljs-string">&quot;!A1:A&quot;</span> + (strings.length + endRow));<br>       <span class="hljs-type">DataValidationHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> sheet.getDataValidationHelper();<br>       <span class="hljs-type">DataValidationConstraint</span> <span class="hljs-variable">constraint</span> <span class="hljs-operator">=</span> helper.createFormulaListConstraint(hiddenName);<br>       <span class="hljs-type">CellRangeAddressList</span> <span class="hljs-variable">addressList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CellRangeAddressList</span>(firstRow, endRow, col, col);<br>       <span class="hljs-type">DataValidation</span> <span class="hljs-variable">dataValidation</span> <span class="hljs-operator">=</span> helper.createValidation(constraint, addressList);<br>       <span class="hljs-keyword">if</span> (dataValidation <span class="hljs-keyword">instanceof</span> XSSFDataValidation) &#123;<br>           <span class="hljs-comment">// 数据校验</span><br>           dataValidation.setSuppressDropDownArrow(<span class="hljs-literal">true</span>);<br>           dataValidation.setShowErrorBox(<span class="hljs-literal">true</span>);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           dataValidation.setSuppressDropDownArrow(<span class="hljs-literal">false</span>);<br>       &#125;<br>       <span class="hljs-comment">// 作用在目标sheet上</span><br>       sheet.addValidationData(dataValidation);<br>       <span class="hljs-comment">// 为了用户友好，设置hiddenSheet隐藏</span><br>       workbook.setSheetHidden(workbook.getSheetIndex(hiddenName), <span class="hljs-literal">true</span>);<br>   &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Easypoi</tag>
      
      <tag>Excel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Arthas:排查cpu异常过高的问题</title>
    <link href="/2023/10/27/Arthas-%E6%8E%92%E6%9F%A5cpu%E5%BC%82%E5%B8%B8%E8%BF%87%E9%AB%98%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <url>/2023/10/27/Arthas-%E6%8E%92%E6%9F%A5cpu%E5%BC%82%E5%B8%B8%E8%BF%87%E9%AB%98%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>下载arthas</p><p><code>curl -O https://alibaba.github.io/arthas/arthas-boot.jar</code></p><p>启动arthas</p><p><code>java -jar arthas-boot.jar</code></p><p>dashboard 仪表板</p><blockquote><p>第一部分是显示JVM中运行的所有线程：所在线程组，优先级，线程的状态，CPU的占用率，是否是后台进程等</p><p>第二部分显示的JVM内存的使用情况</p><p>第三部分是操作系统的一些信息和Java版本号</p></blockquote><p><code>dashboard</code></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231226145518601.png" alt="image-20231226145518601"></p><p>通过 thread 命令来获取线程信息</p><blockquote><p>1、当没有参数时，显示所有线程的信息</p><p>thread<br>2、展示当前最忙的前3个线程并打印堆栈</p><p>thread -n 3<br>3、显示1号线程的运行堆栈</p><p>thread 1<br>4、找出当前阻塞其他线程的线程，有时候我们发现应用卡住了， 通常是由于某个线程拿住了某个锁， 并且其他线程都在等待这把锁造成的。 为了排查这类问题， arthas提供了thread -b， 一键找出那个罪魁祸首。</p><p>thread -b<br>5、指定采样时间间隔，每过1000毫秒采样，显示最占时间的3个线程</p><p>thread -i 1000 -n 3<br>6、查看处于等待状态的线程</p></blockquote><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231226145349492.png" alt="image-20231226145349492"></p><p>找对对应方法解决</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Elasticseatch简单实践</title>
    <link href="/2023/09/05/Elasticseatch%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5/"/>
    <url>/2023/09/05/Elasticseatch%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<p>Elasticsearch是一个开源的分布式搜索和分析引擎，用于存储、搜索和分析大量数据。它最初由Elasticsearch BV（现在称为Elastic NV）开发，是Elastic Stack（以前称为ELK Stack）的核心组件之一。Elastic Stack是一个用于日志和数据分析的开源解决方案，包括Elasticsearch、Logstash和Kibana。</p><p>Elasticsearch的主要特点包括：</p><ol><li>分布式性能：Elasticsearch可以轻松地扩展到多个节点，以处理大规模的数据和查询。它使用分片和复制来确保数据的高可用性和性能。</li><li>实时搜索：Elasticsearch能够在文档被索引后几乎立即提供实时搜索结果，使其非常适用于各种应用，包括日志分析、搜索引擎、监控和仪表板等。</li><li>多数据类型支持：Elasticsearch支持多种数据类型，包括文本、数值、日期、地理位置等。这使得它非常灵活，可以应用于各种不同类型的数据分析任务。</li><li>强大的查询功能：Elasticsearch提供了丰富的查询语言和功能，包括全文搜索、模糊搜索、范围查询、聚合分析等，使用户可以针对不同的数据进行复杂的查询和分析。</li><li>可扩展性和插件生态系统：Elasticsearch具有丰富的插件生态系统，可以扩展其功能，包括安全性、监控、报告等方面。</li><li>开源和免费：Elasticsearch是开源软件，可免费使用，并且有一个活跃的社区支持和维护。</li></ol><p>Elasticsearch通常与其他Elastic Stack组件一起使用，例如Logstash用于数据收集和处理，Kibana用于数据可视化和仪表板创建。这些组件共同构建了强大的数据分析和搜索解决方案，广泛用于各种应用领域，包括企业搜索、日志分析、安全信息和事件管理（SIEM）、电子商务搜索等。</p><h2 id="安装ElasticSearch"><a href="#安装ElasticSearch" class="headerlink" title="安装ElasticSearch"></a>安装ElasticSearch</h2><ul><li><p>从Docker镜像仓库（通常是Docker Hub或其他镜像仓库）下载（或拉取）elasticsearch镜像到本地计算机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull elasticsearch:7.16.2<br></code></pre></td></tr></table></figure></li><li><p>创建启动一个名为 “es” 的后台运行的Elasticsearch容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d --name es -p 9200:9200 -p 9300:9300 -e ES_JAVA_OPTS=&quot;-Xms256m -Xmx256m&quot; -e &quot;discovery.type=single-node&quot; -v es:/usr/share/elasticsearch/data  elasticsearch:7.16.2<br></code></pre></td></tr></table></figure><blockquote><ol><li><code>docker run</code>: 这是Docker命令行工具中用于创建和运行容器的命令。</li><li><code>-d</code>: 这是一个选项，表示容器将以后台（守护进程）模式运行，即不会阻止终端。</li><li><code>--name es</code>: 这是一个选项，用于指定容器的名称为 “es”。这将使您能够使用容器名称引用容器，而不必依赖于容器的ID。</li><li><code>-p 9200:9200 -p 9300:9300</code>: 这是用于端口映射的选项。它将容器内部的9200端口映射到主机的9200端口，同时将容器内部的9300端口映射到主机的9300端口。这些端口是Elasticsearch用于与外部通信的端口，其中9200用于HTTP请求，9300用于内部节点通信。</li><li><code>-e ES_JAVA_OPTS=&quot;-Xms256m -Xmx256m&quot;</code>: 这是一个选项，用于设置Elasticsearch的Java虚拟机选项。在这里，它设置了初始堆大小（Xms）和最大堆大小（Xmx）都为256MB，以控制Elasticsearch使用的内存。</li><li><code>-e &quot;discovery.type=single-node&quot;</code>: 这是另一个选项，用于设置Elasticsearch的发现类型为 “single-node”。这表示Elasticsearch将作为单节点运行，适用于开发和测试环境。</li><li><code>-v es:/usr/share/elasticsearch/data</code>: 这是一个选项，用于将主机的一个卷（volume）挂载到容器内部的目录。这里将主机上的名为 “es” 的卷挂载到容器内的 “&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data” 目录，用于持久化存储Elasticsearch的数据。</li><li><code>elasticsearch:7.16.2</code>: 这是要运行的Docker镜像的名称和标签。具体来说，这是Elasticsearch 7.16.2镜像的标识，Docker将根据此标识从Docker Hub拉取镜像并创建容器。</li></ol></blockquote></li><li><p>进入名为 “es” 的容器，并以交互方式（<code>-it</code>标志）启动一个bash shell。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it es /bin/bash<br></code></pre></td></tr></table></figure></li><li><p>在容器内安装ik中文分词器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.16.2/elasticsearch-analysis-ik-7.16.2.zip<br></code></pre></td></tr></table></figure></li><li><p>重启es容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker restart es<br></code></pre></td></tr></table></figure></li><li><p>验证分词插件是否安装成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">// 增加一个叫test001的索引<br>curl -X PUT http://localhost:9200/test001<br>// 成功返回 &#123;&quot;acknowledged&quot;:true,&quot;shards_acknowledged&quot;:true,&quot;index&quot;:&quot;test001&quot;&#125;<br><br>// ik_smart分词<br>curl -X POST \<br>&#x27;http://127.0.0.1:9200/test001/_analyze?pretty=true&#x27; \<br>-H &#x27;Content-Type: application/json&#x27; \<br>-d &#x27;&#123;&quot;text&quot;:&quot;我们是软件工程师&quot;,&quot;tokenizer&quot;:&quot;ik_smart&quot;&#125;&#x27;<br><br>// ik_max_word分词<br>curl -X POST \<br>&#x27;http://127.0.0.1:9200/test001/_analyze?pretty=true&#x27; \<br>-H &#x27;Content-Type: application/json&#x27; \<br>-d &#x27;&#123;&quot;text&quot;:&quot;我们是软件工程师&quot;,&quot;tokenizer&quot;:&quot;ik_max_word&quot;&#125;&#x27;<br></code></pre></td></tr></table></figure></li><li><p>我们可以在本机的 host 文件中，添加映射，将 <code>127.0.0.1 host.docker.internal</code>;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">host.docker.internal 127.0.0.1<br></code></pre></td></tr></table></figure></li><li><p>创建启动一个名为 “kibana” 的后台运行的kibana容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run --name kibana -e ELASTICSEARCH_HOSTS=http://host.docker.internal:9200 -p 5601:5601 -d kibana:7.16.2<br></code></pre></td></tr></table></figure></li><li><p>访问<a href="http://localhost:5601判断kibana是否启动成功">http://localhost:5601判断kibana是否启动成功</a></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202309051448318.png" alt="image-20230905114036359"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202309051448326.png" alt="image-20230905114212959"></p></li></ul><h2 id="集成Springboot"><a href="#集成Springboot" class="headerlink" title="集成Springboot"></a>集成Springboot</h2><ul><li><p>添加Elasticsearch客户端库依赖项：这里我是跟着springboot的版本 2.3.9.RELEASE</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在<code>application.properties</code>或<code>application.yml</code>配置文件中，配置Elasticsearch连接信息，包括主机名、端口号等。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">elasticsearch:</span><br>      <span class="hljs-attr">client:</span><br>        <span class="hljs-attr">reactive:</span><br>          <span class="hljs-attr">endpoints:</span> <span class="hljs-string">http://localhost:9200</span><br></code></pre></td></tr></table></figure></li><li><p>创建实体类： 创建一个实体类，表示要存储在Elasticsearch中的文档。该实体类需要使用<code>@Document</code>注解来指定与Elasticsearch索引的映射。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Document(indexName = &quot;test_index&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestIndex</span> &#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> String id;<br>    <span class="hljs-keyword">private</span> String title;<br>    <span class="hljs-keyword">private</span> String content;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;TestIndex&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;id=&#x27;&quot;</span> + id + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, title=&#x27;&quot;</span> + title + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, content=&#x27;&quot;</span> + content + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建Elasticsearch存储库（Repository）： 创建一个Elasticsearch存储库接口，它将继承自Spring Data Elasticsearch的<code>ElasticsearchRepository</code>。这个存储库将用于定义与Elasticsearch索引的交互。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TestIndexElasticsearchRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;TestIndex, String&gt; &#123;<br>    List&lt;TestIndex&gt; <span class="hljs-title function_">findAllByContent</span><span class="hljs-params">(String content)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在test下创建测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TestIndexElasticsearchRepository testIndexElasticsearchRepository;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TestIndex</span> <span class="hljs-variable">testIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestIndex</span>();<br>        testIndex.setId(<span class="hljs-string">&quot;1&quot;</span>);<br>        testIndex.setTitle(<span class="hljs-string">&quot;你好&quot;</span>);<br>        testIndex.setContent(<span class="hljs-string">&quot;我是java开发工程师&quot;</span>);<br>        <span class="hljs-type">TestIndex</span> <span class="hljs-variable">save</span> <span class="hljs-operator">=</span> testIndexElasticsearchRepository.save(testIndex);<br>        System.out.println(save);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">search</span><span class="hljs-params">()</span> &#123;<br>        List&lt;TestIndex&gt; testIndices = testIndexElasticsearchRepository.findAllByContent(<span class="hljs-string">&quot;java&quot;</span>);<br>        <span class="hljs-keyword">for</span> (TestIndex index : testIndices) &#123;<br>            System.out.println(index);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">find</span><span class="hljs-params">()</span> &#123;<br>        Iterable&lt;TestIndex&gt; testIndices = testIndexElasticsearchRepository.findAll();<br>        <span class="hljs-keyword">for</span> (TestIndex index : testIndices) &#123;<br>            System.out.println(index);<br>        &#125;<br>        <span class="hljs-type">TestIndex</span> <span class="hljs-variable">testIndex</span> <span class="hljs-operator">=</span> testIndexElasticsearchRepository.findById(<span class="hljs-string">&quot;1&quot;</span>).get();<br>        System.out.println(testIndex);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;<br>        testIndexElasticsearchRepository.deleteById(<span class="hljs-string">&quot;1&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>检查执行结果</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202309051448825.png" alt="image-20230905144512754"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式系统</tag>
      
      <tag>ElasticSearch</tag>
      
      <tag>搜索与分析引擎</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式事务-Seata简单实践</title>
    <link href="/2023/08/28/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-Seata%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5/"/>
    <url>/2023/08/28/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-Seata%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<p>当涉及多个不同的计算机或系统之间的操作时，分布式事务是确保这些操作在一组相关的事务中保持一致性和隔离性的机制。在传统的单机事务中，可以使用数据库的事务来确保操作的一致性和隔离性。然而，在分布式系统中，数据分布在多个节点上，可能涉及网络问题、节点故障等，使得保持一致性变得更加复杂。分布式事务需要解决以下挑战：</p><ol><li><strong>原子性（Atomicity）</strong>：分布式事务要么全部成功，要么全部失败，不能只完成部分操作。这意味着如果一个操作失败，所有涉及的操作都必须回滚。</li><li><strong>一致性（Consistency）</strong>：事务开始前和结束后，系统必须保持一致状态。即使在分布式环境中，事务也必须确保数据不会进入不一致状态。</li><li><strong>隔离性（Isolation）</strong>：在事务执行过程中，各个事务之间应该相互隔离，以避免并发执行导致的问题，例如脏读、不可重复读和幻读。</li><li><strong>持久性（Durability）</strong>：一旦事务提交，其结果应该持久保存，即使发生系统故障也不应丢失。</li></ol><p>分布式事务模式</p><ol><li><strong>XA模式</strong>： XA是一种标准的分布式事务协议，它在两阶段提交（2PC）的基础上实现了分布式事务的ACID属性。XA涉及两个角色：事务管理器（TM）和资源管理器（RM）。在第一阶段，TM要求所有RM预提交事务。在第二阶段，TM发送全局提交或回滚命令，RM执行对应操作。虽然XA确保了一致性，但它的缺点是可能会导致阻塞，尤其是在网络故障或参与者故障的情况下。</li><li><strong>AT模式（Automatic Transaction）</strong>： AT模式是一种基于数据库的分布式事务解决方案，通过自动化事务的提交和回滚来实现一致性。每个参与者节点在执行事务之前会先尝试执行操作，然后记录操作产生的影响。如果所有参与者的操作都成功，那么事务就会被自动提交。如果有任何一个参与者的操作失败，整个事务会被回滚。AT模式避免了2PC的阻塞问题，但可能导致部分失败问题。</li><li><strong>TCC模式（Try-Confirm-Cancel）</strong>： TCC模式通过将一个大事务分解为三个阶段来实现分布式事务：尝试（Try）、确认（Confirm）和取消（Cancel）。在尝试阶段，所有参与者都会尝试执行操作。在确认阶段，如果所有参与者的操作都成功，就会进行确认操作。如果任何操作失败，就会进行取消操作。TCC模式提供了更细粒度的控制，但需要在代码中显式编写确认和取消逻辑。</li><li><strong>Saga模式</strong>： Saga模式将一个大事务拆分为一系列小步骤，每个步骤都是一个原子操作。每个步骤都有一个与之关联的补偿操作，用于撤销该步骤的影响。如果一个步骤失败，就会触发其关联的补偿操作，将系统状态回滚到一致状态。Saga模式适用于分布式环境中的长时间事务，但需要开发人员仔细设计补偿逻辑。</li></ol><h2 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h2><h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><ul><li><p>下载</p><p>点击链接进去下载：<a href="https://seata.io/zh-cn/blog/download.html">https://seata.io/zh-cn/blog/download.html</a></p><p>本文的seata版本为1.7.0</p></li><li><p>配置</p><ul><li><p>参考conf&#x2F;application.example.yml修改conf&#x2F;application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">7091</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">seata-server</span><br><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">classpath:logback-spring.xml</span><br>  <span class="hljs-attr">file:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">$&#123;user.home&#125;/logs/seata</span><br><br><span class="hljs-attr">console:</span><br>  <span class="hljs-attr">user:</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">seata</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">seata</span><br><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-comment"># support: nacos, consul, apollo, zk, etcd3</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">namespace:</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">SEATA_GROUP</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">context-path:</span><br>      <span class="hljs-comment">##if use MSE Nacos with auth, mutex with username/password attribute</span><br>      <span class="hljs-comment">#access-key:</span><br>      <span class="hljs-comment">#secret-key:</span><br>      <span class="hljs-attr">data-id:</span> <span class="hljs-string">seataServer.properties</span><br>    <span class="hljs-attr">consul:</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">SEATA_GROUP</span><br>      <span class="hljs-attr">namespace:</span><br>      <span class="hljs-attr">cluster:</span> <span class="hljs-string">default</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">context-path:</span><br>  <span class="hljs-attr">store:</span><br>    <span class="hljs-comment"># support: file 、 db 、 redis</span><br>    <span class="hljs-attr">mode:</span> <span class="hljs-string">db</span><br>    <span class="hljs-attr">db:</span><br>      <span class="hljs-attr">datasource:</span> <span class="hljs-string">druid</span><br>      <span class="hljs-attr">db-type:</span> <span class="hljs-string">mysql</span><br>      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>      <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/seata?rewriteBatchedStatements=true</span><br>      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">min-conn:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">max-conn:</span> <span class="hljs-number">100</span><br>      <span class="hljs-attr">global-table:</span> <span class="hljs-string">global_table</span><br>      <span class="hljs-attr">branch-table:</span> <span class="hljs-string">branch_table</span><br>      <span class="hljs-attr">lock-table:</span> <span class="hljs-string">lock_table</span><br>      <span class="hljs-attr">distributed-lock-table:</span> <span class="hljs-string">distributed_lock</span><br>      <span class="hljs-attr">query-limit:</span> <span class="hljs-number">1000</span><br>      <span class="hljs-attr">max-wait:</span> <span class="hljs-number">5000</span><br><span class="hljs-comment">#  server:</span><br><span class="hljs-comment">#    service-port: 8091 #If not configured, the default is &#x27;$&#123;server.port&#125; + 1000&#x27;</span><br>  <span class="hljs-attr">security:</span><br>    <span class="hljs-attr">secretKey:</span> <span class="hljs-string">SeataSecretKey0c382ef121d778043159209298fd40bf3850a017</span><br>    <span class="hljs-attr">tokenValidityInMilliseconds:</span> <span class="hljs-number">1800000</span><br>    <span class="hljs-attr">ignore:</span><br>      <span class="hljs-attr">urls:</span> <span class="hljs-string">/,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.jpeg,/**/*.ico,/api/v1/auth/login</span><br></code></pre></td></tr></table></figure></li><li><p>mysql数据库创建seata库并执行&#x2F;seata&#x2F;script&#x2F;server&#x2F;db&#x2F;mysql.sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------<br>-- the table to store GlobalSession data<br>CREATE TABLE IF NOT EXISTS `global_table`<br>(<br>    `xid`                       VARCHAR(128) NOT NULL,<br>    `transaction_id`            BIGINT,<br>    `status`                    TINYINT      NOT NULL,<br>    `application_id`            VARCHAR(32),<br>    `transaction_service_group` VARCHAR(32),<br>    `transaction_name`          VARCHAR(128),<br>    `timeout`                   INT,<br>    `begin_time`                BIGINT,<br>    `application_data`          VARCHAR(2000),<br>    `gmt_create`                DATETIME,<br>    `gmt_modified`              DATETIME,<br>    PRIMARY KEY (`xid`),<br>    KEY `idx_status_gmt_modified` (`status` , `gmt_modified`),<br>    KEY `idx_transaction_id` (`transaction_id`)<br>) ENGINE = InnoDB<br>  DEFAULT CHARSET = utf8mb4;<br><br>-- the table to store BranchSession data<br>CREATE TABLE IF NOT EXISTS `branch_table`<br>(<br>    `branch_id`         BIGINT       NOT NULL,<br>    `xid`               VARCHAR(128) NOT NULL,<br>    `transaction_id`    BIGINT,<br>    `resource_group_id` VARCHAR(32),<br>    `resource_id`       VARCHAR(256),<br>    `branch_type`       VARCHAR(8),<br>    `status`            TINYINT,<br>    `client_id`         VARCHAR(64),<br>    `application_data`  VARCHAR(2000),<br>    `gmt_create`        DATETIME(6),<br>    `gmt_modified`      DATETIME(6),<br>    PRIMARY KEY (`branch_id`),<br>    KEY `idx_xid` (`xid`)<br>) ENGINE = InnoDB<br>  DEFAULT CHARSET = utf8mb4;<br><br>-- the table to store lock data<br>CREATE TABLE IF NOT EXISTS `lock_table`<br>(<br>    `row_key`        VARCHAR(128) NOT NULL,<br>    `xid`            VARCHAR(128),<br>    `transaction_id` BIGINT,<br>    `branch_id`      BIGINT       NOT NULL,<br>    `resource_id`    VARCHAR(256),<br>    `table_name`     VARCHAR(32),<br>    `pk`             VARCHAR(36),<br>    `status`         TINYINT      NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;0:locked ,1:rollbacking&#x27;,<br>    `gmt_create`     DATETIME,<br>    `gmt_modified`   DATETIME,<br>    PRIMARY KEY (`row_key`),<br>    KEY `idx_status` (`status`),<br>    KEY `idx_branch_id` (`branch_id`),<br>    KEY `idx_xid` (`xid`)<br>) ENGINE = InnoDB<br>  DEFAULT CHARSET = utf8mb4;<br><br>CREATE TABLE IF NOT EXISTS `distributed_lock`<br>(<br>    `lock_key`       CHAR(20) NOT NULL,<br>    `lock_value`     VARCHAR(20) NOT NULL,<br>    `expire`         BIGINT,<br>    primary key (`lock_key`)<br>) ENGINE = InnoDB<br>  DEFAULT CHARSET = utf8mb4;<br><br>INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#x27;AsyncCommitting&#x27;, &#x27; &#x27;, 0);<br>INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#x27;RetryCommitting&#x27;, &#x27; &#x27;, 0);<br>INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#x27;RetryRollbacking&#x27;, &#x27; &#x27;, 0);<br>INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#x27;TxTimeoutCheck&#x27;, &#x27; &#x27;, 0);<br></code></pre></td></tr></table></figure></li></ul></li><li><p>启动</p><p>在seata目录下执行seata-server.sh 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">bin/seata-server.sh <br></code></pre></td></tr></table></figure><p>访问<a href="http://localhost:7091/%EF%BC%8C%E5%87%BA%E7%8E%B0%E4%BB%A5%E4%B8%8B%E7%94%BB%E9%9D%A2%E4%BB%A3%E8%A1%A8%E6%88%90%E5%8A%9F%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E5%B0%B1%E6%98%AF%E5%9C%A8application.yml%E9%85%8D%E7%BD%AE%E7%9A%84console.user.username%E5%92%8Cconsole.user.password">http://localhost:7091/，出现以下画面代表成功账号密码就是在application.yml配置的console.user.username和console.user.password</a></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308282051746.png" alt="image-20230828204423604"></p><p>也可以在nacos页面中查看服务是否注册成功</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308282051341.png" alt="image-20230828205059592"></p></li></ul><p>​</p><h3 id="微服务集成Seata"><a href="#微服务集成Seata" class="headerlink" title="微服务集成Seata"></a>微服务集成Seata</h3><ul><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>              <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="XA"><a href="#XA" class="headerlink" title="XA"></a>XA</h4><h5 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h5><p>支持XA 事务的数据库。<br>Java 应用，通过 JDBC 访问数据库。</p><h5 id="整体机制"><a href="#整体机制" class="headerlink" title="整体机制"></a>整体机制</h5><p>在 Seata 定义的分布式事务框架内，利用事务资源（数据库、消息服务等）对 XA 协议的支持，以 XA 协议的机制来管理分支事务的一种 事务模式。</p><p>执行阶段：</p><p>可回滚：业务 SQL 操作放在 XA 分支中进行，由资源对 XA 协议的支持来保证 可回滚<br>持久化：XA 分支完成后，执行 XA prepare，同样，由资源对 XA 协议的支持来保证 持久化（即，之后任何意外都不会造成无法回滚的情况）</p><p>完成阶段：</p><p>分支提交：执行 XA 分支的 commit<br>分支回滚：执行 XA 分支的 rollback</p><ul><li><p>配置application.yml 使用XA模式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">data-source-proxy-mode:</span> <span class="hljs-string">XA</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>  <span class="hljs-comment">#事务组的名称</span><br>  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">seata-demo</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-comment">#事务组和cluster的映射关系</span><br>    <span class="hljs-attr">vgroup-mapping:</span><br>    <span class="hljs-comment">#你配置的seata/conf/application.yml的 cluster</span><br>      <span class="hljs-attr">seata-demo:</span> <span class="hljs-string">default</span><br></code></pre></td></tr></table></figure></li><li><p>Seata通过封装数据库的XA接口，实现了分布式事务处理的流程，降低了使用者的复杂度。用户只要在Seata客户端进行简单的开启XA模式的配置，即可成功使用Seata的XA模式。XA模式的性能也较差，只适用于一些对事务一致性要求非常高的场景。</p><p>直接在service对用方法上添加注解@GlobalTransactional，即可生效</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308311843476.png" alt="image-20230831183911000"></p><p>xa模式下的日志</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308311843190.png" alt="image-20230831182630307"></p></li></ul><h4 id="AT"><a href="#AT" class="headerlink" title="AT"></a>AT</h4><h5 id="前提-1"><a href="#前提-1" class="headerlink" title="前提"></a>前提</h5><ul><li>基于支持本地 ACID 事务的关系型数据库。</li><li>Java 应用，通过 JDBC 访问数据库。</li></ul><h5 id="整体机制-1"><a href="#整体机制-1" class="headerlink" title="整体机制"></a>整体机制</h5><p>两阶段提交协议的演变：</p><ul><li>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</li><li>二阶段：<ul><li>提交异步化，非常快速地完成。</li><li>回滚通过一阶段的回滚日志进行反向补偿。</li></ul></li></ul><ul><li><p>mysql数据新增undo_log表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `undo_log` (<br>  `id` bigint(20) NOT NULL AUTO_INCREMENT,<br>  `branch_id` bigint(20) NOT NULL,<br>  `xid` varchar(100) NOT NULL,<br>  `context` varchar(128) NOT NULL,<br>  `rollback_info` longblob NOT NULL,<br>  `log_status` int(11) NOT NULL,<br>  `log_created` datetime NOT NULL,<br>  `log_modified` datetime NOT NULL,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)<br>) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure></li><li><p>data-source-proxy-mode修改成AT模式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">data-source-proxy-mode:</span> <span class="hljs-string">AT</span><br></code></pre></td></tr></table></figure></li><li><p>AT下的日志</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202309011026520.png" alt="image-20230901101219676"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>SpringCloud</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>熔断降级限流-Sentinel简单实践</title>
    <link href="/2023/08/25/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E9%99%90%E6%B5%81-Sentinel%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5/"/>
    <url>/2023/08/25/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E9%99%90%E6%B5%81-Sentinel%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<p>在分布式系统中，熔断、降级和限流是三种常见的保护策略，用于确保系统的稳定性和可用性。</p><p><strong>熔断：</strong> 熔断是一种针对特定服务或资源的保护机制。当该服务或资源出现异常、故障或性能下降时，熔断机制会迅速停止向该服务或资源发送请求，避免继续的请求可能加重问题。熔断通常基于一些指标（如错误率、响应时间等）进行触发，如果这些指标超过了预设的阈值，系统会将该服务熔断，即暂停对它的请求，直到一段时间后重新尝试。熔断有助于防止故障扩散，提高系统的稳定性。</p><p><strong>降级：</strong> 降级是一种在系统压力剧增、资源不足或异常情况下的应对策略。为了保持核心功能的可用性，系统可以主动放弃一些非核心或次要功能，从而减轻系统的负载。例如，在高流量期间，系统可以降级为提供基本的服务，禁用某些高成本或资源密集型的功能。这可以确保系统的关键部分仍然正常工作，即使在资源有限的情况下也能保持较好的响应性能。</p><p><strong>限流：</strong> 限流是一种控制系统访问量的策略，用于防止系统过载。通过限制对某个特定服务、接口或资源的并发访问数量，限流可以防止过多的请求影响系统的性能和可用性。限流可以基于多种条件进行，如设置每秒查询数（QPS）限制、并发连接数、请求频率等。这有助于维护系统的稳定性，确保系统在其可承受的负载范围内运行。</p><h2 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h2><p>Sentinel旨在解决分布式系统中常见的流量控制、熔断降级和保护问题，帮助开发人员构建稳定、可靠的微服务架构。以下是Sentinel的一些重要方面：</p><ol><li><p><strong>流量控制：</strong> Sentinel可以根据系统的负载情况和资源的可用性，限制对某个特定资源的访问。通过设定阈值，开发人员可以限制资源的并发访问数、QPS等，防止过多的请求导致资源耗尽或性能下降。</p></li><li><p><strong>熔断降级：</strong> Sentinel可以监控资源的错误率、异常率等情况。如果错误率超过了设定的阈值，Sentinel可以自动触发熔断操作，停止对该资源的请求一段时间，以防止故障扩散。熔断机制有助于保护系统免受故障的影响。</p></li><li><p><strong>系统保护：</strong> Sentinel可以监控整个系统的健康状态，包括系统负载、资源利用率等。当系统负载过高或出现异常情况时，Sentinel可以采取措施，如限制某些资源的访问，以保护整个系统免受过载的影响。</p></li><li><p><strong>实时监控和统计：</strong> Sentinel提供实时的监控面板和统计信息，开发人员可以通过这些信息了解资源的使用情况、异常情况和系统的整体状态。这些数据有助于及时发现问题并采取措施。</p></li><li><p><strong>规则配置：</strong> Sentinel允许开发人员配置流量控制和熔断降级的规则。规则可以基于资源的名称、路径、HTTP方法等进行配置，以适应不同的场景和需求。</p></li><li><p><strong>集成和适用性：</strong> Sentinel可以与各种编程语言和框架一起使用，适用于微服务架构中的各种场景。它提供了丰富的API和插件，以便与现有系统集成。</p></li></ol><h3 id="简单实践"><a href="#简单实践" class="headerlink" title="简单实践"></a>简单实践</h3><ul><li><p>下载sentinel</p><blockquote><p>地址：<a href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a></p></blockquote></li><li><p>启动sentinel</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">java -jar sentinel-dashboard-1.8.6.jar <br></code></pre></td></tr></table></figure><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308251829872.png" alt="image-20230825182945267"></p></li><li><p><strong>引入依赖：</strong> 在你的Spring Boot项目的 <code>pom.xml</code> 文件中，添加Sentinel的依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>配置：</strong> 在你的 <code>application.properties</code> 或 <code>application.yml</code> 文件中，可以进行一些基本的配置，例如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8080</span><br></code></pre></td></tr></table></figure></li><li><p>启动项目即可在页面中实时监控、配置流控规则等</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308251825142.png" alt="image-20230825182546927"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>SpringCloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式系统</tag>
      
      <tag>Sentinel</tag>
      
      <tag>熔断</tag>
      
      <tag>降级</tag>
      
      <tag>限流</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式配置中心-Nacos简单实践</title>
    <link href="/2023/08/23/%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-Nacos%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5/"/>
    <url>/2023/08/23/%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-Nacos%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<p>分布式配置中心是一种用于管理和集中存储应用程序配置的系统，特别适用于大规模、复杂的分布式系统。它的主要目标是将应用程序的配置信息从代码中分离出来，使得配置可以在运行时进行动态修改和管理，而无需重新部署应用程序。</p><p>以下是分布式配置中心的一些关键特点和优势：</p><ol><li><strong>集中管理：</strong> 分布式配置中心允许将所有应用程序的配置集中存储在一个地方，从而方便统一管理和修改配置，避免了在每个应用程序实例中手动更改配置。</li><li><strong>动态更新：</strong> 配置中心支持在应用程序运行时动态更新配置，而无需重新启动或重新部署应用。这对于需要频繁变更配置的场景非常有用。</li><li><strong>版本控制：</strong> 配置中心通常支持配置版本控制，使得可以跟踪配置的变更历史，方便回退或恢复配置。</li><li><strong>环境隔离：</strong> 配置中心允许将不同环境（如开发、测试、生产）的配置隔离开来，从而确保在不同环境中使用不同的配置。</li><li><strong>动态扩展：</strong> 配置中心可以支持多个应用程序实例和多个团队同时访问，并能够处理高并发的配置请求。</li><li><strong>安全性：</strong> 配置中心通常提供权限控制，确保只有授权用户可以访问和修改配置。</li><li><strong>集成支持：</strong> 配置中心可以与其他工具和框架集成，如监控系统、CI&#x2F;CD流水线等，从而更好地支持自动化和运维流程。</li></ol><h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><p>Nacos（Naming and Configuration Service）是阿里巴巴开源的一个用于服务发现、动态配置管理和可视化平台的项目。它结合了服务发现、配置管理和健康监测等功能，是一个综合的微服务基础设施组件。其中，Nacos的配置管理部分可以被用作分布式配置中心。</p><ul><li><p>添加nacos配置管理依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">  <span class="hljs-comment">&lt;!-- nacos的配置管理依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在resource下创建bootstrap.yaml配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-comment"># 环境</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-comment"># nacos地址</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-comment"># 文件后缀</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span> <br></code></pre></td></tr></table></figure><ol><li><strong>配置加载顺序：</strong> 在Spring Boot应用程序中，配置文件的加载顺序是有一定规则的。<code>bootstrap.yaml</code> 配置文件在加载顺序上位于其他配置文件（如 <code>application.yaml</code> 或 <code>application.properties</code>）之前。这意味着它可以用于配置一些在应用程序启动之前就需要的属性，例如连接到配置服务器的属性。</li><li><strong>外部配置加载：</strong> 通常，分布式系统中的应用程序可能需要从配置中心（如Nacos、Consul等）获取配置信息。<code>bootstrap.yaml</code> 配置文件可以用来配置与配置中心的连接和身份验证等信息，以便在应用程序启动时能够正确地加载配置。</li></ol></li><li><p>在nacos中以&lt;spring.application.name&gt;-&lt;spring.profiles.active&gt;.yaml作为data id在DEFAULT_GROUP新建配置，例如：gateway-dev.yaml</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308231648127.png" alt="image-20230823161911507"></p></li></ul><p>项目启动后，无需重新启动或停机就会从nacos中动态加载配置下来，通过@Value即可获取对应的值。如果您将配置属性注入到了Spring管理的Bean中，而且希望在配置发生变化时动态刷新Bean的状态，您可以使用 <code>@RefreshScope</code> 注解。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RefreshScope</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;config.hello&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String helloConfig;<br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>SpringCloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式系统</tag>
      
      <tag>Nacos</tag>
      
      <tag>配置中心</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>API网关-SpringCloud Gateway</title>
    <link href="/2023/08/17/API%E7%BD%91%E5%85%B3-SpringCloud-Gateway/"/>
    <url>/2023/08/17/API%E7%BD%91%E5%85%B3-SpringCloud-Gateway/</url>
    
    <content type="html"><![CDATA[<p>Spring Cloud Gateway是一个基于Spring Framework的开源API网关，用于构建微服务架构中的统一访问层。它充当了应用程序和后端服务之间的代理，提供了路由、负载均衡、安全性、监控等功能，以简化微服务架构中的网络请求管理和流量控制。</p><p>Spring Cloud Gateway的主要特点包括：</p><ol><li><strong>动态路由：</strong> 可以根据请求的信息将流量路由到不同的后端服务，支持动态添加、删除和修改路由规则。</li><li><strong>负载均衡：</strong> 可以自动分配流量到多个实例，以提高系统的可用性和性能。</li><li><strong>断路器模式：</strong> 提供了断路器模式来处理后端服务的故障，防止故障服务对整个系统的影响。</li><li><strong>过滤器：</strong> 可以在请求和响应之间应用一系列的过滤器，用于修改请求、响应或执行一些预处理&#x2F;后处理操作。</li><li><strong>限流和速率控制：</strong> 可以通过配置限制每个路由或服务的请求速率，以防止过载和滥用。</li><li><strong>安全性：</strong> 可以集成Spring Security等安全框架，对请求进行认证和授权。</li><li><strong>监控和日志：</strong> 提供了监控和日志功能，帮助开发人员了解流量和系统的状态。</li><li><strong>易于扩展：</strong> 由于基于Spring Framework构建，因此可以通过自定义插件和过滤器来扩展其功能。</li></ol><h2 id="SpringCloud-Gateway简单使用"><a href="#SpringCloud-Gateway简单使用" class="headerlink" title="SpringCloud Gateway简单使用"></a>SpringCloud Gateway简单使用</h2><ul><li><p><strong>添加依赖：</strong> 在生成的<code>pom.xml</code>文件中，添加Spring Cloud Gateway的依赖。通常，您需要添加以下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>因为我们使用了nacos实现服务注册与服务发现，所以也要引入nacos相关的依赖，如果不需要可以不引入，routes.uri直接指定目标服务的完整URL字符串。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">  <span class="hljs-comment">&lt;!--nacos服务发现依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>配置路由：</strong> 在<code>application.yml</code>或<code>application.properties</code>中配置您的路由规则。以下是一个简单的示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 路由标示，必须唯一</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service</span><br>          <span class="hljs-comment"># 路由的目标地址</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>          <span class="hljs-comment"># 路由断言，判断请求是否符合规则</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-comment"># 路径断言，判断路径是否是以/user开头，如果是则符合</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span><br>          <span class="hljs-attr">filter:</span><br>          <span class="hljs-comment">#添加路由过滤器</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=Tag,userRequest</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order-service</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order/**</span><br>      <span class="hljs-comment">#添加default过滤器</span><br>      <span class="hljs-attr">default-filters:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=origin,gateway</span><br></code></pre></td></tr></table></figure><blockquote><ol><li><p><strong>直接URL字符串：</strong> 最简单的写法就是直接指定目标服务的完整URL字符串。</p><p><code>  uri: http://example.com</code></p></li><li><p><strong>lb协议：</strong> 使用<code>lb</code>协议可以通过服务发现来进行负载均衡，将请求分发到不同实例。</p><p> <code> uri: lb://service-name</code></p></li><li><p><strong>lb协议 + 负载均衡策略：</strong> 可以在<code>lb</code>协议后面添加负载均衡策略，如<code>lb://service-name?lbMethod=ROUND_ROBIN</code>。</p><p><code> uri: lb://service-name?lbMethod=ROUND_ROBIN</code></p></li><li><p><strong>使用自定义协议：</strong> 您可以定义自己的协议前缀，然后在目标URI中使用。</p><p><code>uri: custom://destination</code></p></li><li><p><strong>使用表达式：</strong> 您可以在<code>routes.uri</code>中使用SpEL表达式来动态生成目标URI。</p><p><code>uri: &quot;&#39;http://dynamic-&#39; + #serviceId + &#39;.example.com&#39;&quot;</code></p></li></ol></blockquote></li><li><p><strong>测试路由：</strong> 启动应用程序后，您可以使用浏览器或工具（如curl或Postman）来测试配置的路由。访问<code>http://localhost:10010/user/1</code>应该将请求代理到<code>http://user-service/user/1</code>。</p><p>![image-20230817210750025](..&#x2F;..&#x2F;..&#x2F;..&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230817210750025.png)</p></li><li><p>添加GlobalFilter简单实现访问鉴权</p><blockquote><p><code>GlobalFilter</code>是Spring Cloud Gateway中的一个重要概念，它允许您在请求和响应的生命周期中执行全局操作。这些操作可以用于各种目的，如身份验证、日志记录、添加请求头、处理异常等。<code>GlobalFilter</code>可以在整个网关的请求处理流程中应用，无论是在路由匹配之前还是之后。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;<br><br>    <span class="hljs-meta">@SneakyThrows(Exception.class)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();<br>        MultiValueMap&lt;String, String&gt; params = request.getQueryParams();<br>        <span class="hljs-comment">//获取参数中的 authorization 参数 。通常是获取header里的authorization</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">authorization</span> <span class="hljs-operator">=</span> params.getFirst(<span class="hljs-string">&quot;authorization&quot;</span>);<br>        <span class="hljs-comment">//这里demo简单处理 判断数值是否等于 admin</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;admin&quot;</span>.equals(authorization)) &#123;<br>            <span class="hljs-comment">//放行</span><br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br>        <span class="hljs-comment">//先设置状态码</span><br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br>        response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>        <span class="hljs-type">DataBufferFactory</span> <span class="hljs-variable">bufferFactory</span> <span class="hljs-operator">=</span> response.bufferFactory();<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        <span class="hljs-type">DataBuffer</span> <span class="hljs-variable">wrap</span> <span class="hljs-operator">=</span> bufferFactory.wrap(objectMapper.writeValueAsBytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RestResult</span>&lt;&gt;(<span class="hljs-number">401</span>, <span class="hljs-string">&quot;unauthrize&quot;</span>)));<br>        <span class="hljs-keyword">return</span> response.writeWith(Mono.fromSupplier(() -&gt; wrap));<br><span class="hljs-comment">//        //拦截请求</span><br><span class="hljs-comment">//        return exchange.getResponse().setComplete();</span><br>    &#125;<br><br>    <span class="hljs-comment">//设置优先级为-1</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>上面代码通过对请求参数里的authorization是否等于admin简单实现了鉴权，是admin则通过</p><p>![image-20230817211428288](..&#x2F;..&#x2F;..&#x2F;..&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230817211428288.png)</p><p>否则返回401 httpstatus和json responsebody提示</p><p>![image-20230817211437210](..&#x2F;..&#x2F;..&#x2F;..&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230817211437210.png)</p></li></ul><h3 id="集成nacos配置中心实现动态路由"><a href="#集成nacos配置中心实现动态路由" class="headerlink" title="集成nacos配置中心实现动态路由"></a>集成nacos配置中心实现动态路由</h3><ul><li><p><strong>添加依赖</strong>：在上面配置的依赖的基础上添加nacos-config相关的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos的配置管理依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>配置Nacos作为配置中心：</strong> 在<code>bootstrap.yaml</code>或<code>bootstrap.properties</code>中配置Nacos的配置中心信息，包括Nacos Server的地址和配置的Data ID、Group等信息。</p><p>bootstrap.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment"># nacos地址</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span> <span class="hljs-comment"># 文件后缀</span><br></code></pre></td></tr></table></figure><p>application.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">com.cason:</span> <span class="hljs-string">debug</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br></code></pre></td></tr></table></figure></li><li><p><strong>配置动态路由：</strong> 在Nacos配置中心中创建配置，用于定义动态路由规则。配置的Data ID可以根据您的实际情况进行定义，我这里用的是&lt;spring.application.name&gt;-&lt;spring.profiles.active&gt;.yaml以下是一个示例配置：</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308172132323.png" alt="image-20230817212606004"></p></li><li><p><strong>测试</strong></p><ul><li><p>访问user，order相关路由没有问题</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308172133265.png" alt="image-20230817213157261"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308172133225.png" alt="image-20230817213209689"></p></li><li><p>移除user相关的路由，请求user相关路由404，请求order相关路由没有问题</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308172133551.png" alt="image-20230817213049030"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308172133941.png" alt="image-20230817213130551"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308180955610.png" alt="image-20230817213238702"></p></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>SpringCloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gateway</tag>
      
      <tag>API网关</tag>
      
      <tag>分布式系统</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OpenFeign实践</title>
    <link href="/2023/08/16/OpenFeign%E5%AE%9E%E8%B7%B5/"/>
    <url>/2023/08/16/OpenFeign%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<p>OpenFeign是一个用于声明式REST客户端的Java框架，它是由Netflix开发的，用于简化在Java应用程序中调用HTTP API的过程。它与Spring Cloud集成得很好，特别适用于微服务架构中的服务间通信。</p><p>OpenFeign的核心思想是通过定义接口的方式来描述远程API的调用。你可以使用注解在接口方法上指定HTTP请求的方式、URL、请求参数、请求体、响应处理等信息，而不必手动编写大量的HTTP请求代码。这种方式使得代码更加清晰、可读性更高，并且可以方便地维护和扩展。</p><p>主要特点和优势包括：</p><ol><li><strong>声明式接口定义：</strong> 使用Java接口来描述API调用，通过注解来配置请求的方式、路径等信息，使代码具有更高的可读性和可维护性。</li><li><strong>集成负载均衡：</strong> OpenFeign与Ribbon等负载均衡组件集成，可以自动地在多个服务实例中进行负载均衡，提高了系统的可用性和性能。</li><li><strong>内建Hystrix支持：</strong> OpenFeign集成了Hystrix，可以方便地为接口方法添加容错和降级的逻辑，增加了系统的可靠性。</li><li><strong>与Spring Cloud集成：</strong> OpenFeign与Spring Cloud框架无缝集成，可以与Eureka、Config、Zuul等组件协同工作，构建出完整的微服务架构。</li><li><strong>简化HTTP调用：</strong> OpenFeign自动处理HTTP请求和响应，减少了手动编写HTTP请求代码的复杂性。</li><li><strong>易于测试：</strong> 由于OpenFeign接口是基于Java接口定义的，因此可以方便地使用单元测试来测试接口方法。</li></ol><p>OpenFeign在微服务架构中发挥着重要的作用，通过简化服务间通信的实现，提高了开发效率并促进了系统的可靠性和可维护性。</p><h2 id="OpenFeign简单使用"><a href="#OpenFeign简单使用" class="headerlink" title="OpenFeign简单使用"></a>OpenFeign简单使用</h2><h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--OpenFeign--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="启动类添加-EnableFeignClients注解"><a href="#启动类添加-EnableFeignClients注解" class="headerlink" title="启动类添加@EnableFeignClients注解"></a>启动类添加<code>@EnableFeignClients</code>注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="远程服务客户端"><a href="#远程服务客户端" class="headerlink" title="远程服务客户端"></a>远程服务客户端</h4><ul><li><p>User项目下创建UserController.java和UserService.java 通过&#x2F;user&#x2F;{id}提供服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">public</span> UserEntity <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-type">UserEntity</span> <span class="hljs-variable">userEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserEntity</span>();<br>        userEntity.setId(id);<br>        userEntity.setName(<span class="hljs-string">&quot;用户&quot;</span>+id);<br>        <span class="hljs-keyword">return</span> userEntity;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserClient</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> UserEntity <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.getUser(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Order项目下创建UserClient.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;user-service&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>    UserEntity <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>@FeignClient注解声明式REST客户端接口上标记，以指示该接口将被OpenFeign用作远程服务调用的客户端。</p><p>主要属性包括：</p><ol><li><strong>name：</strong> 用于指定远程服务的名称。这通常是Eureka注册中心中的服务名称，以便OpenFeign能够根据名称找到对应的服务实例。例如：<code>@FeignClient(name = &quot;user-service&quot;)</code>。</li><li><strong>url：</strong> 如果不使用服务发现（例如Eureka）来定位服务，可以直接指定服务的URL。例如：<code>@FeignClient(url = &quot;http://localhost:8080&quot;)</code>。</li><li><strong>value：</strong> 与<code>name</code>属性相同，用于指定远程服务的名称。</li><li><strong>path：</strong> 用于指定基础路径，它会被添加到所有接口方法的URL前面。例如：<code>@FeignClient(name = &quot;user-service&quot;, path = &quot;/api&quot;)</code>。</li><li><strong>fallback：</strong> 指定一个降级处理的类，当远程服务调用失败时会执行降级逻辑。这个类需要实现相应的接口，并添加<code>@Component</code>注解以让Spring能够扫描到。例如：<code>@FeignClient(name = &quot;user-service&quot;, fallback = UserServiceFallback.class)</code>。</li><li><strong>fallbackFactory：</strong> 与<code>fallback</code>类似，但是这里指定的是一个降级处理工厂，用于创建降级处理类的实例。这通常用于实现更复杂的降级逻辑。例如：<code>@FeignClient(name = &quot;user-service&quot;, fallbackFactory = UserServiceFallbackFactory.class)</code>。</li></ol><h4 id="调用方"><a href="#调用方" class="headerlink" title="调用方"></a>调用方</h4><ul><li><p>Order项目下创建OrderService.java </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserClient userClient;<br><br><br>    <span class="hljs-keyword">public</span> OrderEntity <span class="hljs-title function_">getOrder</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-type">OrderEntity</span> <span class="hljs-variable">orderEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderEntity</span>();<br>        orderEntity.setUser(userClient.getUser(id));<br>        orderEntity.setId(id);<br>        orderEntity.setTitle(<span class="hljs-string">&quot;订单&quot;</span>+id);<br><br>        <span class="hljs-keyword">return</span> orderEntity;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Order项目下创建OrderController.java </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> OrderEntity <span class="hljs-title function_">getOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> orderService.getOrder(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308162052859.png" alt="image-20230816204051210"></p><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308162052726.png" alt="image-20230816204027091"></p><p>RPC 接口和实现各自放在独立的模块中，方便服务调用方重用服务接口，服务接口模块只能包括最基本的模块依靠（过多会导致依靠传递）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">user</span>:<br><span class="hljs-keyword">user</span><span class="hljs-operator">-</span>service<br><span class="hljs-keyword">user</span><span class="hljs-operator">-</span>api<br><span class="hljs-keyword">order</span>:<br><span class="hljs-keyword">order</span><span class="hljs-operator">-</span>service<br><span class="hljs-keyword">order</span><span class="hljs-operator">-</span>api<br></code></pre></td></tr></table></figure><p>xxx-api 模块中放服务调用方需求用到的东西，api接口，vo，入参等等。</p><p>xxx-service 实现 account-api 供给的接口。</p><ul><li><p>user-api</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;user-service&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>    UserEntity <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>user-service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserClient</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> UserEntity <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.getUser(id);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>Order-service引入user-api</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.cason<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>user-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>指定client注入容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(clients = &#123;UserClient.class&#125;)</span><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>SpringCloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式注册中心-Nacos</title>
    <link href="/2023/08/16/%E5%88%86%E5%B8%83%E5%BC%8F%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83-Nacos/"/>
    <url>/2023/08/16/%E5%88%86%E5%B8%83%E5%BC%8F%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83-Nacos/</url>
    
    <content type="html"><![CDATA[<p>分布式注册中心是分布式系统中的一种关键组件，用于管理和维护各个分布式服务实例的注册、发现和状态信息。它提供了一种集中化的机制，使得不同的服务能够在一个共享的地方注册自己的信息，并能够动态地发现其他服务，从而实现分布式系统中的服务治理和通信。</p><p>在分布式架构中，服务注册与服务发现是两个关键的概念，用于管理和维护系统中各个分布式组件之间的通信。</p><p><strong>服务注册：</strong> 服务注册是指将服务的网络地址和元数据注册到一个中心化的服务注册表中。在分布式系统中，各个服务提供者将自己的服务注册到这个注册表，使得其他组件或服务能够找到并与其通信。这种注册可以包括服务的名称、版本、IP地址、端口号等信息，以便其他服务能够准确地定位和连接到这些服务。</p><p><strong>服务发现：</strong> 服务发现是指在分布式系统中，一个服务或组件能够动态地找到和识别其他服务的过程。通过服务发现，服务消费者能够查询服务注册表，找到所需的服务的网络地址和其他信息，从而能够与其建立通信和交互。服务发现可以帮助系统自动适应组件的变化，如新增、删除或替换服务，而不需要手动更新配置。</p><p><strong>Zookeeper：</strong> Zookeeper是一个分布式的协调服务，可以用于服务注册与发现。它提供了一个层次化的命名空间结构，允许服务注册和发现，并能够处理分布式系统中的一致性问题。Zookeeper适用于一些需要高一致性和稳定性的场景</p><p><strong>Eureka：</strong> Eureka是Netflix开源的一个服务发现组件，特别适用于基于微服务架构的系统。它允许服务注册和发现，并提供了一些高级的负载均衡和故障转移机制。Eureka一般用于内部服务发现，不太适合复杂的多数据中心场景。</p><p><strong>Nacos：</strong> Nacos是阿里巴巴开源的一个综合性服务发现和配置管理平台，支持服务注册、配置管理、服务发现和动态配置更新等功能。它能够满足多种分布式系统的需求，包括微服务和云原生应用。</p><h2 id="Nacos-实现简单的服务注册和服务发现"><a href="#Nacos-实现简单的服务注册和服务发现" class="headerlink" title="Nacos 实现简单的服务注册和服务发现"></a>Nacos 实现简单的服务注册和服务发现</h2><h3 id="启动分布式注册中心"><a href="#启动分布式注册中心" class="headerlink" title="启动分布式注册中心"></a>启动分布式注册中心</h3><blockquote><p>官方文档：<a href="https://nacos.io/zh-cn/docs/what-is-nacos.html">什么是 Nacos</a></p></blockquote><p>启动nacos</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">前往解压的nacos文件夹内</span><br>cd bin<br>./startup.sh -m standalone<br></code></pre></td></tr></table></figure><p>启动成功</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308161114188.png" alt="image-20230816103800624"></p><p>访问地址：<a href="http://localhost:8848/nacos/#/login">http://localhost:8848/nacos/#/login</a></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308161114059.png" alt="image-20230816103746727"></p><p>账号密码：nacos&#x2F;nacos</p><h2 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h2><p>项目根目录pom.xml添加springcloud，springcloud alibaba依赖管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>         <span class="hljs-comment">&lt;!-- springCloud --&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-comment">&lt;!-- alibaba nacos--&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Module项目pom.xml添加nacos discovery依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos客户端依赖包 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>application.yaml添加nacos相关配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>    <span class="hljs-comment"># nacos服务地址</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <br>      <span class="hljs-attr">discovery:</span><br>      <span class="hljs-comment"># cluster-name 属性来指定集群名称，从而更好地管理和区分不同的服务发现集群。</span><br>        <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">HZ</span><br>        <span class="hljs-comment"># 命名空间：命名空间可以用来隔离不同的应用或团队的配置。不同的命名空间可以在不同的 Nacos 实例中。</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">7a5618ff-a674-46dd-99a7-33da5f094f7f</span> <span class="hljs-comment"># 命名空间ID</span><br>        <span class="hljs-comment"># 是否是临时实例</span><br>        <span class="hljs-attr">ephemeral:</span> <span class="hljs-literal">true</span> <br></code></pre></td></tr></table></figure><p>启动项目</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308161114223.png" alt="image-20230816111101326"></p><p>注册到 Nacos 后，您的微服务将被自动注册到 Nacos 服务注册中心，并且其他微服务可以使用 Nacos 进行服务发现。这使得微服务可以轻松地找到其他服务的实例，并进行负载均衡，从而实现更高的可用性和性能。Nacos 支持动态注册和注销微服务，这意味着您可以在运行时动态地添加、更新或删除服务实例，而无需重启应用。这使得服务的管理和维护更加灵活和高效。</p>]]></content>
    
    
    <categories>
      
      <category>SpringCloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式系统</tag>
      
      <tag>Nacos</tag>
      
      <tag>注册中心</tag>
      
      <tag>服务注册与服务发现</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Github action持续部署springboot+vue前后端分离项目</title>
    <link href="/2023/08/15/Github-action%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2springboot-vue%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE/"/>
    <url>/2023/08/15/Github-action%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2springboot-vue%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<p>因为购买的阿里云服务器性能比较拉垮，安装jenkins做持续集成和持续部署会占用比较大量的服务器资源。因为实习的时候当时负责的一个项目就是把jenkins迁移到github action，所以就优先考虑使用Github action.</p><p>GitHub Actions 是一个由 GitHub 提供的持续集成（CI）和持续部署（CD）平台，它允许开发者在代码仓库中设置自动化的工作流程。这些工作流程可以在代码的不同事件触发时自动执行，例如推送代码、创建 Pull Request、发布 Release 等。</p><h2 id="Secret配置"><a href="#Secret配置" class="headerlink" title="Secret配置"></a>Secret配置</h2><p>需要提前配置一些github action secret，打开对应项目setting</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202308151056837.png" alt="image-20230815103929921"></p><p>配置后即可在yaml文件中使用$使用对应值</p><h2 id="vue项目"><a href="#vue项目" class="headerlink" title="vue项目"></a>vue项目</h2><p>在项目里编写.github&#x2F;workflows&#x2F;node.js.yml</p><p>在github action里实现了</p><p>1、checkout代码</p><p>2、将源代码进行打包、压缩和优化，生成适合部署的生产环境代码</p><p>3、压缩并scp发送到服务器指定地址并解压</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">CI</span><br><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">&quot;master&quot;</span> ]<br>  <span class="hljs-attr">pull_request:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">&quot;master&quot;</span> ]<br><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">build:</span><br><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br><br>    <span class="hljs-attr">strategy:</span><br>      <span class="hljs-attr">matrix:</span><br>        <span class="hljs-attr">node-version:</span> [ <span class="hljs-number">16.</span><span class="hljs-string">x</span> ]<br>        <span class="hljs-comment"># See supported Node.js release schedule at https://nodejs.org/en/about/releases/</span><br><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">node-version:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">&#125;&#125;</span><br>          <span class="hljs-attr">cache:</span> <span class="hljs-string">&#x27;npm&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">ci</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span> <span class="hljs-string">--if-present</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">zip</span> <span class="hljs-string">-r</span> <span class="hljs-string">ui.zip</span> <span class="hljs-string">ui/</span><br><br>      <span class="hljs-comment"># 部署到服务器</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">🚀</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">cross-the-world/ssh-scp-ssh-pipelines@latest</span> <br>        <span class="hljs-attr">env:</span><br>         <span class="hljs-attr">WELCOME:</span> <span class="hljs-string">&quot;ssh scp ssh pipelines&quot;</span><br>         <span class="hljs-attr">LASTSSH:</span> <span class="hljs-string">&quot;Doing something after copying&quot;</span><br>        <span class="hljs-attr">with:</span><br>         <span class="hljs-attr">host:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HOST</span> <span class="hljs-string">&#125;&#125;</span><br>         <span class="hljs-attr">user:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.USERNAME</span> <span class="hljs-string">&#125;&#125;</span><br>         <span class="hljs-attr">pass:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br>         <span class="hljs-attr">port:</span> <span class="hljs-number">22</span><br>         <span class="hljs-attr">first_ssh:</span> <span class="hljs-string">|</span><br><span class="hljs-string">            ls -a</span><br><span class="hljs-string"></span>         <span class="hljs-attr">scp:</span> <span class="hljs-string">|</span><br><span class="hljs-string">           &#x27;./ui.zip&#x27; =&gt; /www/wwwroot/default/x-springboot/</span><br><span class="hljs-string"></span>         <span class="hljs-attr">last_ssh:</span> <span class="hljs-string">|</span><br><span class="hljs-string">           cd /www/wwwroot/default/x-springboot/</span><br><span class="hljs-string">           unzip ui.zip</span><br></code></pre></td></tr></table></figure><h2 id="Springboot项目"><a href="#Springboot项目" class="headerlink" title="Springboot项目"></a>Springboot项目</h2><p>在项目中编写.github&#x2F;workflows&#x2F;maven.yml</p><p>1、checkout代码</p><p>2、使用maven打包项目成jarbao</p><p>3、scp发送到服务器指定地址</p><p>4、宝塔重新启动项目，当然你也可以在yaml中编写last_ssh: 执行java -jar启动项目</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Java</span> <span class="hljs-string">CI</span> <span class="hljs-string">with</span> <span class="hljs-string">Maven</span><br><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">&quot;master&quot;</span> ]<br>  <span class="hljs-attr">pull_request:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">&quot;master&quot;</span> ]<br><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">build:</span><br><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br><br>    <span class="hljs-attr">steps:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">JDK</span> <span class="hljs-number">17</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v3</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">java-version:</span> <span class="hljs-string">&#x27;17&#x27;</span><br>        <span class="hljs-attr">distribution:</span> <span class="hljs-string">&#x27;temurin&#x27;</span><br>        <span class="hljs-attr">cache:</span> <span class="hljs-string">maven</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">Maven</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">mvn</span> <span class="hljs-string">-B</span> <span class="hljs-string">package</span> <span class="hljs-string">--file</span> <span class="hljs-string">pom.xml</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">jar</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">cross-the-world/ssh-scp-ssh-pipelines@latest</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">host:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HOST</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">user:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.USERNAME</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">pass:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">22</span><br>        <span class="hljs-attr">scp:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          ./target/x-springboot.jar =&gt; /www/wwwroot/default/x-springboot/</span><br><span class="hljs-string"></span><span class="hljs-comment">#参考以下在scp上传包以后执行</span><br><span class="hljs-comment">#        last_ssh: |</span><br><span class="hljs-comment">#        nohup java -jar /www/wwwroot/default/x-springboot/x-springboot.jar &gt;temp.txt &amp; </span><br></code></pre></td></tr></table></figure><h2 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h2><p>当然这里每个人的项目不一样nginx配置都不一样，我只是用来记录一下方便以后恢复环境</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2;<br>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl http2;<br>    <span class="hljs-attribute">server_name</span> &lt;域名&gt;;<br>    <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">100m</span>;<br><br>    <span class="hljs-attribute">ssl_certificate</span> &lt;path&gt;_bundle.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> &lt;path&gt;.key;<br>    <span class="hljs-attribute">ssl_trusted_certificate</span> &lt;path&gt;_bundle.pem;<br><br>    <span class="hljs-comment"># SSL配置</span><br>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">1d</span>;<br>    <span class="hljs-attribute">ssl_session_cache</span> shared:MozSSL:<span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">ssl_session_tickets</span> <span class="hljs-literal">off</span>;<br><br>    <span class="hljs-comment"># SSL加密方式，使用现代化的加密套件</span><br>    <span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;<br>    <span class="hljs-attribute">ssl_ciphers</span> ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDSA-AES256-SHA384:RSA-AES256-SHA384:ECDSA-AES256-SHA:RSA-AES256-SHA:ECDSA-AES128-SHA256:RSA-AES128-SHA256:ECDSA-AES128-SHA:RSA-AES128-SHA:!DSS;<br><br><br>    <span class="hljs-section">location</span> / &#123;<br>        <span class="hljs-comment"># UI目录</span><br>        <span class="hljs-attribute">root</span> /www/wwwroot/default/x-springboot/ui/;<br>        <span class="hljs-comment">#动态页面</span><br>        <span class="hljs-attribute">proxy_set_header</span> X-forwarded-for <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        <span class="hljs-attribute">if</span> ( !-e <span class="hljs-variable">$request_filename</span> ) &#123;<br>            <span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:8080;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-section">location</span><span class="hljs-regexp"> ^~//</span> &#123;<br>        <span class="hljs-attribute">proxy_set_header</span> X-forwarded-for <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        <span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:8080;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>CI/CD</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>从输入URL到页面展示发生了什么？</title>
    <link href="/2023/08/10/%E4%BB%8E%E8%BE%93%E5%85%A5URL%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F/"/>
    <url>/2023/08/10/%E4%BB%8E%E8%BE%93%E5%85%A5URL%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<p>一个URL从浏览器输入到应用服务处理的完整请求过程涉及多个步骤，以下是一个简要的概述：</p><ol><li><p><strong>URL解析和分析</strong>： 用户在浏览器中输入URL（统一资源定位符）。浏览器需要解析这个URL，它包括协议（如http、https）、域名（例如<a href="http://www.example.com)、路径、查询参数等等./">www.example.com）、路径、查询参数等等。</a></p></li><li><p><strong>DNS解析</strong>： 浏览器需要将域名解析为IP地址，这一过程称为DNS解析。浏览器向本地DNS服务器发送请求，本地DNS服务器可能会查询其缓存，如果找不到，它会向根DNS服务器逐步查询，最终找到对应的IP地址。</p></li><li><p><strong>建立TCP连接</strong>： 通过解析得到的IP地址，浏览器与目标服务器建立TCP连接。这个过程涉及TCP的三次握手，确保浏览器与服务器之间可以进行数据传输。</p></li><li><p><strong>发起HTTP请求</strong>： 一旦TCP连接建立，浏览器会向服务器发送一个HTTP请求。这个请求中包含了之前解析得到的路径、查询参数、请求方法（GET、POST等）、Headers（例如User-Agent、Cookie等）等信息。</p><blockquote><p>:authority:cason.work</p><p>:method:GET</p><p>:path:&#x2F;api&#x2F;user&#x2F;sysInfo</p><p>:scheme:https</p><p>Accept:application&#x2F;json, text&#x2F;plain, <em>&#x2F;</em></p><p>Accept-Encoding:gzip, deflate, br</p><p>Accept-Language:zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8,en-US;q&#x3D;0.7,en-GB;q&#x3D;0.6</p><p>Cache-Control:no-cache</p><p>Cookie:na me&#x3D;1691121971; </p><p>Pragma:no-cache</p><p>Referer:<a href="https://cason.work/">https://cason.work/</a></p><p>Sec-Fetch-Dest:empty</p><p>Sec-Fetch-Mode:cors</p><p>Sec-Fetch-Site:same-origin</p><p>Token:***</p><p>User-Agent:Mozilla&#x2F;5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit&#x2F;605.1.15 (KHTML, like Gecko) Version&#x2F;13.0.3 Mobile&#x2F;15E148 Safari&#x2F;604.1 Edg&#x2F;115.0.0.0</p></blockquote></li><li><p><strong>服务器处理请求</strong>： 服务器接收到HTTP请求后，会根据请求的内容进行处理。如果请求的是静态资源（例如HTML文件、图片等），服务器会从文件系统中读取资源并返回给浏览器。如果请求需要应用逻辑处理（例如通过某种编程语言生成动态内容），服务器会将请求转发给相应的应用服务。</p></li><li><p><strong>应用服务处理</strong>： 应用服务接收到请求后，根据请求的内容执行相应的逻辑。这可能包括从数据库中检索数据、处理业务逻辑、生成动态内容等。</p></li><li><p><strong>生成HTTP响应</strong>： 应用服务处理完请求后，会生成一个HTTP响应。这个响应包括了状态码（例如200表示成功、404表示资源未找到等）、Headers（例如Content-Type、Cache-Control等）以及实际的响应内容。</p><blockquote><details open=""><devtools-response-header-section style="display: block;"><devtools-header-section-row data-index="0" style="display: block; --override-error-background-color: #d93025; margin-top: 2px;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Cache-Control:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">no-cache, no-store, max-age=0, must-revalidate<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="1" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Content-Type:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">application/json<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="2" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Date:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">Thu, 10 Aug 2023 11:47:23 GMT<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="3" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Expires:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">0<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="4" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Pragma:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">no-cache<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 1; visibility: visible; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="5" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Server:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">nginx<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="6" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Vary:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">Access-Control-Request-Headers<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="7" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Vary:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">Access-Control-Request-Method<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="8" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">Vary:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">Origin<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="9" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">X-Content-Type-Options:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">nosniff<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="10" style="display: block; --override-error-background-color: #d93025;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">X-Frame-Options:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">DENY<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row><devtools-header-section-row data-index="11" style="display: block; --override-error-background-color: #d93025; margin-bottom: 10px;"><div class=" row " style="display: flex; line-height: 20px; padding-left: 8px; gap: 12px; user-select: text;"><div class=" header-name " style="color: var(--color-text-primary); font-weight: 400; width: 160px; flex-shrink: 0; text-transform: capitalize; overflow-wrap: break-word;">X-Xss-Protection:</div><div class=" header-value " style="display: flex; overflow-wrap: anywhere;">1; mode=block<devtools-button class="enable-editing inline-button" role="presentation" title="替代标头" style="display: inline-flex; flex-direction: row; vertical-align: middle; opacity: 0; visibility: hidden; transition: opacity 200ms ease 0s; padding-left: 2px;"><button class=" round only-icon small tiny explicit-size " style="margin: 0px; padding: 0px; box-sizing: border-box; --button-has-right-border-radius: calc(1 - var(--override-button-no-right-border-radius, 0)); --button-border-size: 1px; --button-height: 18px; --button-width: 18px; align-items: center; border-radius: 100%; display: inline-flex; font-family: inherit; font-size: 12px; font-weight: 500; height: var(--button-height); line-height: 14px; justify-content: center; width: var(--button-width); white-space: nowrap; background: transparent; border: none; overflow: hidden;"><devtools-icon style="display: inline-block; white-space: nowrap; position: relative; margin: 0px; padding: 0px; box-sizing: border-box; width: unset; height: unset; --icon-color: var(--icon-default);"><div class="icon-basic" style="width: 16px; height: 16px; display: block; -webkit-mask-image: url(&quot;devtools://devtools/bundled/Images/edit.svg&quot;); -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; -webkit-mask-size: 99%; background-color: var(--icon-color, var(--color-background));"></div></devtools-icon><slot style="margin: 0px; padding: 0px; box-sizing: border-box;"></slot></button></devtools-button></div></div></devtools-header-section-row></devtools-response-header-section></details></blockquote></li><li><p><strong>传输HTTP响应</strong>： 服务器将生成的HTTP响应通过之前建立的TCP连接传输回浏览器。</p></li><li><p><strong>浏览器接收响应</strong>： 浏览器接收到服务器传回的HTTP响应。它会根据响应中的信息进行处理，例如解析HTML内容、渲染页面、执行JavaScript代码等。</p></li><li><p><strong>关闭连接</strong>： 一旦响应传输完毕，浏览器与服务器之间的TCP连接会被关闭。这一步确保连接资源被释放。</p></li></ol><p>总的来说，这个过程涉及了多个关键步骤，包括URL解析、DNS解析、建立TCP连接、发起HTTP请求、服务器处理、应用服务处理、生成HTTP响应、传输响应、浏览器处理等，最终将用户输入的URL转化为浏览器上可见的网页内容。</p>]]></content>
    
    
    
    <tags>
      
      <tag>面试问题</tag>
      
      <tag>网络</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>obsidian git ios 多平台同步</title>
    <link href="/2023/04/20/obsidian-git-ios-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%90%8C%E6%AD%A5/"/>
    <url>/2023/04/20/obsidian-git-ios-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%90%8C%E6%AD%A5/</url>
    
    <content type="html"><![CDATA[<p>Obsidian 提供了多种数据同步方式，其中可以通过第三方插件实现 Git 同步。通过 Git 同步，你可以将 Obsidian 中的笔记数据上传到 GitHub、GitLab、Bitbucket 等 Git 仓库中，从而实现在 iOS 和 Mac 等不同设备之间同步笔记。</p><p>以下是实现 Obsidian Git 同步的步骤：</p><h4 id="Mac："><a href="#Mac：" class="headerlink" title="Mac："></a>Mac：</h4><ol><li><p>在你的 Git 仓库中创建一个新的仓库，并将其克隆到本地计算机上。</p></li><li><p>在 Obsidian 中打开设置界面，选择「第三方插件」选项卡，安装并启用「Obsidian Git」插件。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304201140960.png" alt="image-20230420114013073"></p></li><li><p>在 Obsidian Git设置界面中，点击开启自动commit和push，并设置时间。</p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304201142184.png" alt="image-20230420114154147" style="zoom:50%;" /></li></ol><p>此时，Obsidian 中的笔记数据将被同步到 Git 仓库中</p><h4 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h4><ol><li>apple store下载ISH</li></ol><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304201146055.png" alt="image-20230420114624522"></p><ol start="2"><li><p>打开ISH执行以下命令</p><ol><li>安装git</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apk add git<br></code></pre></td></tr></table></figure><ol start="2"><li>用于在当前用户的主目录下创建一个名为 “obsidian” 的新文件夹</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~ &amp;&amp; mkdir obsidian<br></code></pre></td></tr></table></figure><ol start="3"><li>执行以下命令会打开手机文件管理器，之后需要选中本地的obsidian文件夹，点击完成。这样就让obsidian软件中的math文件夹，装载到ish上的obsidian文件夹内 ，之后对于obsidian软件内math文件的修改，iSH上也同步修改</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount -t ios . obsidian<br></code></pre></td></tr></table></figure><ol start="4"><li>通过cd命令，进入obsidian文件夹内</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ~/obsidian<br></code></pre></td></tr></table></figure><ol start="5"><li>Git 克隆仓库到obsidian目录,输入账号和密码（github personal access key）</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://xxxxxx.git<br></code></pre></td></tr></table></figure></li><li><p>打开obsidian就会看到你的仓库咯，然后打开Obsidian Git配置，git账号密码</p></li></ol><h4 id="异常解决"><a href="#异常解决" class="headerlink" title="异常解决"></a>异常解决</h4><p>如果遇到git clone 一直卡着 多次尝试都无法clone成功的</p><ol><li>先创建目录并进入目录</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir ～/obsidian/目录名<br>cd ～/obsidian/目录名<br></code></pre></td></tr></table></figure><ol start="2"><li>初始化git仓库</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git init<br></code></pre></td></tr></table></figure><ol start="3"><li>将一个名为 “safe.directory” 的 Git 全局配置设置添加到您的 Git 环境中，并将其设置为 “ <del>&#x2F;obsidian&#x2F;目录名” 目录。这个全局配置设置被添加到您的 “</del>&#x2F;.gitconfig” 文件中，并且可以被所有在您的本地机器上运行的 Git 仓库使用，以确保它们都知道您选择的安全目录的位置。这个命令是为了帮助您保护您的个人、敏感或重要的 Git 仓库，以防止在错误的位置或受到攻击的计算机上泄露。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git config --global --add safe.directory ~/obsidian/目录名<br></code></pre></td></tr></table></figure><ol start="4"><li>当 Git 打包一个仓库的对象时，会将这些对象压缩成一个文件存储在 Git 对象库中。这个操作非常耗费资源，因此使用多线程处理可以加速打包过程。设置 “pack.threads” 为 1 意味着 Git 将使用单线程进行打包操作，这样可能会减缓打包速度，但是也能够减少计算机的 CPU 和内存负载。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git config pack.threads 1<br></code></pre></td></tr></table></figure><ol start="5"><li>从远程仓库获取最新的提交和对象，但是不会将它们合并到当前的本地分支中。它通常被用来检查远程仓库中的最新变更，以便在本地进行更新或者合并操作之前先了解这些变更。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git fetch<br></code></pre></td></tr></table></figure><ol start="7"><li>如果想要拉取最新的代码并自动将其合并到本地分支中，可以使用 <code>git pull</code> 命令。但是如果只是想要知道远程仓库的最新状态，而不会改变当前的本地分支状态，可以使用 <code>git fetch</code>。这样可以避免不必要的合并冲突，提高工作效率。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git pull<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>obsidian</category>
      
    </categories>
    
    
    <tags>
      
      <tag>obsidian</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mysql事务</title>
    <link href="/2023/04/17/Mysql%E4%BA%8B%E5%8A%A1/"/>
    <url>/2023/04/17/Mysql%E4%BA%8B%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<p>数据库事务是指一组数据库操作，它们作为一个逻辑单元一起执行，要么全部执行，要么全部不执行。在数据库中，事务通常用于执行一系列的数据库操作，比如插入、更新或删除多条记录等。</p><h3 id="事务特性"><a href="#事务特性" class="headerlink" title="事务特性"></a>事务特性</h3><p>事务具有以下四个特性，通常称为 ACID 特性：</p><ol><li>原子性（Atomicity）：事务中的所有操作都要么全部执行，要么全部不执行，不允许出现部分执行的情况。</li><li>一致性（Consistency）：事务执行前和执行后，数据库的完整性约束没有被破坏。</li><li>隔离性（Isolation）：多个事务并发执行时，每个事务都应该感觉不到其他事务的存在，各个事务之间应该相互隔离。</li><li>持久性（Durability）：事务一旦提交成功，其结果就应该永久保存在数据库中，即使出现系统故障也不应该丢失。</li></ol><h3 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h3><p>脏读（Dirty Read）是指在一个事务中读取了另一个事务尚未提交的数据。在脏读的情况下，读取到的数据可能是不准确的，因为这些数据可能会被另一个事务撤销或修改。</p><p>例如，假设有两个事务 A 和 B，事务 A 在读取了一条数据之后，事务 B 修改了该数据，但是尚未提交。如果此时事务 A 再次读取该数据，那么就会读取到事务 B 修改后的数据，而这个数据可能是不准确的。</p><h3 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h3><p>在数据库事务中，不可重复读是指在同一个事务中，多次读取同一个数据时得到的结果可能不同。这通常是由于在事务执行期间，另一个并发的事务修改了同一个数据所导致的。</p><p>以下是一个示例，说明不可重复读的情况：</p><ol><li>事务T1读取数据X，获得结果A。</li><li>在T1读取数据X之后，事务T2修改了数据X，将其更改为B。</li><li>事务T1再次读取数据X，此时获得结果B，与第一次读取时的结果不同。</li></ol><h3 id="幻读"><a href="#幻读" class="headerlink" title="幻读"></a>幻读</h3><p>在数据库事务中，幻读是指在同一个事务中多次读取同一个范围内的记录时，得到的结果可能不同。这通常是由于在事务执行期间，另一个并发的事务插入或删除了一些记录所导致的。</p><p>以下是一个示例，说明幻读的情况：</p><ol><li>事务T1读取数据集X，获得结果A。</li><li>在T1读取数据集X之后，事务T2在数据集X中插入了一条新的记录，这条记录不在T1的结果集中。</li><li>事务T1再次读取数据集X，此时获得结果B，其中包含了T2插入的新记录。</li></ol><p>在这个示例中，T1的两次读取之间的差异就是幻读的结果。</p><h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>数据库事务隔离级别是指多个事务之间相互隔离的程度，可以通过设置隔离级别来控制事务之间的并发性和数据一致性。常见的隔离级别有四个，分别是：</p><ol><li>读未提交（Read Uncommitted）：在这个隔离级别下，一个事务可以读取另一个事务尚未提交的数据，会出现脏读、不可重复读和幻读的问题。</li><li>读已提交（Read Committed）：在这个隔离级别下，一个事务只能读取另一个事务已经提交的数据，可以避免脏读的问题，但是仍然会出现不可重复读和幻读的问题。</li><li>可重复读（Repeatable Read）：在这个隔离级别下，一个事务在执行期间多次读取同一条记录的数据时，会保证每次读取的数据都相同，可以避免脏读和不可重复读的问题，但是仍然会出现幻读的问题。</li><li>串行化（Serializable）：在这个隔离级别下，所有的事务都是串行执行的，每个事务必须等待前一个事务执行完成后才能执行，可以避免脏读、不可重复读和幻读的问题，但是会降低系统的并发性能。</li></ol><h3 id="log"><a href="#log" class="headerlink" title="log"></a>log</h3><h4 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h4><p>在 MySQL 中，redo log 是一种用于崩溃恢复和事务持久化的机制。redo log 记录了所有的修改操作，即事务对数据库中数据所做的所有修改。当 MySQL 在崩溃后重新启动时，它可以使用 redo log 来恢复最后一次崩溃之前提交的事务。</p><p>redo log 是基于磁盘的日志，它是循环写入的，当所有的 redo log 被写满之后，MySQL 将从 redo log 的开头重新开始写入。redo log 存储在磁盘上，因此它不会消耗过多的内存。</p><p>redo log 的工作原理是：当一个事务开始时，所有的修改操作都被记录到 redo log 中，但实际的数据修改操作不会立即被执行。相反，它们会被暂时保存在内存中，等到事务提交时，MySQL 才会将其写入磁盘。这样做的目的是为了减少磁盘写入的次数，提高系统的性能。</p><p>当 MySQL 发生崩溃或非正常关闭时，redo log 就发挥了重要的作用。MySQL 在重新启动时，会检查 redo log 中尚未提交的事务，然后将其重新执行，以保证数据库状态的一致性。</p><h4 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h4><p>在 MySQL 中，undo log 是用于事务回滚和 MVCC（多版本并发控制）实现的机制。当一个事务开始时，MySQL 会创建一个 undo log 来记录该事务所做的修改操作。当事务被回滚时，MySQL 就会使用 undo log 将数据恢复到事务开始之前的状态。</p><p>与 redo log 不同的是，undo log 记录的是原始数据的“旧值”，而不是新的修改值。因此，在事务回滚时，MySQL 可以使用 undo log 将数据恢复到事务开始之前的状态。此外，undo log 还可以用于支持 MVCC 实现，MVCC 允许多个事务同时读取同一个数据项，而不会互相干扰。</p><p>undo log 存储在磁盘上，但它们通常存储在内存中的临时缓冲区中。当事务提交时，MySQL 会将其对应的 undo log 从内存中写入磁盘中的 undo log 文件中。如果一个事务还没有提交，那么它的 undo log 就不会被写入磁盘，这样可以避免写入磁盘的开销。</p><h4 id="bin-log"><a href="#bin-log" class="headerlink" title="bin log"></a>bin log</h4><p>在 MySQL 中，bin log 是用于数据备份、恢复以及复制的机制。bin log 记录了 MySQL 中所有修改数据的操作，包括对数据的插入、更新和删除等操作。</p><p>bin log 存储在磁盘上，可以用来恢复数据或复制数据到其他 MySQL 实例。因此，bin log 可以用于数据备份和恢复，也可以用于主从复制，将一个 MySQL 实例的数据复制到其他 MySQL 实例。</p><p>bin log 的工作原理是：当一个事务开始时，MySQL 会将所有的修改操作记录到 bin log 中。当事务提交时，MySQL 将事务的提交信息一并记录到 bin log 中。因此，bin log 中不仅包含数据的修改操作，还包含了事务提交的时间、事务 ID 等信息。</p><p>bin log 有多种格式，包括 statement、row 和 mixed 等格式。其中，statement 格式记录的是 SQL 语句，row 格式记录的是行级别的变化，mixed 格式是两者的结合。</p><h4 id="事务中日志执行流程"><a href="#事务中日志执行流程" class="headerlink" title="事务中日志执行流程"></a>事务中日志执行流程</h4><ol><li><p>记录undo log，将修改前的数据记录到undoLog中，以便在事务回滚时恢复原来的数据。</p></li><li><p>执行事务中的SQL语句，这些语句会修改数据库中的数据。</p></li><li><p>记录redo log，将修改后的数据写入到磁盘上的数据文件中，保证事务的持久性。</p></li><li><p>记录bin log，将执行的SQL语句记录在二进制日志中，以便用于主从同步和数据恢复等。</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>zookeeper简单使用+工具类</title>
    <link href="/2023/04/13/zookeeper%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E5%B7%A5%E5%85%B7%E7%B1%BB/"/>
    <url>/2023/04/13/zookeeper%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E5%B7%A5%E5%85%B7%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<p>Zookeeper是一种分布式协调服务，旨在帮助构建可靠的分布式系统。它提供了一组原语，用于协调不同进程之间的通信和同步。Zookeeper可以用于各种分布式应用程序，例如分布式锁，配置管理，队列等。</p><p>Zookeeper的核心概念是znode，它是一种特殊的节点，类似于文件系统中的目录或文件。每个znode都有一个名称和一个关联的数据。Zookeeper维护了一个分层的znode命名空间，类似于文件系统中的目录树。通过创建，删除和更新znode，应用程序可以实现在不同进程之间共享状态的协调。</p><p>Zookeeper还提供了一些特殊的znode，例如临时节点和顺序节点，用于实现分布式锁和队列等功能。</p><p>Zookeeper使用一种称为“Zab”的协议来保持数据的一致性。Zab协议确保在分布式系统中的所有节点之间，只有一个节点是主节点，其余节点都是从节点。主节点负责处理所有写操作，然后将结果复制到所有从节点。这种方式可以保证系统在任何时候都具有一致的状态。</p><p><strong>永久节点和临时节点</strong></p><p>Zookeeper中，永久节点和临时节点的不同点在于它们的生命周期和用途。</p><ol><li>生命周期：</li></ol><ul><li>永久节点：一旦创建，节点将一直存在直到被显式删除。即使客户端和Zookeeper Server之间的连接断开，节点也会一直存在于Zookeeper Server上。</li><li>临时节点：当创建临时节点的客户端和Zookeeper Server短暂的失去连接时，节点会被自动删除。如果客户端与Zookeeper Server之间的连接恢复，则节点将重新出现在Zookeeper Server上。</li></ul><ol start="2"><li>用途：</li></ol><ul><li>永久节点：用于存储永久性的数据，例如配置信息、元数据等。</li><li>临时节点：用于表示在线客户端的状态，例如任务调度节点、任务执行状态、队列中的元素等。</li></ul><p>因此，开发人员在使用Zookeeper时需要根据实际需求选择永久节点或临时节点来存储数据。</p><p><strong>有序节点和无序节点</strong></p><p>Zookeeper中，有序节点和无序节点的不同点在于它们的节点名称和排序方式。</p><ol><li>节点名称：</li></ol><ul><li>无序节点：节点名称由用户指定，Zookeeper会检查该名称是否已经存在，如果已存在则会报错。节点名称可以是任何字符串。</li><li>有序节点：节点名称由Zookeeper自动分配，节点名称的格式为指定节点名称后跟着一个序号，例如：&#x2F;myapp&#x2F;node00001。在分配节点名称时，Zookeeper会根据节点编号的大小来排序节点。</li></ul><ol start="2"><li>排序方式：</li></ol><ul><li>无序节点：节点无法进行排序，只能根据节点名称进行查找。</li><li>有序节点：节点根据节点编号的大小进行排序，可以通过节点的编号来查找节点，而不是通过节点的名称。</li></ul><p>有序节点在实际应用中，常用于实现队列或者锁等功能，因为有序节点总是能够保证执行的先后顺序。而无序节点通常用于存储配置信息等，因为修改、删除等操作较频繁，使用有序节点会带来一定的复杂度。</p><h3 id="Springboot集成"><a href="#Springboot集成" class="headerlink" title="Springboot集成"></a>Springboot集成</h3><p>Curator是一个Zookeeper客户端库，提供了一组简单易用的API，可以帮助开发者更容易地与Zookeeper进行交互。Curator也提供了一些实用的特性，例如重试机制、选举、分布式锁等，可以帮助开发者构建可靠的分布式应用程序。</p><p>application.properties</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#地址和端口号</span><br><span class="hljs-attr">curator.zookeeper.address</span>=<span class="hljs-string">127.0.0.1:2181</span><br><span class="hljs-comment">#会话超时时间 单位ms</span><br><span class="hljs-attr">curator.zookeeper.session_timeout</span>=<span class="hljs-string">60000</span><br><span class="hljs-comment">#连接超时时间 单位ms</span><br><span class="hljs-attr">curator.zookeeper.connection_timeout</span>=<span class="hljs-string">15000</span><br><span class="hljs-comment">#默认为操作的根节点，为了实现不同的Zookeeper业务之间的隔离，所有操作都是基于该目录进行的</span><br><span class="hljs-attr">curator.zookeeper.name_space</span>=<span class="hljs-string">beixian</span><br><span class="hljs-comment">#重试间隔时间</span><br><span class="hljs-attr">curator.zookeeper.base_sleep_time_ms</span>=<span class="hljs-string">3000</span><br><span class="hljs-comment">#重试次数</span><br><span class="hljs-attr">curator.zookeeper.max_retries</span>=<span class="hljs-string">10</span><br></code></pre></td></tr></table></figure><p>CuratorConfig.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CuratorConfig</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;curator.zookeeper.address&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String zkAddress;<br>    <span class="hljs-meta">@Value(&quot;$&#123;curator.zookeeper.session_timeout&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> sessionTimeout;<br>    <span class="hljs-meta">@Value(&quot;$&#123;curator.zookeeper.connection_timeout&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> connectionTimeout;<br>    <span class="hljs-meta">@Value(&quot;$&#123;curator.zookeeper.name_space&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String nameSpace;<br>    <span class="hljs-meta">@Value(&quot;$&#123;curator.zookeeper.base_sleep_time_ms&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> baseSleepTimeMs;<br>    <span class="hljs-meta">@Value(&quot;$&#123;curator.zookeeper.max_retries&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxRetries;<br><br>    <span class="hljs-meta">@Bean(initMethod = &quot;start&quot;, destroyMethod = &quot;close&quot;)</span><br>    <span class="hljs-keyword">public</span> CuratorFramework <span class="hljs-title function_">curatorFramework</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">RetryPolicy</span> <span class="hljs-variable">retryPolicy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExponentialBackoffRetry</span>(baseSleepTimeMs, maxRetries);<br>        <span class="hljs-keyword">return</span> CuratorFrameworkFactory.builder()<br>                .connectString(zkAddress)<br>                .sessionTimeoutMs(sessionTimeout)<br>                .connectionTimeoutMs(connectionTimeout)<br>                .retryPolicy(retryPolicy)<br>                .namespace(nameSpace)<br>                .build();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h3><p>通过以下工具类实现对zookeeper节点的增删改查</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZookeeperService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CuratorFramework client;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建永久Zookeeper节点</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath  节点路径（如果父节点不存在则会自动创建父节点），如：/curator</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodeValue 节点数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回创建成功的节点路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createPersistentNode</span><span class="hljs-params">(String nodePath, String nodeValue)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> client.create().creatingParentsIfNeeded().forPath(nodePath, nodeValue.getBytes());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;创建永久Zookeeper节点失败,nodePath:&#123;&#125;,nodeValue:&#123;&#125;&quot;</span>, nodePath, nodeValue, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建永久有序Zookeeper节点</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath  节点路径（如果父节点不存在则会自动创建父节点），如：/curator</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodeValue 节点数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回创建成功的节点路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createSequentialPersistentNode</span><span class="hljs-params">(String nodePath, String nodeValue)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> client.create().creatingParentsIfNeeded()<br>                    .withMode(CreateMode.PERSISTENT_SEQUENTIAL)<br>                    .forPath(nodePath, nodeValue.getBytes());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;创建永久有序Zookeeper节点失败,nodePath:&#123;&#125;,nodeValue:&#123;&#125;&quot;</span>, nodePath, nodeValue, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建临时Zookeeper节点</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath  节点路径（如果父节点不存在则会自动创建父节点），如：/curator</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodeValue 节点数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回创建成功的节点路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createEphemeralNode</span><span class="hljs-params">(String nodePath, String nodeValue)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> client.create().creatingParentsIfNeeded()<br>                    .withMode(CreateMode.EPHEMERAL)<br>                    .forPath(nodePath, nodeValue.getBytes());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;创建临时Zookeeper节点失败,nodePath:&#123;&#125;,nodeValue:&#123;&#125;&quot;</span>, nodePath, nodeValue, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建临时有序Zookeeper节点</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath  节点路径（如果父节点不存在则会自动创建父节点），如：/curator</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodeValue 节点数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回创建成功的节点路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createSequentialEphemeralNode</span><span class="hljs-params">(String nodePath, String nodeValue)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> client.create().creatingParentsIfNeeded()<br>                    .withMode(CreateMode.EPHEMERAL_SEQUENTIAL)<br>                    .forPath(nodePath, nodeValue.getBytes());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;创建临时有序Zookeeper节点失败,nodePath:&#123;&#125;,nodeValue:&#123;&#125;&quot;</span>, nodePath, nodeValue, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检查Zookeeper节点是否存在</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath 节点路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean 如果存在则返回true</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkExists</span><span class="hljs-params">(String nodePath)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Stat</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> client.checkExists().forPath(nodePath);<br><br>            <span class="hljs-keyword">return</span> stat != <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;检查Zookeeper节点是否存在出现异常,nodePath:&#123;&#125;&quot;</span>, nodePath, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取某个Zookeeper节点的所有子节点</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath 节点路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回所有子节点的节点名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getChildren</span><span class="hljs-params">(String nodePath)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> client.getChildren().forPath(nodePath);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;获取某个Zookeeper节点的所有子节点出现异常,nodePath:&#123;&#125;&quot;</span>, nodePath, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取某个Zookeeper节点的数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath 节点路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 节点存储的数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getData</span><span class="hljs-params">(String nodePath)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(client.getData().forPath(nodePath));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;获取某个Zookeeper节点的数据出现异常,nodePath:&#123;&#125;&quot;</span>, nodePath, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置某个Zookeeper节点的数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath 节点路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setData</span><span class="hljs-params">(String nodePath, String newNodeValue)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            client.setData().forPath(nodePath, newNodeValue.getBytes());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;设置某个Zookeeper节点的数据出现异常,nodePath:&#123;&#125;&quot;</span>, nodePath, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除某个Zookeeper节点</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath 节点路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String nodePath)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            client.delete().guaranteed().forPath(nodePath);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;删除某个Zookeeper节点出现异常,nodePath:&#123;&#125;&quot;</span>, nodePath, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 级联删除某个Zookeeper节点及其子节点</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath 节点路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteChildrenIfNeeded</span><span class="hljs-params">(String nodePath)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            client.delete().guaranteed().deletingChildrenIfNeeded().forPath(nodePath);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;级联删除某个Zookeeper节点及其子节点出现异常,nodePath:&#123;&#125;&quot;</span>, nodePath, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 监听节点变化</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nodePath 节点路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheListener</span><span class="hljs-params">(String nodePath, CuratorCacheListener listener)</span> &#123;<br>        <span class="hljs-comment">//1.创建curatorCache对象</span><br>        <span class="hljs-type">CuratorCache</span> <span class="hljs-variable">curatorCache</span> <span class="hljs-operator">=</span> CuratorCache.build(client, nodePath);<br>        <span class="hljs-comment">//2.注册监听器</span><br>        curatorCache.listenable().addListener(listener);<br>        <span class="hljs-comment">//3.开启监听：true加载缓冲数据</span><br>        curatorCache.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="监听改动"><a href="#监听改动" class="headerlink" title="监听改动"></a>监听改动</h3><p>要通过Curator来监听Zookeeper上的目录，可以使用Curator提供的CuratorCache类。CuratorCache类可以监听一个目录下的所有子节点，并且可以自动处理节点的新增、删除、更新等事件。下面是一个使用CuratorCache类监听Zookeeper上目录的示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CuratorWatcher</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CuratorFramework curatorFramework;<br><br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span>;<br>        <span class="hljs-type">CuratorCache</span> <span class="hljs-variable">curatorCache</span> <span class="hljs-operator">=</span> CuratorCache.build(curatorFramework, path);<br>        curatorCache.listenable().addListener((type, childData, childData1) -&gt; &#123;<br>            <span class="hljs-keyword">switch</span> (type) &#123;<br>                <span class="hljs-keyword">case</span> NODE_CHANGED:<br>                    log.info(<span class="hljs-string">&quot;节点数据修改&quot;</span>);<br>                    log.info(<span class="hljs-string">&quot;修改前的节点路径：&quot;</span> + childData.getPath());<br>                    log.info(<span class="hljs-string">&quot;修改前的节点数据：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(childData.getData()));<br>                    log.info(<span class="hljs-string">&quot;修改后的节点路径：&quot;</span> + childData1.getPath());<br>                    log.info(<span class="hljs-string">&quot;修改后的节点数据：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(childData1.getData()));<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> NODE_CREATED:<br>                    log.info(<span class="hljs-string">&quot;新增节点&quot;</span>);<br>                    log.info(<span class="hljs-string">&quot;新增节点的路径&quot;</span> + childData1.getPath());<br>                    log.info(<span class="hljs-string">&quot;新增节点的数据：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(childData1.getData()));<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> NODE_DELETED:<br>                    log.info(<span class="hljs-string">&quot;删除节点&quot;</span>);<br>                    log.info(<span class="hljs-string">&quot;删除节点的路径&quot;</span> + childData.getPath());<br>                    log.info(<span class="hljs-string">&quot;删除节点的数据：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(childData.getData()));<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;);<br>        curatorCache.start();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="简单实现分布式锁"><a href="#简单实现分布式锁" class="headerlink" title="简单实现分布式锁"></a>简单实现分布式锁</h3><p>InterProcessMutex是Zookeeper中提供的一种分布式锁实现方式。它基于Zookeeper的有序节点的特性实现，通过在Zookeeper上创建一个有序节点来代表锁，并通过检查该节点的前一个节点是否存在来控制锁的获取和释放。</p><p>InterProcessMutex的主要方法包括：</p><ol><li>acquire()：获取锁，如果锁处于可用状态，则获取锁，在锁被释放之前将一直阻塞。</li><li>acquire(long time, TimeUnit unit)：尝试获取锁，最多阻塞指定的时间，如果成功获取锁则返回true，否则返回false。</li><li>release()：释放锁，如果当前线程持有锁，则释放锁。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZookeeperLockService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CuratorFramework client;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">lock</span><span class="hljs-params">(String path, <span class="hljs-type">long</span> timeMs)</span> &#123;<br>        <span class="hljs-type">InterProcessMutex</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessMutex</span>(client, path);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> lock.acquire(timeMs, TimeUnit.MILLISECONDS);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(e.getMessage(), e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String path)</span> &#123;<br>        <span class="hljs-type">InterProcessMutex</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessMutex</span>(client, path);<br>        <span class="hljs-keyword">try</span> &#123;<br>            lock.release();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(e.getMessage(), e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>zookeeper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java html转pdf 且解决中文不显示问题</title>
    <link href="/2023/04/10/Java-html%E8%BD%ACpdf-%E4%B8%94%E8%A7%A3%E5%86%B3%E4%B8%AD%E6%96%87%E4%B8%8D%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/"/>
    <url>/2023/04/10/Java-html%E8%BD%ACpdf-%E4%B8%94%E8%A7%A3%E5%86%B3%E4%B8%AD%E6%96%87%E4%B8%8D%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p> 记录一下利用freemarker 将html转换pdf的教程</p><p><strong>pom.xml引入包</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.itextpdf/itextpdf --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itextpdf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>itextpdf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.5.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.itextpdf.tool/xmlworker --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itextpdf.tool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xmlworker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.5.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.xhtmlrenderer/flying-saucer-pdf --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.xhtmlrenderer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flying-saucer-pdf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.1.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.xhtmlrenderer/flying-saucer-pdf-itext5 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.xhtmlrenderer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flying-saucer-pdf-itext5<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.1.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br>        <span class="hljs-comment">&lt;!-- 解决中文字体问题 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itextpdf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>itext-asian<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.freemarker/freemarker --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.19<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>解决中文不显示问题</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.express.excms.enroll.config;<br><br><span class="hljs-keyword">import</span> com.itextpdf.text.Font;<br><span class="hljs-keyword">import</span> com.itextpdf.text.pdf.BaseFont;<br><span class="hljs-keyword">import</span> com.itextpdf.tool.xml.XMLWorkerFontProvider;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by IntelliJ IDEA.</span><br><span class="hljs-comment"> * User: 贝先 [ Cason mo ]</span><br><span class="hljs-comment"> * Date: 2021/11/12</span><br><span class="hljs-comment"> * Time: 14:46</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsianFontProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">XMLWorkerFontProvider</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Font <span class="hljs-title function_">getFont</span><span class="hljs-params">(String fontname, String encoding, <span class="hljs-type">float</span> size, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> style)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">BaseFont</span> <span class="hljs-variable">bfChinese</span> <span class="hljs-operator">=</span>BaseFont.createFont( <span class="hljs-string">&quot;STSong-Light&quot;</span>, <span class="hljs-string">&quot;UniGB-UCS2-H&quot;</span>, BaseFont.EMBEDDED);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>(bfChinese, size, style);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getFont(fontname, encoding, size, style);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>html转pdf</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.express.excms.enroll.utils;<br><br><span class="hljs-keyword">import</span> com.express.excms.enroll.config.AsianFontProvider;<br><span class="hljs-keyword">import</span> com.itextpdf.text.Document;<br><span class="hljs-keyword">import</span> com.itextpdf.text.pdf.PdfWriter;<br><span class="hljs-keyword">import</span> com.itextpdf.tool.xml.XMLWorkerHelper;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by IntelliJ IDEA.</span><br><span class="hljs-comment"> * User: 贝先 [ Cason mo ]</span><br><span class="hljs-comment"> * Date: 2021/10/18</span><br><span class="hljs-comment"> * Time: 10:54</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PDFUtils</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ByteArrayOutputStream pdf文件流</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> htmlContent 通过freemarker生成的html</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">htmlToPdf</span><span class="hljs-params">(String htmlContent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();<br>        <span class="hljs-type">PdfWriter</span> <span class="hljs-variable">pdfWriter</span> <span class="hljs-operator">=</span> PdfWriter.getInstance(document, output);<br>        document.open();<br>        XMLWorkerHelper.getInstance().parseXHtml(pdfWriter,document,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(htmlContent.getBytes(StandardCharsets.UTF_8)),<span class="hljs-literal">null</span>, StandardCharsets.UTF_8,<span class="hljs-keyword">new</span> <span class="hljs-title class_">AsianFontProvider</span>());<br>        document.close();<br>        <span class="hljs-keyword">return</span> output;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 写入到文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> htmlContent 通过freemarker生成的html</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filePath 要写入的pdf文件地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">htmlToPdf</span><span class="hljs-params">(String htmlContent,String filePath)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();<br>        <span class="hljs-type">PdfWriter</span> <span class="hljs-variable">pdfWriter</span> <span class="hljs-operator">=</span> PdfWriter.getInstance(document, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(filePath));<br>        document.open();<br>        XMLWorkerHelper.getInstance().parseXHtml(pdfWriter,document,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(htmlContent.getBytes(StandardCharsets.UTF_8)),<span class="hljs-literal">null</span>, StandardCharsets.UTF_8,<span class="hljs-keyword">new</span> <span class="hljs-title class_">AsianFontProvider</span>());<br>        document.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>freemarker 解析并获取生成的html</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">        <span class="hljs-meta">@Autowired</span><br>        <span class="hljs-keyword">private</span> Configuration configuration;<br><br><br>......省略<br><br><br><br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">cfg</span> <span class="hljs-operator">=</span> (Configuration) configuration.clone();<br>        cfg.clearTemplateCache();<br>        <span class="hljs-type">Template</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Template</span>(templateInDB.getName(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(未渲染的html), configuration);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">html</span> <span class="hljs-operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(t, 要渲染的数据);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> PDFUtils.htmlToPdf(html);<br>            <span class="hljs-comment">//获取pdf的base64</span><br>            <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br>       <br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> ResponseResult.defaultFailed(e.getMessage());<br>        &#125;<br>    <br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>效果图</strong></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304101743692.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>设计模式-适配器模式</title>
    <link href="/2023/04/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
    <url>/2023/04/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p>适配器模式是一种结构型设计模式，它允许将一个现有的类与另一个不兼容的类进行协同工作。适配器模式通过创建一个中间适配器来连接两个不兼容的接口，使它们能够正常地协作。</p><p>适配器模式适用于需要将不兼容的类或接口进行适配的情况。例如，当我们需要将一个旧版 API 系统与新版的客户端进行集成时，可以使用适配器模式将两种不同的接口进行适配。适配器模式的主要优点是可以复用现有的代码，减少代码的修改和重构，从而提高代码的可维护性和可重用性。但是，适配器模式也会增加系统的复杂度，需要额外的适配器类来协调两个不兼容的接口，在设计时需要慎重考虑其使用场景和影响。</p><h3 id="简单实现"><a href="#简单实现" class="headerlink" title="简单实现"></a>简单实现</h3><p><strong>大概的构思图</strong><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304101732677.png" alt="构思图"></p><p><strong>这是影像数据输出接口</strong>（只输出数据啊 不负责显示！！！）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IComputerOuputContent</span> &#123;<br>    String <span class="hljs-title function_">toDisplayData</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p> <strong>适配器接口类</strong>（数据转换器接口类）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IVideoAdapter</span> &#123;<br>    String <span class="hljs-title function_">convertData</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>输出数据接口实现类</strong>  电脑</p><p> 一台电脑implements很多接口  比如各种输入接口（键盘输入接口 鼠标输入接口）  输出接口 （显示屏内容输出接口 音频输出接口）</p><p> 当然我这里只实现了影像输出接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Computer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IComputerOuputContent</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toDisplayData</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//给显示器的数据 显示器无法理解的</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1101010101010101010&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p> <strong>适配器类</strong>   就是把电脑给的数据转化为图像的东东</p><p> computer（电脑）输出的<code>1101010101010101010</code>是 Displayer（显示器）不能直接显示的内容</p><p> adapter（适配器） 应运而生  这个adapter是可以做很多事情的  但是我只实现了IVideoAdapter（影像数据适配（转换）功能） 当然你还可以implements别的功能，Adapter（适配器）负责把computer（电脑）输出的数据解码成Displayer（显示器）能理解的编码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Computer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IVideoAdapter</span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 此处进行适配(数据转换)</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 改写适配器convertData接口  执行解码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">convertData</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 获取Computer给的数据</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">displayData</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.toDisplayData();<br>        <span class="hljs-comment">//此处正在努力转换成显示器能接受的数据。。。。。。。假装在解码</span><br>        displayData = displayData.replace(<span class="hljs-string">&quot;1101010101&quot;</span>, <span class="hljs-string">&quot;你&quot;</span>)<br>                .replace(<span class="hljs-string">&quot;010101010&quot;</span>, <span class="hljs-string">&quot;好&quot;</span>);<br>        <span class="hljs-keyword">return</span> displayData;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>显示器类</strong></p><p>输出转换后Displayer（显示器）能理解的编码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Displayer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> IVideoAdapter videoAdapter;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 给显示器加个影像数据适配（转换）器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> videoAdapter</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setVideoAdapter</span><span class="hljs-params">(IVideoAdapter videoAdapter)</span> &#123;<br>        <span class="hljs-built_in">this</span>.videoAdapter = videoAdapter;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 显示内容</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">view</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(videoAdapter.convertData());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>main方法测试一下</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 实例化显示器</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">Displayer</span> <span class="hljs-variable">displayer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Displayer</span>();<br>        displayer.setVideoAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Adapter</span>());<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 把数据转换器接入显示器</span><br><span class="hljs-comment">         * 显示器显示内容</span><br><span class="hljs-comment">         */</span><br>        displayer.view();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出内容</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304102055869.png" alt="image-20230410205458740"></p><p>懒得敲代码的人可以到这里下载<a href="https://download.csdn.net/download/Mo_0214/12536851">https://download.csdn.net/download/Mo_0214/12536851</a></p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo-PicGo+Github配置图床</title>
    <link href="/2023/04/10/hexo-PicGo-Github%E9%85%8D%E7%BD%AE%E5%9B%BE%E5%BA%8A/"/>
    <url>/2023/04/10/hexo-PicGo-Github%E9%85%8D%E7%BD%AE%E5%9B%BE%E5%BA%8A/</url>
    
    <content type="html"><![CDATA[<p>使用 PicGo 将图片上传到 Github 仓库作为图床，需要进行以下几个步骤：</p><ol><li><p>在 Github 上创建一个公开仓库，用于存放图片。仓库名称可以自定义，建议取一个简单明了的名称，比如 <code>pic-go</code>。</p></li><li><p>在本地安装 PicGo，并在设置中选择 Github 作为上传方式。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304100345581.png" alt="image-20230410034338520"></p></li><li><p>创建一个 Github token，用于访问 Github 仓库。在 Github 中进入 <code>Settings</code> -&gt; <code>Developer settings</code> -&gt; <code>Personal access tokens</code>，点击 <code>Generate new token</code> 按钮，按照提示填写 token 的名称和权限，并点击 <code>Generate token</code> 按钮生成 token。复制 token 的值，然后在 PicGo 的设置中将其粘贴到 <code>Token</code> 中。</p></li><li><p>上传图片</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304100346131.png" alt="image-20230410034508553">上传完成后，PicGo 会自动将图片的访问链接复制到剪贴板中，可以直接将链接粘贴到需要使用图片的地方。</p></li></ol><p>需要注意的是，Github 有上传文件大小限制，单个文件不能超过 100 MB，总大小不能超过 1 GB。另外，上传的图片会占用 Github 的存储空间，需要根据实际情况进行管理。</p>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo-优化seo</title>
    <link href="/2023/04/10/Hexo-%E4%BC%98%E5%8C%96seo/"/>
    <url>/2023/04/10/Hexo-%E4%BC%98%E5%8C%96seo/</url>
    
    <content type="html"><![CDATA[<h4 id="Sitemap"><a href="#Sitemap" class="headerlink" title="Sitemap"></a>Sitemap</h4><p>Sitemap是一种包含网站所有页面URL的XML文件，有助于搜索引擎更快地索引和发现您的网站。以下是在Hexo中使用Sitemap优化SEO的步骤：</p><ol><li>安装hexo-generator-sitemap插件。可以使用以下命令进行安装：</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install hexo-generator-sitemap --save<br></code></pre></td></tr></table></figure><ol><li>在Hexo配置文件_config.yml中添加以下内容：</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">sitemap:</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">sitemap.xml</span><br>  <span class="hljs-attr">exclude:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/404.html</span><br>  <span class="hljs-attr">lastmod:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">priority:</span> <span class="hljs-number">0.8</span><br>  <span class="hljs-attr">changefreq:</span> <span class="hljs-string">weekly</span><br></code></pre></td></tr></table></figure><p>其中，<code>path</code>是Sitemap文件的生成路径；<code>exclude</code>是要排除的页面列表；<code>lastmod</code>用于在Sitemap中包含最后修改时间；<code>priority</code>表示页面的重要性，值的范围为0.0到1.0；<code>changefreq</code>表示页面更新频率。</p><ol><li>生成Sitemap。使用以下命令在Hexo中生成Sitemap文件：</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo generate --deploy<br></code></pre></td></tr></table></figure><p>这将生成Sitemap文件并将其部署到您的网站目录下。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304100235786.png" alt="image-20230410022647919"></p><ol><li>提交Sitemap到搜索引擎。将Sitemap文件提交到Google Search Console和Bing Webmaster Tools等搜索引擎工具中，以帮助搜索引擎更快地发现和索引您的网站。</li></ol><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304100224631.png" alt="image-20230410022410719"></p><p>通过使用Sitemap，您可以确保搜索引擎可以找到您的网站的所有页面，并更好地理解您网站的结构和内容，从而提高您的网站在搜索结果中的排名。</p><h4 id="Robots-txt"><a href="#Robots-txt" class="headerlink" title="Robots.txt"></a>Robots.txt</h4><p>Robots 文件是一个文本文件，用于向搜索引擎指示哪些页面可以访问和索引，哪些页面应该被忽略。通过优化 Robots 文件，可以提高您的网站在搜索引擎中的排名和曝光度。</p><p>在 Hexo 中使用 Robots 文件进行 SEO 优化，可以按照以下步骤操作：</p><ol><li>在 Hexo 根目录下创建一个名为 <code>robots.txt</code> 的文件。</li><li>打开 <code>robots.txt</code> 文件，输入以下内容：</li></ol><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">makefileCopy code<br><span class="hljs-section">User-agent: *</span><br><span class="hljs-section">Disallow:</span><br></code></pre></td></tr></table></figure><p>其中，<code>User-agent: *</code> 表示允许所有搜索引擎访问您的网站，<code>Disallow:</code> 表示允许搜索引擎访问您的网站中所有页面和文件。</p><ol><li>如果您需要禁止某些搜索引擎访问您的网站，请添加以下内容：</li></ol><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">makefileCopy</span> <span class="hljs-selector-tag">code</span><br><span class="hljs-selector-tag">User-agent</span>: <span class="hljs-selector-attr">[搜索引擎名称]</span><br><span class="hljs-selector-tag">Disallow</span>: /<br></code></pre></td></tr></table></figure><p>其中，<code>[搜索引擎名称]</code> 表示您要禁止访问的搜索引擎名称，<code>Disallow: /</code> 表示禁止该搜索引擎访问您的网站中所有页面和文件。</p><p>例如，如果您想禁止 Google 访问您的网站，可以将以下内容添加到 <code>robots.txt</code> 文件中：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">makefileCopy code<br><span class="hljs-section">User-agent: Googlebot</span><br><span class="hljs-section">Disallow: /</span><br></code></pre></td></tr></table></figure><ol><li>保存并上传 <code>robots.txt</code> 文件到您的网站根目录下。</li><li>使用 Google Search Console 的 Robots.txt 检查工具，检查您的 Robots 文件是否存在问题，并且是否被正确解析。</li></ol><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304100227739.png" alt="image-20230410022631870"></p><p>注意：Robots 文件可以帮助您优化 SEO，但是也需要谨慎使用。请确保您了解 Robots 文件的规则和用法，以避免出现意外的问题。</p>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mysql索引</title>
    <link href="/2023/04/10/Mysql%E7%B4%A2%E5%BC%95/"/>
    <url>/2023/04/10/Mysql%E7%B4%A2%E5%BC%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本文基于Innodb存储引擎编写，图源+总结自《mysql是怎样运行的》</p></blockquote><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>MySQL索引是MySQL数据库中的一种数据结构，它可以帮助快速查询数据。它类似于书的索引，可以让您快速找到特定的数据行，而无需遍历整个数据表。</p><p>索引是通过在一个或多个列上创建一个数据结构来实现的。当查询需要使用索引的列时，MySQL会使用索引的数据结构来快速定位和检索相应的数据行。这种方式比全表扫描要快得多，特别是在大型数据表中查询数据时，索引的性能优势非常明显。</p><h3 id="B-树索引"><a href="#B-树索引" class="headerlink" title="B+树索引"></a>B+树索引</h3><p>mysql通过数据页进行存储数据，如下图结构，每个数据页之间的结构是双向链表，单个数据页内的记录是通过单向链接根据主键从小到大串连</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304102034269.png" alt="image-20230410193826228"></p><p>每个数据页会为里面的记录生成页目录（槽组成页目录）</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304102034284.png" alt="image-20230410195931662"></p><p>如果是根据主键（有序存储进数据页）查找是通过二分快速定位然后遍历槽（4-8条记录组合一个槽）内记录会比较快。但是如果不是主键的字段（且不是索引）这种情况下只能按主键顺序把每个数据页从 最小记录 开始依次遍历单链表中的每条记录。</p><p>Innodb使用 <code>目录项纪录</code> 来实现索引，<code>目录项纪录</code>里只存储主键+数据页号，目录项纪录还有更顶层的目录项纪录，直至根节点，如下图</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304102034015.png" alt="image-20230410193422059"></p><p>叶子结点存放用户记录，非叶子结点（内结点）存放目录项</p><h4 id="聚簇索引"><a href="#聚簇索引" class="headerlink" title="聚簇索引"></a>聚簇索引</h4><p>聚簇索引根据主键值的大小进行记录和页的排序，目录项存储的是主键值和数据页号，叶子结点记录的是完整的用户记录。不需要显式的使用Index去创建，Innodb会为我们自动创建。</p><p>非叶子结点（目录项记录）：主键 - 数据页号</p><p>叶子结点（索引记录）：主键 - 完整用户记录</p><h4 id="二级索引"><a href="#二级索引" class="headerlink" title="二级索引"></a>二级索引</h4><p>二级索引根据索引键值的大小进行记录和页的排序，非叶子结点记录索引键值和数据页号，叶子结点只记录索引键值和主键值。二级索引查询到主键后需要执行回表操作获取完整记录。（再开了一个b+树）</p><p>非叶子结点（目录项记录）：索引列 - 数据页号</p><p>叶子结点（索引记录）：索引列 - 主键</p><h4 id="联合索引"><a href="#联合索引" class="headerlink" title="联合索引"></a>联合索引</h4><p>联合索引是按照定义的索引列顺序排序，对于相同的索引列，再按照其索引键值的大小进行排序。也就是说，在索引建立之时，定义的索引列顺序就对应了索引的排序方式，按照它们定义的顺序排序，以达到最优的查询效率。</p><p>对于非叶子结点，它们按照索引列的顺序记录着子结点的索引键值和数据页号，索引键值用于指示要查找的数据应该落在哪个子结点中，数据页号则用于指示存储该子结点中数据的数据页。</p><p>对于叶子结点，它们也按照索引列的顺序记录着索引键值和主键值，索引键值用于查询操作中定位到叶子结点，而主键值则用于获取完整的数据行。</p><p>联合索引遵循最左前缀集合。</p><p>非叶子结点（目录项记录）：A索引列 - B索引列 - 数据页号</p><p>叶子结点（索引记录）：A索引列 - B索引列 - 主键</p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><strong>字符串索引原理</strong></p><p>在B-tree索引中，MySQL将每个字符串值都分解成一组前缀，然后将这些前缀作为索引的键值。这些前缀可以是固定长度的，也可以是可变长度的，具体取决于索引定义的长度。</p><p>例如，如果我们在一个名为<code>mytable</code>的表的<code>name</code>列上创建了一个长度为10的索引，那么MySQL将对每个<code>name</code>值提取前10个字符，并将其存储在索引树中。查询时，MySQL可以使用这个索引快速查找匹配的记录。</p><p>然而，需要注意的是，在创建索引时需要权衡索引长度和查询效率。如果索引长度过长，那么会导致索引树变得更大，更慢，甚至会影响到查询性能。因此，我们需要根据具体情况来确定索引长度，以平衡查询效率和存储空间的利用率。</p><p>查询时MySQL 会将字符串按照字符集的排序规则进行比较</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Msql锁机制</title>
    <link href="/2023/04/09/Msql%E9%94%81%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/04/09/Msql%E9%94%81%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<p>MySQL锁机制是为了保证并发操作的数据一致性而设计的。在并发环境下，多个事务同时访问同一数据，如果不加控制，就会导致数据的不一致性。</p><p>MySQL的锁可以分为行级锁和表级锁。</p><ol><li><p>行级锁：在对表中的数据进行修改时，MySQL会自动加上行级锁，该锁只针对修改的行有效，其他行不受影响。行级锁的优点是精度高，缺点是占用资源多，容易造成死锁。InnoDB行锁是通过给索引上的索引项加锁 来实现的，没有索引的情况下，InnoDB仍然可以使用行级锁。不过，由于在没有索引的情况下需要扫描整个表，因此会对性能产生较大的影响，同时会将锁定作用于整个表，从而影响并发性能和可伸缩性</p><p>使用行级锁定的主要是 <code>InnoDB</code> 存储引擎。</p></li><li><p>表级锁：在对整个表进行操作时，MySQL会自动加上表级锁，该锁可以防止其他事务修改该表。表级锁的优点是简单高效，缺点是并发度低，容易造成阻塞。</p><p>使用表级锁定的主要是 <code>MyISAM</code>，<code>MEMORY</code>，<code>CSV</code> 等一些非事务性存储引擎。</p></li></ol><h3 id="InnoDB-引擎实现的锁机制"><a href="#InnoDB-引擎实现的锁机制" class="headerlink" title="InnoDB 引擎实现的锁机制"></a>InnoDB 引擎实现的锁机制</h3><h4 id="记录锁（Record-LOCK）"><a href="#记录锁（Record-LOCK）" class="headerlink" title="记录锁（Record LOCK）"></a>记录锁（Record LOCK）</h4><blockquote><p>Record Lock表示记录锁，锁的是索引记录。</p></blockquote><p>记录锁是 InnoDB 存储引擎实现多版本并发控制（MVCC）机制的重要基础，用来保证数据的一致性和并发性。在 MVCC 中，每个事务在执行修改操作时都会为所修改的数据行创建一个新的版本，并且使用记录锁来保护当前事务对该数据行的修改操作。</p><h5 id="共享锁（Shared-Lock）"><a href="#共享锁（Shared-Lock）" class="headerlink" title="共享锁（Shared Lock）"></a>共享锁（Shared Lock）</h5><p>共享锁（S锁）是一种共享锁定，它允许多个事务同时读取一行数据，但防止这些事务对该行数据进行修改，保证数据的一致性和隔离性。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 加共享锁（S）<br>select * from table_name where ... lock in share mode<br></code></pre></td></tr></table></figure><h5 id="排它锁（Exclusive-Lock）"><a href="#排它锁（Exclusive-Lock）" class="headerlink" title="排它锁（Exclusive Lock）"></a>排它锁（Exclusive Lock）</h5><p>排它锁（X锁）是一种排它锁定，它防止其他事务读取或修改该行数据，保证了数据的独占性。如果一个事务已经持有了一个行的 X 锁，其他的事务就不能再持有该行的任何锁，包括共享锁和排它锁。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 加排它锁（X)<br>select * from table_name where ... for update<br></code></pre></td></tr></table></figure><h4 id="间隙锁（GAP-LOCK）"><a href="#间隙锁（GAP-LOCK）" class="headerlink" title="间隙锁（GAP LOCK）"></a>间隙锁（GAP LOCK）</h4><blockquote><p>Gap Lock是间隙锁，锁的是索引记录之间的间隙。</p></blockquote><p>间隙锁是 InnoDB 存储引擎实现的一种锁机制，它可以在多版本并发控制（MVCC）下防止幻读问题的发生。在 RR 隔离级别下，InnoDB 存储引擎可以使用 MVCC 机制来保证读取的数据的可重复性，并且可以使用间隙锁来避免幻读问题的发生。</p><p>间隙锁是针对索引上的间隙（即索引记录之间的空隙）进行加锁，用来防止其他事务在这些间隙中插入新的数据，从而保证了查询结果的一致性。在 RR 隔离级别下，InnoDB 存储引擎使用间隙锁机制来支持幻读问题的解决。</p><p>举例来说，假如 emp 表中只有 101 条记录，其 empid 的值分别是1, 2, …, 100, 101，下面的SQL：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM emp WHERE empid &gt; 100 FOR UPDATE<br></code></pre></td></tr></table></figure><p>当我们用条件检索数据，并请求共享或排他锁时，InnoDB 不仅会对符合条件的 empid 值为 101 的记录加锁，也会对 empid 大于 101（这些记录并不存在）的 “间隙” 加锁。</p><p>这个时候如果你插入 empid 等于 102 的数据的，如果那边事物还没有提交，那你就会处于等待状态，无法插入数据。</p><p><strong>使用方式</strong></p><ol><li><p>使用 SELECT … FOR UPDATE 语句：可以在 SQL 查询语句中使用 SELECT … FOR UPDATE 语句，该语句会在查询时对索引进行间隙锁定。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM table_name WHERE col BETWEEN 10 AND 20 FOR UPDATE;<br></code></pre></td></tr></table></figure><p>该语句会对 col 列值在 10 和 20 之间的行进行间隙锁定，防止其他事务在该间隙内插入新的数据。</p></li><li><p>使用 SELECT … LOCK IN SHARE MODE 语句：该语句与 SELECT … FOR UPDATE 语句类似，但它会对索引进行共享锁定。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM table_name WHERE col BETWEEN 10 AND 20 LOCK IN SHARE MODE;<br></code></pre></td></tr></table></figure><p>该语句会对 col 列值在 10 和 20 之间的行进行共享锁定，防止其他事务在该间隙内修改数据。</p></li></ol><h3 id="临键锁"><a href="#临键锁" class="headerlink" title="临键锁"></a>临键锁</h3><blockquote><p>Next-Key Lock是Record Lock和Gap Lock的组合，同时锁索引记录和间隙。他的范围是左开右闭的。</p></blockquote><p>临键锁可以理解为锁住的是索引本身以及索引之前的间隙，是一个左开右闭的区间。当 SQL 执行按照<strong>非唯一索引</strong>进行数据的检索时，会给匹配到行上加上临键锁。</p><p>示例：</p><p>范围：(负无穷大，10]</p><p><strong>事务A:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">begin;<br>select * from sys_user where age=10 for update;<br></code></pre></td></tr></table></figure><p><strong>事务B:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">begin;<br>insert into sys_user (id, name, name_pinyin, id_card, phone, age)values (5, &#x27;小六&#x27;, &#x27;xiaoliu&#x27;, 300000004, 13000008000, 9);<br></code></pre></td></tr></table></figure><p>结果：<br>事务B被阻塞，无法被插入。</p><p><strong>事务C:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">begin;<br>insert into sys_user (id, name, name_pinyin, id_card, phone, age)values (5, &#x27;小六&#x27;, &#x27;xiaoliu&#x27;, 300000004, 13000008000, 11);<br></code></pre></td></tr></table></figure><p>结果：<br>事务C正常插入，无阻塞。</p><h4 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h4><p>意向锁是 InnoDB 存储引擎实现的一种锁机制，它用来协调事务对表和分区的锁定。</p><p>意向锁是一种表级别的锁，它可以分为意向共享锁（IS）和意向排它锁（IX）两种类型。意向共享锁（IS）表示一个事务想要对表或分区进行共享锁定，意向排它锁（IX）表示一个事务想要对表或分区进行排它锁定。当一个事务想要对表或分区加锁时，它需要先获取对应的意向锁，以通知其他事务该表或分区的锁定状态。</p><p>在 InnoDB 存储引擎中，一个事务想要对一个数据行加锁时，它需要先获取该数据行所在的表或分区的意向锁，然后再获取该数据行的行级锁。这种方式可以减少锁的竞争，提高系统的并发性能。</p><p>需要注意的是，意向锁并不是用来保证数据一致性的锁，而是用来协调事务对表和分区的锁定，避免锁的冲突和竞争。</p><p>我们可以举个生活中的例子，再来理解下为什么需要存在意向锁。</p><p>打个比方，就像有个游乐场，很多小朋友进去玩，看门大爷如果要下班锁游乐场的门(加表锁)，他必须确保每个角落都要去检查一遍，确保每个小朋友都离开了（释放行锁），才可以锁门。</p><p>假设锁门是件频繁发生的事情，大爷就会非常崩溃。那大爷想了一个办法，每个小朋友进入，就把自己的名字写在本子上，小朋友离开，就把自己的名字划掉，那大爷就能方便掌握有没有小朋友在游乐场里，不必每个角落都去寻找一遍。例子中的“小本子”，就是意向锁，他记录的信息并不精细，他只是提醒大爷，是否有人在屋里。</p><h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>MySQL死锁是指两个或多个事务相互等待对方释放锁资源的状态，导致事务无法继续执行，造成数据库的阻塞。MySQL死锁是一个常见的并发问题，特别是在高并发环境下容易发生。</p><p>MyISAM表锁是deadlock free的，这是因为MyISAM总是一次获得所需的全部锁，要么全部满足，要么等待，因此不会出现死锁。但在InnoDB中，除单个SQL组成的事务外，锁是逐步获得的，这就决定了在InnoDB中发生死锁是可能的。</p><p>造成死锁的原因主要有以下几个：</p><ol><li>竞争资源：多个事务同时竞争同一资源（如行、表等），导致相互等待。</li><li>事务执行顺序不一致：当两个事务在相互等待时，如果它们执行的顺序不一致，就会出现死锁。</li><li>数据库事务隔离级别设置不当：如果事务隔离级别设置过高，可能会导致死锁的发生。</li></ol><p>为了避免MySQL死锁，我们可以采取以下措施：</p><ol><li>减少事务时间：事务执行时间越长，死锁的概率就越大。因此，我们应该尽可能地减少事务的执行时间。</li><li>合理使用索引：合理地使用索引可以减少行级锁的竞争，降低死锁的发生率。</li><li>设置合适的事务隔离级别：在选择事务隔离级别时，应根据业务需求来选择，避免设置过高的隔离级别。</li><li>控制并发度：通过控制并发度，可以降低锁竞争的概率，减少死锁的发生。</li><li>定期优化数据库表结构：定期优化表结构可以降低锁竞争的概率，从而减少死锁的发生。</li><li>在应用中，如果不同的程序会并发存取多个表，应尽量约定以相同的顺序来访问表，这样可以大大降低产生死锁的机会。</li><li>在程序以批量方式处理数据的时候，如果事先对数据排序，保证每个线程按固定的顺序来处理记录，也可以大大降低出现死锁的可能。</li></ol><p>如果出现死锁，通过 MySQL 提供的 SHOW ENGINE INNODB STATUS 命令可以查看当前 MySQL 的锁状态。该命令会输出包含当前所有事务、锁等信息的大量文本，需要找到其中的“LATEST DETECTED DEADLOCK”部分，查看最近发生的死锁信息。</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>对dubbo的一些理解和简单使用记录</title>
    <link href="/2023/04/06/%E5%AF%B9dubbo%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3%E5%92%8C%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
    <url>/2023/04/06/%E5%AF%B9dubbo%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3%E5%92%8C%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>图片和内容总结来自：<a href="https://cn.dubbo.apache.org/zh-cn/overview/what/">Dubbo 介绍 | Apache Dubbo</a></p></blockquote><h4 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h4><p>Dubbo是一款高性能、轻量级的Java RPC框架。它可以用于构建分布式服务架构，简化不同服务之间的远程调用过程。Dubbo支持多种协议和序列化方式，可以轻松地与Spring Boot进行集成。Dubbo提供了服务治理、负载均衡、容错、路由、降级等丰富的特性，可以帮助我们构建健壮的分布式系统。</p><p>在使用Dubbo时，我们可以将服务提供者注册到注册中心，消费者通过注册中心查找到服务提供者的地址，然后进行远程调用。Dubbo提供了多种负载均衡策略，例如随机、轮询、一致性哈希等，可以根据实际场景进行选择。此外，Dubbo还支持容错机制，例如超时、失败重试、熔断等，可以提高系统的可靠性和稳定性。</p><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202304061124551.png" alt="service-discovery"></p><p>服务发现包含提供者、消费者和注册中心三个参与角色，其中，Dubbo 提供者实例注册 URL 地址到注册中心，注册中心负责对数据进行聚合，Dubbo 消费者从注册中心读取地址列表并订阅变更，每当地址列表发生变化，注册中心将最新的列表通知到所有订阅的消费者实例。</p><p>Dubbo 使用 JDK 动态代理或者字节码增强技术，生成一个代理类，该代理类实现了本地接口，具有本地接口的所有方法。在调用本地接口方法时，会通过代理类的 invoke 方法将请求转发到远程服务提供者上，服务提供方接收到请求后，会根据请求中的服务接口名和方法名，找到对应的实现类和方法，并将请求消息反序列化成参数列表，最终调用服务实现类的方法，并将执行结果序列化成响应消息返回给客户端。</p><h4 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h4><ul><li><p>引入依赖</p><p>配置Dubbo相关依赖：在<code>pom.xml</code>文件中添加Dubbo相关依赖，例如<code>dubbo-spring-boot-starter</code>、<code>dubbo</code>等。</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.dubbo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.dubbo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dubbo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;dubbo.version&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml"> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br></code></pre></td></tr></table></figure></li><li><p>服务提供者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProvideService</span> &#123;<br>    String <span class="hljs-title function_">test</span><span class="hljs-params">(String text)</span>;<br>&#125;<br><br><span class="hljs-comment">//实现Dubbo服务接口：编写Dubbo服务接口的实现类</span><br><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProvideServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProvideService</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">(String text)</span> &#123;<br>         System.out.println(text);<br>      <span class="hljs-keyword">return</span> text;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在<code>application.properties</code>或<code>application.yml</code>中配置Dubbo服务提供者信息和注册中心地址和协议</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># Dubbo服务提供者配置</span><br><span class="hljs-attr">dubbo.application.name</span>=dubbo-provide<br><span class="hljs-attr">dubbo.registry.protocol</span>=zookeeper<br><span class="hljs-attr">dubbo.protocol.name</span>=dubbo<br><span class="hljs-attr">dubbo.protocol.port</span>=<span class="hljs-number">20880</span><br><span class="hljs-comment"># Dubbo注册中心配置</span><br><span class="hljs-attr">dubbo.registry.address</span>=zookeeper://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2181</span><br></code></pre></td></tr></table></figure><p>打成jar包发不到maven仓库并启动服务</p></li><li><p>服务消费者</p><p>引入包含ProvideService服务的依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerService</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    <span class="hljs-keyword">private</span> ProvideService provideService;<br>  <br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">(String text)</span> &#123;<br>         <span class="hljs-keyword">return</span> provideService.test(text)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在<code>application.properties</code>或<code>application.yml</code>中配置Dubbo注册中心地址和协议</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># Dubbo注册中心配置</span><br><span class="hljs-attr">dubbo.registry.protocol</span>=zookeeper<br><span class="hljs-attr">dubbo.registry.address</span>=zookeeper://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2181</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h4><blockquote><p>为什么使用rpc框架，而不是用http？</p></blockquote><ul><li><p>在异构系统（跨语言和跨平台），HTTP具有更好的兼容性，因为HTTP是一种通用的协议，几乎所有的编程语言和操作系统都支持HTTP协议，因为Dubbo支持更严格的通信协议和类型约束，而不是所有的编程语言和操作系统都支持相同的RPC协议。</p></li><li><p>RPC适合用在企业内部，要求使用同一套注册中心进行服务治理，如果是跨组织，或者跨公司，这种情况只能用更加通用的HTTP进行通信。</p></li><li><p>Dubbo在并发连接数较高时表现更好，因为Dubbo使用长连接和TCP协议，而HTTP协议每次请求都要建立连接，在每次连接的过程中需要额外的时间开销和数据传输量。但是，在低并发量和小数据量的情况下，HTTP的开销相对较小。</p></li></ul><blockquote><p>rpc具有以下优点：</p></blockquote><ul><li><p>性能好：RPC在传输效率上通常比HTTP更高，此外，RPC可以使用更紧凑的数据格式，如Protocol Buffers和Thrift，可以更有效地利用网络带宽和存储空间。</p></li><li><p>安全性：目前，Dubbo等RPC框架主要应用在企业内部之间的系统调用，而内部系统之间调用的话安全性就更有保障一些。</p></li><li><p>调用简单：RCP可以帮我们像调用本地方法一样调用远程代码，而HTTP调用需要拼接Body、Header等等，过于复杂。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Dubbo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>请求wordpress json api记录</title>
    <link href="/2023/01/28/%E8%AF%B7%E6%B1%82wordpress-json-api%E8%AE%B0%E5%BD%95/"/>
    <url>/2023/01/28/%E8%AF%B7%E6%B1%82wordpress-json-api%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h4 id="第三方平台连接wp-json接口需要借助plugin生成token"><a href="#第三方平台连接wp-json接口需要借助plugin生成token" class="headerlink" title="第三方平台连接wp-json接口需要借助plugin生成token"></a>第三方平台连接wp-json接口需要借助plugin生成token</h4><h5 id="JWT-Authentication-for-WP-API"><a href="#JWT-Authentication-for-WP-API" class="headerlink" title="JWT Authentication for WP-API"></a>JWT Authentication for WP-API</h5><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202301281606338.png" alt="image-20230128151015431"></p><p>不太行 要手动修改apache .htaccess文件</p><h5 id="API-Bearer-Auth"><a href="#API-Bearer-Auth" class="headerlink" title="API Bearer Auth"></a>API Bearer Auth</h5><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202301281606381.png" alt="image-20230128152534220"></p><blockquote><p><a href="https://cn.wordpress.org/plugins/api-bearer-auth/">API Bearer Auth – WordPress 插件 | WordPress.org China 简体中文</a></p></blockquote><ul><li>获取Bearer token</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl --location --request POST &#x27;http://localhost/wp-json/api-bearer-auth/v1/login&#x27; \<br>--header &#x27;Content-Type: application/json&#x27; \<br>--data-raw &#x27;&#123;<br>    &quot;username&quot;: &quot;beixian&quot;,<br>    &quot;password&quot;: &quot;123456&quot;,<br>    &quot;client_name&quot;: &quot;dealar&quot;<br>&#125;&#x27;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;wp_user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;ID&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;user_login&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;user_nicename&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;user_email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;user_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;user_registered&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-01-04 06:32:18&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;user_activation_key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;user_status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;display_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ID&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;caps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;administrator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;cap_key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wp_capabilities&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;roles&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-string">&quot;administrator&quot;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;allcaps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;switch_themes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_themes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;activate_plugins&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_plugins&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_files&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;manage_options&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;moderate_comments&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;manage_categories&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;manage_links&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;upload_files&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;import&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;unfiltered_html&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_others_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_published_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;publish_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_10&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_9&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_8&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_7&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_6&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_5&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_4&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_3&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_2&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;level_0&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_others_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_published_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;publish_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_others_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_published_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_others_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_published_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_private_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_private_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read_private_posts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_private_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_private_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read_private_pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;create_users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;unfiltered_upload&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_dashboard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;update_plugins&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_plugins&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;install_plugins&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;update_themes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;install_themes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;update_core&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;list_users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;remove_users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;promote_users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_theme_options&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_themes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;export&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;manage_woocommerce&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;view_woocommerce_reports&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_product&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read_product&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_product&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_others_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;publish_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read_private_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_private_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_published_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_others_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_private_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_published_products&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;manage_product_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_product_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_product_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;assign_product_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_shop_order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read_shop_order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_shop_order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_others_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;publish_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read_private_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_private_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_published_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_others_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_private_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_published_shop_orders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;manage_shop_order_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_shop_order_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_shop_order_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;assign_shop_order_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_shop_coupon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read_shop_coupon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_shop_coupon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_others_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;publish_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;read_private_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_private_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_published_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_others_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_private_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_published_shop_coupons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;manage_shop_coupon_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;edit_shop_coupon_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;delete_shop_coupon_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;assign_shop_coupon_terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;administrator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">null</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dcc21431b90fd8acac52d934ea1955981b68c27d48ea16dc3bad09d9f0aff6e2&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;expires_in&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">86400</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;refresh_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;8ae0503926687677e6e5237031b1876cecfb81ce7dd982461dee8bd50ca48e97&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ul><li>Refresh token</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl --location --request POST &#x27;http://localhost/wp-json/api-bearer-auth/v1/tokens/refresh&#x27; \<br>--header &#x27;Content-Type: application/json&#x27; \<br>--data-raw &#x27;&#123;&quot;token&quot;: &quot;8ae0503926687677e6e5237031b1876cecfb81ce7dd982461dee8bd50ca48e97&quot;, &quot;client_name&quot;: &quot;dealar&quot;&#125;&#x27;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;f07dc29c8b001ec143e7d6e6ebd110fb5fb07c078c9cb6e384a7cef5a479f1bf&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;expires_in&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">86400</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="Wordpree-media"><a href="#Wordpree-media" class="headerlink" title="Wordpree media"></a>Wordpree media</h4><p>上传media文件接口</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl --location --request POST &#x27;http://localhost/wp-json/wp/v2/media&#x27; \<br>--header &#x27;content-disposition: attachment; filename=beixian.png&#x27; \<br>--header &#x27;Authorization: Bearer f07dc29c8b001ec143e7d6e6ebd110fb5fb07c078c9cb6e384a7cef5a479f1bf&#x27; \<br>--header &#x27;Content-Type: image/jpeg&#x27; \<br>--data-binary &#x27;@/Users/casonmo/Pictures/Photos Library.photoslibrary/originals/9/9E00792B-5CD0-4233-851B-121320A61618.jpeg&#x27;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">36</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;date&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-01-28T07:42:13&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;date_gmt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-01-28T07:42:13&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;guid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;rendered&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian.jpg&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;raw&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian.jpg&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-01-28T07:42:13&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;modified_gmt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-01-28T07:42:13&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;slug&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;inherit&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;attachment&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;link&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/beixian/&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;raw&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;rendered&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;comment_status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;open&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ping_status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;closed&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;template&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;meta&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;permalink_template&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/?attachment_id=36&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;generated_slug&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;raw&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;rendered&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&lt;p class=\&quot;attachment\&quot;&gt;&lt;a href=&#x27;http://localhost/wp-content/uploads/2023/01/beixian.jpg&#x27;&gt;&lt;img width=\&quot;300\&quot; height=\&quot;300\&quot; src=\&quot;http://localhost/wp-content/uploads/2023/01/beixian-300x300.jpg\&quot; class=\&quot;attachment-medium size-medium\&quot; alt=\&quot;\&quot; decoding=\&quot;async\&quot; loading=\&quot;lazy\&quot; srcset=\&quot;http://localhost/wp-content/uploads/2023/01/beixian-300x300.jpg 300w, http://localhost/wp-content/uploads/2023/01/beixian.jpg 1024w, http://localhost/wp-content/uploads/2023/01/beixian-150x150.jpg 150w, http://localhost/wp-content/uploads/2023/01/beixian-768x768.jpg 768w, http://localhost/wp-content/uploads/2023/01/beixian-324x324.jpg 324w, http://localhost/wp-content/uploads/2023/01/beixian-416x416.jpg 416w, http://localhost/wp-content/uploads/2023/01/beixian-100x100.jpg 100w\&quot; sizes=\&quot;(max-width: 300px) 100vw, 300px\&quot; /&gt;&lt;/a&gt;&lt;/p&gt;\n&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;caption&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;raw&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;rendered&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;alt_text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;media_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;media_details&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023/01/beixian.jpg&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;filesize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">66568</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;sizes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;medium&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian-300x300.jpg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;filesize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">14751</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian-300x300.jpg&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;large&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian-1024x1024.jpg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;filesize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">65430</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian-1024x1024.jpg&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;thumbnail&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian-150x150.jpg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;filesize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6292</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian-150x150.jpg&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;medium_large&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian-768x768.jpg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">768</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">768</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;filesize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">48019</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian-768x768.jpg&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;woocommerce_thumbnail&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian-324x324.jpg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">324</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">324</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;filesize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">16413</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;uncropped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian-324x324.jpg&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;woocommerce_single&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian-416x416.jpg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">416</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">416</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;filesize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22105</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian-416x416.jpg&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;woocommerce_gallery_thumbnail&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian-100x100.jpg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;filesize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4004</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian-100x100.jpg&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;full&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;beixian.jpg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;height&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;mime_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/jpeg&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian.jpg&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;image_meta&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;aperture&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;credit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;camera&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;caption&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;created_timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;copyright&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;focal_length&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;iso&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;shutter_speed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;orientation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;keywords&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;post&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">null</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;source_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-content/uploads/2023/01/beixian.jpg&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;missing_image_sizes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_links&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;self&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;href&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-json/wp/v2/media/36&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;collection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;href&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-json/wp/v2/media&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;about&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;href&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-json/wp/v2/types/attachment&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;embeddable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;href&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-json/wp/v2/users/1&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;replies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;embeddable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;href&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-json/wp/v2/comments?post=36&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;wp:action-unfiltered-html&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;href&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-json/wp/v2/media/36&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;wp:action-assign-author&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;href&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost/wp-json/wp/v2/media/36&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;curies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wp&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;href&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://api.w.org/&#123;rel&#125;&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;templated&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>wordpress</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>《mysql是怎样运行的》笔记</title>
    <link href="/2023/01/20/%E3%80%8Amysql%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84%E3%80%8B%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/01/20/%E3%80%8Amysql%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84%E3%80%8B%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><h5 id="Unix里mysql服务器程序："><a href="#Unix里mysql服务器程序：" class="headerlink" title="Unix里mysql服务器程序："></a>Unix里mysql服务器程序：</h5><p>mysqld:mysql服务器程序</p><p>mysqld_safe: 调用mysqld+监控进程+日志</p><p>mysql.server:启动脚本&#x3D;调用mysqld_safe</p><p> mysql_multi:启动多个mysql服务器程序</p><h5 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a>启动客户端</h5><p>mysql -h主机名 -u用户名 -p密码 -P端口</p><h5 id="客户端和服务器连接的方法"><a href="#客户端和服务器连接的方法" class="headerlink" title="客户端和服务器连接的方法"></a>客户端和服务器连接的方法</h5><ul><li><p>TCP&#x2F;IP</p><ul><li>采用TCP协议，通过IP地址+端口号进行网络连接</li><li>通过skip-networking禁用</li></ul></li><li><p>命名管道（windows）</p><ul><li>启动服务器程序的命令中加上 –enable-named-pipe</li><li>启动客户端程序的命令中加入 –pipe 或者 –protocol&#x3D;pipe 参数</li></ul></li><li><p>共享内存（windows）</p><ul><li>启动服务器程序的命令中加上 –shared-memory</li><li>在启动客户端程序的命令中加入 –protocol&#x3D;memory </li><li>使用 共享内存 的方式进行通信的服务器进程和客户端进程必须在同一台 Windows 主机中</li></ul></li><li><p><strong>Unix</strong>域套接字文件（unix）</p><ul><li><p>启动客户端程序的时候指定的主机名为 localhost ，或者指定了 –protocol&#x3D;socket 的启动参数</p></li><li><p>MySQL 服务器程序默认监听的 Unix 域套接字文件路径为 &#x2F;tmp&#x2F;mysql.sock ,通过mysqld –socket&#x3D;&#x2F;tmp&#x2F;a.txt修改套接字文件路径</p></li><li><p>客户端程序显式连接到unix域套接字路径 mysql -hlocalhost -uroot –socket&#x3D;&#x2F;tmp&#x2F;a.txt -p</p></li></ul></li></ul><h4 id="服务器处理客户端请求"><a href="#服务器处理客户端请求" class="headerlink" title="服务器处理客户端请求"></a>服务器处理客户端请求</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091807683.png" alt="image-20230120113343299"></p><h5 id="连接管理"><a href="#连接管理" class="headerlink" title="连接管理"></a>连接管理</h5><p>为了避免频繁创建和销毁进程，服务器不会立即删除刚退出的客户端连接线程，缓存起来，分配给下一个新连接进来的客户端。连接建立后，对应客户端的服务器进程会持续监控客户端发送的请求</p><h5 id="解析与优化"><a href="#解析与优化" class="headerlink" title="解析与优化"></a>解析与优化</h5><ul><li><p>查询缓存 </p><blockquote><p>缓冲sql请求，并在不同客户端之间共享</p><p>无法命中：任意字符不同，查询请求中包含某些系统函数、用户自定义变量和函数、一些系统表</p><p>失效：INSERT 、 UPDATE 、 DELETE 、 TRUNCATE TABLE 、 ALTER TABLE 、 DROP TABLE 、DROP DATABASE 语句</p></blockquote></li><li><p>语法解析</p><blockquote><p>是一个编译过程，涉及词法解析、语法分析、语义分析等阶段</p><p>提取查询信息到 MySQL 服务器内部使用的一些数据结构</p></blockquote></li><li><p>查询优化</p><blockquote><p>优化sql，生成执行计划，EXPLAIN 语句来查看某个语句的执行计划</p></blockquote></li></ul><p>MySQL 中磁盘和内存交互的基本单位是 页,页的大小一般是 16KB ，也就是 16384 字节，</p><h5 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h5><p>对数据的存储和提取，MySQL server 完成了查询优化后，只需按照生成的执行计划调用底层存储引擎提供的API，获取到数据后</p><p>返回给客户端</p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091807992.png" alt="image-20230120114806430" style="zoom:50%;" /><p>常用的就是 InnoDB 和 MyISAM </p><p>innodb 具有外键支持功能的事务春初引擎</p><p>myisam 主要的非事物处理引擎</p><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>配置文件里就定义了许多个组，组名分别是 server 、 mysqld 、 mysqld_safe 、 client 、 mysql 、mysqladmin </p><p>配置文件优先级：如果我们在多个配置文件中设置了相同的启动选项，那以最后一个配置文件中的为准，将以最后一个出现的组中的启动选项为准，么以命令行中的启动选项为准</p><h4 id="字符集（CHARACTER）和排序规则（COLLATION）"><a href="#字符集（CHARACTER）和排序规则（COLLATION）" class="headerlink" title="字符集（CHARACTER）和排序规则（COLLATION）"></a>字符集（CHARACTER）和排序规则（COLLATION）</h4><h5 id="字符集（部分）："><a href="#字符集（部分）：" class="headerlink" title="字符集（部分）："></a>字符集（部分）：</h5><p>utf8mb3 ：阉割过的 utf8 字符集，只使用1～3个字节表示字符。</p><p>utf8mb4 ：正宗的 utf8 字符集，使用1～4个字节表示字符。</p><h5 id="排序规则："><a href="#排序规则：" class="headerlink" title="排序规则："></a>排序规则：</h5><p>_ai ：accent insensitive  不区分重音</p><p>_as ： accent sensitive 区分重音</p><p>_ci ： case insensitive 不区分大小写</p><p>_cs ： case sensitive 区分大小写</p><p>_bin ： binary 以二进制方式比较</p><p>MySQL 有4个级别的字符集和比较规则，分别是：</p><ul><li>服务器级别</li><li>数据库级别</li><li>表级别</li><li>列级别</li></ul><h5 id="编码和解码使用的字符集不一致的后果"><a href="#编码和解码使用的字符集不一致的后果" class="headerlink" title="编码和解码使用的字符集不一致的后果"></a>编码和解码使用的字符集不一致的后果</h5><p>贝先 utf8编码 &#x3D; 0xE8B49D 0xE58588（3个字节）</p><p>​转gbk &#x3D; 0xE8B4 0x9DE5 0x8588（1-2个字节 1个字节找不到 就2个字节）</p><p>​显示 &#x3D;璐  濆      厛</p><blockquote><p>GBK和文字在线转换：<a href="https://www.23bei.com/tool/54.html#">ASCII&#x2F;GBK&#x2F;GB2312中文汉字区位码,内码,编码在线查询软件 (23bei.com)</a></p><p>UTF-8和文字在线转换：<a href="http://www.metools.info/code/utf8235.html">UTF-8编码转换器-ME2在线工具 (metools.info)</a></p></blockquote><h5 id="MySQL中字符集的转换"><a href="#MySQL中字符集的转换" class="headerlink" title="MySQL中字符集的转换"></a>MySQL中字符集的转换</h5><p>服务器接收到客户端发送来的请求其实是一串二进制的字节，它会认为这串字节采用的字符集是character_set_client ，然后把这串字节转换为 character_set_connection 字符集编码的字符。最后使用 character_set_results字符集 返回客户端</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091807626.png" alt="image-20230120122125932"></p><p>为避免乱码，确保一下三个字符集一致</p><ul><li><p>character_set_client 服务器解码请求时使用的字符集</p></li><li><p>character_set_connection 服务器处理请求时会把请求字符串从 character_set_client 转为 character_set_connection</p></li><li><p>character_set_results 服务器向客户端返回数据时使用的字符集</p></li></ul><p>在配置文件中添加default-character-set&#x3D;utf8</p><p>[client]</p><p>default-character-set&#x3D;utf8</p><h4 id="Innodb"><a href="#Innodb" class="headerlink" title="Innodb"></a>Innodb</h4><p>InnoDB 是一个将表中的数据存储到磁盘上的存储引擎，最大特色就是支持了<a href="https://baike.baidu.com/item/ACID/10738?fromModule=lemma_inlink">ACID</a>兼容的<a href="https://baike.baidu.com/item/%E4%BA%8B%E5%8A%A1/5945882?fromModule=lemma_inlink">事务</a>（Transaction）功能。</p><p>将数据划分为若干个页，以页作为磁盘和内存之间交互的基本单位，InnoDB中页的大小一般为 <strong>16</strong> KB</p><p>是以记录为单位来向表中插入数据的，这些记录在磁盘上的存放方式也被称为 行格式 或者 记录格式</p><blockquote><p>ACID:原子性（atomicity，或称不可分割性）、一致性（consistency）、隔离性（isolation，又称独立性）、持久性（durability）</p></blockquote><h5 id="行格式"><a href="#行格式" class="headerlink" title="行格式"></a>行格式</h5><ul><li>COMPACT行格式</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091807391.png" alt="image-20230120102114581"></p><ul><li>Redundant行格式</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091807341.png" alt="image-20230120102325757"></p><p>字段长度偏移列表 按照两个相邻数值的差值来计算各个列值的长度</p><ul><li><p>Dynamic</p><blockquote><p>行溢出处理：把所有的字节都存储到其他页面中，只在记录的真实数据处存储其他页面的地址</p></blockquote></li><li><p>Compressed</p><blockquote><p>Compressed 行格式会采用压缩算法对页面进行压缩，以节省空间。</p></blockquote></li></ul><h5 id="varchar-M-最多能存储的数据"><a href="#varchar-M-最多能存储的数据" class="headerlink" title="varchar(M)最多能存储的数据"></a>varchar(M)最多能存储的数据</h5><p> VARCHAR(M) 类型的列最多可以占用 65535 个字节 MySQL 对一条记录占用的最大存储空间是有限制的，除了 BLOB 或者 TEXT 类型的列之外，其他所有的列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过 65535 个字节</p><p>M &#x3D; 真实数据+真实数据占用字节的长度+NULL 值标识(如果该列有 NOT NULL 属性则可以没有这部分存储空间)</p><p>如果该 VARCHAR 类型的列没有 NOT NULL 属性，那最多只能存储 65532 个字节的数据，因为真实数据的长度可能</p><p>占用2个字节， NULL 值标识需要占用1个字节：</p><blockquote><p>真实数据占用字节的长度65535(十进制) &#x3D; 11111111 11111111（二进制）&#x3D; 2字节</p><p>65532 &#x3D; 65535-2（真实数据占用字节的长度）-1（NULL 值标识）</p><p>65533 &#x3D; 65535-2（真实数据占用字节的长度）-0（Not Null无需标识）</p></blockquote><p>ascii 字符集(最多占用一个字节) 允许为null情况下可以最大65532 ，Not Null最大65533</p><p>gbk 字符集(最多占用2个字节) 允许为null情况下可以最大32766（65532 &#x2F;2）</p><p>utf8 字符集(&#x3D;utf8mb3 最多占用3个字节) 允许为null情况下可以最大21844（65532 &#x2F;3）</p><h5 id="行溢出"><a href="#行溢出" class="headerlink" title="行溢出"></a>行溢出</h5><p>溢出原因：一个页一般是 16KB ，当记录中的数据太多，当前页放不下的时候，会把多余的数据存储到其他页中，这种现象称为 行溢出 。</p><p>解决方法：在 Compact 和 Reduntant 行格式中，在 记录的真实数据 处只会存储该列的一部分数据，把剩余的数据分散存储在几个其他的页中，然后 记录的真实数据 处用20个字节存储指向这些页的地址（当然这20个字节中还包括这些分散在其他页面中的数据的占用的字节数）</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091808473.png" alt="image-20230120111527905"></p><p>只要知道如果我们想一个行中存储了很大的数据时，可能发生 行溢出 的现象</p><p>索引页（数据页）结构</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091808995.png" alt="image-20230120143359530"></p><p><strong>记录头信息</strong></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091808206.png" alt="image-20230120144359136"></p><p>delete_mask：标记着当前记录是否被删除。立即删除重新排列影响性能，所有被删除掉的记录都会组成一个所谓的 垃圾链表 ，在这个链表中的记录占用的空间称之为所谓的 可重用空间 ，之后如果有新记录插入到表中的话，可能把这些被删除的记录占用的存储空间覆盖掉</p><p>min_rec_mask：</p><p>heap_no：当前记录在本 页 中的位置，innodb自动给页添加伪记录（虚拟记录），分别是最小记录和最大记录，以它们并不存放在 页 的 User Records 部分，他们被单独放在 Infimum + Supremum 。</p><p>record_type： 0 表示普通记录， 1 表示B+树非叶节点记录， 2 表示最小记录， 3 表示最大记录</p><p>next_record：从当前记录的真实数据到下一条记录的真实数据的地址偏移量。<strong>Infimum</strong>记录（也就是最小记录） 的下一条记录就是</p><p>本页中主键值最小的用户记录，而本页中主键值最大的用户记录的下一条记录就是 <strong>Supremum</strong>记录（也就是最大记录）</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091808925.png" alt="image-20230207152610054"></p><p>记录在页中按照主键值由小到大顺序串联成一个单链表</p><p><strong>Page Directory页目录</strong></p><ul><li>将记录划分组</li></ul><p>对每个分组中的记录条数是有规定的：对于最小记录所在的分组只能有 <strong>1</strong> 条记录，最大记录所在的分组拥有的记录条数只能在 <strong>1~8</strong> 条之间，剩下的分组中记录的条数范围只能在是 <strong>4~8</strong> 条之间</p><ul><li>每组最后一条记录使用n_owned标记该组拥有几条记录</li><li>把每组的最后一条记录的地址偏移量按顺序存储到页的尾部（页目录），页目录中的地址偏移量称作slot槽</li></ul><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091808381.png" alt="image-20230120151640564"></p><p>在一个数据页中查找主键记录的过程</p><ul><li><p>通过二分法确定该记录所在的槽，并找到该槽中主键值最小的那条记录。 </p></li><li><p>通过记录的 next_record 属性遍历该槽所在的组中的各个记录。</p></li></ul><p><strong>Page Header页头</strong></p><p>页 结构的第二部分，这个部分占用固定的 56 个字节，专门存储各种状态信息</p><p><strong>File Header文件头部</strong></p><p>固定占用的 38 个字节，针对 数据页 记录的各种状态信息</p><p><strong>File Trailer</strong></p><p>为保证从内存中同步到磁盘的页的完整性，在页的首部和尾部都会存储页中数据的校验和和页面最后修改时对应的 LSN 值，如果首部和尾部的校验和和 LSN 值校验不成功的话，就说明同步过程出现了问题</p><h5 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h5><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091808692.png" alt="image-20230207150852788"></p><p>页分裂：在对页中的记录进行增删改操作的过程中，我们必须通过一些诸如记录移动的操作来始终保证这个状态一直成立：下一个数据页中用户记录的主键值必须大于上一个页中用户记录的主键值。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202302091808442.png" alt="image-20230207160245808"></p><p>叶子结点是用户记录，非叶子结点是目录项纪录</p><p>聚簇索引：InnoDB 存储引擎会自动的为我们创建聚簇索引。</p><ul><li>使用记录主键值的大小进行记录和页的排序</li><li>B+ 树的叶子节点存储的是<strong>完整的用户记录</strong></li></ul><p>二级索引：在二级索引根据索引列查到对应主键，根据主键在聚簇索引找完整数据（回表）</p><ul><li>使用记录索引列的大小进行记录和页的排序</li><li>B+ 树的叶子节点存储的并不是完整的用户记录，而只是索引列+主键 这两个列的值。</li><li>目录项记录中不再是 主键+页号 的搭配，而变成了 索引列+页号 的搭配</li></ul><p>联合索引：同时以多个列的大小作为排序规则，也就是同时为多个列建立索引</p><p><strong>记录插入B+树过程</strong>：</p><ul><li>根结点（表自动生成）</li><li>记录插入根节点</li><li>再插入数据 根节点空间不足 复制根节点</li><li>页分裂（两个子节点）</li><li>根节点 便升级为存储目录项记录的页。</li></ul><p><strong>结论</strong>：</p><p>每个索引都对应一棵 B+ 树， B+ 树分为好多层，最下边一层是叶子节点，其余的是内节点。所有用户记录都存储在 B+ 树的叶子节点，所有 目录项记录 都存储在内节点。</p><p>InnoDB 存储引擎会自动为主键（如果没有它会自动帮我们添加）建立 聚簇索引 ，聚簇索引的叶子节点包含完整的用户记录。</p><p>我们可以为自己感兴趣的列建立 二级索引 ， 二级索引 的叶子节点包含的用户记录由 索引列 + 主键 组成，所以如果想通过 二级索引 来查找完整的用户记录的话，需要通过 回表 操作，也就是在通过 二级索引找到主键值之后再到 聚簇索引 中查找完整的用户记录。B+ 树中每层节点都是按照索引列值从小到大的顺序排序而组成了双向链表，而且每个页内的记录（不论是用户记录还是目录项记录）都是按照索引列的值从小到大的顺序而形成了一个单链表。如果是 联合索引 的话，则页面和记录先按照 联合索引 前边的列排序，如果该列值相同，再按照 联合索引 后边的列排序。通过索引查找记录是从 B+ 树的根节点开始，一层一层向下搜索。由于每个页面都按照索引列的值建立了Page Directory （页目录），所以在这些页面中的查找非常快。</p><p><strong>索引的代价</strong></p><ul><li>空间上的代价</li><li>时间上的代价</li></ul><p>​每次对表中的数据进行增、删、改操作时，都需要去修改各个 B+ 树索引。</p><blockquote><p>搜索语句中也可以不用包含全部联合索引中的列，只包含左边的就行</p><p>前缀都是排好序的，所以对于字符串类型的索引列来说，我们只匹配它的前缀也是可以快速定位记录</p><p>联合索引，如果对多个列同时进行范围查找的话，只有对索引最左边的那个列进行范围查找的时候才能用到 B+ 树索引</p><p>于同一个联合索引来说，虽然对多个列都进行范围查找时只能用到最左边那个索引列，但是如果左边的列是精确查找，则右边的列可以进行范围查找</p></blockquote><p><strong>不可以使用索引进行排序的几种情况</strong></p><ul><li><strong>DESC</strong>混用</li><li><strong>WHERE</strong>子句中出现非排序使用到的索引列</li><li>排序列包含非同一个索引的列</li><li>排序列使用了复杂的表达式</li></ul><p><strong>回表</strong></p><p>需要回表的记录越多，使用二级索引的性能就越低，</p><p>为了彻底告别 回表 操作带来的性能损耗，我们建议：最好在查询列表里只包含索引列，</p><p>索引字符串值的前缀 ： 只对字符串的前几个字符进行索引</p><blockquote><p>KEY idx_name_birthday_phone_number (name(10), birthday, phone_number)</p></blockquote><p>如果索引列在比较表达式中不是以单独列的形式出现，而是以某个表达式，或者函数调用形式出现的话，是用不到索引的</p><p><strong>主键插入顺序</strong></p><p>中间插入主键会导致页分裂，导致性能损耗，最好让插入的记录的主键值依次递增，这样就不会发生这样的性能损耗了。所以我们建议：让主键具有 AUTO_INCREMENT ，让存储引擎自己为表生成主键，而不是我们手动插入</p><p>结论：</p><ol><li><p>B+ 树索引在空间和时间上都有代价，所以没事儿别瞎建索引。</p></li><li><p>B+ 树索引适用于下边这些情况：</p></li></ol><p>全值匹配</p><p>匹配左边的列</p><p>匹配范围值</p><p>精确匹配某一列并范围匹配另外一列</p><p>用于排序</p><p>用于分组</p><ol start="3"><li>在使用索引时需要注意下边这些事项：</li></ol><p>只为用于搜索、排序或分组的列创建索引</p><p>为列的基数大的列创建索引</p><p>索引列的类型尽量小</p><p>可以只对字符串值的前缀建立索引</p><p>只有索引列在比较表达式中单独出现才可以适用索引</p><p>为了尽可能少的让 聚簇索引 发生页面分裂和记录移位的情况，建议让主键拥有 AUTO_INCREMENT 属性。</p><p>定位并删除表中的重复和冗余索引</p><p>尽量使用 覆盖索引 进行查询，避免 回表 带来的性能损耗。</p><h4 id="InnoDB的表空间"><a href="#InnoDB的表空间" class="headerlink" title="InnoDB的表空间"></a>InnoDB的表空间</h4><p>区 （ extent ）：64页</p><p>段（<strong>segment</strong>）：存放叶子节点的区的集合就算是一个 段 （ segment ），存放非叶子节点的区的集合也算是一个 段 。也就是说一个索引会生成2个段，一个叶子节点段，一个非叶子节点段。链表中相邻的两个页，物理位置可能离得非常远，会产生 随机I&#x2F;O，在磁盘中访问速度慢，尽量把页放在相邻的位置</p><ul><li><p>在刚开始向表中插入数据的时候，段是从某个碎片区以单个页面为单位来分配存储空间的。</p></li><li><p>当某个段已经占用了32个碎片区页面之后，就会以完整的区为单位来分配存储空间。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Mysql</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Javascript修改vue输入框的值</title>
    <link href="/2023/01/18/Javascript%E4%BF%AE%E6%94%B9vue%E8%BE%93%E5%85%A5%E6%A1%86%E7%9A%84%E5%80%BC/"/>
    <url>/2023/01/18/Javascript%E4%BF%AE%E6%94%B9vue%E8%BE%93%E5%85%A5%E6%A1%86%E7%9A%84%E5%80%BC/</url>
    
    <content type="html"><![CDATA[<p>vue 是通过<a href="https://so.csdn.net/so/search?q=input%E4%BA%8B%E4%BB%B6&spm=1001.2101.3001.7020">input事件</a>来触发双向绑定的，而你用单纯的js 去修改input值，并没有触发他的input事件，通过下方代码，进行触发即可。两种方式选其一即可。</p><blockquote><ol><li><p>event.target.dispatchEvent(new Event(‘input’));</p></li><li><p>el.dispatchEvent(new Event(‘input’));</p></li></ol></blockquote>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>nginx:根据二级域名自动分发对应文件夹目录</title>
    <link href="/2023/01/18/nginx-%E5%8A%A8%E6%80%81%E4%BA%8C%E7%BA%A7%E5%9F%9F%E5%90%8D%E8%87%AA%E5%8A%A8%E5%88%86%E5%8F%91%E5%AF%B9%E5%BA%94%E6%96%87%E4%BB%B6%E5%A4%B9%E7%9B%AE%E5%BD%95/"/>
    <url>/2023/01/18/nginx-%E5%8A%A8%E6%80%81%E4%BA%8C%E7%BA%A7%E5%9F%9F%E5%90%8D%E8%87%AA%E5%8A%A8%E5%88%86%E5%8F%91%E5%AF%B9%E5%BA%94%E6%96%87%E4%BB%B6%E5%A4%B9%E7%9B%AE%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<p>记录一下</p><p><a href="http://site-1.cason.work/">http://site-1.cason.work</a> 映射到 &#x2F;www&#x2F;site&#x2F;1&#x2F; 目录</p><p><a href="http://site-2.cason.work/">http://site-2.cason.work</a> 映射到 &#x2F;www&#x2F;site&#x2F;2&#x2F; 目录</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">server <span class="hljs-punctuation">&#123;</span><br>       listen       <span class="hljs-number">80</span>;<br>        server_name  ~^site\-(?&lt;subdomain&gt;.+)\.cason\.work$;<br>        root   /www/site/$subdomain/;<br>        index  index.html index.htm ;<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>在上述配置中，<code>server_name</code>使用正则表达式捕获了二级域名的名称，捕获结果保存在名为<code>subdomain</code>的变量中。在<code>root</code>中使用<code>$subdomain</code>变量，指定了该虚拟主机对应的文件夹目录，即访问对应的二级域名时显示的文件夹内的内容。</p>]]></content>
    
    
    <categories>
      
      <category>Nginx</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Tiktok Shop 生成signature（java）</title>
    <link href="/2023/01/10/Tiktok-Shop-%E7%94%9F%E6%88%90signature%EF%BC%88java%EF%BC%89/"/>
    <url>/2023/01/10/Tiktok-Shop-%E7%94%9F%E6%88%90signature%EF%BC%88java%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>tiktok 官方文档：<a href="https://partner.tiktokshop.com/doc/page/261251">TikTok Shop Partner Center</a></p><p>因为tiktok官方文档生成signature只有go语言版本的</p><p>所以记录一下java版本生成tiktok shop 请求open api时需要的signature</p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">getSignature</span><span class="hljs-params">(String uri, Map&lt;String, String&gt; parametersMap, String appSecret)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Map&lt;String, String&gt; tempParamsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>&lt;&gt;(Comparator.naturalOrder());<br>        tempParamsMap.putAll(parametersMap);<br>        tempParamsMap.remove(<span class="hljs-string">&quot;sign&quot;</span>);<br>        tempParamsMap.remove(<span class="hljs-string">&quot;access_token&quot;</span>);<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(uri);<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : tempParamsMap.entrySet()) &#123;<br>            input.append(entry.getKey()).append(entry.getValue());<br>        &#125;<br>        input = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(appSecret + input + appSecret);<br>        <span class="hljs-keyword">return</span> hmacSHA256(appSecret, input.toString());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * sha256_HMAC加密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> secret  秘钥</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 加密后字符串</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">hmacSHA256</span><span class="hljs-params">(String secret, String message)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Mac</span> <span class="hljs-variable">hmacSha256</span> <span class="hljs-operator">=</span> Mac.getInstance(<span class="hljs-string">&quot;HmacSHA256&quot;</span>);<br>        <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">secret_key</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(secret.getBytes(), <span class="hljs-string">&quot;HmacSHA256&quot;</span>);<br>        hmacSha256.init(secret_key);<br>        <span class="hljs-type">byte</span>[] bytes = hmacSha256.doFinal(message.getBytes());<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">hs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        String stmp;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; bytes != <span class="hljs-literal">null</span> &amp;&amp; n &lt; bytes.length; n++) &#123;<br>            stmp = Integer.toHexString(bytes[n] &amp; <span class="hljs-number">0XFF</span>);<br>            <span class="hljs-keyword">if</span> (stmp.length() == <span class="hljs-number">1</span>)<br>                hs.append(<span class="hljs-string">&#x27;0&#x27;</span>);<br>            hs.append(stmp);<br>        &#125;<br>        <span class="hljs-keyword">return</span> hs.toString().toLowerCase();<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h3><p>原来的url参数加上app_key和timestamp即可</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202301101729177.png" alt="image-20230110172708810"></p>]]></content>
    
    
    <categories>
      
      <category>外贸电商</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Tiktok shop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WooCommerce搭建（docker）</title>
    <link href="/2023/01/04/WooCommerce%E6%90%AD%E5%BB%BA%EF%BC%88docker%EF%BC%89/"/>
    <url>/2023/01/04/WooCommerce%E6%90%AD%E5%BB%BA%EF%BC%88docker%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>平台对接WooCommerce api 记录一下创建过程</p><blockquote><p>api地址:<a href="https://woocommerce.github.io/woocommerce-rest-api-docs/?python&from_wecom=1#introduction">Introduction – WooCommerce REST API Documentation - WP REST API v3</a></p></blockquote><h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><p><code>docker pull mysql  </code></p><p><code>docker run --name mysql -e MYSQL_ROOT_PASSWORD=&lt;密码&gt; -p 3306:3306 -d mysql</code></p><p>创建一个DB ：wordpress 编码utf8mb4</p><h2 id="wordpress"><a href="#wordpress" class="headerlink" title="wordpress"></a>wordpress</h2><p><code>docker pull wordpress:latest</code></p><p><code>docker run -d --name wordpress -e WORDPRESS_DB_HOST=mysql -e WORDPRESS_DB_USER=root -e WORDPRESS_DB_PASSWORD=&lt;mysql密码&gt; -e WORDPRESS_DB_NAME=wordpress -p 80:80 --link mysql:mysql wordpress</code></p><p>最好使用80端口 否则wordpress rest api无法使用</p><h2 id="WooCommerce"><a href="#WooCommerce" class="headerlink" title="WooCommerce"></a>WooCommerce</h2><p>在Plugins安装WooCommerce</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202301041630702.png" alt="image-20230104162118061"></p>]]></content>
    
    
    <categories>
      
      <category>外贸电商</category>
      
    </categories>
    
    
    <tags>
      
      <tag>woocommerce</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>算法笔记</title>
    <link href="/2022/12/27/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/"/>
    <url>/2022/12/27/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h1><p>特征</p><ul><li>自身调用：原问题可以分解为子问题，子问题和原问题的求解方法是一致的，即都是调用自身的同一个函数。</li><li>终止条件：递归必须有一个终止的条件，即不能无限循环地调用本身。</li></ul><p>解决递归问题三步曲</p><ul><li>第一步，定义函数功能</li><li>第二步，寻找递归终止条件</li><li>第二步，递推函数的等价关系式</li></ul><p>递归存在的问题</p><ul><li>递归调用层级太多，导致栈溢出问题<ul><li>调大JVM的栈空间内存</li><li>优化一下你的递归</li></ul></li><li>递归重复计算，导致效率低下<ul><li>备忘录</li></ul></li></ul><blockquote><p><strong>「题目：」</strong> 翻转一棵二叉树。</p><p><a href="https://leetcode-cn.com/problems/invert-binary-tree/">https://leetcode-cn.com/problems/invert-binary-tree/</a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br> <span class="hljs-keyword">public</span> TreeNode <span class="hljs-title function_">invertTree</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-comment">//节点为空 或 不为叶子节点</span><br>        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span> || (root.left == <span class="hljs-literal">null</span> &amp;&amp; root.right == <span class="hljs-literal">null</span>)) &#123;<br>            <span class="hljs-keyword">return</span> root;<br>        &#125;<br>        <span class="hljs-comment">//翻转左子树</span><br>        invertTree(root.left);<br>        <span class="hljs-comment">//翻转右子树</span><br>        invertTree(root.right);<br>        <span class="hljs-comment">//将当前节点的左右子树交换</span><br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> root.left;<br>        root.left = root.right;<br>        root.right = temp;<br>        <span class="hljs-keyword">return</span> root;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="字符串相关"><a href="#字符串相关" class="headerlink" title="字符串相关"></a>字符串相关</h1><h2 id="BF算法（Brute-Force）"><a href="#BF算法（Brute-Force）" class="headerlink" title="BF算法（Brute Force）"></a>BF算法（Brute Force）</h2><p>我们将模式串和主串进行比较，一致时则继续比较下一字符，直到比较完整个模式串</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">strStr</span><span class="hljs-params">(String haystack, String needle)</span> &#123;<br>       <span class="hljs-type">char</span>[] haystackChars = haystack.toCharArray();<br>       <span class="hljs-type">char</span>[] needleChars = needle.toCharArray();<br>       <span class="hljs-keyword">if</span> (haystackChars.length &lt; needleChars.length || StringUtils.isBlank(haystack) || StringUtils.isBlank(needle)) &#123;<br>           <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>       &#125;<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; haystackChars.length; i++) &#123;<br>           <span class="hljs-type">int</span> j;<br>           <span class="hljs-keyword">for</span> ( j= <span class="hljs-number">0</span>; j &lt; needleChars.length; j++) &#123;<br>               <span class="hljs-keyword">if</span> (haystackChars[i+j] != needleChars[j]) &#123;<br>                   <span class="hljs-keyword">break</span>;<br>               &#125;<br>           &#125;<br>           <span class="hljs-keyword">if</span> (j == needleChars.length) &#123;<br>               <span class="hljs-keyword">return</span> i;<br>           &#125;<br>       &#125;<br>       <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据结构笔记</title>
    <link href="/2022/12/27/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AC%94%E8%AE%B0/"/>
    <url>/2022/12/27/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h1><p><strong>栈（stack）是限制插入和删除只能在一个位置上进行的表</strong>，该位置是表的末端叫做栈的顶（top），对栈的基本操作有 push(进栈)和 pop(出栈),前者相当于插入，后者则是删除最后插入的元素。</p><p>栈的另一个名字是 LIFO（先进后出）表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StackTest</span> &#123;<br><br>    <span class="hljs-type">int</span> len;<br>    <span class="hljs-type">int</span>[] elems;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">top</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StackTest</span><span class="hljs-params">(<span class="hljs-type">int</span> len)</span> &#123;<br>        <span class="hljs-built_in">this</span>.len = len;<br>        <span class="hljs-built_in">this</span>.elems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[len];<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFull</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">return</span> <span class="hljs-variable">top</span> <span class="hljs-operator">=</span>= len - <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">return</span> <span class="hljs-variable">top</span> <span class="hljs-operator">=</span>= -<span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (isEmpty()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;empty stack&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.elems[top];<br>        top--;<br>        <span class="hljs-keyword">return</span> val;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>        <span class="hljs-keyword">if</span> (isFull()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;full stack&quot;</span>);<br>        &#125;<br>        top++;<br>        elems[top] = i;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h1><p>像栈一样，队列（queue）也是表。然而使用队列时插入在一端进行而删除在另一端进行，遵守先进先出的规则。所以队列的另一个名字是（FIFO）。</p><p>队列的基本操作是入队（enqueue）:它是在表的末端(队尾(rear)插入一个元素。出队（dequeue）:出队他是删除在表的开头（队头(front)）的元素。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueueTest</span> &#123;<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">rear</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">front</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> size;<br>    <span class="hljs-type">int</span>[] elems;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">QueueTest</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span> &#123;<br>        <span class="hljs-built_in">this</span>.size = size;<br>        <span class="hljs-built_in">this</span>.elems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[size];<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">return</span> <span class="hljs-variable">rear</span> <span class="hljs-operator">=</span>= front;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFull</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (rear + <span class="hljs-number">1</span>) % <span class="hljs-built_in">this</span>.size == front;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dequeue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (isEmpty()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;empty queue&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.front = (<span class="hljs-built_in">this</span>.front + <span class="hljs-number">1</span>) % <span class="hljs-built_in">this</span>.size;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.elems[<span class="hljs-built_in">this</span>.front];<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueue</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> &#123;<br>        <span class="hljs-keyword">if</span> (isFull()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;full queue&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.rear = (<span class="hljs-built_in">this</span>.rear + <span class="hljs-number">1</span>) % <span class="hljs-built_in">this</span>.size;<br>        <span class="hljs-built_in">this</span>.elems[<span class="hljs-built_in">this</span>.rear] = val;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="散列表"><a href="#散列表" class="headerlink" title="散列表"></a>散列表</h1><p>散列过程</p><ul><li>通过<strong>散列函数</strong>计算记录的散列地址，并按此<strong>散列地址</strong>存储该记录</li><li>查找时，我们通过<strong>同样的散列函数</strong>计算记录的散列地址，按此散列地址访问该记录</li></ul><p>散列函数构造方法</p><ul><li><p>直接定址法</p></li><li><p>数字分析法</p></li><li><p>折叠法</p></li><li><p>除法散列法</p></li><li><p>乘法散列法</p></li><li><p>随机数法</p></li><li><p>平方取中法</p></li></ul><p>处理散列冲突的方法</p><ul><li>开放地址法</li><li>链地址法</li><li>公共溢出区法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashTest</span> &#123;<br>    KeyValue[] elements;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HashTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.elements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>[size];<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(String key,String value)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> key.hashCode() % <span class="hljs-built_in">this</span>.size;<br>        <span class="hljs-type">KeyValue</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.elements[index];<br>        <span class="hljs-keyword">if</span> (element != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">while</span> (element.next != <span class="hljs-literal">null</span>) &#123;<br>                element = element.next;<br>            &#125;<br>            <span class="hljs-type">KeyValue</span> <span class="hljs-variable">newKv</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>(key, value);<br>            newKv.setNext(element);<br>            <span class="hljs-built_in">this</span>.elements[index] = newKv;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            element = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>(key, value);<br>            <span class="hljs-built_in">this</span>.elements[index] = element;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> key.hashCode() % <span class="hljs-built_in">this</span>.size;<br>        <span class="hljs-type">KeyValue</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.elements[index];<br>        <span class="hljs-keyword">while</span> (!element.getKey().equals(key)) &#123;<br>            element=element.next;<br>        &#125;<br>        <span class="hljs-keyword">return</span> element.getValue();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyValue</span> &#123;<br>        <span class="hljs-keyword">private</span> String key;<br>        <span class="hljs-keyword">private</span> String value;<br>        <span class="hljs-keyword">private</span> KeyValue next;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getKey</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> key;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKey</span><span class="hljs-params">(String key)</span> &#123;<br>            <span class="hljs-built_in">this</span>.key = key;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(String value)</span> &#123;<br>            <span class="hljs-built_in">this</span>.value = value;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> KeyValue <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> next;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(KeyValue next)</span> &#123;<br>            <span class="hljs-built_in">this</span>.next = next;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">KeyValue</span><span class="hljs-params">(String key, String value)</span> &#123;<br>            <span class="hljs-built_in">this</span>.key = key;<br>            <span class="hljs-built_in">this</span>.value = value;<br>            <span class="hljs-built_in">this</span>.next = <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h1><p>定义：链表是一种递归的数据结构，他或者为空（null），或者是指向一个结点（node）的引用，该结点含有一个泛型的元素和一个指向另一条链表的引用。是一种线性表，但是他不是按线性顺序存取数据。链表在内存不是连续分配的</p><p>链表的类型</p><ul><li>单链表</li><li>双向链表</li></ul><h1 id="树"><a href="#树" class="headerlink" title="树"></a>树</h1><p>树是 n （n &gt;&#x3D; 0） 个节点的有限集。 n &#x3D; 0 时 我们称之为空树, 空树是树的特例。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202212281826260.png" alt="image-20221228121105999"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202212281826519.png" alt="image-20221228121120312"></p><p>整理源自<a href="https://github.com/chefyuan/algorithm-base/blob/main/animation-simulation/%E4%BA%8C%E5%8F%89%E6%A0%91/%E4%BA%8C%E5%8F%89%E6%A0%91%E5%9F%BA%E7%A1%80.md">algorithm-base&#x2F;二叉树基础.md at main · chefyuan&#x2F;algorithm-base · GitHub</a></p><h2 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h2><ul><li>每个节点最多有两棵子树，也就是说二叉树中不存在度大于 2 的节点，节点的度可以为 0，1，2。</li><li>左子树和右子树是有顺序的,有左右之分。</li><li>假如只有一棵子树 ，也要区分它是左子树还是右子树</li></ul><h2 id="特殊的二叉树"><a href="#特殊的二叉树" class="headerlink" title="特殊的二叉树"></a>特殊的二叉树</h2><h3 id="满二叉树"><a href="#满二叉树" class="headerlink" title="满二叉树"></a>满二叉树</h3><p>满二叉树：在一棵二叉树中，<code>所有分支节点都存在左子树和右子树</code>，并且<code>所有的叶子都在同一层</code></p><h3 id="完全二叉树"><a href="#完全二叉树" class="headerlink" title="完全二叉树"></a>完全二叉树</h3><p>叶子结点只能出现在最下层和次下层，且最下层的叶子结点集中在树的左部。</p><h3 id="斜二叉树"><a href="#斜二叉树" class="headerlink" title="斜二叉树"></a>斜二叉树</h3><p>斜二叉树也就是斜的二叉树,所有的节点只有左子树的称为左斜树,所有节点只有右子树的二叉树称为右斜树.</p><h3 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h3><p>前序遍历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> TreeNode <span class="hljs-title function_">traverse</span><span class="hljs-params">(TreeNode root, List&lt;Integer&gt; arr)</span> &#123;<br>     <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-keyword">return</span> root;<br>     &#125;<br>     arr.add(root.val);<br>     traverse(root.left, arr);<br>     traverse(root.right, arr);<br>     <span class="hljs-keyword">return</span> root;<br> &#125;<br></code></pre></td></tr></table></figure><p>中序遍历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> TreeNode <span class="hljs-title function_">traverse</span><span class="hljs-params">(TreeNode root, List&lt;Integer&gt; arr)</span> &#123;<br>     <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-keyword">return</span> root;<br>     &#125;<br>     traverse(root.left, arr);<br>   arr.add(root.val);<br>     traverse(root.right, arr);<br>     <span class="hljs-keyword">return</span> root;<br> &#125;<br></code></pre></td></tr></table></figure><p>后序遍历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> TreeNode <span class="hljs-title function_">traverse</span><span class="hljs-params">(TreeNode root, List&lt;Integer&gt; arr)</span> &#123;<br>     <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-keyword">return</span> root;<br>     &#125;<br>     traverse(root.left, arr);<br>     traverse(root.right, arr);<br>   arr.add(root.val);<br>     <span class="hljs-keyword">return</span> root;<br> &#125;<br></code></pre></td></tr></table></figure><p>层级遍历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">levelOrder</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        List&lt;List&lt;Integer&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> list;<br>        &#125;<br>        Queue&lt;TreeNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>        queue.offer(root);<br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            List&lt;Integer&gt; temp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            <span class="hljs-comment">//提前取出这层的size ，queue的size是不断变化的</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> queue.size();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>                <span class="hljs-type">TreeNode</span> <span class="hljs-variable">treeNode</span> <span class="hljs-operator">=</span> queue.poll();<br>              <span class="hljs-comment">//出队列前就取出这个节点的左右子节点</span><br>                <span class="hljs-keyword">if</span>(treeNode.left!=<span class="hljs-literal">null</span>) queue.offer(treeNode.left);<br>                <span class="hljs-keyword">if</span>(treeNode.right!=<span class="hljs-literal">null</span>) queue.offer(treeNode.right);<br>                temp.add(treeNode.val);<br>            &#125;<br>            list.add(temp);<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>数据结构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>面试问题记录-Mysql select count(1)、count(*)、count(column)</title>
    <link href="/2022/08/01/%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95-Mysql-select-count-1-%E3%80%81count-%E3%80%81count-column/"/>
    <url>/2022/08/01/%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95-Mysql-select-count-1-%E3%80%81count-%E3%80%81count-column/</url>
    
    <content type="html"><![CDATA[<blockquote><p>摘抄自网络</p></blockquote><p>count(*)：先把星号翻译为具体字段名字，多了一步翻译，效率差点<br>count(1)：计算有多少符合条件的行，可以理解为每行数据存在某个值固定的字段，计算有多少个固定值</p><p><strong>从结果来说：</strong></p><ul><li>count(*) 和 count(1) 没区别，都不会过滤 NULL</li><li>count(column) 会过滤 NULL</li></ul><p><strong>从速度来说：</strong></p><ul><li>如果只有一列，count(<em>) 效率最高</em></li><li><em>多列时，count(1) 效率高于 count(</em>)</li><li>如果列为主键，count(column) 效率最高</li><li>如果列不为主键，count(1) 效率比 count(column) 效率高</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>面试问题</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python 通过requests爬取shopify collections商品</title>
    <link href="/2022/08/01/python-%E9%80%9A%E8%BF%87requests%E7%88%AC%E5%8F%96shopify-collections%E5%95%86%E5%93%81/"/>
    <url>/2022/08/01/python-%E9%80%9A%E8%BF%87requests%E7%88%AC%E5%8F%96shopify-collections%E5%95%86%E5%93%81/</url>
    
    <content type="html"><![CDATA[<p>简单使用requests爬取shopify商品信息</p><p>需要自行分析商品链接、标题、价格、描述、图片的选择器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> csv<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">import</span> bs4<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-comment"># collections地址</span><br>url_pro = <span class="hljs-string">&#x27;https://www.naluboutique.com/collections/all&#x27;</span><br><br><span class="hljs-comment"># 分析xpath</span><br>product_link_select = <span class="hljs-string">&#x27;.grid-product__content .grid-product__link&#x27;</span><br>product_title_select = <span class="hljs-string">&#x27;.product-single__title&#x27;</span><br>product_price_select = <span class="hljs-string">&#x27;.product__price&#x27;</span><br>product_desc_select = <span class="hljs-string">&#x27;.product-single__description&#x27;</span><br>product_img_select = <span class="hljs-string">&#x27;.product__photos img&#x27;</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;采集商品集合开始&#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crawl_collections</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            res = requests.get(url, timeout=<span class="hljs-number">30</span>)<br>            res.encoding = res.apparent_encoding<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;请求&#x27;</span>, url, <span class="hljs-string">&#x27;状态&#x27;</span>, res.status_code)<br>            <span class="hljs-comment"># 如果返回状态不是200，则抛出异常</span><br>            res.raise_for_status()<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">except</span>:<br>            timeout = <span class="hljs-number">3</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;链接失败,等待&#x27;</span>, timeout, <span class="hljs-string">&#x27;秒重试&#x27;</span>)<br>            time.sleep(timeout)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;重新链接中&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;请求成功，开始获取商品链接&#x27;</span>)<br>    <span class="hljs-comment"># html.parser 指定解析器</span><br>    noStarchSoup = bs4.BeautifulSoup(res.text, <span class="hljs-string">&#x27;html.parser&#x27;</span>)<br>    url = noStarchSoup.select(product_link_select)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(url)):<br>        imgurl = domainWithProtocol + url[i].get(<span class="hljs-string">&#x27;href&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;获取产品url&#x27;</span>)<br>        <span class="hljs-comment"># 调用采集内容方法</span><br>        crawl_product(imgurl)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;采集商品url结束&#x27;&#x27;&#x27;</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;采集商品内容开始&#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crawl_product</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;开始请求产品页面&#x27;</span>, url)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            res = requests.get(url, timeout=<span class="hljs-number">30</span>)<br>            res.encoding = res.apparent_encoding<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;成功请求商品页面:&#x27;</span>, res.status_code)<br>            res.raise_for_status()  <span class="hljs-comment"># 如果下载发生问题，就抛出异常</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;请求商品页面&#x27;</span>, url, <span class="hljs-string">&#x27;失败，重新链接&#x27;</span>)<br><br>    noStarchSoup = bs4.BeautifulSoup(res.text, <span class="hljs-string">&#x27;html.parser&#x27;</span>)<br>    name = noStarchSoup.select(product_title_select)<br>    name = name[<span class="hljs-number">0</span>].getText()<br>    price = noStarchSoup.select(product_price_select)<br>    price = price[<span class="hljs-number">0</span>].getText()<br>    price = re.sub(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, price)<br>    price = re.sub(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, price)<br>    des = noStarchSoup.select(product_desc_select)<br>    des = des[<span class="hljs-number">0</span>].getText()<br>    img = noStarchSoup.select(product_img_select)<br>    l = []<br>    <span class="hljs-keyword">if</span> img != []:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(img)):<br>            imgurl = img[i].get(<span class="hljs-string">&#x27;src&#x27;</span>)<br>            <span class="hljs-keyword">if</span> imgurl <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                imgurl = img[i].get(<span class="hljs-string">&#x27;data-src&#x27;</span>)<br>            <span class="hljs-keyword">if</span> imgurl.__contains__(<span class="hljs-string">&#x27;&#123;width&#125;&#x27;</span>):<br>                <span class="hljs-keyword">continue</span><br>            l.append(<span class="hljs-string">&#x27;https:&#x27;</span> + imgurl)<br>        l = <span class="hljs-string">&#x27;\r\n&#x27;</span>.join(l)<br>    fileHeader = [<span class="hljs-string">&#x27;标题&#x27;</span>, <span class="hljs-string">&#x27;产品url&#x27;</span>, <span class="hljs-string">&#x27;价格&#x27;</span>, <span class="hljs-string">&#x27;描述&#x27;</span>, <span class="hljs-string">&#x27;图片&#x27;</span>]<br>    file = [name, url, price, des, l]<br>    <span class="hljs-comment"># 文件存储的地方，文件夹需要事先创建，并指定文件的格式为utf-8</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            csvFile = <span class="hljs-built_in">open</span>(csv_name, <span class="hljs-string">&#x27;a+&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(e)<br>            <span class="hljs-built_in">print</span>(csv_name + <span class="hljs-string">&#x27;文件写入失败，重试中。。。。。&#x27;</span>)<br>            time.sleep(<span class="hljs-number">5</span>)<br>    size = os.path.getsize(csv_name)  <span class="hljs-comment"># 判断文件大小，如果文件大于0则表示文件有内</span><br>    writer = csv.writer(csvFile)<br>    <span class="hljs-keyword">if</span> size == <span class="hljs-number">0</span>:<br>        writer.writerow(fileHeader)<br>        writer.writerow(file)<br>        csvFile.close()<br>    <span class="hljs-keyword">else</span>:<br>        writer.writerow(file)<br>        csvFile.close()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;采集成功！&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    protocol = <span class="hljs-string">&#x27;https://&#x27;</span><br>    domain = re.match(<span class="hljs-string">&#x27;https://(.*)/collections&#x27;</span>, url_pro).group(<span class="hljs-number">1</span>)<br>    domainWithProtocol = protocol + domain<br>    csv_name = domain + time.strftime(<span class="hljs-string">&#x27;_%Y-%m-%d-%H-%M-%S&#x27;</span>, time.localtime(time.time())) + <span class="hljs-string">&#x27;.csv&#x27;</span><br>    <span class="hljs-built_in">next</span> = [<span class="hljs-string">&#x27;1&#x27;</span>]<br>    n = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">next</span> != []:<br>        url = url_pro + <span class="hljs-string">&#x27;?sort_by=best-selling&amp;page=&#x27;</span> + <span class="hljs-built_in">str</span>(n)<br>        <span class="hljs-comment"># 调用采集列表方法</span><br>        crawl_collections(url)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;成功采集&#x27;</span>, n, <span class="hljs-string">&#x27;页&#x27;</span>)<br>        n = n + <span class="hljs-number">1</span><br>        res = requests.get(url)<br>        res.raise_for_status()<br>        noStarchSoup = bs4.BeautifulSoup(res.text, <span class="hljs-string">&#x27;html.parser&#x27;</span>)<br>        <span class="hljs-built_in">next</span> = noStarchSoup.select(<span class="hljs-string">&#x27;.next&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;全部采集完毕！！&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>效果：</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202208011527113.png" alt="image-20220801152718166"></p>]]></content>
    
    
    
    <tags>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OkhttpUtils 工具类</title>
    <link href="/2022/07/26/OkhttpUtils%20%E5%B7%A5%E5%85%B7%E7%B1%BB/"/>
    <url>/2022/07/26/OkhttpUtils%20%E5%B7%A5%E5%85%B7%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<p>记录一下OkhttpUtils工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by IntelliJ IDEA.</span><br><span class="hljs-comment"> * User: 贝先 [ Cason mo ]</span><br><span class="hljs-comment"> * Date: 2022/5/20</span><br><span class="hljs-comment"> * Time: 10:56</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OkHttpUtils</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(OkHttpUtils.class);<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-variable">readTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-variable">connectTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-variable">writeTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MediaType</span> <span class="hljs-variable">JSON</span> <span class="hljs-operator">=</span> MediaType.parse(<span class="hljs-string">&quot;application/json; charset=utf-8&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] LOCKER = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OkHttpUtils mInstance;<br>    <span class="hljs-keyword">private</span> OkHttpClient mOkHttpClient;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setReadTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> readTimeout)</span> &#123;<br>        <span class="hljs-built_in">this</span>.readTimeout = readTimeout;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setConnectTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> connectTimeout)</span> &#123;<br>        <span class="hljs-built_in">this</span>.connectTimeout = connectTimeout;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWriteTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> writeTimeout)</span> &#123;<br>        <span class="hljs-built_in">this</span>.writeTimeout = writeTimeout;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自定义网络回调接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">NetCall</span> &#123;<br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">success</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException;<br><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">failed</span><span class="hljs-params">(Call call, IOException e)</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">OkHttpUtils</span><span class="hljs-params">()</span> &#123;<br>        okhttp3.OkHttpClient.<span class="hljs-type">Builder</span> <span class="hljs-variable">clientBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">okhttp3</span>.OkHttpClient.Builder();<br>        clientBuilder.readTimeout(readTimeout, TimeUnit.SECONDS);<span class="hljs-comment">//读取超时</span><br>        clientBuilder.connectTimeout(connectTimeout, TimeUnit.SECONDS);<span class="hljs-comment">//连接超时</span><br>        clientBuilder.writeTimeout(writeTimeout, TimeUnit.SECONDS);<span class="hljs-comment">//写入超时</span><br>        clientBuilder.hostnameVerifier(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostnameVerifier</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verify</span><span class="hljs-params">(String hostname, SSLSession session)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;);<br>        mOkHttpClient = clientBuilder.build();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OkHttpUtils <span class="hljs-title function_">newInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpUtils</span>();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 单例模式获取OkHttpUtil</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OkHttpUtils <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (LOCKER) &#123;<br>                <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-literal">null</span>) &#123;<br>                    mInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpUtils</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> mInstance;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">get</span><span class="hljs-params">(String url, Map&lt;String, String&gt; params, Headers headers)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (headers == <span class="hljs-literal">null</span>) &#123;<br>            headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>.Builder().build();<br>        &#125;<br>        Request.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder();<br>        <span class="hljs-type">UriBuilder</span> <span class="hljs-variable">uriBuilder</span> <span class="hljs-operator">=</span> UriBuilder.fromUri(url);<br>        <span class="hljs-keyword">if</span> (params != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; param : params.entrySet()) &#123;<br>                <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(param.getKey())) &#123;<br>                    uriBuilder.queryParam(param.getKey(), param.getValue());<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> builder.get().url(uriBuilder.build().toString()).headers(headers).build();<br>        logger.info(<span class="hljs-string">&quot;okhttp url : [&#123;&#125;] &#123;&#125; \nheader : &#123;&#125; \nrequestBody : &#123;&#125;&quot;</span>, request.method(), request.url(), request.headers(), getRequestBody(request));<br>        <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> mOkHttpClient.newCall(request);<br>        <span class="hljs-keyword">return</span> call.execute();<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> &lt;T&gt; Response <span class="hljs-title function_">post</span><span class="hljs-params">(String url, T t, Headers headers)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (headers == <span class="hljs-literal">null</span>) &#123;<br>            headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>.Builder().build();<br>        &#125;<br>        Request.<span class="hljs-type">Builder</span> <span class="hljs-variable">requestBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder();<br>        requestBuilder.post(RequestBody.create(JSON, <span class="hljs-string">&quot;&quot;</span>)).url(url).headers(headers);<br>        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(JSON, JsonUtils.toJSONString(t));<br>            requestBuilder.post(body);<br>        &#125;<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> requestBuilder.build();<br>        logger.info(<span class="hljs-string">&quot;okhttp url : [&#123;&#125;] &#123;&#125; \nheader : &#123;&#125; \nrequestBody : &#123;&#125;&quot;</span>, request.method(), request.url(), request.headers(), getRequestBody(request));<br>        <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> mOkHttpClient.newCall(request);<br>        <span class="hljs-keyword">return</span> call.execute();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;T&gt; Response <span class="hljs-title function_">patch</span><span class="hljs-params">(String url, T t, Headers headers)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (headers == <span class="hljs-literal">null</span>) &#123;<br>            headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>.Builder().build();<br>        &#125;<br>        Request.<span class="hljs-type">Builder</span> <span class="hljs-variable">requestBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder();<br>        requestBuilder.patch(RequestBody.create(JSON, <span class="hljs-string">&quot;&quot;</span>)).url(url).headers(headers);<br>        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(JSON, JsonUtils.toJSONString(t));<br>            requestBuilder.patch(body);<br>        &#125;<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> requestBuilder.build();<br>        logger.info(<span class="hljs-string">&quot;okhttp url : [&#123;&#125;] &#123;&#125; \nheader : &#123;&#125; \nrequestBody : &#123;&#125;&quot;</span>, request.method(), request.url(), request.headers(), getRequestBody(request));<br>        <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> mOkHttpClient.newCall(request);<br>        <span class="hljs-keyword">return</span> call.execute();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">postJson</span><span class="hljs-params">(String url, String json, Headers headers)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (headers == <span class="hljs-literal">null</span>) &#123;<br>            headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>.Builder().build();<br>        &#125;<br>        <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(JSON, json);<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>                .url(url)<br>                .post(body)<br>                .headers(headers)<br>                .build();<br>        logger.info(<span class="hljs-string">&quot;okhttp url : [&#123;&#125;] &#123;&#125; \nheader : &#123;&#125; \nrequestBody : &#123;&#125;&quot;</span>, request.method(), request.url(), request.headers(), getRequestBody(request));<br>        <span class="hljs-keyword">return</span> mOkHttpClient.newCall(request).execute();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;T&gt; Response <span class="hljs-title function_">put</span><span class="hljs-params">(String url, T t, Headers headers)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (headers == <span class="hljs-literal">null</span>) &#123;<br>            headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>.Builder().build();<br>        &#125;<br>        Request.<span class="hljs-type">Builder</span> <span class="hljs-variable">requestBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder();<br>        requestBuilder.put(RequestBody.create(JSON, <span class="hljs-string">&quot;&quot;</span>)).url(url).headers(headers);<br>        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(JSON, JsonUtils.toJSONString(t));<br>            requestBuilder.put(body);<br>        &#125;<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> requestBuilder.build();<br>        logger.info(<span class="hljs-string">&quot;okhttp url : [&#123;&#125;] &#123;&#125; \nheader : &#123;&#125; \nrequestBody : &#123;&#125;&quot;</span>, request.method(), request.url(), request.headers(), getRequestBody(request));<br>        <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> mOkHttpClient.newCall(request);<br>        <span class="hljs-keyword">return</span> call.execute();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">putJson</span><span class="hljs-params">(String url, String json, Headers headers)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (headers == <span class="hljs-literal">null</span>) &#123;<br>            headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>.Builder().build();<br>        &#125;<br>        <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(JSON, json);<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>                .url(url)<br>                .put(body)<br>                .headers(headers)<br>                .build();<br>        logger.info(<span class="hljs-string">&quot;okhttp url : [&#123;&#125;] &#123;&#125; \nheader : &#123;&#125; \nrequestBody : &#123;&#125;&quot;</span>, request.method(), request.url(), request.headers(), getRequestBody(request));<br>        <span class="hljs-keyword">return</span> mOkHttpClient.newCall(request).execute();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;T&gt; Response <span class="hljs-title function_">delete</span><span class="hljs-params">(String url, T t, Headers headers)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (headers == <span class="hljs-literal">null</span>) &#123;<br>            headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>.Builder().build();<br>        &#125;<br>        Request.<span class="hljs-type">Builder</span> <span class="hljs-variable">requestBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder();<br>        requestBuilder.delete().url(url).headers(headers);<br>        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(JSON, JsonUtils.toJSONString(t));<br>            requestBuilder.delete(body);<br>        &#125;<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> requestBuilder.build();<br>        logger.info(<span class="hljs-string">&quot;okhttp url : [&#123;&#125;] &#123;&#125; \nheader : &#123;&#125; \nrequestBody : &#123;&#125;&quot;</span>, request.method(), request.url(), request.headers(), getRequestBody(request));<br>        <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> mOkHttpClient.newCall(request);<br>        <span class="hljs-keyword">return</span> call.execute();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">deleteJson</span><span class="hljs-params">(String url, String json, Headers headers)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (headers == <span class="hljs-literal">null</span>) &#123;<br>            headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>.Builder().build();<br>        &#125;<br>        <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(JSON, json);<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>                .url(url)<br>                .delete(body)<br>                .headers(headers)<br>                .build();<br>        logger.info(<span class="hljs-string">&quot;okhttp url : [&#123;&#125;] &#123;&#125; \nheader : &#123;&#125; \nrequestBody : &#123;&#125;&quot;</span>, request.method(), request.url(), request.headers(), getRequestBody(request));<br>        <span class="hljs-keyword">return</span> mOkHttpClient.newCall(request).execute();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getRequestBody</span><span class="hljs-params">(Request request)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Buffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Buffer</span>();<br>        <span class="hljs-keyword">if</span> (request.body() != <span class="hljs-literal">null</span>) &#123;<br>            request.body().writeTo(buffer);<br>            <span class="hljs-keyword">return</span> buffer.clone().readUtf8();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>获取指定包下使用指定注解相关的类、方法、字段</title>
    <link href="/2022/07/20/%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E5%8C%85%E4%B8%8B%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AE%9A%E6%B3%A8%E8%A7%A3%E7%9B%B8%E5%85%B3%E7%9A%84%E7%B1%BB%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E5%AD%97%E6%AE%B5/"/>
    <url>/2022/07/20/%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E5%8C%85%E4%B8%8B%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AE%9A%E6%B3%A8%E8%A7%A3%E7%9B%B8%E5%85%B3%E7%9A%84%E7%B1%BB%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E5%AD%97%E6%AE%B5/</url>
    
    <content type="html"><![CDATA[<p>通过对指定包下的所有类文件进行扫描，获取使用指定注解的所有类、方法、字段</p><h3 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.core.io.DefaultResourceLoader;<br><span class="hljs-keyword">import</span> org.springframework.core.io.Resource;<br><span class="hljs-keyword">import</span> org.springframework.core.io.ResourceLoader;<br><span class="hljs-keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;<br><span class="hljs-keyword">import</span> org.springframework.core.io.support.ResourcePatternUtils;<br><span class="hljs-keyword">import</span> org.springframework.core.type.ClassMetadata;<br><span class="hljs-keyword">import</span> org.springframework.core.type.classreading.MetadataReader;<br><span class="hljs-keyword">import</span> org.springframework.core.type.classreading.MetadataReaderFactory;<br><span class="hljs-keyword">import</span> org.springframework.core.type.classreading.SimpleMetadataReaderFactory;<br><span class="hljs-keyword">import</span> org.springframework.util.ClassUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.annotation.Annotation;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by IntelliJ IDEA.</span><br><span class="hljs-comment"> * User: 贝先 [ Cason mo ]</span><br><span class="hljs-comment"> * Date: 2022/6/29</span><br><span class="hljs-comment"> * Time: 10:45</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationUtils</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(AnnotationUtils.class);<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_RESOURCE_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;**/*.class&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AnnotationUtils mInstance;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">LOCKER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 单例模式获取AnnotationUtils</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AnnotationUtils <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-literal">null</span>) &#123;<br>            LOCKER.lock();<br>            <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-literal">null</span>) &#123;<br>                mInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationUtils</span>();<br>            &#125;<br>            LOCKER.unlock();<br>        &#125;<br>        <span class="hljs-keyword">return</span> mInstance;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Class&lt;?&gt;&gt; getClassCandidates(String basePackages, Class clazz) &#123;<br>        List&lt;Class&lt;?&gt;&gt; candidates = scanPackagesForClass(basePackages, clazz);<br>        validateCandidates(basePackages, candidates.isEmpty());<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Method&gt; <span class="hljs-title function_">getMethodCandidates</span><span class="hljs-params">(String basePackages, Class clazz)</span> &#123;<br>        List&lt;Method&gt; candidates = scanPackagesForMethod(basePackages, clazz);<br>        validateCandidates(basePackages, candidates.isEmpty());<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Field&gt; <span class="hljs-title function_">getFieldCandidates</span><span class="hljs-params">(String basePackages, Class clazz)</span> &#123;<br>        List&lt;Field&gt; candidates = scanPackagesForField(basePackages, clazz);<br>        validateCandidates(basePackages, candidates.isEmpty());<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Class&lt;?&gt;&gt; scanPackagesForClass(String basePackages, Class clazz) &#123;<br>        List&lt;Class&lt;?&gt;&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Class&lt;?&gt;&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            candidates.addAll(findCandidateClasses(basePackages, clazz));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            logger.error(<span class="hljs-string">&quot;扫描指定包时出现异常&quot;</span>, basePackages);<br>        &#125;<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Method&gt; <span class="hljs-title function_">scanPackagesForMethod</span><span class="hljs-params">(String basePackages, Class clazz)</span> &#123;<br>        List&lt;Method&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Method&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            candidates.addAll(findCandidateMethod(basePackages, clazz));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            logger.error(<span class="hljs-string">&quot;扫描指定包时出现异常&quot;</span>, basePackages);<br>        &#125;<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Field&gt; <span class="hljs-title function_">scanPackagesForField</span><span class="hljs-params">(String basePackages, Class clazz)</span> &#123;<br>        List&lt;Field&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Field&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            candidates.addAll(findCandidateField(basePackages, clazz));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            logger.error(<span class="hljs-string">&quot;扫描指定包时出现异常&quot;</span>, basePackages);<br>        &#125;<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Class&lt;?&gt;&gt; findCandidateClasses(String basePackage, Class clazz) <span class="hljs-keyword">throws</span> IOException &#123;<br>        List&lt;Class&lt;?&gt;&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Class&lt;?&gt;&gt;();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">packageSearchPath</span> <span class="hljs-operator">=</span> getPackageSearchPath(basePackage);<br>        <span class="hljs-type">ResourceLoader</span> <span class="hljs-variable">resourceLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResourceLoader</span>();<br>        <span class="hljs-type">MetadataReaderFactory</span> <span class="hljs-variable">readerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMetadataReaderFactory</span>(resourceLoader);<br>        Resource[] resources = ResourcePatternUtils.getResourcePatternResolver(resourceLoader).getResources(packageSearchPath);<br>        <span class="hljs-keyword">for</span> (Resource resource : resources) &#123;<br>            <span class="hljs-type">MetadataReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> readerFactory.getMetadataReader(resource);<br>            <span class="hljs-keyword">if</span> (match(reader.getClassMetadata(), clazz)) &#123;<br>                Class&lt;?&gt; candidateClass = transform(reader.getClassMetadata().getClassName());<br>                <span class="hljs-keyword">if</span> (candidateClass != <span class="hljs-literal">null</span>) &#123;<br>                    candidates.add(candidateClass);<br>                    logger.debug(<span class="hljs-string">&quot;扫描到符合要求的类：&quot;</span> + candidateClass.getName());<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Method&gt; <span class="hljs-title function_">findCandidateMethod</span><span class="hljs-params">(String basePackage, Class clazz)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        List&lt;Method&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Method&gt;();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">packageSearchPath</span> <span class="hljs-operator">=</span> getPackageSearchPath(basePackage);<br>        <span class="hljs-type">ResourceLoader</span> <span class="hljs-variable">resourceLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResourceLoader</span>();<br>        <span class="hljs-type">MetadataReaderFactory</span> <span class="hljs-variable">readerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMetadataReaderFactory</span>(resourceLoader);<br>        Resource[] resources = ResourcePatternUtils.getResourcePatternResolver(resourceLoader).getResources(packageSearchPath);<br>        <span class="hljs-keyword">for</span> (Resource resource : resources) &#123;<br>            <span class="hljs-type">MetadataReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> readerFactory.getMetadataReader(resource);<br>            matchMethod(clazz, candidates, reader);<br>        &#125;<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Field&gt; <span class="hljs-title function_">findCandidateField</span><span class="hljs-params">(String basePackage, Class clazz)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        List&lt;Field&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Field&gt;();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">packageSearchPath</span> <span class="hljs-operator">=</span> getPackageSearchPath(basePackage);<br>        <span class="hljs-type">ResourceLoader</span> <span class="hljs-variable">resourceLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResourceLoader</span>();<br>        <span class="hljs-type">MetadataReaderFactory</span> <span class="hljs-variable">readerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMetadataReaderFactory</span>(resourceLoader);<br>        Resource[] resources = ResourcePatternUtils.getResourcePatternResolver(resourceLoader).getResources(packageSearchPath);<br>        <span class="hljs-keyword">for</span> (Resource resource : resources) &#123;<br>            <span class="hljs-type">MetadataReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> readerFactory.getMetadataReader(resource);<br>            matchField(clazz, candidates, reader);<br>        &#125;<br>        <span class="hljs-keyword">return</span> candidates;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">matchMethod</span><span class="hljs-params">(Class clazz, List&lt;Method&gt; candidates, MetadataReader reader)</span> &#123;<br>        Class&lt;?&gt; clz = transformToClass(reader.getClassMetadata().getClassName());<br>        Method[] methods = clz.getMethods();<br>        <span class="hljs-keyword">for</span> (Method method : methods) &#123;<br>            <span class="hljs-type">Annotation</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> method.getAnnotation(clazz);<br><br>            <span class="hljs-keyword">if</span> (annotation == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (method != <span class="hljs-literal">null</span> &amp;&amp; method.isAnnotationPresent(clazz)) &#123;<br>                candidates.add(method);<br>                logger.debug(<span class="hljs-string">&quot;扫描到符合要求的method：&quot;</span> + method.getName());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">matchField</span><span class="hljs-params">(Class clazz, List&lt;Field&gt; candidates, MetadataReader reader)</span> &#123;<br>        Class&lt;?&gt; clz = transformToClass(reader.getClassMetadata().getClassName());<br>        Field[] declaredFields = clz.getDeclaredFields();<br>        <span class="hljs-keyword">for</span> (Field field : declaredFields) &#123;<br>            <span class="hljs-type">Annotation</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> field.getAnnotation(clazz);<br><br>            <span class="hljs-keyword">if</span> (annotation == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (field != <span class="hljs-literal">null</span> &amp;&amp; field.isAnnotationPresent(clazz)) &#123;<br>                candidates.add(field);<br>                logger.debug(<span class="hljs-string">&quot;扫描到符合要求的field：&quot;</span> + field.getName());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">convertPath</span><span class="hljs-params">(String path)</span> &#123;<br>        <span class="hljs-keyword">return</span> StringUtils.replace(path, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; transform(String className) &#123;<br>        Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            clazz = ClassUtils.forName(className, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            logger.info(<span class="hljs-string">&quot;未找到指定类&quot;</span>, className);<br>        &#125;<br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">match</span><span class="hljs-params">(ClassMetadata metadata, Class c)</span> &#123;<br>        Class&lt;?&gt; clazz = transformToClass(metadata.getClassName());<br>        <span class="hljs-keyword">return</span> clazz != <span class="hljs-literal">null</span> &amp;&amp; clazz.isAnnotationPresent(c);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; transformToClass(String className) &#123;<br>        Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            clazz = ClassUtils.forName(className, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            logger.info(<span class="hljs-string">&quot;未找到指定类&quot;</span>, className);<br>        &#125;<br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateCandidates</span><span class="hljs-params">(String basePackages, <span class="hljs-type">boolean</span> empty)</span> &#123;<br>        <span class="hljs-keyword">if</span> (empty) &#123;<br>            logger.info(<span class="hljs-string">&quot;扫描指定包下，未发现符合条件的类&quot;</span>, basePackages);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getPackageSearchPath</span><span class="hljs-params">(String basePackage)</span> &#123;<br>        <span class="hljs-keyword">return</span> ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +<br>                convertPath(basePackage) + <span class="hljs-string">&#x27;/&#x27;</span> + DEFAULT_RESOURCE_PATTERN;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获取使用指定注解的所有类</span><br>List&lt;Class&lt;?&gt;&gt; candidates = AnnotationUtils.getInstance().getClassCandidates(<span class="hljs-string">&quot;com.cason&quot;</span>, PermitAccountStatus.class);<br><span class="hljs-comment">//获取使用指定注解的所有方法</span><br>List&lt;Method&gt; methodCandidates = AnnotationUtils.getInstance().getMethodCandidates(<span class="hljs-string">&quot;com.cason&quot;</span>, PermitAccountStatus.class);<br><span class="hljs-comment">//获取使用指定注解的所有字段</span><br>List&lt;Field&gt; fieldCandidates = AnnotationUtils.getInstance().getFieldCandidates(<span class="hljs-string">&quot;com.cason&quot;</span>, PermitAccountStatus.class);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>使用ImageIO读取网络图片或本地图片</title>
    <link href="/2022/07/19/%E4%BD%BF%E7%94%A8ImageIO%E8%AF%BB%E5%8F%96%E7%BD%91%E7%BB%9C%E5%9B%BE%E7%89%87%E6%88%96%E6%9C%AC%E5%9C%B0%E5%9B%BE%E7%89%87/"/>
    <url>/2022/07/19/%E4%BD%BF%E7%94%A8ImageIO%E8%AF%BB%E5%8F%96%E7%BD%91%E7%BB%9C%E5%9B%BE%E7%89%87%E6%88%96%E6%9C%AC%E5%9C%B0%E5%9B%BE%E7%89%87/</url>
    
    <content type="html"><![CDATA[<blockquote><p>来自网络</p></blockquote><h3 id="读取网络图片"><a href="#读取网络图片" class="headerlink" title="读取网络图片"></a>读取网络图片</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(path);<br>BufferedImage source= ImageIO.read(url);<br></code></pre></td></tr></table></figure><h3 id="读取本地图片"><a href="#读取本地图片" class="headerlink" title="读取本地图片"></a>读取本地图片</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">BufferedImage source= ImageIO.read(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path));<br></code></pre></td></tr></table></figure><h3 id="获取网络图片工具类"><a href="#获取网络图片工具类" class="headerlink" title="获取网络图片工具类"></a>获取网络图片工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpImageUtils</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(HttpImageUtils.class);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span> * <span class="hljs-number">1000</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取网络图片转成字节流</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> strUrl 完整图片地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 图片资源数组</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getNetImgByUrl(String strUrl) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(strUrl);<br>            <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>            conn.setRequestMethod(<span class="hljs-string">&quot;GET&quot;</span>);<br>            conn.setConnectTimeout(TIMEOUT);<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inStream</span> <span class="hljs-operator">=</span> conn.getInputStream();<br>            <span class="hljs-keyword">return</span> readInputStream(inStream);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            logger.error(e.getMessage(),e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 从输入流中获取字节流数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> inStream 输入流</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  图片流</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] readInputStream(InputStream inStream) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">outStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[Integer.MAX_VALUE];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> ((len = inStream.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>            outStream.write(buffer, <span class="hljs-number">0</span>, len);<br>        &#125;<br>        inStream.close();<br>        <span class="hljs-keyword">return</span> outStream.toByteArray();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>解决Okhttp只能获取一次responsebody的问题</title>
    <link href="/2022/07/18/%E8%A7%A3%E5%86%B3Okhttp%E5%8F%AA%E8%83%BD%E8%8E%B7%E5%8F%96%E4%B8%80%E6%AC%A1responsebody%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <url>/2022/07/18/%E8%A7%A3%E5%86%B3Okhttp%E5%8F%AA%E8%83%BD%E8%8E%B7%E5%8F%96%E4%B8%80%E6%AC%A1responsebody%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>okhttp通过response.body().string() 获取字符串类型的responsebody</p><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">string</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> source()) &#123;<br>      <span class="hljs-type">Charset</span> <span class="hljs-variable">charset</span> <span class="hljs-operator">=</span> Util.bomAwareCharset(source, charset());<br>      <span class="hljs-keyword">return</span> source.readString(charset);<br>    &#125;<br>  &#125;<br><br><br><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>    Util.closeQuietly(source());<br>  &#125;<br></code></pre></td></tr></table></figure><p>ResponseBody，其实现了 <code>Closeable</code> 接口，通过复写 <code>close()</code> 方法来 <strong>关闭并释放资源</strong>，关闭 <code>ResponseBody</code> 子类所持有的 <code>BufferedSource</code> 接口对象，当我们第一次调用 <code>response.body().string()</code> 时，OkHttp 将响应体的缓冲资源返回的同时，调用 <code>closeQuietly()</code> 方法默默释放了资源</p><h3 id="获取responseBody"><a href="#获取responseBody" class="headerlink" title="获取responseBody"></a>获取responseBody</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getResponseBody</span><span class="hljs-params">(Response response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>     <span class="hljs-type">BufferedSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> response.body().source();<br>     source.request(Long.MAX_VALUE);<br>     <span class="hljs-type">Buffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> source.getBuffer();<br>     <span class="hljs-type">String</span> <span class="hljs-variable">responseBody</span> <span class="hljs-operator">=</span> buffer.clone().readUtf8();<br>     <span class="hljs-keyword">return</span> responseBody;<br> &#125;<br></code></pre></td></tr></table></figure><h3 id="获取requestBody"><a href="#获取requestBody" class="headerlink" title="获取requestBody"></a>获取requestBody</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getRequestBody</span><span class="hljs-params">(Request request)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Buffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Buffer</span>();<br>        <span class="hljs-keyword">if</span> (request.body() != <span class="hljs-literal">null</span>) &#123;<br>            request.body().writeTo(buffer);<br>            <span class="hljs-keyword">return</span> buffer.clone().readUtf8();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>okhttp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>InheritableThreadLocal解决ThreadLocal子线程不可继承父线程变量的问题</title>
    <link href="/2022/06/17/InheritableThreadLocal%E8%A7%A3%E5%86%B3ThreadLocal%E5%AD%90%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%8F%AF%E7%BB%A7%E6%89%BF%E7%88%B6%E7%BA%BF%E7%A8%8B%E5%8F%98%E9%87%8F%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <url>/2022/06/17/InheritableThreadLocal%E8%A7%A3%E5%86%B3ThreadLocal%E5%AD%90%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%8F%AF%E7%BB%A7%E6%89%BF%E7%88%B6%E7%BA%BF%E7%A8%8B%E5%8F%98%E9%87%8F%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>当我用Mybatis-plus自动填充创建人员，更新人员字段的时候，发现数据库中又很多字段都没有记录这两个字段，通过分析发现是因为这些更新或者创建操作是在异步的情况下去执行的，由于父线程创建的子线程无法获取父线程的ThreadLocal变量，导致无法正确的获取这两个字段。</p><blockquote><p>以下代码说明使用ThreadLocal 子线程无法访问父线程的线程变量</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestThreadLocal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;String&gt; username = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        username.set(<span class="hljs-string">&quot;beixian&quot;</span>);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;子线程获取：&quot;</span>+username.get());<br>            &#125;<br>        &#125;);<br>        thread.start();<br>        System.out.println(<span class="hljs-string">&quot;main线程获取&quot;</span>+username.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202206180001004.png" alt="TestThreadLocal.main执行结果"></p><p>原因：子线程ThreadLocal get()获取的的是子线程的threadLocals里的值，而父线程set()的是父线程的threadLocals里的值，而子线程创建的时候没有继承threadLocals里的值。</p><blockquote><p>以下代码说明使用InheritableThreadLocal子线程可以访问父线程的线程变量</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestInheritableThreadLocal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InheritableThreadLocal&lt;String&gt; username = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        username.set(<span class="hljs-string">&quot;beixian&quot;</span>);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;子线程获取：&quot;</span>+username.get());<br>            &#125;<br>        &#125;);<br>        thread.start();<br>        System.out.println(<span class="hljs-string">&quot;main线程获取&quot;</span>+username.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202206180001992.png" alt="TestInheritableThreadLocal.main执行结果"></p><p>解决方案：InheritableThreadLocal可以帮助我们解决这个问题，子线程在初始化的时候会通过父线程的inheritThreadLocals变量初始化子线程的inheritThreadLocals变量，这样子线程拥有了父线程的线程变量并可访问。</p><h5 id="Thread-init-源码"><a href="#Thread-init-源码" class="headerlink" title="Thread init()源码"></a>Thread init()源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Thread的构造方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Thread</span><span class="hljs-params">(Runnable target)</span> &#123;<br>        init(<span class="hljs-literal">null</span>, target, <span class="hljs-string">&quot;Thread-&quot;</span> + nextThreadNum(), <span class="hljs-number">0</span>);<br>    &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ThreadGroup g, Runnable target, String name,</span><br><span class="hljs-params">                      <span class="hljs-type">long</span> stackSize)</span> &#123;<br>  <span class="hljs-comment">//这里设置了inheritThreadLocals为true</span><br>        init(g, target, name, stackSize, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ThreadGroup g, Runnable target, String name,</span><br><span class="hljs-params">                      <span class="hljs-type">long</span> stackSize, AccessControlContext acc,</span><br><span class="hljs-params">                      <span class="hljs-type">boolean</span> inheritThreadLocals)</span> &#123;<br>      <span class="hljs-comment">/**省略部分代码**/</span><br>  <span class="hljs-comment">// inheritThreadLocals为true 且 父线程的inheritThreadLocals不为空</span><br>        <span class="hljs-keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="hljs-literal">null</span>)<br>            <span class="hljs-built_in">this</span>.inheritableThreadLocals =<br>                ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);<br>       <span class="hljs-comment">/**省略部分代码**/</span><br>    &#125;<br><br><span class="hljs-keyword">static</span> ThreadLocalMap <span class="hljs-title function_">createInheritedMap</span><span class="hljs-params">(ThreadLocalMap parentMap)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(parentMap);<br>    &#125;<br></code></pre></td></tr></table></figure><h5 id="InheritableThreadLocal源码"><a href="#InheritableThreadLocal源码" class="headerlink" title="InheritableThreadLocal源码"></a>InheritableThreadLocal源码</h5><p>InheritableThreadLocal继承于ThreadLocal，只是重写了childValue()，getMap()，createMap()方法，重写的原因是因为要获取和操作的不在是Thread.threadLocals这个变量，而是inheritableThreadLocals这个变量</p><p>get()、set()等方法同ThreadLocal，可以参考【Threadlocal的简单理解和部分源码分析】这篇文章</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadLocal</span>&lt;T&gt; &#123;<br>  <br>    <span class="hljs-keyword">protected</span> T <span class="hljs-title function_">childValue</span><span class="hljs-params">(T parentValue)</span> &#123;<br>        <span class="hljs-keyword">return</span> parentValue;<br>    &#125;<br><br>    ThreadLocalMap <span class="hljs-title function_">getMap</span><span class="hljs-params">(Thread t)</span> &#123;<br>       <span class="hljs-keyword">return</span> t.inheritableThreadLocals;<br>    &#125;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createMap</span><span class="hljs-params">(Thread t, T firstValue)</span> &#123;<br>        t.inheritableThreadLocals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(<span class="hljs-built_in">this</span>, firstValue);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>并发编程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ThreadLocal</tag>
      
      <tag>InheritableThreadLocal</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Threadlocal的简单理解和部分源码分析</title>
    <link href="/2022/06/16/Threadlocal%E7%9A%84%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3%E5%92%8C%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/16/Threadlocal%E7%9A%84%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3%E5%92%8C%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>Mybatis-plus 可以实现字段自动填充功能，我通常会把多个表中共同字段抽离到了一个公共实体类中，如创建时间，创建人员，更新时间，更新人员等等，但是如何获取当前用户信息填入创建人员，更新人员字段？</p><p>ThreadLocal可以帮助我解决这个问题，我使用的的是JWT token 验证登陆状态，在每次Http请求时Header都会附带token，token中就会附带用户信息，当我们验证完后把用户信息set进Threadlocal，就可以在同一个线程中通过ThreadLocal获取用户信息。</p><h4 id="ThreadLocal理解"><a href="#ThreadLocal理解" class="headerlink" title="ThreadLocal理解"></a>ThreadLocal理解</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202206162045177.png" alt="图源自网络"></p><p>ThreadLocal是线程安全的，它可以确保多线程访问时每个线程只能访问到自己的线程私有变量。它的线程隔离机制是通过把共享变量的副本存储到Thread.threadLocals实现，每个线程只能访问自己的副本，就能避免线程安全问题。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202206162045799.png" alt="Thread类截图"></p><p>ThreadLocal实际上就是一个操作Thread.threadLocals的外壳。Thread.threadLocals变量是一个keyvalueMap，Thread创建的时候默认初始化threadLocals为null，在ThreadLocal首次读或写的时候初始化threadLocals。ThreadLocalMap是ThreadLocal中的静态内部类，ThreadLocalMap通过Entry键值对的方式存储数据，是一个定制化的Map。</p><h4 id="ThreadLocal源码分析"><a href="#ThreadLocal源码分析" class="headerlink" title="ThreadLocal源码分析"></a>ThreadLocal源码分析</h4><h5 id="set"><a href="#set" class="headerlink" title="set()"></a>set()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> &#123;<br>  <span class="hljs-comment">//获取当前线程</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>  <span class="hljs-comment">//获取Thread.threadLocals</span><br>        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>  <span class="hljs-comment">//map不为空就设入键值对 key为当前ThreadLocal对象 </span><br>        <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>)<br>            map.set(<span class="hljs-built_in">this</span>, value);<br>        <span class="hljs-keyword">else</span><br>          <span class="hljs-comment">//否则创建Thread.threadLocals</span><br>            createMap(t, value);<br>    &#125;<br></code></pre></td></tr></table></figure><p>我们可以发现ThreadLocal set的方法是对Thread.threadLocals这个定制化的Map进行操作</p><h6 id="getMap"><a href="#getMap" class="headerlink" title="getMap()"></a>getMap()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">ThreadLocalMap <span class="hljs-title function_">getMap</span><span class="hljs-params">(Thread t)</span> &#123;<br>  <span class="hljs-comment">//就是取出Thread.threadLocals</span><br>    <span class="hljs-keyword">return</span> t.threadLocals;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="createMap"><a href="#createMap" class="headerlink" title="createMap()"></a>createMap()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">createMap</span><span class="hljs-params">(Thread t, T firstValue)</span> &#123;<br>  <span class="hljs-comment">//以当前TreadLocal对象为key 创建并初始化一个Thread.threadLocals</span><br>    t.threadLocals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(<span class="hljs-built_in">this</span>, firstValue);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="get"><a href="#get" class="headerlink" title="get()"></a>get()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-comment">//获取当前线程</span><br>     <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>  <span class="hljs-comment">//获取Thread.threadLocals</span><br>     <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>  <span class="hljs-comment">//map不为空 通过当前对象作为key 获取值</span><br>     <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>         ThreadLocalMap.<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>);<br>       <span class="hljs-comment">//map部位空还得判断当前键在不在map里</span><br>         <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>             <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>             <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (T)e.value;<br>             <span class="hljs-keyword">return</span> result;<br>         &#125;<br>     &#125;<br>  <span class="hljs-comment">// map为空就创建并初始化</span><br>     <span class="hljs-keyword">return</span> setInitialValue();<br> &#125;<br></code></pre></td></tr></table></figure><h6 id="setInitialValue"><a href="#setInitialValue" class="headerlink" title="setInitialValue()"></a>setInitialValue()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-keyword">private</span> T <span class="hljs-title function_">setInitialValue</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-comment">//初始化value为null</span><br>       <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> initialValue();<br>     <span class="hljs-comment">//获取当前线程</span><br>       <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>     <span class="hljs-comment">//获取Thread.threadLocals</span><br>       <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>     <span class="hljs-comment">//判断map是否为空 不为空就把 key为当前对象 value为null 设置进map</span><br>       <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>)<br>           map.set(<span class="hljs-built_in">this</span>, value);<br>       <span class="hljs-keyword">else</span><br>         <span class="hljs-comment">//否则就创建并初始化Thread.threadLocals</span><br>           createMap(t, value);<br>       <span class="hljs-keyword">return</span> value;<br>   &#125;<br><br><span class="hljs-keyword">protected</span> T <span class="hljs-title function_">initialValue</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>   &#125;<br></code></pre></td></tr></table></figure><h5 id="remove"><a href="#remove" class="headerlink" title="remove()"></a>remove()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-comment">//在当前线程里获取Thread.threadLocals</span><br>        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> getMap(Thread.currentThread());<br>        <span class="hljs-keyword">if</span> (m != <span class="hljs-literal">null</span>)<br>           <span class="hljs-comment">//在map里移除 以当前对象为key的 键值对</span><br>            m.remove(<span class="hljs-built_in">this</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>并发编程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ThreadLocal</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Springboot集成WebSocket实现消息推送 记录</title>
    <link href="/2022/06/07/Springboot%E9%9B%86%E6%88%90WebSocket%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81-%E8%AE%B0%E5%BD%95/"/>
    <url>/2022/06/07/Springboot%E9%9B%86%E6%88%90WebSocket%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81-%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h3 id="一、什么是WebSocket？"><a href="#一、什么是WebSocket？" class="headerlink" title="一、什么是WebSocket？"></a>一、什么是WebSocket？</h3><p>WebSocket是HTML5开始提供的一种在单个TCP连接上进行全双工通讯的协议，能更好的节省服务器资源和带宽，并且能够更实时地进行通讯。</p><p>WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据，在WebSocket API中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。–来源自<a href="https://juejin.cn/post/6844904004762222606?utm_source=gold_browser_extension">https://juejin.cn/post/6844904004762222606?utm_source=gold_browser_extension</a></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202206071031666.jpeg" alt="img"></p><center><small>(图源自网络)</small></center><h3 id="二、与springboot集成"><a href="#二、与springboot集成" class="headerlink" title="二、与springboot集成"></a>二、与springboot集成</h3><h4 id="引入spring-boot-starter-websocket依赖"><a href="#引入spring-boot-starter-websocket依赖" class="headerlink" title="引入spring-boot-starter-websocket依赖"></a>引入spring-boot-starter-websocket依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;springboot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="新建WebSocketHandler"><a href="#新建WebSocketHandler" class="headerlink" title="新建WebSocketHandler"></a>新建WebSocketHandler</h4><p>MercuryWebsocketHandler.class 对连接建立处理，消息处理，错误处理，以及连接关闭处理等等</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MercuryWebSocketHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionEstablished</span><span class="hljs-params">(WebSocketSession webSocketSession)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">wsId</span> <span class="hljs-operator">=</span> WsSessionManager.getWsId(webSocketSession.getUri().getPath());<br>        <span class="hljs-keyword">if</span> (wsId != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 用户连接成功，放入在线用户缓存</span><br>            WsSessionManager.add(wsId, webSocketSession);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;用户登录已经失效!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(WebSocketSession webSocketSession, WebSocketMessage&lt;?&gt; webSocketMessage)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> webSocketMessage.getPayload().toString();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">wsId</span> <span class="hljs-operator">=</span> WsSessionManager.getWsId(webSocketSession.getUri().getPath());<br>        System.out.println(<span class="hljs-string">&quot;server 接收到 &quot;</span> + wsId + <span class="hljs-string">&quot; 发送的 &quot;</span> + payload);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTransportError</span><span class="hljs-params">(WebSocketSession webSocketSession, Throwable throwable)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        log.error(<span class="hljs-string">&quot;发生错误&quot;</span>, throwable);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionClosed</span><span class="hljs-params">(WebSocketSession webSocketSession, CloseStatus closeStatus)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">wsId</span> <span class="hljs-operator">=</span> WsSessionManager.getWsId(webSocketSession.getUri().getPath());<br>        <span class="hljs-keyword">if</span> (wsId != <span class="hljs-literal">null</span>) &#123;<br>            WsSessionManager.removeAndClose(wsId);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsPartialMessages</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="实现WebSocketConfigurer-来对握手前后进行逻辑处理"><a href="#实现WebSocketConfigurer-来对握手前后进行逻辑处理" class="headerlink" title="实现WebSocketConfigurer 来对握手前后进行逻辑处理"></a>实现WebSocketConfigurer 来对握手前后进行逻辑处理</h4><p>因为我需要对websocket 握手前进行校验，所以创建WebSocketHandshakeInterceptor.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketHandshakeInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpSessionHandshakeInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">beforeHandshake</span><span class="hljs-params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler webSocketHandler, Map&lt;String, Object&gt; attributes)</span><br>            <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-comment">/**省略校验逻辑 校验不通过 return false**/</span><br>      <br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.beforeHandshake(request, response, webSocketHandler, attributes);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterHandshake</span><span class="hljs-params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Exception e)</span> &#123;<br>        <span class="hljs-built_in">super</span>.afterHandshake(request, response, wsHandler, e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="实现WebSocketConfigurer"><a href="#实现WebSocketConfigurer" class="headerlink" title="实现WebSocketConfigurer"></a>实现WebSocketConfigurer</h4><p>新建websocket配置类，添加拦截地址以及相应的websocket消息处理器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSocket</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketServerConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerWebSocketHandlers</span><span class="hljs-params">(WebSocketHandlerRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// 添加拦截地址以及相应的websocket消息处理器</span><br>        <span class="hljs-type">WebSocketHandlerRegistration</span> <span class="hljs-variable">registration</span> <span class="hljs-operator">=</span> registry<br>                .addHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MercuryWebSocketHandler</span>(), <span class="hljs-string">&quot;/api/websocket/**&quot;</span>)<br>                .setAllowedOrigins(<span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-comment">// 添加拦截器</span><br>        registration.addInterceptors(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketHandshakeInterceptor</span>());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="创建WsSessionManager存储websocket-session"><a href="#创建WsSessionManager存储websocket-session" class="headerlink" title="创建WsSessionManager存储websocket session"></a>创建WsSessionManager存储websocket session</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WsSessionManager</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;String, WebSocketSession&gt; SESSION_POOL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">onlineCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加 session</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wsId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(String wsId, WebSocketSession session)</span> &#123;<br>        addOnlineCount();<br>        SESSION_POOL.put(wsId, session);<br>        log.info(<span class="hljs-string">&quot;有新窗口开始监听:&quot;</span> + wsId + <span class="hljs-string">&quot;,当前在线人数为:&quot;</span> + getOnlineCount());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除 session,会返回删除的 session</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wsId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WebSocketSession <span class="hljs-title function_">remove</span><span class="hljs-params">(String wsId)</span> &#123;<br>        <span class="hljs-type">WebSocketSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> SESSION_POOL.remove(wsId);<br>        subOnlineCount();<br>        log.info(<span class="hljs-string">&quot;释放的wsId为：&quot;</span> + wsId);<br>        log.info(<span class="hljs-string">&quot;有一连接关闭！当前在线人数为&quot;</span> + getOnlineCount());<br>        <span class="hljs-keyword">return</span> session;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除并同步关闭连接</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wsId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAndClose</span><span class="hljs-params">(String wsId)</span> &#123;<br>        <span class="hljs-type">WebSocketSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> remove(wsId);<br>        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 关闭连接</span><br>                session.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                log.error(e.getMessage(),e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获得 session</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WebSocketSession <span class="hljs-title function_">get</span><span class="hljs-params">(String wsId)</span> &#123;<br>        <span class="hljs-comment">// 获得 session</span><br>        <span class="hljs-keyword">return</span> SESSION_POOL.get(wsId);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 实现服务器主动推送</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String wsId,String message)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        get(wsId).sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(message));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 非多机部署请注释此方法</span><br><span class="hljs-comment">     * 实现服务器主动推送 用于解决分布式websocket session不共享的问题</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageBroadcasting</span><span class="hljs-params">(String wsId,String message)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RocketMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> SpringContextUtils.getBean(RocketMQProducer.class);<br>        <span class="hljs-type">WebSocketMessageSendDto</span> <span class="hljs-variable">webSocketMessageSendDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketMessageSendDto</span>();<br>        webSocketMessageSendDto.setWsId(wsId);<br>        webSocketMessageSendDto.setMessage(message);<br>        producer.sendObject(RocketMqConstant.Topic.MERCURY_WEB_SOCKET_MESSAGE_SEND,webSocketMessageSendDto);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> WsSessionManager.onlineCount.get();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addOnlineCount</span><span class="hljs-params">()</span> &#123;<br>        WsSessionManager.onlineCount.getAndIncrement();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subOnlineCount</span><span class="hljs-params">()</span> &#123;<br>        WsSessionManager.onlineCount.getAndDecrement();<br>    &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * url template：http://localhost/api/websocket/&#123;ws_id&#125;</span><br><span class="hljs-comment">    * 需要在url提取ws_id</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getWsId</span><span class="hljs-params">(String requestUrl)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String[] split = requestUrl.split(<span class="hljs-string">&quot;/api/websocket/&quot;</span>);<br>        <span class="hljs-keyword">if</span> (split.length &lt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;invalid ws request&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> split[split.length - <span class="hljs-number">1</span>];<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="发送消息给前端"><a href="#发送消息给前端" class="headerlink" title="发送消息给前端"></a>发送消息给前端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">WsSessionManager.sendMessage(ws_id,message)<br></code></pre></td></tr></table></figure><h3 id="三、前端Vue与websocket集成"><a href="#三、前端Vue与websocket集成" class="headerlink" title="三、前端Vue与websocket集成"></a>三、前端Vue与websocket集成</h3><h4 id="新建websocket-js"><a href="#新建websocket-js" class="headerlink" title="新建websocket.js"></a>新建websocket.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// import &#123; showInfoMsg, showErrorMsg &#125; from &#x27;@/utils/popInfo&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ElementUI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;element-ui&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WS_API</span> = <span class="hljs-string">`ws://localhost:8080`</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">initWebSocket</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-string">&#x27;WebSocket&#x27;</span><span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>)) &#123;<br>        <span class="hljs-title class_">ElementUI</span>.<span class="hljs-title class_">Notification</span>(&#123;<br>            <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;当前浏览器 Not support websocket&#x27;</span>,<br>            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;error&#x27;</span>,<br>            <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span>,<br>        &#125;);<br>    &#125;<br>    <span class="hljs-keyword">const</span> wsUri = <span class="hljs-variable constant_">WS_API</span> + <span class="hljs-string">&#x27;/api/websocket/&#x27;</span> + e;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(wsUri); <span class="hljs-comment">//这里面的this都指向vue</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-property">onerror</span> = webSocketOnError;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-property">onmessage</span> = webSocketOnMessage;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-property">onclose</span> = closeWebsocket;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">webSocketOnError</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-comment">// console.log(e)</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)<br>    <span class="hljs-title class_">ElementUI</span>.<span class="hljs-title class_">Notification</span>(&#123;<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;WebSocket连接发生错误&#x27;</span>,<br>        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;error&#x27;</span>,<br>        <span class="hljs-attr">duration</span>: <span class="hljs-number">3000</span>,<br>    &#125;);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">webSocketOnMessage</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">data</span>);<br>  <span class="hljs-title class_">ElementUI</span>.<span class="hljs-title class_">Notification</span>(&#123;<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">message</span>: data.<span class="hljs-property">msg</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;success&#x27;</span>,<br>    <span class="hljs-attr">duration</span>: <span class="hljs-number">5000</span>,<br>  &#125;);<br>&#125;<br><br><span class="hljs-comment">// 关闭websiocket</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">closeWebsocket</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;连接已关闭...&#x27;</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 关闭 websocket</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e); <span class="hljs-comment">//监听关闭事件</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;关闭&#x27;</span>);<br>    &#125;;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">webSocketSend</span>(<span class="hljs-params">agentData</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">send</span>(agentData);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>    initWebSocket,<br>    close,<br>&#125;;<br><br></code></pre></td></tr></table></figure><h4 id="在main-js引入"><a href="#在main-js引入" class="headerlink" title="在main.js引入"></a>在main.js引入</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> websocket <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;具体地址/websocket&quot;</span>;<br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$websocket</span> = websocket;<br></code></pre></td></tr></table></figure><p>然后在需要初始化websocket的地方，我是在App.vue全局mounted以下代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">$websocket</span>.<span class="hljs-title function_">initWebSocket</span>(&#123;ws_id&#125;)<span class="hljs-comment">//请根据具体逻辑替换ws_id 我这里填入的是jwt token</span><br></code></pre></td></tr></table></figure><h3 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h3><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202206071032239.png" alt="image-20220606183934456"></p><center><small>进入页面就会连接websocket</small></center><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202206071032020.png" alt="image-20220606183828420"></p><center><small>后端通过调用WsSessionManager.sendMessage(ws_id,message)发送消息给具体用户</small></center><h3 id="三、解决websocket-session在分布式系统不共享问题"><a href="#三、解决websocket-session在分布式系统不共享问题" class="headerlink" title="三、解决websocket session在分布式系统不共享问题"></a>三、解决websocket session在分布式系统不共享问题</h3><p>在Spring所集成的WebSocket里面，每个ws连接都有一个对应的session：WebSocketSession，在Spring WebSocket中，我们建立ws连接之后可以通过类似这样的方式进行与客户端的通信。但是 ws的session无法序列化到redis， 因此在集群中，我们无法将所有WebSocketSession都缓存到redis进行session共享。</p><p>本文简单解决方案思路：利用rocketmq广播的特性使得每一台机子都能执行发送消息的动作，这样的操作可能会导致没有对应webSocketSession的机器执行一直没必要的操作，但是因为根据键值ws_id在map中定位session，可以忽略不计。</p><h4 id="简单定义一个数据传输对象"><a href="#简单定义一个数据传输对象" class="headerlink" title="简单定义一个数据传输对象"></a>简单定义一个数据传输对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketMessageSendDto</span> &#123;<br>    <span class="hljs-keyword">private</span> String wsId;<br>    <span class="hljs-keyword">private</span> String message;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="创建消费者"><a href="#创建消费者" class="headerlink" title="创建消费者"></a>创建消费者</h4><p>重点：messageModel &#x3D; MessageModel.BROADCASTING</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RocketMQMessageListener(topic = RocketMqConstant.Topic.MERCURY_WEB_SOCKET_MESSAGE_SEND</span><br><span class="hljs-meta">        , consumerGroup = RocketMqConstant.ComsumerGroup.MERCURY_WEB_SOCKET_MESSAGE_SEND,</span><br><span class="hljs-meta">        messageModel = MessageModel.BROADCASTING)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketMessageSendConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;WebSocketMessageSendDto&gt;, RocketMQPushConsumerLifecycleListener &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(WebSocketMessageSendDto dto)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;WebSocketMessageSendConsumer 接收到信息：&#123;&#125;&quot;</span>,JSON.toJSONString(dto));<br>        <span class="hljs-keyword">try</span> &#123;<br>            WsSessionManager.sendMessage(dto.getWsId(),dto.getMessage());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(e.getMessage(),e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareStart</span><span class="hljs-params">(DefaultMQPushConsumer consumer)</span> &#123;<br>        consumer.setMaxReconsumeTimes(<span class="hljs-number">2</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="消息生产者"><a href="#消息生产者" class="headerlink" title="消息生产者"></a>消息生产者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 实现服务器主动推送</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageBroadcasting</span><span class="hljs-params">(String wsId,String message)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>     <span class="hljs-type">RocketMQTemplate</span> <span class="hljs-variable">rocketMQTemplate</span> <span class="hljs-operator">=</span> SpringContextUtils.getBean(RocketMQTemplate.class);<br>     <span class="hljs-type">WebSocketMessageSendDto</span> <span class="hljs-variable">webSocketMessageSendDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketMessageSendDto</span>();<br>     webSocketMessageSendDto.setWsId(wsId);<br>     webSocketMessageSendDto.setMessage(message);<br>   rocketMQTemplate.convertAndSend(RocketMqConstant.Topic.MERCURY_WEB_SOCKET_MESSAGE_SEND, JSON.toJSONString(webSocketMessageSendDto))<br> &#125;<br>  <br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WebSocket</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>店匠插件开发-创建店匠应用</title>
    <link href="/2022/05/09/%E5%BA%97%E5%8C%A0%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91-%E5%88%9B%E5%BB%BA%E5%BA%97%E5%8C%A0%E5%BA%94%E7%94%A8/"/>
    <url>/2022/05/09/%E5%BA%97%E5%8C%A0%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91-%E5%88%9B%E5%BB%BA%E5%BA%97%E5%8C%A0%E5%BA%94%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p>因为公司最近有需求需要开发商品批量导入到店匠，所以简单记录一下操作过程</p><h3 id="创建店匠私有App"><a href="#创建店匠私有App" class="headerlink" title="创建店匠私有App"></a>创建店匠私有App</h3><p>店匠官网：<a href="https://promo.shoplazza.cn/">https://promo.shoplazza.cn</a></p><p>官方教程：<a href="https://www.shoplazza.dev/reference">https://www.shoplazza.dev/reference</a></p><blockquote><p>创建店铺过程忽略</p></blockquote><p>进入店铺&gt;Apps&gt;管理私有App&gt;创建应用</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205091923902.png" alt="image-20220509151049132"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205091920237.png" alt="image-20220509192015711"></p><p>填入应用名称，开发者邮箱，然后按需选择接口调用权限</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205091923235.png" alt="image-20220509151137589"></p><p>创建app成功后即可获得Token、App UID、App Secret，后续开发会用到</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205091924048.png" alt="image-20220509151302132"></p><h3 id="使用Postman调试"><a href="#使用Postman调试" class="headerlink" title="使用Postman调试"></a>使用Postman调试</h3><p>使用Token和官方提供的API进行接口调试</p><p>填入token 复制CURL语句</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205091919133.png" alt="image-20220509191946173"></p><p>粘贴到postman进行调试</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205091924847.png" alt="image-20220509191446157"></p><p>有返回值且状态码为200表示测试成功</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205091924934.png" alt="image-20220509191601006"></p><blockquote><p>接下来就可以根据对应接口进行定制化开发啦，后续是公司定制化代码就不展示上来了</p></blockquote><h3 id="创建店匠公有App"><a href="#创建店匠公有App" class="headerlink" title="创建店匠公有App"></a>创建店匠公有App</h3><h4 id="注册账号"><a href="#注册账号" class="headerlink" title="注册账号"></a>注册账号</h4><p>官网：<a href="https://partners.shoplazza.com/">https://partners.shoplazza.com/</a></p><h4 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h4><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205092121186.png" alt="image-20220509212114676"></p><table><thead><tr><th align="left"><strong>App URL</strong></th><th align="left">App’s main service URL</th><th align="left">在应用程序安装过程中使用。 当商家安装您的应用或进入该应用时，您的应用会收到对该应用 URL 的 GET 请求。 您的应用在收到 GET 请求后需要启动 OAuth 流程来安装应用，无论应用安装过程是从 Shoplaza 应用商店的“添加应用”开始，还是从合作伙伴中心仪表板的“安装应用”开始。–谷歌翻译</th></tr></thead><tbody><tr><td align="left"><strong>Redirect URL</strong></td><td align="left">App’s redirect URL</td><td align="left">在应用程序安装过程中使用。 商户在 OAuth 过程中授予权限后，商户将被重定向到带有 OAuth 代码和其他字段的重定向 URL。–谷歌翻译</td></tr></tbody></table><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205092121847.png" alt="image-20220509212107975"></p><h4 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h4><blockquote><p> 以下大部分内容是直接谷歌翻译自店匠官方</p></blockquote><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205092153822.png" alt="img"></p><center><small>基于商家、您的应用和 Shoplaza 的操作的 OAuth 流程-图源来自店匠官网</small></center><ol><li>商家发出安装应用程序的请求。</li><li>应用重定向到Shoplazza Store的应用安装页面，请求商家授权。</li><li>Shoplazza 商店的应用安装页面提示 OAuth 授权屏幕并请求商家授权所需的范围。</li><li>商家通过同意应用请求的权限来授权应用。</li><li>该应用程序收到一个授权代码。</li><li>该应用程序通过使用授权代码向 Shoplazza Store 发送请求来请求访问令牌。</li><li>Shoplazza 对应用程序进行身份验证，验证授权代码，然后发出并返回访问令牌。该应用程序现在可以从 Shoplazza 请求数据。</li><li>该应用程序使用访问令牌向<a href="https://www.shoplazza.dev/reference/overview">Shoplazza Open API</a>发出请求。</li><li>Shoplazza 验证访问令牌并返回请求的数据。</li></ol><h5 id="OAuth授权流程的步骤"><a href="#OAuth授权流程的步骤" class="headerlink" title="OAuth授权流程的步骤"></a>OAuth授权流程的步骤</h5><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205092153672.png" alt="img"></p><center><small>OAuth授权流程-图源来自店匠官网</small></center><blockquote><p> PHP和GO可以使用官网的SDK进行授权第二步，自行尝试</p></blockquote><h5 id="Java对接店匠OAuth授权流程"><a href="#Java对接店匠OAuth授权流程" class="headerlink" title="Java对接店匠OAuth授权流程"></a>Java对接店匠OAuth授权流程</h5>]]></content>
    
    
    <categories>
      
      <category>外贸电商</category>
      
    </categories>
    
    
    <tags>
      
      <tag>店匠</tag>
      
      <tag>外贸电商</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>让 Google 收录博客</title>
    <link href="/2022/05/08/%E8%AE%A9google-%E6%94%B6%E5%BD%95%E5%8D%9A%E5%AE%A2/"/>
    <url>/2022/05/08/%E8%AE%A9google-%E6%94%B6%E5%BD%95%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>注意：本文以Fluid主题当示例来介绍</p></blockquote><h3 id="Google-Search-Console配置"><a href="#Google-Search-Console配置" class="headerlink" title="Google Search Console配置"></a>Google Search Console配置</h3><p>进入网址<a href="https://search.google.com/search-console">https://search.google.com/search-console</a></p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081849682.png" alt="image-20220508183546777" /><p>我选择的是&lt;网址前缀&gt; 输入网址后提示</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081849684.png" alt="image-20220508183818914"></p><p>我选择的是HTML标识验证 把元标记复制添加到hexo配置</p><h3 id="Hexo配置"><a href="#Hexo配置" class="headerlink" title="Hexo配置"></a>Hexo配置</h3><p>因为上文中已使用覆盖配置的方式使<strong>主题配置</strong>放置在 &lt;主题&gt; 目录之外，所以我们需要在hexo根目录下修改_config.&lt;主题名称&gt;.yml即可</p><p>我这里是_config.fluid.yml，全局搜索comment找到以下内容添加google提供的meta</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081849685.png" alt="image-20220508183318695"></p><p>添加成功并Hexo部署</p><p>然后再回到Google Search Console点击验证，显示这个代表配置成功</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081849686.png" alt="image-20220508183634549"></p><h3 id="Google-Search-Console-请求编入索引"><a href="#Google-Search-Console-请求编入索引" class="headerlink" title="Google Search Console 请求编入索引"></a>Google Search Console 请求编入索引</h3><p>登录你的 <a href="https://search.google.com/search-console/about">Google search console</a>，登陆后在控制台点击网址检查。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081849687.png" alt="image-20220508184304499"></p><p>点击请求编入索引，耐心等待</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081849688.png" alt="image-20220508184322245"></p><p>显示以下内容表示编入索引成功</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081849689.png" alt="image-20220508184351161"></p>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo 配置评论功能</title>
    <link href="/2022/05/08/Hexo-%E9%85%8D%E7%BD%AE%E8%AF%84%E8%AE%BA%E5%8A%9F%E8%83%BD/"/>
    <url>/2022/05/08/Hexo-%E9%85%8D%E7%BD%AE%E8%AF%84%E8%AE%BA%E5%8A%9F%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<blockquote><p>注意：本文以Fluid主题当示例来介绍如何配置评论，其他主题请根据对应用户手册配置</p></blockquote><p>我是用的主题Fluid支持多种评论插件，utterances | disqus | gitalk | valine | waline | changyan | livere | remark42 | twikoo | </p><p>cusdis，每种插件有不同的配置方法，为了和评论用户有真实反馈、长久的交互和尽可能简单配置我这里选择了基于 GitHub Issues实现的utterances</p><h3 id="新建github仓库"><a href="#新建github仓库" class="headerlink" title="新建github仓库"></a>新建github仓库</h3><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081715639.png" alt="image-20220508171452067"></p><p>（我这里已经创建过了，所以显示报错）</p><h3 id="github-Install-utterances-app"><a href="#github-Install-utterances-app" class="headerlink" title="github Install utterances app"></a>github Install utterances app</h3><p>utterances官网：<a href="https://utteranc.es/">https://utteranc.es/</a></p><p>点击此链接github安装<a href="https://github.com/apps/utterances">utterances app</a>。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081720238.png" alt="image-20220508172011715"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081730113.png" alt="image-20220508172028588"></p><h3 id="Hexo配置"><a href="#Hexo配置" class="headerlink" title="Hexo配置"></a>Hexo配置</h3><p>因为上文中已使用覆盖配置的方式使<strong>主题配置</strong>放置在 &lt;主题&gt; 目录之外，所以我们需要在hexo根目录下修改_config.&lt;主题名称&gt;.yml即可</p><p>我这里是_config.fluid.yml，全局搜索comment找到以下内容开启评论并使用utterances插件 修改</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 评论插件</span><br><span class="hljs-comment"># Comment plugin</span><br><span class="hljs-attr">comments:</span><br><span class="hljs-comment">#开启评论插件</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># 指定的插件，需要同时设置对应插件的必要参数</span><br>  <span class="hljs-comment"># The specified plugin needs to set the necessary parameters at the same time</span><br>  <span class="hljs-comment"># Options: utterances | disqus | gitalk | valine | waline | changyan | livere | remark42 | twikoo | cusdis</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">utterances</span><br></code></pre></td></tr></table></figure><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081730114.png" alt="image-20220508170721628"></p><p>配置utterances插件 在_config.fluid.yml文件全局搜索utterances找到以下内容修改</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Utterances</span><br><span class="hljs-comment"># 基于 GitHub Issues</span><br><span class="hljs-comment"># Based on GitHub Issues</span><br><span class="hljs-comment"># See: https://utteranc.es</span><br><span class="hljs-attr">utterances:</span><br>  <span class="hljs-attr">repo:</span> <span class="hljs-string">repo仓库</span><br>  <span class="hljs-attr">issue_term:</span> <span class="hljs-string">pathname</span><br>  <span class="hljs-attr">label:</span> <span class="hljs-string">utterances</span><br>  <span class="hljs-attr">theme:</span> <span class="hljs-string">github-light</span><br>  <span class="hljs-attr">theme_dark:</span> <span class="hljs-string">github-dark</span><br>  <span class="hljs-attr">crossorigin:</span> <span class="hljs-string">anonymous</span><br></code></pre></td></tr></table></figure><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>打开你的博客文章 看到以下内容 即为配置成功</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081730181.png" alt="image-20220508172837182"></p><p>注：如果有些页面没有出现此评论插件可以在文章开头手动打开</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081729044.png" alt="image-20220508172937108"></p><p>一旦有评论我就会第一时间收到邮件啦，我就会在第一时间回复啦🤪，欢迎评论</p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081734441.png" alt="image-20220508173435809" />]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo 搭建博客Blog记录</title>
    <link href="/2022/05/07/Hexo%20%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2Blog%E8%AE%B0%E5%BD%95/"/>
    <url>/2022/05/07/Hexo%20%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2Blog%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<p><strong>我的第一篇文章 记录一下博客搭建过程</strong></p><center><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/202205081923624.jpg" alt="GitHub+Hexo 搭建个人网站详细教程" style="width:100%;"/></center><center><small><font color="gray">(此图来源于网络)</font></small></center><h4 id="Hexo介绍"><a href="#Hexo介绍" class="headerlink" title="Hexo介绍"></a>Hexo介绍</h4><p>Hexo官网地址 &gt; <a href="https://hexo.io/">https://hexo.io/</a></p><blockquote><p>What is Hexo?</p><p>Hexo is a fast, simple and powerful blog framework. You write posts in <a href="http://daringfireball.net/projects/markdown/">Markdown</a> (or other markup languages) and Hexo generates static files with a beautiful theme in seconds.—引用自官网</p></blockquote><p>Hexo是什么？ Hexo是一个快速、简单且功能强大的博客框架。你用Markdown（或其他标记语言）写文章，Hexo会在几秒钟内生成带有漂亮主题的静态文件。</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20220507225447240.png" alt="image-20220507225447240"></p><p>注：本文安装教程针对 Mac系统，部分命令不适用于Windows</p><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><ul><li><p><a href="http://nodejs.org/">Node.js</a> (Should be at least Node.js 10.13, recommends 12.0 or higher)</p><p><code>brew install node</code></p><blockquote><p>官网：</p><ul><li>Windows: Download &amp; install <a href="https://git-scm.com/download/win">git</a>.</li><li>Mac: Install it with <a href="https://brew.sh/">Homebrew</a>, <a href="http://www.macports.org/">MacPorts</a> or <a href="http://sourceforge.net/projects/git-osx-installer/">installer</a>.</li><li>Linux (Ubuntu, Debian): <code>sudo apt-get install git-core</code></li><li>Linux (Fedora, Red Hat, CentOS): <code>sudo yum install git-core</code></li></ul></blockquote></li><li><p><a href="http://git-scm.com/">Git</a></p><p><code>brew install git</code></p><blockquote><p>官网：</p><ul><li>Windows: Install it with <a href="https://github.com/jasongin/nvs/">nvs</a> (recommended) or <a href="https://github.com/nvm-sh/nvm">nvm</a>.</li><li>Mac: Install it with <a href="https://brew.sh/">Homebrew</a> or <a href="http://www.macports.org/">MacPorts</a>.</li><li>Linux (DEB&#x2F;RPM-based): Install it with <a href="https://github.com/nodesource/distributions">NodeSource</a>.</li><li>Others: Install it through respective package manager. Refer to <a href="https://nodejs.org/en/download/package-manager/">the guide</a> provided by Node.js.</li></ul></blockquote></li></ul><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><code>npm install hexo-cli -g </code></p><p><code>hexo init blog </code></p><p><code>cd blog </code></p><p><code>npm install</code></p><h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p><code>hexo server</code></p><p>显示以下内容为启动成功</p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20231208170516196.png" alt="image-20231208170516196"></p><p>访问<a href="http://localhost:4000/">http://localhost:4000/</a> 即可进入你的博客</p><h4 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h4><p>主题地址：<a href="https://hexo.io/themes/">https://hexo.io/themes/</a></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20220507233206084.png" alt="image-20220507233206084"></p><p>挑选喜欢的主题 点击进入github地址</p><p>在初始化的hexo目录下执行git clone 到theme下指定目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs git">git clone https://github.com/fluid-dev/hexo-theme-fluid.git themes/fluid<br></code></pre></td></tr></table></figure><p>主题都会有自己的用户手册 我用的是Fluid主题 用户手册：<a href="https://hexo.fluid-dev.com/docs/start">https://hexo.fluid-dev.com/docs/start</a></p><p>主题跟这个用户手册配置就好了 我这里就不赘述了</p><h4 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h4><blockquote><p> 详细使用教程 <a href="https://hexo.io/zh-cn/docs/">https://hexo.io/zh-cn/docs/</a></p></blockquote><ul><li>可以使用以下命令新建文章</li></ul><p><code>hexo new &quot;&lt;文章名称&gt;&quot;</code></p><ul><li><p>然后cd &lt;hexo目录&gt;&#x2F;source&#x2F;_posts 就可以用markdown语句编辑文档</p></li><li><p>可以在文件顶部通过tags 修改标签 、通过categories修改分类、通过hide隐藏文章、通过archives归档</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">title:</span> <span class="hljs-string">Hexo</span> <span class="hljs-string">搭建博客Blog记录</span><br><span class="hljs-attr">date:</span> <span class="hljs-number">2022-05-07 17:44:14</span><br><span class="hljs-attr">hide:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">archives:</span> <span class="hljs-string">/archives</span><br><span class="hljs-attr">tags:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">first</span> <span class="hljs-string">tags</span><br><span class="hljs-attr">categories:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">first</span> <span class="hljs-string">categories</span><br><span class="hljs-meta">---</span><br><span class="hljs-string">&lt;正文内容&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20220508045636333.png" alt="image-20220508045636333"></p><p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20220508045657889.png" alt="image-20220508045657889"></p><h4 id="关于部署"><a href="#关于部署" class="headerlink" title="关于部署"></a>关于部署</h4><blockquote><p>Hexo 支持多种部署方式 具体可到官网查看：<a href="https://hexo.io/zh-cn/docs/one-command-deployment">https://hexo.io/zh-cn/docs/one-command-deployment</a></p></blockquote><h5 id="新建github仓库"><a href="#新建github仓库" class="headerlink" title="新建github仓库"></a>新建github仓库</h5><p>注意：固定名称&lt;用户名&gt;.github.io</p><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20220508050126798.png" alt="·" style="zoom:50%;" /><h5 id="关联git仓库和Hexo"><a href="#关联git仓库和Hexo" class="headerlink" title="关联git仓库和Hexo"></a>关联git仓库和Hexo</h5><p>在你初始化Hexo的根目录 修改_config.yml 在#Deployment下添加以下内容 注意空格</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">deploy:</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">git</span><br><span class="hljs-attr">repo:</span> <span class="hljs-string">仓库地址</span><br><span class="hljs-attr">branch:</span> <span class="hljs-string">分支</span><br></code></pre></td></tr></table></figure><h5 id="安装部署插件"><a href="#安装部署插件" class="headerlink" title="安装部署插件"></a>安装部署插件</h5><p><code>npm install hexo-deployer-git --save</code></p><h5 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h5><p><code>hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</code></p><p>可简写为</p><p><code>hexo clean &amp;&amp; hexo g -d</code></p><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul><li><p>覆盖配置可以使<strong>主题配置</strong>放置在 fluid 目录之外，避免在更新主题时丢失自定义的配置。</p><p>在博客目录下创建 <code>_config.&lt;主题名称&gt;.yml</code> 文件，将主题的 <a href="https://github.com/fluid-dev/hexo-theme-fluid/blob/master/_config.yml">_config.yml (opens new window)</a>全部配置（或部分配置）复制过去。</p><p>以后如果修改任何主题配置，都只需修改 <code>_config.&lt;主题名称&gt;.yml</code> 的配置即可。</p><p><left><img src="https://picgo-1258041929.cos.ap-guangzhou.myqcloud.com/img/image-20220508154920223.png" alt="image-20220508154920223"  /></left></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
      <tag>部署</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
